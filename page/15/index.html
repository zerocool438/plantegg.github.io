<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="plantegg" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="java mysql tcp performance network docker Linux">
<meta property="og:type" content="website">
<meta property="og:title" content="plantegg">
<meta property="og:url" content="https://plantegg.github.io/page/15/index.html">
<meta property="og:site_name" content="plantegg">
<meta property="og:description" content="java mysql tcp performance network docker Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="plantegg">
<meta name="twitter:description" content="java mysql tcp performance network docker Linux">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://plantegg.github.io/page/15/"/>





  <title>plantegg - java tcp mysql performance network docker Linux</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">plantegg</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">java tcp mysql performance network docker Linux</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-categories"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2016/10/12/ss用法大全/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weibo @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/12/ss用法大全/" itemprop="url">就是要你懂网络监控--ss用法大全</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-12T15:30:03+08:00">
                2016-10-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index">
                    <span itemprop="name">network</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="就是要你懂网络监控–ss用法大全"><a href="#就是要你懂网络监控–ss用法大全" class="headerlink" title="就是要你懂网络监控–ss用法大全"></a>就是要你懂网络监控–ss用法大全</h1><p>ss是Socket Statistics的缩写。</p>
<p>netstat命令大家肯定已经很熟悉了，但是在2001年的时候netstat 1.42版本之后就没更新了，之后取代的工具是ss命令，是iproute2 package的一员。</p>
<blockquote>
<p>​    rpm -ql iproute | grep ss<br>​    /usr/sbin/ss</p>
</blockquote>
<p>netstat的替代工具是nstat，当然netstat的大部分功能ss也可以替代</p>
<p>ss可以显示跟netstat类似的信息，但是速度却比netstat快很多，netstat是基于/proc/net/tcp获取 TCP socket 的相关统计信息，用strace跟踪一下netstat查询tcp的连接，会看到他open的是/proc/net/tcp的信息。ss快的秘密就在于它利用的是TCP协议的tcp_diag模块，而且是从内核直接读取信息，<strong>当内核不支持  tcp_diag 内核模块时，会回退到 /proc/net/tcp 模式</strong>。</p>
<p>/proc/net/snmp 存放的是系统启动以来的累加值，netstat -s 读取它<br>/proc/net/tcp  是存放目前活跃的tcp连接的统计值，连接断开统计值清空， ss -it 读取它</p>
<h2 id="ss-查看Buffer窗口"><a href="#ss-查看Buffer窗口" class="headerlink" title="ss 查看Buffer窗口"></a><a href="https://access.redhat.com/discussions/3624151" target="_blank" rel="external">ss 查看Buffer窗口</a></h2><p>ss参数说明<a href="https://man7.org/linux/man-pages/man8/ss.8.html" target="_blank" rel="external">权威参考</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">-m, --memory  //查看每个连接的buffer使用情况</div><div class="line">              Show socket memory usage. The output format is:</div><div class="line"></div><div class="line">              skmem:(r&lt;rmem_alloc&gt;,rb&lt;rcv_buf&gt;,t&lt;wmem_alloc&gt;,tb&lt;snd_buf&gt;,</div><div class="line">                            f&lt;fwd_alloc&gt;,w&lt;wmem_queued&gt;,o&lt;opt_mem&gt;,</div><div class="line">                            bl&lt;back_log&gt;,d&lt;sock_drop&gt;)</div><div class="line"></div><div class="line">              &lt;rmem_alloc&gt;</div><div class="line">                     the memory allocated for receiving packet</div><div class="line"></div><div class="line">              &lt;rcv_buf&gt;</div><div class="line">                     the total memory can be allocated for receiving</div><div class="line">                     packet</div><div class="line"></div><div class="line">              &lt;wmem_alloc&gt;</div><div class="line">                     the memory used for sending packet (which has been</div><div class="line">                     sent to layer 3)</div><div class="line"></div><div class="line">              &lt;snd_buf&gt;</div><div class="line">                     the total memory can be allocated for sending</div><div class="line">                     packet</div><div class="line"></div><div class="line">              &lt;fwd_alloc&gt;</div><div class="line">                     the memory allocated by the socket as cache, but</div><div class="line">                     not used for receiving/sending packet yet. If need</div><div class="line">                     memory to send/receive packet, the memory in this</div><div class="line">                     cache will be used before allocate additional</div><div class="line">                     memory.</div><div class="line"></div><div class="line">              &lt;wmem_queued&gt;</div><div class="line">                     The memory allocated for sending packet (which has</div><div class="line">                     not been sent to layer 3)</div><div class="line"></div><div class="line">              &lt;ropt_mem&gt;</div><div class="line">                     The memory used for storing socket option, e.g.,</div><div class="line">                     the key for TCP MD5 signature</div><div class="line"></div><div class="line">              &lt;back_log&gt;</div><div class="line">                     The memory used for the sk backlog queue. On a</div><div class="line">                     process context, if the process is receiving</div><div class="line">                     packet, and a new packet is received, it will be</div><div class="line">                     put into the sk backlog queue, so it can be</div><div class="line">                     received by the process immediately</div><div class="line"></div><div class="line">              &lt;sock_drop&gt;</div><div class="line">                     the number of packets dropped before they are de-</div><div class="line">                     multiplexed into the socket</div></pre></td></tr></table></figure>
<p>The entire print format of <code>ss -m</code> is given in the source:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">      printf(&quot; skmem:(r%u,rb%u,t%u,tb%u,f%u,w%u,o%u&quot;,</div><div class="line">               skmeminfo[SK_MEMINFO_RMEM_ALLOC],</div><div class="line">               skmeminfo[SK_MEMINFO_RCVBUF],</div><div class="line">               skmeminfo[SK_MEMINFO_WMEM_ALLOC],</div><div class="line">               skmeminfo[SK_MEMINFO_SNDBUF],</div><div class="line">               skmeminfo[SK_MEMINFO_FWD_ALLOC],</div><div class="line">               skmeminfo[SK_MEMINFO_WMEM_QUEUED],</div><div class="line">               skmeminfo[SK_MEMINFO_OPTMEM]);</div><div class="line"></div><div class="line">        if (RTA_PAYLOAD(tb[attrtype]) &gt;=</div><div class="line">                (SK_MEMINFO_BACKLOG + 1) * sizeof(__u32))</div><div class="line">                printf(&quot;,bl%u&quot;, skmeminfo[SK_MEMINFO_BACKLOG]);</div><div class="line"></div><div class="line">        if (RTA_PAYLOAD(tb[attrtype]) &gt;=</div><div class="line">                (SK_MEMINFO_DROPS + 1) * sizeof(__u32))</div><div class="line">                printf(&quot;,d%u&quot;, skmeminfo[SK_MEMINFO_DROPS]);</div><div class="line"></div><div class="line">        printf(&quot;)&quot;);</div><div class="line">        </div><div class="line">        </div><div class="line">net/core/sock.c line:3095</div><div class="line">void sk_get_meminfo(const struct sock *sk, u32 *mem)</div><div class="line">&#123;</div><div class="line">	memset(mem, 0, sizeof(*mem) * SK_MEMINFO_VARS);</div><div class="line"></div><div class="line">	mem[SK_MEMINFO_RMEM_ALLOC] = sk_rmem_alloc_get(sk);</div><div class="line">	mem[SK_MEMINFO_RCVBUF] = sk-&gt;sk_rcvbuf;</div><div class="line">	mem[SK_MEMINFO_WMEM_ALLOC] = sk_wmem_alloc_get(sk);</div><div class="line">	mem[SK_MEMINFO_SNDBUF] = sk-&gt;sk_sndbuf;</div><div class="line">	mem[SK_MEMINFO_FWD_ALLOC] = sk-&gt;sk_forward_alloc;</div><div class="line">	mem[SK_MEMINFO_WMEM_QUEUED] = sk-&gt;sk_wmem_queued;</div><div class="line">	mem[SK_MEMINFO_OPTMEM] = atomic_read(&amp;sk-&gt;sk_omem_alloc);</div><div class="line">	mem[SK_MEMINFO_BACKLOG] = sk-&gt;sk_backlog.len;</div><div class="line">	mem[SK_MEMINFO_DROPS] = atomic_read(&amp;sk-&gt;sk_drops);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="/images/951413iMgBlog/image-20210604120011898.png" alt="image-20210604120011898"></p>
<p>–memory/-m ： 展示buffer窗口的大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#ss -m | xargs -L 1 | grep &quot;ESTAB&quot; | awk &apos;&#123; if($3&gt;0 || $4&gt;0) print $0 &#125;&apos;</div><div class="line">tcp ESTAB 0 31 10.97.137.1:7764 10.97.137.2:41019 skmem:(r0,rb7160692,t0,tb87040,f1792,w2304,o0,bl0)</div><div class="line">tcp ESTAB 0 193 ::ffff:10.97.137.1:sdo-tls ::ffff:10.97.137.2:55545 skmem:(r0,rb369280,t0,tb87040,f1792,w2304,o0,bl0)</div><div class="line">tcp ESTAB 0 65 ::ffff:10.97.137.1:splitlock ::ffff:10.97.137.2:47796 skmem:(r0,rb369280,t0,tb87040,f1792,w2304,o0,bl0)</div><div class="line">tcp ESTAB 0 80 ::ffff:10.97.137.1:informer ::ffff:10.97.137.3:49279 skmem:(r0,rb369280,t0,tb87040,f1792,w2304,o0,bl0)</div><div class="line">tcp ESTAB 0 11 ::ffff:10.97.137.1:acp-policy ::ffff:10.97.137.2:41607 skmem:(r0,rb369280,t0,tb87040,f1792,w2304,o0,bl0)</div><div class="line"></div><div class="line">#ss -m -n | xargs -L 1 | grep &quot;tcp EST&quot; | grep &quot;t[1-9]&quot;</div><div class="line">tcp ESTAB 0 281 10.97.169.173:32866 10.97.170.220:3306 skmem:(r0,rb4619516,t2304,tb87552,f1792,w2304,o0,bl0)</div></pre></td></tr></table></figure>
<p><img src="/images/oss/4a09503e6c6e84c25e026248a1b3ebb6.png" alt="image.png"></p>
<p>如上图，tb指可分配的发送buffer大小，不够还可以动态调整（应用没有写死的话），w[The memory allocated for sending packet (which has not been sent to layer 3)]已经预分配好了的size，t[the memory used for sending packet (which has been sent to layer 3)] , 似乎 w总是等于大于t？</p>
<p>example:</p>
<p><img src="/images/oss/4ed3d8aab6ef3ee45decda75e534baab.png" alt="image.png"></p>
<p>对172.16.210.17和172.16.160.1之间的带宽限速50MB后观察(带宽限制后，发送buffer就很容易被撑满了）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash">ss -m | xargs -L 1 | grep <span class="string">"tcp EST"</span> | awk <span class="string">'&#123; if($3&gt;0 || $4&gt;0) print $0 &#125;'</span></span></div><div class="line">Netid State Recv-Q Send-Q Local Address:Port Peer Address:Port</div><div class="line">tcp ESTAB 1431028 0 172.16.210.17:30082 172.16.160.1:4847 skmem:(r2066432,rb2135508,t0,tb46080,f2048,w0,o0,bl0,d72)</div><div class="line">tcp ESTAB 1195628 0 172.16.210.17:30086 172.16.160.1:4847 skmem:(r1742848,rb1915632,t8,tb46080,f190464,w0,o0,bl0,d187)</div><div class="line">tcp ESTAB 86416 0 172.16.210.17:40470 172.16.160.1:4847 skmem:(r127232,rb131072,t0,tb46080,f3840,w0,o0,bl0,d16)</div><div class="line">tcp ESTAB 1909826 0 172.16.210.17:40476 172.16.160.1:4847 skmem:(r2861568,rb2933688,t2,tb46080,f26112,w0,o0,bl0,d15)</div><div class="line">tcp ESTAB 758312 0 172.16.210.17:40286 172.16.160.1:4847 skmem:(r1124864,rb1177692,t0,tb46080,f1536,w0,o0,bl0,d17)</div><div class="line">tcp ESTAB 2238720 0 172.16.210.17:40310 172.16.160.1:4847 skmem:(r3265280,rb3334284,t0,tb46080,f3328,w0,o0,bl0,d30)</div><div class="line">tcp ESTAB 88172 0 172.16.210.17:40508 172.16.160.1:4847 skmem:(r128000,rb131072,t0,tb46080,f3072,w0,o0,bl0,d16)</div><div class="line">tcp ESTAB 87700 0 172.16.210.17:41572 172.16.160.1:4847 skmem:(r130560,rb131072,t0,tb46080,f512,w0,o0,bl0,d10)</div><div class="line">tcp ESTAB 4147293 0 172.16.210.17:40572 172.16.160.1:4847 skmem:(r6064896,rb6291456,t2,tb46080,f75008,w0,o0,bl0,d27)</div><div class="line">tcp ESTAB 1610940 0 172.16.210.17:30100 172.16.160.1:4847 skmem:(r2358784,rb2533092,t6,tb46080,f82432,w0,o0,bl0,d304)</div><div class="line">tcp ESTAB 4216156 0 172.16.210.17:30068 172.16.160.1:4847 skmem:(r6091008,rb6291456,t0,tb46080,f3840,w0,o0,bl0,d112)</div><div class="line">tcp ESTAB 87468 0 172.16.210.17:40564 172.16.160.1:4847 skmem:(r127232,rb131072,t0,tb46080,f3840,w0,o0,bl0,d16)</div><div class="line">tcp ESTAB 0 84608 172.16.210.17:3306 10.100.7.27:43114 skmem:(r0,rb65536,t8352,tb131072,f75648,w92288,o0,bl0,d0)</div><div class="line">tcp ESTAB 4141872 0 172.16.210.17:40584 172.16.160.1:4847 skmem:(r6050560,rb6291456,t2,tb46080,f19712,w0,o0,bl0,d14)</div><div class="line"><span class="meta"></span></div><div class="line">$<span class="bash">ss -itn</span></div><div class="line">State       Recv-Q Send-Q   Local Address:Port                  Peer Address:Port</div><div class="line">ESTAB       965824 0        172.16.210.17:19310                 172.16.160.1:4847</div><div class="line">         cubic wscale:9,7 rto:215 rtt:14.405/0.346 ato:160 mss:1440 rcvmss:1460 advmss:1460 cwnd:10 bytes_acked:1324584 bytes_received:2073688144 segs_out:91806 segs_in:1461520 data_segs_out:4824 data_segs_in:1456130 send 8.0Mbps lastsnd:545583 lastrcv:545276 lastack:13173 pacing_rate 16.0Mbps delivery_rate 8.9Mbps app_limited busy:9071ms rcv_rtt:1.303 rcv_space:164245 minrtt:1.293</div><div class="line">ESTAB       0      84371    172.16.210.17:3306                  10.100.7.147:59664</div><div class="line">         cubic wscale:7,7 rto:217 rtt:16.662/0.581 ato:40 mss:1448 rcvmss:976 advmss:1448 cwnd:375 ssthresh:19 bytes_acked:5087795046 bytes_received:1647 segs_out:3589314 segs_in:358086 data_segs_out:3589313 data_segs_in:8 send 260.7Mbps lastsnd:6 lastrcv:1177745 lastack:4 pacing_rate 312.8Mbps delivery_rate 32.9Mbps busy:1176476ms rwnd_limited:1717ms(0.1%) sndbuf_limited:159867ms(13.6%) unacked:37 retrans:0/214 rcv_space:14600 notsent:32055 minrtt:7.945</div><div class="line">ESTAB       0      83002    172.16.210.17:3306                   10.100.7.28:34066</div><div class="line">         cubic wscale:7,7 rto:215 rtt:14.635/0.432 ato:40 mss:1448 rcvmss:976 advmss:1448 cwnd:144 ssthresh:144 bytes_acked:972464708 bytes_received:1466 segs_out:671667 segs_in:94369 data_segs_out:671666 data_segs_in:8 send 114.0Mbps lastsnd:1 lastrcv:453365 lastack:1 pacing_rate 136.8Mbps delivery_rate 24.0Mbps busy:453493ms sndbuf_limited:200ms(0.0%) unacked:23 rcv_space:14600 notsent:49698 minrtt:9.937</div><div class="line">ESTAB       1239616 0        172.16.210.17:41592                 172.16.160.1:4847</div><div class="line">         cubic wscale:9,7 rto:216 rtt:15.754/0.775 ato:144 mss:1440 rcvmss:1460 advmss:1460 cwnd:10 bytes_acked:20321 bytes_received:1351071 segs_out:269 segs_in:1091 data_segs_out:76 data_segs_in:988 send 7.3Mbps lastsnd:339339 lastrcv:337401 lastack:10100 pacing_rate 14.6Mbps delivery_rate 1.0Mbps app_limited busy:1214ms rcv_rtt:227.156 rcv_space:55581 minrtt:11.38</div><div class="line">ESTAB       3415748 0        172.16.210.17:30090                 172.16.160.1:4847</div><div class="line">         cubic wscale:9,7 rto:202 rtt:1.667/0.011 ato:80 mss:1440 rcvmss:1460 advmss:1460 cwnd:10 bytes_acked:398583 bytes_received:613824362 segs_out:28630 segs_in:437621 data_segs_out:1495 data_segs_in:435792 send 69.1Mbps lastsnd:1179931 lastrcv:1179306 lastack:12149 pacing_rate 138.2Mbps delivery_rate 7.2Mbps app_limited busy:2520ms rcv_rtt:1.664 rcv_space:212976 minrtt:1.601</div><div class="line">ESTAB       86480  0        172.16.210.17:41482                 172.16.160.1:4847</div><div class="line">         cubic wscale:9,7 rto:215 rtt:14.945/1.83 ato:94 mss:1440 rcvmss:1460 advmss:1460 cwnd:10 bytes_acked:3899 bytes_received:93744 segs_out:73 segs_in:136 data_segs_out:20 data_segs_in:83 send 7.7Mbps lastsnd:449541 lastrcv:449145 lastack:19314 pacing_rate 15.4Mbps delivery_rate 964.2Kbps app_limited busy:296ms rcv_rtt:8561.27 rcv_space:14600 minrtt:11.948</div><div class="line">ESTAB       89136  0        172.16.210.17:40480                 172.16.160.1:4847</div><div class="line">         cubic wscale:9,7 rto:213 rtt:12.11/0.79 ato:196 mss:1440 rcvmss:1460 advmss:1460 cwnd:10 bytes_acked:2510 bytes_received:95652 segs_out:102 segs_in:168 data_segs_out:16 data_segs_in:81send 9.5Mbps lastsnd:1099067 lastrcv:1098659 lastack:13686 pacing_rate 19.0Mbps delivery_rate 1.0Mbps app_limited busy:199ms rcv_rtt:2438.63 rcv_space:14600 minrtt:11.178</div><div class="line">ESTAB       0      84288    172.16.210.17:3306                   10.100.7.26:51160</div><div class="line">         cubic wscale:7,7 rto:216 rtt:15.129/0.314 ato:40 mss:1448 rcvmss:976 advmss:1448 cwnd:157 ssthresh:157 bytes_acked:2954689465 bytes_received:1393 segs_out:2041403 segs_in:237797 data_segs_out:2041402 data_segs_in:8 send 120.2Mbps lastsnd:11 lastrcv:1103462 lastack:10 pacing_rate 144.2Mbps delivery_rate 31.3Mbps busy:1103503ms sndbuf_limited:3398ms(0.3%) unacked:24 retrans:0/7rcv_space:14600 notsent:49536 minrtt:9.551</div></pre></td></tr></table></figure>
<p>推荐 -m -i 一起查看状态，比如 rcv_space 表示buffer达到过的最大水位</p>
<blockquote>
<p><strong>rcv_space</strong> is the high water mark of the rate of the local application reading from the receive buffer during any RTT. This is used internally within the kernel to adjust sk_rcvbuf.</p>
</blockquote>
<h2 id="ss-查看拥塞窗口、RTO"><a href="#ss-查看拥塞窗口、RTO" class="headerlink" title="ss 查看拥塞窗口、RTO"></a>ss 查看拥塞窗口、RTO</h2><blockquote>
<p>//rto的定义，不让修改，每个ip的rt都不一样，必须通过rtt计算所得, HZ 一般是1秒</p>
<p>#define TCP_RTO_MAX     ((unsigned)(120*HZ))</p>
<p>#define TCP_RTO_MIN     ((unsigned)(HZ/5)) //在rt很小的环境中计算下来RTO基本等于TCP_RTO_MIN</p>
</blockquote>
<p>下面看到的rto和rtt单位都是毫秒，一般rto最小为200ms、最大为120秒</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#ss -itn |egrep &quot;cwnd|rto&quot;	</div><div class="line">ESTAB       0      165      [::ffff:192.168.0.174]:48074                [::ffff:192.168.0.173]:3306</div><div class="line">	cubic wscale:7,7 rto:201 rtt:0.24/0.112 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:10 bytes_acked:1910206449 bytes_received:8847784416 segs_out:11273005 segs_in:22997562 data_segs_out:9818729 data_segs_in:13341573 send 482.7Mbps lastsnd:1 lastrcv:1 pacing_rate 963.8Mbps delivery_rate 163.2Mbps app_limited busy:2676463ms retrans:0/183 rcv_rtt:1.001 rcv_space:35904 minrtt:0.135</div><div class="line"></div><div class="line">ESTAB       0      0        [::ffff:192.168.0.174]:48082                [::ffff:192.168.0.173]:3306</div><div class="line">	 cubic wscale:7,7 rto:201 rtt:0.262/0.112 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:10 bytes_acked:1852907381 bytes_received:8346503207 segs_out:10913962 segs_in:22169704 data_segs_out:9531411 data_segs_in:12796151 send 442.1Mbps lastsnd:2 lastack:2 pacing_rate 881.3Mbps delivery_rate 164.3Mbps app_limited busy:2736500ms retrans:0/260 rcv_rtt:1.042 rcv_space:31874 minrtt:0.133</div><div class="line">	 </div><div class="line">	 -----</div><div class="line">	 skmem:(r0,rb131072,t0,tb133632,f0,w0,o0,bl0,d0) cubic wscale:8,7 rto:233 rtt:32.489/2.99 ato:40 mss:1380 rcvmss:536 advmss:1460 cwnd:11 ssthresh:8 bytes_acked:99862366 bytes_received:2943 segs_out:78933 segs_in:23388 data_segs_out:78925 data_segs_in:81 send 3.7Mbps lastsnd:1735288 lastrcv:1735252 lastack:1735252 pacing_rate 4.5Mbps delivery_rate 2.9Mbps busy:370994ms retrans:0/6479 reordering:5 rcv_space:14600 minrtt:27.984</div></pre></td></tr></table></figure>
<h3 id="RTO计算算法"><a href="#RTO计算算法" class="headerlink" title="RTO计算算法"></a>RTO计算算法</h3><p>RTO的计算依赖于RTT值，或者说一系列RTT值。rto=f(rtt)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">1.1. 在没有任何rtt sample的时候，RTO &lt;- TCP_TIMEOUT_INIT (1s)</div><div class="line">   多次重传时同样适用指数回避算法(backoff)增加RTO  </div><div class="line"></div><div class="line">1.2. 获得第一个RTT sample后，</div><div class="line">    SRTT &lt;- RTT</div><div class="line">    RTTVAR &lt;- RTT/2</div><div class="line">    RTO &lt;- SRTT + max(G, K * RTTVAR)</div><div class="line">其中K=4, G表示timestamp的粒度(在CONFIG_HZ=1000时，粒度为1ms)</div><div class="line"></div><div class="line">1.3. 后续获得更多RTT sample后，</div><div class="line">    RTTVAR &lt;- (1 - beta) * RTTVAR + beta * |SRTT - R|</div><div class="line">    SRTT &lt;- (1 - alpha) * SRTT + alpha * R</div><div class="line">其中beta = 1/4, alpha = 1/8</div><div class="line"></div><div class="line">1.4. Whenever RTO is computed, if it is less than 1 second, then the</div><div class="line">   RTO SHOULD be rounder up to 1 second.</div><div class="line"></div><div class="line">1.5. A maximum value MAY be placed on RTO provided it is at least 60 seconds.</div></pre></td></tr></table></figure>
<p>RTTVAR表示的是平滑过的平均偏差，SRTT表示的平滑过的RTT。这两个值的具体含义会在后面介绍<br>具体实现的时候进一步的解释。<br>以上是计算一个初始RTO值的过程，当连续出现RTO超时后，<br>RTO值会用一个叫做指数回避的策略进行调整，下面来具体介绍。</p>
<h2 id="从系统cache中查看-tcp-metrics-item"><a href="#从系统cache中查看-tcp-metrics-item" class="headerlink" title="从系统cache中查看 tcp_metrics item"></a>从系统cache中查看 tcp_metrics item</h2><pre><code>$sudo ip tcp_metrics show | grep  100.118.58.7
100.118.58.7 age 1457674.290sec tw_ts 3195267888/5752641sec ago rtt 1000us rttvar 1000us ssthresh 361 cwnd 40 ----这两个值对传输性能很重要

192.168.1.100 age 1051050.859sec ssthresh 4 cwnd 2 rtt 4805us rttvar 4805us source 192.168.0.174 ---这条记录有问题，缓存的ssthresh 4 cwnd 2都太小，传输速度一定慢 

清除 tcp_metrics, sudo ip tcp_metrics flush all 
关闭 tcp_metrics 功能，net.ipv4.tcp_no_metrics_save = 1
sudo ip tcp_metrics delete 100.118.58.7
</code></pre><p>每个连接的ssthresh默认是个无穷大的值，但是内核会cache对端ip上次的ssthresh（大部分时候两个ip之间的拥塞窗口大小不会变），这样大概率到达ssthresh之后就基本拥塞了，然后进入cwnd的慢增长阶段。</p>
<h2 id="ss-过滤地址和端口号，类似tcpdump的用法"><a href="#ss-过滤地址和端口号，类似tcpdump的用法" class="headerlink" title="ss 过滤地址和端口号，类似tcpdump的用法"></a>ss 过滤地址和端口号，类似tcpdump的用法</h2><p>过滤目标端口是80的或者源端口是1723的连接，dst后面要跟空格然后加“：”：</p>
<pre><code># ss -ant dst :80 or src :1723 
State      Recv-Q Send-Q   Local Address:Port Peer Address:Port 
LISTEN     0      3        *:1723              *:*     
TIME-WAIT  0      0                                                     172.31.23.95:37269                                              111.161.68.235:80    
TIME-WAIT  0      0                                                     172.31.23.95:37263                                              111.161.68.235:80    
TIME-WAIT  0      0                                                     172.31.23.95:37267 
</code></pre><p>or：</p>
<pre><code>ss -ant dport = :80 or sport = :1723
</code></pre><p>地址筛选，目标地址是111.161.68.235的连接</p>
<pre><code>ss -ant dst 111.161.68.235
</code></pre><p>端口大小筛选，源端口大于1024的端口：</p>
<pre><code>ss sport gt 1024
</code></pre><p>How Do I Compare Local and/or Remote Port To A Number?<br>Use the following syntax:</p>
<pre><code>## Compares remote port to a number ##
ss dport OP PORT

## Compares local port to a number ##
sport OP PORT
</code></pre><p>Where OP can be one of the following:</p>
<pre><code>&lt;= or le : Less than or equal to port
&gt;= or ge : Greater than or equal to port
== or eq : Equal to port
!= or ne : Not equal to port
&lt; or gt : Less than to port
&gt; or lt : Greater than to port
Note: le, gt, eq, ne etc. are use in unix shell and are accepted as well.

###################################################################################
### Do not forget to escape special characters when typing them in command line ###
###################################################################################

ss  sport = :http
ss  dport = :http
ss  dport \&gt; :1024
ss  sport \&gt; :1024
ss sport \&lt; :32000
ss  sport eq :22
ss  dport != :22
ss  state connected sport = :http
ss \( sport = :http or sport = :https \)
ss -o state fin-wait-1 \( sport = :http or sport = :https \) dst 192.168.1/24
</code></pre><h2 id="ss-查看-timer-状态"><a href="#ss-查看-timer-状态" class="headerlink" title="ss 查看 timer 状态"></a>ss 查看 timer 状态</h2><p>ss -atonp</p>
<h2 id="按连接状态过滤"><a href="#按连接状态过滤" class="headerlink" title="按连接状态过滤"></a>按连接状态过滤</h2><p>Display All Established HTTP Connections</p>
<pre><code>ss -o state established &apos;( dport = :http or sport = :http )&apos;
</code></pre><p>List all the TCP sockets in state -FIN-WAIT-1 for our httpd to network 202.54.1/24 and look at their timers:<br>    ss -o state fin-wait-1 ‘( sport = :http or sport = :https )’ dst 202.54.1/24</p>
<p>Filter Sockets Using TCP States</p>
<pre><code>ss -4 state FILTER-NAME-HERE
</code></pre><p>Where FILTER-NAME-HERE can be any one of the following,</p>
<pre><code>established
syn-sent
syn-recv
fin-wait-1
fin-wait-2
time-wait
closed
close-wait
last-ack
listen
closing
all : All of the above states
connected : All the states except for listen and closed
synchronized : All the connected states except for syn-sent
bucket : Show states, which are maintained as minisockets, i.e. time-wait and syn-recv.
big : Opposite to bucket state.
</code></pre><h2 id="ss分析重传的包数量"><a href="#ss分析重传的包数量" class="headerlink" title="ss分析重传的包数量"></a>ss分析重传的包数量</h2><p>通过抓取ss命令，可以分析出来重传的包数量，然后将重传的流的数量和重传的包的数量按照对端IP:port的维度分段聚合，参考命令：</p>
<pre><code>ss -itn |grep -v &quot;Address:Port&quot; | xargs -L 1  | grep retrans | awk &apos;{gsub(&quot;retrans:.*/&quot;, &quot;&quot;,$21); print $5, $21}&apos; | awk &apos;{arr[$1]+=$2} END {for (i in arr) {print i,arr[i]}}&apos; | sort -rnk 2 
</code></pre><p>xargs <strong>-L 1</strong>  每一行处理一次，但是这个行如果是空格、tab结尾，那么会被认为是连续行，跟下一行合并</p>
<p>高版本Linux内核的话，可以用systemtap或者bcc来获取每个连接的重传包以及发生重传的阶段</p>
<h2 id="当前和最大全连接队列确认"><a href="#当前和最大全连接队列确认" class="headerlink" title="当前和最大全连接队列确认"></a>当前和最大全连接队列确认</h2><pre><code>$ss -lt
State      Recv-Q Send-Q Local Address:Port                 Peer Address:Port         
LISTEN     0      128    127.0.0.1:10248                       *:*                   
LISTEN     0      128           *:2376                        *:*                    
LISTEN     0      128    127.0.0.1:10249                       *:*                   
LISTEN     0      128           *:7337                        *:*                    
LISTEN     0      128           *:10250                       *:*                    
LISTEN     0      128    11.163.187.44:7946                        *:*               
LISTEN     0      128    127.0.0.1:55631                       *:*                   
LISTEN     0      128           *:10256                       *:*                    
LISTEN     0      10            *:6640                        *:*                    
LISTEN     0      128    127.0.0.1:vmware-fdm                  *:*                   
LISTEN     0      128    11.163.187.44:vmware-fdm                  *:*               
LISTEN     0      128           *:ssh                         *:*                    
LISTEN     0      10     127.0.0.1:15772                       *:*                   
LISTEN     0      10     127.0.0.1:15776                       *:*                   
LISTEN     0      10     127.0.0.1:19777                       *:*                   
LISTEN     0      10     11.163.187.44:15778                       *:*               
LISTEN     0      128           *:tr-rsrb-p2                  *:*
</code></pre><h2 id="ss-s"><a href="#ss-s" class="headerlink" title="ss -s"></a>ss -s</h2><p>统计所有连接的状态</p>
<h2 id="nstat"><a href="#nstat" class="headerlink" title="nstat"></a>nstat</h2><p>nstat -z -t 1 类似 netstat -s  (ss –info 展示rto、拥塞算法等更详细信息； netstat -ant -o 展示keepalive是否)</p>
<p>netstat<a href="http://perthcharles.github.io/2015/11/10/wiki-netstat-proc/" target="_blank" rel="external">参考</a></p>
<h2 id="knetstat"><a href="#knetstat" class="headerlink" title="knetstat"></a>knetstat</h2><p>最后给出的一个工具，knetstat（需要单独安装），也可以查看tcp的状态下的各种参数，需要单独安装</p>
<p>example(3306是本地server，4192是后端MySQL）：</p>
<pre><code>Recv-Q Send-Q Local Address           Foreign Address         Stat Diag Options
 0      0 0.0.0.0:3306            0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 0.0.0.0:3406            0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 127.0.0.1:8182          0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 10.0.186.73:8182        0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 0.0.0.0:22              0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 0.0.0.0:8188            0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 127.0.0.1:15778         0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0 
 0    138 10.0.186.73:51756       10.0.160.1:4192         ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0      0 10.0.186.73:3306        10.0.186.70:37428       ESTB      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVBUF=32768,SO_SNDBUF=65536,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0    138 10.0.186.73:51476       10.0.160.1:4192         ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0      0 10.0.186.73:3306        10.0.186.70:37304       ESTB      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVBUF=32768,SO_SNDBUF=65536,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0      0 10.0.186.73:51842       10.0.160.1:4192         ESTB      SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
44      0 10.0.186.73:3306        10.0.186.70:36238       ESTB      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVBUF=32768,SO_SNDBUF=65536,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
44      0 10.0.186.73:3306        10.0.186.70:36160       ESTB      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVBUF=32768,SO_SNDBUF=65536,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
0      0 10.0.186.73:19030       10.0.171.188:8000       TIMW
</code></pre><p>3306对应的client上：</p>
<pre><code>Recv-Q Send-Q Local Address           Foreign Address         Stat Diag Options
 0     44 10.0.186.70:42428       10.0.186.73:3306        ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVTIMEO=31536000000ms,SO_SNDTIMEO=31536000000ms,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0     44 10.0.186.70:42298       10.0.186.73:3306        ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVTIMEO=31536000000ms,SO_SNDTIMEO=31536000000ms,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0     44 10.0.186.70:42296       10.0.186.73:3306        ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVTIMEO=31536000000ms,SO_SNDTIMEO=31536000000ms,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0     44 10.0.186.70:42322       10.0.186.73:3306        ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVTIMEO=31536000000ms,SO_SNDTIMEO=31536000000ms,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
</code></pre><p>Diag列的说明<br>    Indicator        Meaning</p>
<pre><code>&gt;|             The sender window (i.e. the window advertised by the remote endpoint) is 0. No data can be sent to the peer.
  &gt;|&lt;             The receiver window (i.e. the window advertised by the local endpoint) is 0. No data can be received from the peer.
&gt;
&gt;#             There are unacknowledged packets and the last ACK was received more than one second ago. This may be an indication that there are network problems or that the peer crashed.
</code></pre><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.cyberciti.biz/tips/linux-investigate-sockets-network-connections.html" target="_blank" rel="external">https://www.cyberciti.biz/tips/linux-investigate-sockets-network-connections.html</a></p>
<p><a href="http://perthcharles.github.io/2015/11/10/wiki-netstat-proc/" target="_blank" rel="external">http://perthcharles.github.io/2015/11/10/wiki-netstat-proc/</a></p>
<p>源代码：<a href="https://github.com/sivasankariit/iproute2/blob/master/misc/ss.c" target="_blank" rel="external">https://github.com/sivasankariit/iproute2/blob/master/misc/ss.c</a></p>
<p><a href="https://github.com/veithen/knetstat/tree/master" target="_blank" rel="external">https://github.com/veithen/knetstat/tree/master</a></p>
<p><a href="https://access.redhat.com/discussions/782343" target="_blank" rel="external">https://access.redhat.com/discussions/782343</a></p>
<p><a href="https://perthcharles.github.io/2015/09/06/wiki-rtt-estimator/" target="_blank" rel="external">RTO的计算方法(基于RFC6298和Linux 3.10)</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2016/08/24/Linux tc qdisc的使用案例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weibo @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/24/Linux tc qdisc的使用案例/" itemprop="url">Linux tc qdisc的使用案例</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-24T17:30:03+08:00">
                2016-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Linux-tc-qdisc的使用案例"><a href="#Linux-tc-qdisc的使用案例" class="headerlink" title="Linux tc qdisc的使用案例"></a>Linux tc qdisc的使用案例</h1><p>在linux下通过tc qdisc 很容易对rt延时、丢包、带宽进行控制，这样的话方便重现各种网络问题</p>
<h2 id="延时"><a href="#延时" class="headerlink" title="延时"></a>延时</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">1. give packets from eth0 a delay of 2ms</div><div class="line"><span class="meta">bash$</span> tc qdisc add dev eth0 root netem delay 2ms</div><div class="line"> </div><div class="line">2.change the delay to 300ms</div><div class="line"><span class="meta">bash$</span> tc qdisc change dev eth0 root netem delay 3ms</div><div class="line"></div><div class="line">3.display eth0 delay setting</div><div class="line"><span class="meta">bash$</span> tc qdisc show dev eth0</div><div class="line"> </div><div class="line">4.stop the delay</div><div class="line"><span class="meta">bash$</span> tc qdisc del dev eth0 root</div><div class="line"><span class="meta"></span></div><div class="line">#corrupt</div><div class="line">The following rule corrupts 5% of the packets by introducing single bit error at a random offset in the packet:</div><div class="line">tc qdisc change dev eth0 root netem corrupt 5%</div></pre></td></tr></table></figure>
<h2 id="模拟网络丢包"><a href="#模拟网络丢包" class="headerlink" title="模拟网络丢包"></a>模拟网络丢包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc qdisc add dev eth0 root netem loss 1%</div></pre></td></tr></table></figure>
<p>指定ip 172.31.65.30延时17ms， 测试发现181和183这两句命令顺序无所谓。恢复正常：179行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">179  tc qdisc del dev eth0 root</div><div class="line">180  tc qdisc add dev eth0 root handle 1: prio</div><div class="line">181  tc filter add dev eth0 parent 1:0 protocol ip pref 55 handle ::55 u32 match ip dst 172.31.65.30 flowid 2:1</div><div class="line">182  tc qdisc ls</div><div class="line">183  tc qdisc add dev eth0 parent 1:1 handle 2: netem delay 17ms</div></pre></td></tr></table></figure>
<h2 id="指定ip和端口延时"><a href="#指定ip和端口延时" class="headerlink" title="指定ip和端口延时"></a>指定ip和端口延时</h2><p>指定 eth0 网卡，来源 ip 是 10.0.1.1，目的端口是 3306 的访问延迟 20ms，上下浮动 2ms </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># 指定 eth0 网卡，来源 ip 是 10.0.1.1，目的端口是 3306 的访问延迟 20ms，上下浮动 2ms</div><div class="line">tc qdisc add dev eth0 root handle 1: prio bands 4</div><div class="line">tc qdisc add dev eth0 parent 1:4 handle 40: netem delay 20ms 2ms</div><div class="line">tc filter add dev eth0 parent 1: protocol ip prio 4 basic match &quot;cmp(u16 at 2 layer transport eq 3306)</div><div class="line">                            and cmp(u8 at 16 layer network eq 10)</div><div class="line">                            and cmp(u8 at 17 layer network eq 0)</div><div class="line">                            and cmp(u8 at 18 layer network eq 1)</div><div class="line">                            and cmp(u8 at 19 layer network eq 1)&quot; flowid 1:4</div><div class="line">                            </div><div class="line"># 删除过滤</div><div class="line">sudo tc filter del dev eth0 parent 1: prio 4 basic</div><div class="line">sudo tc qdisc  del dev eth0 root</div></pre></td></tr></table></figure>
<p>0 layer 代表 sport<br>2 layer 代表 dport</p>
<h2 id="指定端口34001上，延时5ms"><a href="#指定端口34001上，延时5ms" class="headerlink" title="指定端口34001上，延时5ms"></a>指定端口34001上，延时5ms</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tc qdisc add dev eth0 root handle 1: prio</div><div class="line">tc qdisc add dev eth0 parent 1:3 handle 30: netem delay 5ms</div><div class="line">tc filter add dev eth0 protocol ip parent 1:0 u32 match ip sport 34001 0xffff flowid 1:3</div></pre></td></tr></table></figure>
<h2 id="控制eth0网卡的带宽、延时、乱序、丢包"><a href="#控制eth0网卡的带宽、延时、乱序、丢包" class="headerlink" title="控制eth0网卡的带宽、延时、乱序、丢包"></a>控制eth0网卡的带宽、延时、乱序、丢包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">sudo tc qdisc add dev bond0 root handle 1: netem delay 10ms reorder 25% 50% loss 0.2%</div><div class="line">sudo tc qdisc add dev bond0 parent 1: handle 2: tbf rate 1mbit burst 32kbit latency 10ms</div><div class="line"></div><div class="line">/sbin/tc qdisc add dev eth0 root tbf rate 500kbit latency 50ms burst 15kb</div><div class="line"></div><div class="line">// 同时模拟20Mbps带宽，50msRTT和0.1%丢包率  </div><div class="line"><span class="meta">#</span> tc qdisc add dev eth5 root handle 1:0 tbf rate 20mbit burst 10kb limit 300000  </div><div class="line"><span class="meta">#</span> tc qdisc add dev eth5 parent 1:0 handle 10:0 netem delay 50ms loss 0.1 limit 300000 </div><div class="line"></div><div class="line">tc qdisc change dev eth0 root netem reorder 50% gap 3 delay 1ms</div><div class="line">tc qdisc change dev eth0 root netem delay 1ms reorder 15%</div><div class="line"></div><div class="line"></div><div class="line">//在eth0上设置一个tbf队列，网络带宽为200kbit，延迟10ms以内，超出的包会被drop掉，缓冲区为1540个字节</div><div class="line">sudo /sbin/tc qdisc add dev eth0 root tbf rate 200kbit latency 10ms burst 15kb</div><div class="line">sudo /sbin/tc qdisc ls dev eth0</div></pre></td></tr></table></figure>
<p>在eth0上设置一个tbf队列，网络带宽为200kbit，延迟10ms以内，超出的包会被drop掉，缓冲区为1540个字节<br>rate表示令牌的产生速率, <em>sustained maximum rate</em><br>latency表示数据包在队列中的最长等待时间, <em>packets with higher latency get dropped</em><br>burst参数表示  maximum allowed burst：<br>  burst means the maximum amount of bytes that tokens can be available for instantaneously.<br>  如果数据包的到达速率与令牌的产生速率一致，即200kbit，则数据不会排队，令牌也不会剩余<br>  如果数据包的到达速率小于令牌的产生速率，则令牌会有一定的剩余。<br>  如果后续某一会数据包的到达速率超过了令牌的产生速率，则可以一次性的消耗一定量的令牌。<br>  burst就是用于限制这“一次性”消耗的令牌的数量的，以字节数为单位。</p>
<p>tbf: <em>use</em> the <em>token buffer filter to manipulate traffic rates</em></p>
<p>限制10MB，排队等待超过100ms就触发丢包，只限制了出去的流量，没有限制进来的流量:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tc qdisc ls dev eth0 // 查看eth0上的队列规则  </div><div class="line">sudo tc qdisc add dev eth0 root tbf rate 80mbit burst 1mbit latency 100ms </div><div class="line"></div><div class="line">//限制80MB</div><div class="line">sudo tc qdisc add dev eth0 root tbf rate 80mbps burst 1mbps latency 100ms</div></pre></td></tr></table></figure>
<p>或者：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//Server: 4 Mbit 50 ms</div><div class="line">tc qdisc add dev eth0 handle 1: root htb default 11</div><div class="line">tc class add dev eth0 parent 1: classid 1:1 htb rate 1000Mbps</div><div class="line">tc class add dev eth0 parent 1:1 classid 1:11 htb rate 4Mbit</div><div class="line">tc qdisc add dev eth0 parent 1:11 handle 10: netem delay 50ms</div><div class="line"></div><div class="line">//Client: 512 kbit 50 ms</div><div class="line">tc qdisc add dev vmnet1 handle 1: root htb default 11</div><div class="line">tc class add dev vmnet1 parent 1: classid 1:1 htb rate 1000Mbps</div><div class="line">tc class add dev vmnet1 parent 1:1 classid 1:11 htb rate 512kbit</div><div class="line">tc qdisc add dev vmnet1 parent 1:11 handle 10: netem delay 50ms</div></pre></td></tr></table></figure>
<h2 id="qdisc的类别"><a href="#qdisc的类别" class="headerlink" title="qdisc的类别"></a><a href="https://cloud.tencent.com/developer/article/1409664" target="_blank" rel="external">qdisc的类别</a></h2><p>QDisc(排队规则)是queueing discipline的简写，它是理解流量控制(traffic control)的基础。无论何时，内核如果需要通过某个网络接口发送数据包，它都需要按照为这个接口配置的qdisc(排队规则)把数据包加入队列。然后，内核会尽可能多地从qdisc里面取出数据包，把它们交给网络适配器驱动模块。最简单的QDisc是pfifo它不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列。不过，它会保存网络接口一时无法处理的数据包。</p>
<ul>
<li><p>CLASSLESS QDisc(不可分类QDisc)</p>
<ul>
<li>[p|b]fifo： 使用最简单的qdisc，纯粹的先进先出。只有一个参数：limit，用来设置队列的长度,pfifo是以数据包的个数为单位；bfifo是以字节数为单位。</li>
<li>pfifo_fast： 在编译内核时，如果打开了高级路由器(Advanced Router)编译选项，pfifo_fast就是系统的标准QDISC。它的队列包括三个波段(band)。在每个波段里面，使用先进先出规则。而三个波段(band)的优先级也不相同，band 0的优先级最高，band 2的最低。如果band0里面有数据包，系统就不会处理band 1里面的数据包，band 1和band 2之间也是一样。数据包是按照服务类型(Type of Service,TOS)被分配多三个波段(band)里面的。</li>
<li>red： red是Random Early Detection(随机早期探测)的简写。如果使用这种QDISC，当带宽的占用接近于规定的带宽时，系统会随机地丢弃一些数据包。它非常适合高带宽应用。</li>
<li>sfq： sfq是Stochastic Fairness Queueing的简写。它按照会话(session–对应于每个TCP连接或者UDP流)为流量进行排序，然后循环发送每个会话的数据包。</li>
<li>tbf： tbf是Token Bucket Filter的简写，适合于把流速降低到某个值。</li>
</ul>
</li>
</ul>
<p>一个网络接口上如果没有设置QDisc，pfifo_fast就作为缺省的QDisc。</p>
<p>CLASSFUL QDISC(分类QDisc)，可分类的qdisc包括： </p>
<ul>
<li>CBQ： CBQ是Class Based Queueing(基于类别排队)的缩写。它实现了一个丰富的连接共享类别结构，既有限制(shaping)带宽的能力，也具有带宽优先级管理的能力。带宽限制是通过计算连接的空闲时间完成的。空闲时间的计算标准是数据包离队事件的频率和下层连接(数据链路层)的带宽。</li>
<li>HTB： HTB是Hierarchy Token Bucket的缩写。通过在实践基础上的改进，它实现了一个丰富的连接共享类别体系。使用HTB可以很容易地保证每个类别的带宽，它也允许特定的类可以突破带宽上限，占用别的类的带宽。HTB可以通过TBF(Token Bucket Filter)实现带宽限制，也能够划分类别的优先级。</li>
<li>PRIO： PRIO QDisc不能限制带宽，因为属于不同类别的数据包是顺序离队的。使用PRIO QDisc可以很容易对流量进行优先级管理，只有属于高优先级类别的数据包全部发送完毕，才会发送属于低优先级类别的数据包。为了方便管理，需要使用iptables或者ipchains处理数据包的服务类型(Type Of Service,ToS)。</li>
</ul>
<h3 id="htb分类-qdisc"><a href="#htb分类-qdisc" class="headerlink" title="htb分类 qdisc"></a>htb分类 qdisc</h3><p>tbf能对流量无差别控制，htb可以进一步进行更精细的控制</p>
<h4 id="针对IP、端口限速案例"><a href="#针对IP、端口限速案例" class="headerlink" title="针对IP、端口限速案例"></a>针对IP、端口限速案例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span>cat qdisc_bw.sh</div><div class="line"><span class="meta">#</span>!/bin/bash</div><div class="line"><span class="meta">#</span>针对不同的ip进行限速</div><div class="line"><span class="meta"></span></div><div class="line">#清空原有规则</div><div class="line">tc qdisc del dev eth0 root</div><div class="line"><span class="meta"></span></div><div class="line">#创建根序列</div><div class="line">tc qdisc add dev eth0 root handle 1: htb default 1</div><div class="line"><span class="meta"></span></div><div class="line">#创建一个主分类绑定所有带宽资源（60M）</div><div class="line">tc class add dev eth0 parent 1:0 classid 1:1 htb rate 60Mbps burst 15k</div><div class="line"><span class="meta">#</span>到这里可以使用了，整机速度限制到了60M</div><div class="line"><span class="meta"></span></div><div class="line">#创建子分类，ceil表示最大带宽</div><div class="line">tc class add dev eth0 parent 1:1 classid 1:10 htb rate 2Mbps ceil 1Mbps burst 15k</div><div class="line">tc class add dev eth0 parent 1:1 classid 1:20 htb rate 20Mbps ceil 30Mbps burst 15k</div><div class="line"><span class="meta"></span></div><div class="line">#为了避免一个会话永占带宽,添加随即公平队列sfq.</div><div class="line"><span class="meta">#</span>perturb：是多少秒后重新配置一次散列算法，默认为10秒</div><div class="line"><span class="meta">#</span>sfq,他可以防止一个段内的一个ip占用整个带宽</div><div class="line">tc qdisc add dev eth0 parent 1:10 handle 10: sfq perturb 10</div><div class="line">tc qdisc add dev eth0 parent 1:20 handle 20: sfq perturb 10</div><div class="line"><span class="meta"></span></div><div class="line">#创建过滤器</div><div class="line"><span class="meta">#</span>对所有ip限速到1Mbps</div><div class="line">tc filter add dev eth0 protocol ip parent 1:0 prio 2 u32 match ip dst 0.0.0.0/0 flowid 1:10</div><div class="line"><span class="meta">#</span>对10.0.186.140限速在30Mbps</div><div class="line">tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip dst 10.0.186.140 flowid 1:20</div><div class="line"><span class="meta"></span></div><div class="line">#对端口进行filter限流</div><div class="line"><span class="meta">#</span>tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip sport 22 flowid 1:10</div><div class="line"><span class="meta"></span></div><div class="line">#查看以上规则</div><div class="line">sudo tc class show dev eth0</div><div class="line">sudo tc filter show dev eth0</div></pre></td></tr></table></figure>
<p>限流100MB后的实际监控效果</p>
<p><img src="/images/951413iMgBlog/image-20211031205539407.png" alt="image-20211031205539407"></p>
<h2 id="docker-中使用-tc"><a href="#docker-中使用-tc" class="headerlink" title="docker 中使用 tc"></a>docker 中使用 tc</h2><p>docker里无法使用的bug 可以参考 <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1152231，解决方法就是升级tc版本，tc" target="_blank" rel="external">https://bugzilla.redhat.com/show_bug.cgi?id=1152231，解决方法就是升级tc版本，tc</a> qdisc add 时加上direct_qlen参数</p>
<h3 id="场景："><a href="#场景：" class="headerlink" title="场景："></a>场景：</h3><p>故障注入的docker: 10.1.1.149</p>
<p>10.1.1.149上会模拟各种网络故障，但是中控机到该docker的连接需要不受影响</p>
<p>DEVICE_NAME=eth0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"># 根规则，direct_qlen 1000必须加，否则在docker的虚拟网络跑不了</div><div class="line">tc qdisc add dev $&#123;DEVICE_NAME&#125; root handle 1: htb  default 1024 direct_qlen 1000</div><div class="line"></div><div class="line"></div><div class="line"># 建立两个类继承root</div><div class="line">tc class add dev $&#123;DEVICE_NAME&#125; parent 1:0 classid 1:1 htb rate 10000mbit</div><div class="line">tc class add dev $&#123;DEVICE_NAME&#125; parent 1:0 classid 1:2 htb rate 10000mbit</div><div class="line"></div><div class="line"></div><div class="line">#新版本的tc在filter设置完后，所有网络都会断，类似黑名单，需要加qdisc才能恢复, 所以先让两个通道都能跑</div><div class="line"># 队列采用公平的调度算法，保证网络通畅，perturb参数是每隔10秒换一次hash，进一步保障平均</div><div class="line">tc qdisc add dev $&#123;DEVICE_NAME&#125; parent 1:1 sfq perturb 10</div><div class="line">tc qdisc add dev $&#123;DEVICE_NAME&#125; parent 1:2 sfq perturb 10</div><div class="line"></div><div class="line"></div><div class="line"># 加过滤规则</div><div class="line">#1.队列1是和跳板机交互的网络，需要保持通畅</div><div class="line">tc filter add dev $&#123;DEVICE_NAME&#125; protocol ip parent 1: prio 10 u32 match ip dst 11.136.106.200/32 flowid 1:1</div><div class="line"></div><div class="line"></div><div class="line">#2.其他所有主机走队列2，实现网络模拟</div><div class="line">tc filter add dev $&#123;DEVICE_NAME&#125; protocol ip parent 1: prio 10 u32 match ip dst 0.0.0.0/0 flowid 1:2</div><div class="line"></div><div class="line">#队列2 开始网络模拟</div><div class="line">#该命令将$&#123;DEVICE_NAME&#125;网卡的耗时随机delay 100ms，延迟的尖刺在标准值的正负30ms, 最后的百分比数字是尖刺的相关系数</div><div class="line"></div><div class="line"># 这边用replace是因为之前已经用add加过规则了</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 netem delay 100ms 30ms 25%</div><div class="line"></div><div class="line"></div><div class="line">#该命令将 $&#123;DEVICE_NAME&#125; 网卡的传输设置为随机丢掉10%的数据包, 成功率为50%</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 netem loss 10% 50%</div><div class="line"></div><div class="line"></div><div class="line">#该命令将 $&#123;DEVICE_NAME&#125; 网卡的传输设置为随机产生10%的重复数据包。</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 netem duplicate 10%</div><div class="line"></div><div class="line"></div><div class="line">#该命令将 $&#123;DEVICE_NAME&#125; 网卡的传输设置为:有25%的数据包会被立即发送,其他的延迟10ms,相关性是10%,产生乱序</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 netem delay 10ms reorder 25% 10% </div><div class="line"></div><div class="line"></div><div class="line">#该命令将 $&#123;DEVICE_NAME&#125; 网卡的传输设置为随机产生9%的损坏的数据包</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 netem corrupt 9%</div></pre></td></tr></table></figure>
<p>恢复网络</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#让网络恢复正常</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 sfq perturb 10</div><div class="line"></div><div class="line"># =================== 查看规则 ======================</div><div class="line">tc filter show dev $&#123;DEVICE_NAME&#125;</div><div class="line">tc class show dev $&#123;DEVICE_NAME&#125;</div><div class="line">tc qdisc show dev $&#123;DEVICE_NAME&#125;</div><div class="line"></div><div class="line">#====================== 清理 ======================</div><div class="line">tc filter delete dev $&#123;DEVICE_NAME&#125; parent 1:0 protocol ip pref 10</div><div class="line">tc qdisc del dev $&#123;DEVICE_NAME&#125; parent 1:2 netem</div><div class="line">tc class del dev $&#123;DEVICE_NAME&#125; parent 1:0 classid 1:2</div><div class="line">tc class del dev $&#123;DEVICE_NAME&#125; parent 1:0 classid 1:1</div><div class="line">tc qdisc del dev $&#123;DEVICE_NAME&#125; root handle 1</div></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/" target="_blank" rel="external">https://netbeez.net/blog/how-to-use-the-linux-traffic-control/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2016/03/24/ansible 使用手册/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weibo @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/24/ansible 使用手册/" itemprop="url">ansible 手册</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-24T17:30:03+08:00">
                2016-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ansible/" itemprop="url" rel="index">
                    <span itemprop="name">Ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ansible-手册"><a href="#ansible-手册" class="headerlink" title="ansible 手册"></a>ansible 手册</h1><h2 id="获取模块信息"><a href="#获取模块信息" class="headerlink" title="获取模块信息"></a>获取模块信息</h2><p>-<br>获取所有模块信息，100多个</p>
<ul>
<li>ansible-doc -l</li>
</ul>
<p>获取每个模块的具体信息 </p>
<ul>
<li><p>ansible-doc<br>example：ansible-doc ping</p>
<p>   PING</p>
<p>   A trivial test module, this module always returns <code>pong&#39; on
   successful contact. It does not make sense in playbooks, but it is
   useful from</code>/usr/bin/udp’</p>
<p> EXAMPLES:<br> Test ‘webservers’ status</p>
<p> udp webservers -m ping</p>
</li>
</ul>
<h2 id="嵌套执行命令roles"><a href="#嵌套执行命令roles" class="headerlink" title="嵌套执行命令roles"></a>嵌套执行命令roles</h2><pre><code>- name: create jdk home
  file: path={{ remote_jdk_home }} state=directory mode=0755

- name: xxxxxxxxx
  include: ../../init/tasks/main.yml
</code></pre><h2 id="defaults-中变量定义"><a href="#defaults-中变量定义" class="headerlink" title="defaults 中变量定义"></a>defaults 中变量定义</h2><pre><code>1：加双引号；2：变量名和变量之间，有空格；
diamond_db_key: &quot;{{ diamond_db_ip }}_{{ diamond_db_name }}_dbkey&quot;
manager_user1: &quot;{{ manager_user_name }}&quot;
</code></pre><h1 id="tags"><a href="#tags" class="headerlink" title="tags"></a>tags</h1><p>相同的tasks在不同的环境下面执行，通过tag来进行表面，如下图：</p>
<pre><code>  useage: 
    udp-playbook setup.yml -v -kK -i hosts.ini --tags &quot;ta&quot;

- name: 1
  authorized_key: user={{ ansible_ssh_user }}  key=&quot;{{ lookup('file', '~/.ssh/id_rsa.pub') }}&quot;  state=present
  tags: ta

- name: 2
  group: name={{ remote_user }}
  tags: always

- name: 3
  file: path={{ remote_home }} owner={{ remote_user }} group={{ remote_user }} state=directory recurse=yes mode=0755
  tags: tb
</code></pre><h2 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h2><p>ansible 中 scp scp: ambiguous target 错误还是因为ssh 增加了 -t 参数, scp不支持 -t 参数</p>
<h2 id="disable-python-warning"><a href="#disable-python-warning" class="headerlink" title="disable python warning"></a><a href="https://docs.ansible.com/ansible/latest/reference_appendices/interpreter_discovery.html" target="_blank" rel="external">disable python warning</a></h2><p>To control the discovery behavior:</p>
<ul>
<li>for individual hosts and groups, use the <code>ansible_python_interpreter</code> inventory variable</li>
<li>globally, use the <code>interpreter_python</code> key in the <code>[defaults]</code> section of <code>ansible.cfg</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[defaults]</div><div class="line">interpreter_python=auto_silent</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2016/03/24/ansible 常见问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weibo @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/24/ansible 常见问题/" itemprop="url">ansible 常见问题</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-24T17:30:03+08:00">
                2016-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ansible/" itemprop="url" rel="index">
                    <span itemprop="name">Ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ansible-常见问题"><a href="#ansible-常见问题" class="headerlink" title="ansible 常见问题"></a>ansible 常见问题</h1><h2 id="获取模块信息"><a href="#获取模块信息" class="headerlink" title="获取模块信息"></a>获取模块信息</h2><p>-<br>获取所有模块信息，100多个</p>
<ul>
<li>ansible-doc -l</li>
</ul>
<p>获取每个模块的具体信息 </p>
<ul>
<li><p>ansible-doc<br>example：ansible-doc ping</p>
<p>   PING</p>
<p>   A trivial test module, this module always returns <code>pong&#39; on
   successful contact. It does not make sense in playbooks, but it is
   useful from</code>/usr/bin/udp’</p>
<p> EXAMPLES:<br> Test ‘webservers’ status</p>
<p> udp webservers -m ping</p>
</li>
</ul>
<h2 id="嵌套执行命令roles"><a href="#嵌套执行命令roles" class="headerlink" title="嵌套执行命令roles"></a>嵌套执行命令roles</h2><pre><code>- name: create jdk home
  file: path={{ remote_jdk_home }} state=directory mode=0755

- name: xxxxxxxxx
  include: ../../init/tasks/main.yml
</code></pre><h2 id="defaults-中变量定义"><a href="#defaults-中变量定义" class="headerlink" title="defaults 中变量定义"></a>defaults 中变量定义</h2><pre><code>1：加双引号；2：变量名和变量之间，有空格；
diamond_db_key: &quot;{{ diamond_db_ip }}_{{ diamond_db_name }}_dbkey&quot;
manager_user1: &quot;{{ manager_user_name }}&quot;
</code></pre><h1 id="tags"><a href="#tags" class="headerlink" title="tags"></a>tags</h1><p>相同的tasks在不同的环境下面执行，通过tag来进行表面，如下图：</p>
<pre><code>  useage: 
    udp-playbook setup.yml -v -kK -i hosts.ini --tags &quot;ta&quot;

- name: 1
  authorized_key: user={{ ansible_ssh_user }}  key=&quot;{{ lookup('file', '~/.ssh/id_rsa.pub') }}&quot;  state=present
  tags: ta

- name: 2
  group: name={{ remote_user }}
  tags: always

- name: 3
  file: path={{ remote_home }} owner={{ remote_user }} group={{ remote_user }} state=directory recurse=yes mode=0755
  tags: tb
</code></pre><h2 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h2><p>ansible 中 scp scp: ambiguous target 错误还是因为ssh 增加了 -t 参数, scp不支持 -t 参数</p>
<h2 id="disable-python-warning"><a href="#disable-python-warning" class="headerlink" title="disable python warning"></a><a href="https://docs.ansible.com/ansible/latest/reference_appendices/interpreter_discovery.html" target="_blank" rel="external">disable python warning</a></h2><p>To control the discovery behavior:</p>
<ul>
<li>for individual hosts and groups, use the <code>ansible_python_interpreter</code> inventory variable</li>
<li>globally, use the <code>interpreter_python</code> key in the <code>[defaults]</code> section of <code>ansible.cfg</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[defaults]</div><div class="line">interpreter_python=auto_silent</div></pre></td></tr></table></figure>
<h3 id="其它常见错误"><a href="#其它常见错误" class="headerlink" title="其它常见错误"></a>其它常见错误</h3><table>
<thead>
<tr>
<th>问题</th>
<th>解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td>性能</td>
<td>ansible现在并发执行的任务好像还不够，执行批量传大文件的任务等的比较久 — 用 synchronize  并将 fork 默认的5改大</td>
</tr>
<tr>
<td>sudoers</td>
<td>尝试解决ansible不能执行的问题，搜索各种英文文档，有人说版本的原因，有人反馈是脚本错误，最终无解。 继续在本地进行测试，发现使用原始的ansible命令可以执行ls，但是sudo ls时会提示 sudo need tty 之类的报错。 定位这个错误是因为在/etc/sudoers文件中设置了  Defaults requiretty，修改为 #Defaults requiretty，重试发现问题解决。 手工修改所有机器的配置文件，问题解决。{“msg”: “ssh connection closed waiting for a privilege escalation password prompt”}—实际在部分机器上执行ansible命令时仍然有：sudo: no tty present and no askpass program specified  可以给ssh 增加-t/-tt参数来强制分配一个tty</td>
</tr>
<tr>
<td>failed to transfer file to  xxx</td>
<td>远端机器磁盘已经满,查看df -h，特别是/tmp</td>
</tr>
<tr>
<td>requires a json module, none found</td>
<td>问题已经通过nginx进行解决部署,安装ansible的时候，在目标机器上面安装 python-simplejson 通过如下命令：yum install python-simplejson -y</td>
</tr>
<tr>
<td>openssh升级后无法登录报错</td>
<td>sshrpm 升级后会修改/etc/pam.d/sshd 文件。需要升级前备份此文件最后还原即可登录。</td>
</tr>
<tr>
<td>安装EagleEye出现的问题</td>
<td>1.hadoop name -format 这个需要输入Y/N；2.ssh-key没搞定；3.我们原来可以for循环的地方，古谦脚本只能1条1条的加</td>
</tr>
<tr>
<td>使用lineinfile方法时，内容不能包含”: “(冒号+空格)，这个与ansible底层的分隔符冲突；</td>
<td>让用户在内容中不要包含”: “</td>
</tr>
<tr>
<td>https 相关</td>
<td>SSL validation is not available in your version of python. You can use validate_certs=no, however this is unsafe and not recommended. You can also install python-ssl from EPEL</td>
</tr>
<tr>
<td>You need a C++ compiler for C++ support</td>
<td>yum install -y gcc gcc-c++</td>
</tr>
<tr>
<td>１：udp权限问题，有时候会出现权限认证失败；２：udp如何执行本地命令；　３：udp线上有什么方便的安装方法</td>
<td>问题1:方法一 去掉sudo试试（报访问文件 /opt/aliUDP/logs/udp.log 失败，备份重新建一个udp.log 文件给于 777 权限）; 方法二 指定 –private-key=PRIVATE_KEY_FILE （先试试直接ssh登录某台目标机器行不行）  问题2：udp支持直接运行目标机器上的命令，用法：udp server  -i ~/ali/udp-roles/roles/udp-install/udp-hosts.ini  -m shell -a “ uptime ; df -lh “ -u admin</td>
</tr>
<tr>
<td>同一个ip部署不同的工程时，定义的变量会冲突；例如ip1同时部署mysql和diamond，都定义project_name；这样上面的会生效，下面定义的会被冲掉</td>
<td>Wiki：<a href="http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Different_Hosts_With_Different_Variables" target="_blank" rel="external">http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Different_Hosts_With_Different_Variables</a>  将变量分别定义在 ./roles/mysql/defaults/main.yml 和 ./roles/diamond/defaults/main.yml中 或者使用不同的变量名</td>
</tr>
<tr>
<td>执行udp-play-book 时会报找不到key的问题</td>
<td>在udp机器上执行 ssh-keygen 来生成key，解决</td>
</tr>
<tr>
<td>ssh 的时候需要手工 yes/no</td>
<td>增加参数 -o StrictHostKeyChecking no 就不需要输入了</td>
</tr>
<tr>
<td>防火墙问题，本地可以访问，远程不能</td>
<td>通过抓包/telnet等方式来确认这个问题， 通过iptables stop 来临时关闭防火墙； 修改iptables 的配置永久关闭或者增加所有其它节点到白名单中</td>
</tr>
<tr>
<td></td>
<td>重要！ hostname -i 一定要是本机在局域网内的真实ip地址（不是127.0.0.1 ）。  要绑定etc/hosts 下面 把自己的hostname绑定到对应的真实ip上。</td>
</tr>
<tr>
<td>在UDP PlayBook中如何定义不同的机器、不同的Role使用不同的变量</td>
<td><a href="http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Different_Hosts_With_Different_Variables" target="_blank" rel="external">http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Different_Hosts_With_Different_Variables</a></td>
</tr>
<tr>
<td>Dauth部署问题总结</td>
<td><a href="http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Dauth-UDP-deployment-issues" target="_blank" rel="external">http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Dauth-UDP-deployment-issues</a></td>
</tr>
<tr>
<td>Device or resource busy</td>
<td>一般出现在Docker中修改/etc/hosts会有这个问题，ansible会rm它，实际它是-v进去的，通过脚本补丁绕过去</td>
</tr>
</tbody>
</table>
<p>ansible 中 scp scp: ambiguous target 错误还是因为ssh 增加了 -t 参数, scp不支持 -t 参数</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2016/03/24/ansible 命令通道使用手册/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weibo @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/24/ansible 命令通道使用手册/" itemprop="url">ansible 命令使用手册</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-24T17:30:03+08:00">
                2016-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ansible/" itemprop="url" rel="index">
                    <span itemprop="name">Ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ansible-命令使用手册"><a href="#ansible-命令使用手册" class="headerlink" title="ansible 命令使用手册"></a>ansible 命令使用手册</h1><h2 id="什么是命令通道？"><a href="#什么是命令通道？" class="headerlink" title="什么是命令通道？"></a>什么是命令通道？</h2><p>有时候一些简单任务，没必要写复杂的playbook，所以大多时候我们可以通过ansible命令行来批量操控目标机器</p>
<blockquote>
<p>当我们需要批量操作、查看一组机器，或者在这些机器上批量执行某个命令、修改某个文件，都可以通过命令通道在一台机器上批量并发完成对所有机器的操作</p>
<p>命令通道只是一个帮你将命令发送到多个目标机器，并将执行结果返回来给你的一个执行通道</p>
</blockquote>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li>执行一行命令就能看到几十台机器的负载情况</li>
<li>批量执行远程服务器上已经写好的Shell脚本</li>
<li>查看所有Web服务器最近10000行Log中有没有ERROR</li>
<li>查看所有DB服务器的内存使用情况</li>
<li>批量将所有Diamond服务器的某个端口从7000改成9000</li>
</ul>
<h2 id="开始准备"><a href="#开始准备" class="headerlink" title="开始准备"></a>开始准备</h2><blockquote>
<p>如果不想每次输入ssh密码的话请提前将本地公钥(~/.ssh/id_rsa.pub 没有的话 ssh-keygen生成一对)复制到目标机器的 ~/.ssh/authorized_keys 里面，否则每次执行命令都要输入密码</p>
</blockquote>
<h3 id="编写一个-hosts-ini-配置文件，内容如下"><a href="#编写一个-hosts-ini-配置文件，内容如下" class="headerlink" title="编写一个 hosts.ini 配置文件，内容如下:"></a>编写一个 hosts.ini 配置文件，内容如下:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[server]</div><div class="line">10.125.0.169 ansible_ssh_port=9999 #如果只有这台机器ssh走的是9999端口，其它没有设置的还是默认22端口</div><div class="line">10.125.3.33</div><div class="line">120.26.116.193  </div><div class="line"></div><div class="line">[worker]</div><div class="line">10.125.12.174</div><div class="line">10.125.14.238</div><div class="line"></div><div class="line">[target]</div><div class="line">10.125.192.40 </div><div class="line">10.125.7.151</div><div class="line">192.168.2.[101:107]</div></pre></td></tr></table></figure>
<p>server/worker/target表示将7台机器分成了三组，可以到所有7台机器执行同一个命令，也可以只在server/worker/target中的一组机器上执行某个命令.all代表所有7台机器</p>
<h2 id="运行命令行"><a href="#运行命令行" class="headerlink" title="运行命令行"></a>运行命令行</h2><h3 id="查看-hosts-ini-里面所有服务器的-uptime"><a href="#查看-hosts-ini-里面所有服务器的-uptime" class="headerlink" title="查看 hosts.ini 里面所有服务器的 uptime"></a>查看 hosts.ini 里面所有服务器的 uptime</h3><pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">	$ ansible -i hosts.ini all -m raw -a &quot; uptime  &quot; -u admin</div><div class="line">	/usr/bin/ansible -i hosts.ini all -m raw -a  uptime   -u admin</div><div class="line">	</div><div class="line">	success =&gt; 10.125.12.174 =&gt; rc=0 =&gt;</div><div class="line">	 11:10:50 up 27 days, 15:40,  1 user,  load average: 0.05, 0.03, 0.05</div><div class="line">	success =&gt; 120.26.116.193 =&gt; rc=0 =&gt;</div><div class="line">	 11:10:50 up 13 days, 21:07,  1 user,  load average: 0.00, 0.00, 0.00</div><div class="line"></div><div class="line">命令参数说明</div><div class="line"></div><div class="line">&gt;    __all:__  表示对hosts.ini里面的所有服务器执行后面的命令 </div><div class="line"></div><div class="line">&gt;    __-i:__   指定hosts.ini文件所在的位置</div><div class="line"></div><div class="line">&gt;    __-m raw -a:__ 指定需要执行的命令</div><div class="line"></div><div class="line">&gt;    __&quot; uptime &quot;__ 双引号里面写上需要执行的命令</div><div class="line"></div><div class="line">&gt;    __-u admin__ 表示通过用户名admin 去执行命令【如果没有做好免密码，请加上 -k 参数，会出来提示输入SSH密码】</div><div class="line"></div><div class="line"></div><div class="line">### 查看 hosts.ini 里面 server 组服务器的 home目录下的文件结构</div><div class="line">	$ ansible -i hosts.ini server -m raw -a &quot; ls -lh ~/  &quot; -u admin</div><div class="line">	</div><div class="line">	/usr/bin/ansible -i hosts.ini server -m raw -a  ls -lh ~/   -u admin</div><div class="line">	</div><div class="line">	success =&gt; 10.125.0.169 =&gt; rc=0 =&gt;</div><div class="line">	total 12K</div><div class="line">	drwxr-xr-x  2 root  root  4.0K Nov 13 12:34 files</div><div class="line">	drwxr-xr-x 11 admin admin 4.0K Oct 20 10:49 tomcat</div><div class="line">	drwxr-xr-x  3 test  games 4.0K Nov 18 15:40 ansible-engine</div><div class="line">	success =&gt; 10.125.3.33 =&gt; rc=0 =&gt;</div><div class="line">	total 20K</div><div class="line">	-rw-------  1 admin admin 1.4K Nov 12 13:39 authorized_keys</div><div class="line">	drwxr-xr-x  2 root  root  4.0K Nov 12 16:24 engine</div><div class="line">	drwxr-xr-x  2 root  root  4.0K Nov 13 12:22 files</div><div class="line">	drwxr-xr-x 11 admin admin 4.0K Nov 18 15:43 tomcat</div><div class="line">	drwxr-xr-x  3 test  games 4.0K Nov 18 15:40 ansible-engine</div><div class="line"></div><div class="line">### 查看部分机器 hostname</div></pre></td></tr></table></figure>
</code></pre><h1 id="ansible-i-ccb-test-ini-192-168-2-10-m-shell-a-‘hostname-‘"><a href="#ansible-i-ccb-test-ini-192-168-2-10-m-shell-a-‘hostname-‘" class="headerlink" title="ansible -i ccb_test.ini 192.168.2.10* -m shell -a ‘hostname ‘"></a>ansible -i ccb_test.ini 192.168.2.10* -m shell -a ‘hostname ‘</h1><p>[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details<br>192.168.2.100 | CHANGED | rc=0 &gt;&gt;<br>az2-drds-100<br>192.168.2.106 | CHANGED | rc=0 &gt;&gt;<br>az2-manager-106<br>192.168.2.101 | CHANGED | rc=0 &gt;&gt;<br>az2-alisql-101<br>192.168.2.102 | CHANGED | rc=0 &gt;&gt;<br>az2-alisql-102<br>192.168.2.105 | CHANGED | rc=0 &gt;&gt;<br>az2-alisql-105<br>192.168.2.104 | CHANGED | rc=0 &gt;&gt;<br>az2-alisql-104<br>192.168.2.103 | CHANGED | rc=0 &gt;&gt;<br>az2-alisql-103<br>192.168.2.107 | CHANGED | rc=0 &gt;&gt;<br>az2-manager-107<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### 使用环境变量</div></pre></td></tr></table></figure></p>
<p>#config /etc/hosts<br>ansible -i $1 all -m shell -a  “ sed -i ‘/registry/d’ /etc/hosts “<br>ansible -i $1 all -m shell -a  “ echo ‘    registry’ &gt;/etc/hosts “<br>ansible -i $1 all -m shell -a “ echo ‘ <code>hostname</code>‘ &gt;&gt;/etc/hosts “<br>ansible -i $1 diamond -m shell -a “ echo ‘   jmenv.tbsite.net’ &gt;&gt; /etc/hosts “ -u root<br>//修改机器hostname<br>ansible -i $1 all -m shell -a “ hostnamectl set-hostname=’drds-‘ “ -u root<br>//修改机器hostname -i<br>ansible -i $1 all -m shell -a “ echo ‘  drds-‘ &gt;&gt; /etc/hosts  “ -u root</p>
<p>//hostname 修改机器名</p>
<h1 id="ansible-i-ccb-test-ini-192-168-2-101-m-hostname-a-“-name-az2-alisql-101-“"><a href="#ansible-i-ccb-test-ini-192-168-2-101-m-hostname-a-“-name-az2-alisql-101-“" class="headerlink" title="ansible -i ccb_test.ini 192.168.2.101 -m hostname -a “ name=az2-alisql-101 “"></a>ansible -i ccb_test.ini 192.168.2.101 -m hostname -a “ name=az2-alisql-101 “</h1><p>[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details<br>192.168.2.101 | CHANGED =&gt; {<br>    “ansible_facts”: {<br>        “ansible_domain”: “”,<br>        “ansible_fqdn”: “iZ2ze9aj0re2ggbqa4dgxkZ”,<br>        “ansible_hostname”: “az2-alisql-101”,<br>        “ansible_nodename”: “az2-alisql-101”,<br>        “discovered_interpreter_python”: “/usr/bin/python”<br>    },<br>    “changed”: true,<br>    “name”: “az2-alisql-101”<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### 管理系统service</div><div class="line"></div><div class="line">设置 docker daemon服务重新启动和开机自动启动</div></pre></td></tr></table></figure></p>
<h1 id="ansible-i-ccb-test-ini-192-168-2-101-m-service-a-“-name-docker-enabled-yes-state-restarted-“"><a href="#ansible-i-ccb-test-ini-192-168-2-101-m-service-a-“-name-docker-enabled-yes-state-restarted-“" class="headerlink" title="ansible -i ccb_test.ini 192.168.2.101 -m service -a “ name=docker enabled=yes state=restarted “"></a>ansible -i ccb_test.ini 192.168.2.101 -m service -a “ name=docker enabled=yes state=restarted “</h1><p>[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details<br>192.168.2.101 | CHANGED =&gt; {<br>    “ansible_facts”: {<br>        “discovered_interpreter_python”: “/usr/bin/python”<br>    },<br>    “changed”: true,<br>    “enabled”: true,<br>    “name”: “docker”,<br>    “state”: “started”,<br>    “status”: {<br>        “ActiveEnterTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “ActiveEnterTimestampMonotonic”: “1553024093129”,<br>        “ActiveExitTimestamp”: “二 2020-05-12 19:01:24 CST”,<br>        “ActiveExitTimestampMonotonic”: “1552870910912”,<br>        “ActiveState”: “active”,<br>        “After”: “systemd-journald.socket system.slice docker.socket firewalld.service containerd.service network-online.target basic.target”,<br>        “AllowIsolate”: “no”,<br>        “AmbientCapabilities”: “0”,<br>        “AssertResult”: “yes”,<br>        “AssertTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “AssertTimestampMonotonic”: “1553023902297”,<br>        “Before”: “multi-user.target shutdown.target”,<br>        “BindsTo”: “containerd.service”,<br>        “BlockIOAccounting”: “no”,<br>        “BlockIOWeight”: “18446744073709551615”,<br>        “CPUAccounting”: “no”,<br>        “CPUQuotaPerSecUSec”: “infinity”,<br>        “CPUSchedulingPolicy”: “0”,<br>        “CPUSchedulingPriority”: “0”,<br>        “CPUSchedulingResetOnFork”: “no”,<br>        “CPUShares”: “18446744073709551615”,<br>        “CanIsolate”: “no”,<br>        “CanReload”: “yes”,<br>        “CanStart”: “yes”,<br>        “CanStop”: “yes”,<br>        “CapabilityBoundingSet”: “18446744073709551615”,<br>        “ConditionResult”: “yes”,<br>        “ConditionTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “ConditionTimestampMonotonic”: “1553023902297”,<br>        “Conflicts”: “shutdown.target”,<br>        “ConsistsOf”: “docker.socket”,<br>        “ControlGroup”: “/system.slice/docker.service”,<br>        “ControlPID”: “0”,<br>        “DefaultDependencies”: “yes”,<br>        “Delegate”: “yes”,<br>        “Description”: “Docker Application Container Engine”,<br>        “DevicePolicy”: “auto”,<br>        “Documentation”: “<a href="https://docs.docker.com" target="_blank" rel="external">https://docs.docker.com</a>“,<br>        “ExecMainCode”: “0”,<br>        “ExecMainExitTimestampMonotonic”: “0”,<br>        “ExecMainPID”: “16213”,<br>        “ExecMainStartTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “ExecMainStartTimestampMonotonic”: “1553023907468”,<br>        “ExecMainStatus”: “0”,<br>        “ExecReload”: “{ path=/bin/kill ; argv[]=/bin/kill -s HUP $MAINPID ; ignore_errors=no ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }”,<br>        “ExecStart”: “{ path=/usr/bin/dockerd ; argv[]=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2376 –data-root=/var/lib/docker –log-opt max-size=50m –log-opt max-file=3 –registry-mirror=<a href="https://oqpc6eum.mirror.aliyuncs.com" target="_blank" rel="external">https://oqpc6eum.mirror.aliyuncs.com</a> –containerd=/run/containerd/containerd.sock ; ignore_errors=no ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }”,<br>        “FailureAction”: “none”,<br>        “FileDescriptorStoreMax”: “0”,<br>        “FragmentPath”: “/usr/lib/systemd/system/docker.service”,<br>        “GuessMainPID”: “yes”,<br>        “IOScheduling”: “0”,<br>        “Id”: “docker.service”,<br>        “IgnoreOnIsolate”: “no”,<br>        “IgnoreOnSnapshot”: “no”,<br>        “IgnoreSIGPIPE”: “yes”,<br>        “InactiveEnterTimestamp”: “二 2020-05-12 19:03:43 CST”,<br>        “InactiveEnterTimestampMonotonic”: “1553009791884”,<br>        “InactiveExitTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “InactiveExitTimestampMonotonic”: “1553023907496”,<br>        “JobTimeoutAction”: “none”,<br>        “JobTimeoutUSec”: “0”,<br>        “KillMode”: “process”,<br>        “KillSignal”: “15”,<br>        “LimitAS”: “18446744073709551615”,<br>        “LimitCORE”: “18446744073709551615”,<br>        “LimitCPU”: “18446744073709551615”,<br>        “LimitDATA”: “18446744073709551615”,<br>        “LimitFSIZE”: “18446744073709551615”,<br>        “LimitLOCKS”: “18446744073709551615”,<br>        “LimitMEMLOCK”: “65536”,<br>        “LimitMSGQUEUE”: “819200”,<br>        “LimitNICE”: “0”,<br>        “LimitNOFILE”: “18446744073709551615”,<br>        “LimitNPROC”: “18446744073709551615”,<br>        “LimitRSS”: “18446744073709551615”,<br>        “LimitRTPRIO”: “0”,<br>        “LimitRTTIME”: “18446744073709551615”,<br>        “LimitSIGPENDING”: “379870”,<br>        “LimitSTACK”: “18446744073709551615”,<br>        “LoadState”: “loaded”,<br>        “MainPID”: “16213”,<br>        “MemoryAccounting”: “no”,<br>        “MemoryCurrent”: “58327040”,<br>        “MemoryLimit”: “18446744073709551615”,<br>        “MountFlags”: “0”,<br>        “Names”: “docker.service”,<br>        “NeedDaemonReload”: “no”,<br>        “Nice”: “0”,<br>        “NoNewPrivileges”: “no”,<br>        “NonBlocking”: “no”,<br>        “NotifyAccess”: “main”,<br>        “OOMScoreAdjust”: “0”,<br>        “OnFailureJobMode”: “replace”,<br>        “PermissionsStartOnly”: “no”,<br>        “PrivateDevices”: “no”,<br>        “PrivateNetwork”: “no”,<br>        “PrivateTmp”: “no”,<br>        “ProtectHome”: “no”,<br>        “ProtectSystem”: “no”,<br>        “RefuseManualStart”: “no”,<br>        “RefuseManualStop”: “no”,<br>        “RemainAfterExit”: “no”,<br>        “Requires”: “docker.socket basic.target”,<br>        “Restart”: “always”,<br>        “RestartUSec”: “2s”,<br>        “Result”: “success”,<br>        “RootDirectoryStartOnly”: “no”,<br>        “RuntimeDirectoryMode”: “0755”,<br>        “SameProcessGroup”: “no”,<br>        “SecureBits”: “0”,<br>        “SendSIGHUP”: “no”,<br>        “SendSIGKILL”: “yes”,<br>        “Slice”: “system.slice”,<br>        “StandardError”: “inherit”,<br>        “StandardInput”: “null”,<br>        “StandardOutput”: “journal”,<br>        “StartLimitAction”: “none”,<br>        “StartLimitBurst”: “3”,<br>        “StartLimitInterval”: “60000000”,<br>        “StartupBlockIOWeight”: “18446744073709551615”,<br>        “StartupCPUShares”: “18446744073709551615”,<br>        “StatusErrno”: “0”,<br>        “StopWhenUnneeded”: “no”,<br>        “SubState”: “running”,<br>        “SyslogLevelPrefix”: “yes”,<br>        “SyslogPriority”: “30”,<br>        “SystemCallErrorNumber”: “0”,<br>        “TTYReset”: “no”,<br>        “TTYVHangup”: “no”,<br>        “TTYVTDisallocate”: “no”,<br>        “TasksAccounting”: “no”,<br>        “TasksCurrent”: “58”,<br>        “TasksMax”: “18446744073709551615”,<br>        “TimeoutStartUSec”: “0”,<br>        “TimeoutStopUSec”: “0”,<br>        “TimerSlackNSec”: “50000”,<br>        “Transient”: “no”,<br>        “TriggeredBy”: “docker.socket”,<br>        “Type”: “notify”,<br>        “UMask”: “0022”,<br>        “UnitFilePreset”: “disabled”,<br>        “UnitFileState”: “enabled”,<br>        “WantedBy”: “multi-user.target”,<br>        “Wants”: “network-online.target system.slice”,<br>        “WatchdogTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “WatchdogTimestampMonotonic”: “1553024093096”,<br>        “WatchdogUSec”: “0”<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">### 一次执行多个命令</div></pre></td></tr></table></figure>
<p>$ ansible -i hosts.ini server -m raw -a “ which nc ; find /opt/aliUDP/logs/  “ -u admin</p>
<p>/usr/bin/ansible -i hosts.ini server -m raw -a  which nc ; find /opt/aliUDP/logs/   -u admin</p>
<p>FAILED =&gt; 120.26.116.193 =&gt; rc=1 =&gt;<br>which: no nc in (/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin)<br>find: /opt/aliUDP: No such file or directory</p>
<p>success =&gt; 10.125.3.33 =&gt; rc=0 =&gt;<br>/usr/bin/nc<br>/opt/aliUDP/logs/<br>/opt/aliUDP/logs/ansible.log.bak<br>/opt/aliUDP/logs/ansible.log</p>
<p>success =&gt; 10.125.0.169 =&gt; rc=0 =&gt;<br>/usr/bin/nc<br>/opt/aliUDP/logs/<br>/opt/aliUDP/logs/ansible.log.bak<br>/opt/aliUDP/logs/ansible.log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">结果说明</div><div class="line"></div><div class="line">&gt;   其中  120.26.116.193 上没有命令 nc 和 /opt/aliUDP 文件夹所有执行失败，但是其他两台机器都正常返回了结果</div><div class="line"></div><div class="line">### Copy本地的某个文件到服务器上【前面的例子中都是单独在远程机器上执行的命令】</div></pre></td></tr></table></figure>
<p>$ ansible  -i hosts.ini server  -m copy -a “ src=’~/.ssh/id_rsa.pub’ dest=’/tmp/‘ owner=admin “ -u admin</p>
<p>SUCCESS =&gt; 120.26.116.193 =&gt; {<br>    “changed”: true,<br>    “checksum”: “b12ccf236ab788bbaebd7159c563e97411389c9e”,<br>    “dest”: “/tmp/id_rsa.pub”,<br>    “gid”: 0,<br>    “group”: “root”,<br>    “md5sum”: “b6ba28284ab95aaa0f47602bdab49f46”,<br>    “mode”: “0644”,<br>    “owner”: “root”,<br>    “size”: 392,<br>    “src”: “/root/.ansible/ansible-tmp-1449109886.94-70134064194486/source”,<br>    “state”: “file”,<br>    “uid”: 0<br>}</p>
<p>SUCCESS =&gt; 10.125.0.169 =&gt; {<br>    “changed”: true,<br>    “checksum”: “b12ccf236ab788bbaebd7159c563e97411389c9e”,<br>    “dest”: “/tmp/id_rsa.pub”,<br>    “gid”: 500,<br>    “group”: “admin”,<br>    “md5sum”: “b6ba28284ab95aaa0f47602bdab49f46”,<br>    “mode”: “0664”,<br>    “owner”: “admin”,<br>    “size”: 392,<br>    “src”: “/home/admin/.ansible/ansible-tmp-1449109886.78-98797505042348/source”,<br>    “state”: “file”,<br>    “uid”: 500<br>}</p>
<p>SUCCESS =&gt; 10.125.3.33 =&gt; {<br>    “changed”: true,<br>    “checksum”: “b12ccf236ab788bbaebd7159c563e97411389c9e”,<br>    “dest”: “/tmp/id_rsa.pub”,<br>    “gid”: 500,<br>    “group”: “admin”,<br>    “md5sum”: “b6ba28284ab95aaa0f47602bdab49f46”,<br>    “mode”: “0664”,<br>    “owner”: “admin”,<br>    “size”: 392,<br>    “src”: “/home/admin/.ansible/ansible-tmp-1449109886.81-269249309502640/source”,<br>    “state”: “file”,<br>    “uid”: 500<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">参数说明</div><div class="line"></div><div class="line">&gt;    __-m copy -a:__ 指定这是 **copy** 的命令</div><div class="line">&gt;</div><div class="line">&gt;    __&quot;  src=&apos;~/.ssh/id_rsa.pub&apos; dest=&apos;/tmp/&apos; &quot;__ src表示本地文件 dest表示远程目标位置</div><div class="line"></div><div class="line">### 验证一下刚刚copy上去的文件的MD5值</div></pre></td></tr></table></figure></p>
<p>$ ansible  -i hosts.ini server  -m command -a “ md5sum /tmp/id_rsa.pub “ -u admin</p>
<p>success =&gt; 10.125.0.169 =&gt; rc=0 =&gt;<br>b6ba28284ab95aaa0f47602bdab49f46  /tmp/id_rsa.pub</p>
<p>success =&gt; 10.125.3.33 =&gt; rc=0 =&gt;<br>b6ba28284ab95aaa0f47602bdab49f46  /tmp/id_rsa.pub</p>
<p>success =&gt; 120.26.116.193 =&gt; rc=0 =&gt;<br>b6ba28284ab95aaa0f47602bdab49f46  /tmp/id_rsa.pub<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">结果说明</div><div class="line"></div><div class="line">&gt;   md5都是b6ba28284ab95aaa0f47602bdab49f46 跟本地的一致，说明成功复制到目标机器了</div><div class="line"></div><div class="line">### 执行远程服务器上已经写好的Shell脚本</div></pre></td></tr></table></figure></p>
<p>$ cat test.sh </p>
<p>#/bin/sh</p>
<p>ifconfig | grep ‘inet addr’<br>echo “————-“<br>uptime<br>echo “————-“<br>date</p>
<p>df -lh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">执行结果</div><div class="line"></div><div class="line">```shell</div><div class="line">$ ansible  -i hosts.ini server  -m command -a &quot; sh /tmp/test.sh &quot; -u admin</div><div class="line"></div><div class="line">/usr/bin/ansible -i hosts.ini server -m command -a  sh /tmp/test.sh  -u admin</div><div class="line"></div><div class="line">success =&gt; 10.125.3.33 =&gt; rc=0 =&gt;</div><div class="line">          inet addr:10.125.3.33  Bcast:10.125.15.255  Mask:255.255.240.0</div><div class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</div></pre></td></tr></table></figure></p>
<h3 id="copy个人笔记本的公钥到服务器上，以后从笔记本登录服务器不再需要输入密码"><a href="#copy个人笔记本的公钥到服务器上，以后从笔记本登录服务器不再需要输入密码" class="headerlink" title="copy个人笔记本的公钥到服务器上，以后从笔记本登录服务器不再需要输入密码"></a>copy个人笔记本的公钥到服务器上，以后从笔记本登录服务器不再需要输入密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ansible -i ansible-hosts.ini all -m authorized_key -a &quot; user=xijun.rxj key=\&quot;&#123;&#123; lookup(&apos;file&apos;, &apos;/tmp/id_rsa.pub&apos;) &#125;&#125; \&quot;  &quot; -u xijun.rxj -k</div></pre></td></tr></table></figure>
<h3 id="Copying-files-between-different-folders-on-the-same-remote-machine"><a href="#Copying-files-between-different-folders-on-the-same-remote-machine" class="headerlink" title="Copying files between different folders on the same remote machine"></a>Copying files between different folders on the same remote machine</h3><p>You can also copy files between the various locations on the remote servers. You have to set the <strong>remote_src</strong> parameter to yes.</p>
<p>The following example copies the hello6 file in the /tmp directory of the remote server and pastes it in the /etc/ directory.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- hosts: blocks</div><div class="line">  tasks:</div><div class="line">  - name: Ansible copy files remote to remote</div><div class="line">    copy:</div><div class="line">      src: /tmp/hello6</div><div class="line">      dest: /etc</div><div class="line">      remote_src: yes</div></pre></td></tr></table></figure>
<p>or:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible blocks -m copy -a &quot;src=/tmp/hello6 dest=/tmp/hello7etc remote_src=yes&quot; -s -i inventory.ini</div></pre></td></tr></table></figure>
<h3 id="效率更高的-copy：synchronize"><a href="#效率更高的-copy：synchronize" class="headerlink" title="效率更高的 copy：synchronize"></a>效率更高的 copy：synchronize</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible -i xty_172.ini all -m synchronize -a &quot; src=/home/ren/docker.service dest=/usr/lib/systemd/system/docker.socket &quot; -u root</div></pre></td></tr></table></figure>
<h3 id="find-file"><a href="#find-file" class="headerlink" title="find_file"></a>find_file</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">- hosts: all</div><div class="line"></div><div class="line">  tasks:</div><div class="line">    - name: find_file</div><div class="line">      find:</div><div class="line">        paths: /home/admin/.ssh/</div><div class="line">        patterns: &quot;*.rsa&quot;</div><div class="line">        recurse: no</div><div class="line">      register: file_name</div><div class="line"></div><div class="line">    - name: copy_file</div><div class="line">      fetch:</div><div class="line">        src: &quot;&#123;&#123; item.path &#125;&#125;&quot;</div><div class="line">        dest: /tmp/sshbak/</div><div class="line">        flat: no</div><div class="line">      with_items: &quot;&#123;&#123; file_name.files &#125;&#125;&quot;</div></pre></td></tr></table></figure>
<p>test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook -i 127.0.0.1,  ./find_file.yaml</div></pre></td></tr></table></figure>
<h3 id="不使用-hosts-ini文件，从命令行中传入目标机的-ip-列表"><a href="#不使用-hosts-ini文件，从命令行中传入目标机的-ip-列表" class="headerlink" title="不使用 hosts.ini文件，从命令行中传入目标机的 ip 列表"></a>不使用 hosts.ini文件，从命令行中传入目标机的 ip 列表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ ansible -i 10.125.0.169,10.125.192.40 all -e &quot;ansible_ssh_port=22&quot; -a &quot;uptime&quot; -u xijun.rxj</div><div class="line"></div><div class="line">success =&gt; 10.125.192.40 =&gt; rc=0 =&gt;</div><div class="line"> 12:31:50 up 48 days, 17:01,  0 users,  load average: 0.13, 0.06, 0.05</div><div class="line"></div><div class="line">success =&gt; 10.125.0.169 =&gt; rc=0 =&gt;</div><div class="line"> 12:31:50 up 49 days,  2:25,  0 users,  load average: 0.00, 0.01, 0.05</div></pre></td></tr></table></figure>
<p>执行说明</p>
<blockquote>
<p>   -i 后面带入ip列表，注意每个IP后面一定要有 “,” 分割开来，all 关键字也是必须的</p>
<p>   -e 中ansible_ssh_port=22表示ssh使用22端口（默认），如果ssh使用9999端口在这里将22改成9999即可</p>
</blockquote>
<h3 id="使用root-sudo权限来执行命令"><a href="#使用root-sudo权限来执行命令" class="headerlink" title="使用root sudo权限来执行命令"></a>使用root sudo权限来执行命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible -i 10.125.6.93, all -m  shell -a &quot; ls -lh /home/admin/&quot;    -u xijun.rxj --become-user=root --ask-become-pass --become-method=sudo --become -k</div></pre></td></tr></table></figure>
<h3 id="给admin授权登录server不需要输入密码（也不知道admin的密码）"><a href="#给admin授权登录server不需要输入密码（也不知道admin的密码）" class="headerlink" title="给admin授权登录server不需要输入密码（也不知道admin的密码）"></a>给admin授权登录server不需要输入密码（也不知道admin的密码）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">通过 xijun.rxj(已知密码) 以root 权限将本机pub key复制到server上的 /home/admin, 再通过admin账号登录server就不需要密码了：</div><div class="line">ansible -i 10.125.6.93, all -m  authorized_key -a &quot; user=admin key=\&quot;&#123;&#123; lookup(&apos;file&apos;, &apos;/home/ren/.ssh/id_rsa.pub&apos;) &#125;&#125; \&quot;  &quot; -u xijun.rxj --become-user=root --ask-become-pass --become-method=sudo --become -k</div><div class="line"></div><div class="line">不需要密码就可以执行：</div><div class="line">ansible -i 10.125.6.93, all -m shell -a &quot; ls -lha /home/admin/  &quot; -u admin</div></pre></td></tr></table></figure>
<h3 id="fetch-将远程服务器上的public-key-读取到本地"><a href="#fetch-将远程服务器上的public-key-读取到本地" class="headerlink" title="fetch:将远程服务器上的public key 读取到本地"></a>fetch:将远程服务器上的public key 读取到本地</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ansible -i kfc.ini hadoop -m fetch -a &quot; src=/home/admin/.ssh/id_rsa.pub dest=./test/  &quot;  -u admin</div><div class="line"></div><div class="line">find test/ -type f | xargs cat &gt; ./authorized_keys</div><div class="line"></div><div class="line">#push all the public keys to the server</div><div class="line">ansible -i ~/ali/ansible-edas/kfc.ini hadoop -m  copy -a &quot; src=./authorized_keys dest=/home/admin/.ssh/authorized_keys mode=600  &quot; -u admin</div></pre></td></tr></table></figure>
<p>或者循环fetch：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="string">$cat</span> <span class="string">fetch.yaml</span> </div><div class="line"><span class="attr">- hosts:</span> <span class="string">all</span>   </div><div class="line"><span class="attr">  tasks:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">list</span> <span class="string">the</span> <span class="string">files</span> <span class="string">in</span> <span class="string">the</span> <span class="string">folder</span></div><div class="line">      <span class="comment">#command: ls /u01/nmon/tpcc/ </span></div><div class="line"><span class="attr">      shell:</span> <span class="string">(cd</span> <span class="string">/remote;</span> <span class="string">find</span> <span class="string">.</span> <span class="bullet">-maxdepth</span> <span class="number">1</span> <span class="bullet">-type</span> <span class="string">f)</span> <span class="string">| cut -d'/' -f2</span></div><div class="line"><span class="attr">      register:</span> <span class="string">dir_out</span></div><div class="line"></div><div class="line"><span class="attr">    - name:</span> <span class="string">do</span> <span class="string">the</span> <span class="string">action</span></div><div class="line"><span class="attr">      fetch:</span> <span class="string">src=/u01/nmon/tpcc/&#123;&#123;item&#125;&#125;</span> <span class="string">dest=/home/aliyun/nmon_tpcc/</span> <span class="string">flat=no</span></div><div class="line"><span class="attr">      with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123;dir_out.stdout_lines&#125;&#125;</span>"</span></div></pre></td></tr></table></figure>
<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">$ansible-playbook -i /home/aliyun/all.ini  fetch.yaml -u admin</div><div class="line"></div><div class="line">PLAY [all] *******************************************************************************************</div><div class="line"></div><div class="line">TASK [Gathering Facts] *******************************************************************************</div><div class="line">ok: [10.88.88.18]</div><div class="line">ok: [10.88.88.16]</div><div class="line">ok: [10.88.88.15]</div><div class="line">ok: [10.88.88.19]</div><div class="line">ok: [10.88.88.17]</div><div class="line">ok: [10.88.88.20]</div><div class="line"></div><div class="line">TASK [list the files in the folder] ******************************************************************</div><div class="line">changed: [10.88.88.15]</div><div class="line">changed: [10.88.88.16]</div><div class="line">changed: [10.88.88.17]</div><div class="line">changed: [10.88.88.18]</div><div class="line">changed: [10.88.88.19]</div><div class="line">changed: [10.88.88.20]</div><div class="line"></div><div class="line">TASK [do the action] *********************************************************************************</div><div class="line">changed: [10.88.88.15] =&gt; (item=uos15_200729_1108.nmon)</div><div class="line">changed: [10.88.88.18] =&gt; (item=uos18_200729_1107.nmon)</div><div class="line">changed: [10.88.88.16] =&gt; (item=uos16_200729_1106.nmon)</div><div class="line">changed: [10.88.88.19] =&gt; (item=adbpg2-PC_200729_1108.nmon)</div><div class="line">changed: [10.88.88.17] =&gt; (item=uos17_200729_1107.nmon)</div><div class="line">changed: [10.88.88.19] =&gt; (item=adbpg2-PC_200729_1936.nmon)</div><div class="line">changed: [10.88.88.20] =&gt; (item=adbpg-PC_200729_1110.nmon)</div><div class="line"></div><div class="line">PLAY RECAP *******************************************************************************************</div><div class="line">10.88.88.15                : ok=3    changed=2    unreachable=0    failed=0   </div><div class="line">10.88.88.16                : ok=3    changed=2    unreachable=0    failed=0   </div><div class="line">10.88.88.17                : ok=3    changed=2    unreachable=0    failed=0   </div><div class="line">10.88.88.18                : ok=3    changed=2    unreachable=0    failed=0   </div><div class="line">10.88.88.19                : ok=3    changed=2    unreachable=0    failed=0   </div><div class="line">10.88.88.20                : ok=3    changed=2    unreachable=0    failed=0</div></pre></td></tr></table></figure>
<h3 id="setup-获取机器配置、参数信息"><a href="#setup-获取机器配置、参数信息" class="headerlink" title="setup:获取机器配置、参数信息"></a>setup:获取机器配置、参数信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div></pre></td><td class="code"><pre><div class="line"># ansible -i 192.168.1.91, all -m setup -u admin</div><div class="line">192.168.1.91 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;ansible_facts&quot;: &#123;</div><div class="line">        &quot;ansible_all_ipv4_addresses&quot;: [</div><div class="line">            &quot;172.17.0.1&quot;, </div><div class="line">            &quot;192.168.0.91&quot;, </div><div class="line">            &quot;192.168.1.91&quot;</div><div class="line">        ], </div><div class="line">        &quot;ansible_all_ipv6_addresses&quot;: [], </div><div class="line">        &quot;ansible_apparmor&quot;: &#123;</div><div class="line">            &quot;status&quot;: &quot;disabled&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_architecture&quot;: &quot;x86_64&quot;, </div><div class="line">        &quot;ansible_bios_date&quot;: &quot;04/01/2014&quot;, </div><div class="line">        &quot;ansible_bios_version&quot;: &quot;8c24b4c&quot;, </div><div class="line">        &quot;ansible_cmdline&quot;: &#123;</div><div class="line">            &quot;BOOT_IMAGE&quot;: &quot;/boot/vmlinuz-3.10.0-957.21.3.el7.x86_64&quot;, </div><div class="line">            &quot;LANG&quot;: &quot;en_US.UTF-8&quot;, </div><div class="line">            &quot;biosdevname&quot;: &quot;0&quot;, </div><div class="line">            &quot;console&quot;: &quot;ttyS0,115200n8&quot;, </div><div class="line">            &quot;crashkernel&quot;: &quot;auto&quot;, </div><div class="line">            &quot;idle&quot;: &quot;halt&quot;, </div><div class="line">            &quot;net.ifnames&quot;: &quot;0&quot;, </div><div class="line">            &quot;noibrs&quot;: true, </div><div class="line">            &quot;quiet&quot;: true, </div><div class="line">            &quot;rhgb&quot;: true, </div><div class="line">            &quot;ro&quot;: true, </div><div class="line">            &quot;root&quot;: &quot;UUID=1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_date_time&quot;: &#123;</div><div class="line">            &quot;date&quot;: &quot;2020-07-15&quot;, </div><div class="line">            &quot;day&quot;: &quot;15&quot;, </div><div class="line">            &quot;epoch&quot;: &quot;1594796084&quot;, </div><div class="line">            &quot;hour&quot;: &quot;14&quot;, </div><div class="line">            &quot;iso8601&quot;: &quot;2020-07-15T06:54:44Z&quot;, </div><div class="line">            &quot;iso8601_basic&quot;: &quot;20200715T145444643628&quot;, </div><div class="line">            &quot;iso8601_basic_short&quot;: &quot;20200715T145444&quot;, </div><div class="line">            &quot;iso8601_micro&quot;: &quot;2020-07-15T06:54:44.643725Z&quot;, </div><div class="line">            &quot;minute&quot;: &quot;54&quot;, </div><div class="line">            &quot;month&quot;: &quot;07&quot;, </div><div class="line">            &quot;second&quot;: &quot;44&quot;, </div><div class="line">            &quot;time&quot;: &quot;14:54:44&quot;, </div><div class="line">            &quot;tz&quot;: &quot;CST&quot;, </div><div class="line">            &quot;tz_offset&quot;: &quot;+0800&quot;, </div><div class="line">            &quot;weekday&quot;: &quot;星期三&quot;, </div><div class="line">            &quot;weekday_number&quot;: &quot;3&quot;, </div><div class="line">            &quot;weeknumber&quot;: &quot;28&quot;, </div><div class="line">            &quot;year&quot;: &quot;2020&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_default_ipv4&quot;: &#123;</div><div class="line">            &quot;address&quot;: &quot;192.168.0.91&quot;, </div><div class="line">            &quot;alias&quot;: &quot;eth0&quot;, </div><div class="line">            &quot;broadcast&quot;: &quot;192.168.0.255&quot;, </div><div class="line">            &quot;gateway&quot;: &quot;192.168.0.253&quot;, </div><div class="line">            &quot;interface&quot;: &quot;eth0&quot;, </div><div class="line">            &quot;macaddress&quot;: &quot;00:16:3e:30:d9:a4&quot;, </div><div class="line">            &quot;mtu&quot;: 1500, </div><div class="line">            &quot;netmask&quot;: &quot;255.255.255.0&quot;, </div><div class="line">            &quot;network&quot;: &quot;192.168.0.0&quot;, </div><div class="line">            &quot;type&quot;: &quot;ether&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_default_ipv6&quot;: &#123;&#125;, </div><div class="line">        &quot;ansible_device_links&quot;: &#123;</div><div class="line">            &quot;ids&quot;: &#123;&#125;, </div><div class="line">            &quot;labels&quot;: &#123;</div><div class="line">                &quot;loop2&quot;: [</div><div class="line">                    &quot;CDROM&quot;</div><div class="line">                ]</div><div class="line">            &#125;, </div><div class="line">            &quot;masters&quot;: &#123;&#125;, </div><div class="line">            &quot;uuids&quot;: &#123;</div><div class="line">                &quot;loop0&quot;: [</div><div class="line">                    &quot;2020-07-12-14-26-47-00&quot;</div><div class="line">                ], </div><div class="line">                &quot;loop1&quot;: [</div><div class="line">                    &quot;2020-07-12-20-25-18-00&quot;</div><div class="line">                ], </div><div class="line">                &quot;loop2&quot;: [</div><div class="line">                    &quot;2020-07-13-09-57-36-00&quot;</div><div class="line">                ], </div><div class="line">                &quot;vda1&quot;: [</div><div class="line">                    &quot;1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_devices&quot;: &#123;</div><div class="line">            &quot;loop0&quot;: &#123;</div><div class="line">                &quot;holders&quot;: [], </div><div class="line">                &quot;host&quot;: &quot;&quot;, </div><div class="line">                &quot;links&quot;: &#123;</div><div class="line">                    &quot;ids&quot;: [], </div><div class="line">                    &quot;labels&quot;: [], </div><div class="line">                    &quot;masters&quot;: [], </div><div class="line">                    &quot;uuids&quot;: [</div><div class="line">                        &quot;2020-07-12-14-26-47-00&quot;</div><div class="line">                    ]</div><div class="line">                &#125;, </div><div class="line">                &quot;model&quot;: null, </div><div class="line">                &quot;partitions&quot;: &#123;&#125;, </div><div class="line">                &quot;removable&quot;: &quot;0&quot;, </div><div class="line">                &quot;rotational&quot;: &quot;1&quot;, </div><div class="line">                &quot;sas_address&quot;: null, </div><div class="line">                &quot;sas_device_handle&quot;: null, </div><div class="line">                &quot;scheduler_mode&quot;: &quot;&quot;, </div><div class="line">                &quot;sectors&quot;: &quot;327924&quot;, </div><div class="line">                &quot;sectorsize&quot;: &quot;512&quot;, </div><div class="line">                &quot;size&quot;: &quot;160.12 MB&quot;, </div><div class="line">                &quot;support_discard&quot;: &quot;4096&quot;, </div><div class="line">                &quot;vendor&quot;: null, </div><div class="line">                &quot;virtual&quot;: 1</div><div class="line">            &#125;, </div><div class="line">            &quot;loop1&quot;: &#123;</div><div class="line">                &quot;holders&quot;: [], </div><div class="line">                &quot;host&quot;: &quot;&quot;, </div><div class="line">                &quot;links&quot;: &#123;</div><div class="line">                    &quot;ids&quot;: [], </div><div class="line">                    &quot;labels&quot;: [], </div><div class="line">                    &quot;masters&quot;: [], </div><div class="line">                    &quot;uuids&quot;: [</div><div class="line">                        &quot;2020-07-12-20-25-18-00&quot;</div><div class="line">                    ]</div><div class="line">                &#125;, </div><div class="line">                &quot;model&quot;: null, </div><div class="line">                &quot;partitions&quot;: &#123;&#125;, </div><div class="line">                &quot;removable&quot;: &quot;0&quot;, </div><div class="line">                &quot;rotational&quot;: &quot;1&quot;, </div><div class="line">                &quot;sas_address&quot;: null, </div><div class="line">                &quot;sas_device_handle&quot;: null, </div><div class="line">                &quot;scheduler_mode&quot;: &quot;&quot;, </div><div class="line">                &quot;sectors&quot;: &quot;359172&quot;, </div><div class="line">                &quot;sectorsize&quot;: &quot;512&quot;, </div><div class="line">                &quot;size&quot;: &quot;175.38 MB&quot;, </div><div class="line">                &quot;support_discard&quot;: &quot;4096&quot;, </div><div class="line">                &quot;vendor&quot;: null, </div><div class="line">                &quot;virtual&quot;: 1</div><div class="line">            &#125;, </div><div class="line">            &quot;loop2&quot;: &#123;</div><div class="line">                &quot;holders&quot;: [], </div><div class="line">                &quot;host&quot;: &quot;&quot;, </div><div class="line">                &quot;links&quot;: &#123;</div><div class="line">                    &quot;ids&quot;: [], </div><div class="line">                    &quot;labels&quot;: [</div><div class="line">                        &quot;CDROM&quot;</div><div class="line">                    ], </div><div class="line">                    &quot;masters&quot;: [], </div><div class="line">                    &quot;uuids&quot;: [</div><div class="line">                        &quot;2020-07-13-09-57-36-00&quot;</div><div class="line">                    ]</div><div class="line">                &#125;, </div><div class="line">                &quot;model&quot;: null, </div><div class="line">                &quot;partitions&quot;: &#123;&#125;, </div><div class="line">                &quot;removable&quot;: &quot;0&quot;, </div><div class="line">                &quot;rotational&quot;: &quot;1&quot;, </div><div class="line">                &quot;sas_address&quot;: null, </div><div class="line">                &quot;sas_device_handle&quot;: null, </div><div class="line">                &quot;scheduler_mode&quot;: &quot;&quot;, </div><div class="line">                &quot;sectors&quot;: &quot;128696&quot;, </div><div class="line">                &quot;sectorsize&quot;: &quot;512&quot;, </div><div class="line">                &quot;size&quot;: &quot;62.84 MB&quot;, </div><div class="line">                &quot;support_discard&quot;: &quot;4096&quot;, </div><div class="line">                &quot;vendor&quot;: null, </div><div class="line">                &quot;virtual&quot;: 1</div><div class="line">            &#125;, </div><div class="line">            &quot;vda&quot;: &#123;</div><div class="line">                &quot;holders&quot;: [], </div><div class="line">                &quot;host&quot;: &quot;SCSI storage controller: Red Hat, Inc. Virtio block device&quot;, </div><div class="line">                &quot;links&quot;: &#123;</div><div class="line">                    &quot;ids&quot;: [], </div><div class="line">                    &quot;labels&quot;: [], </div><div class="line">                    &quot;masters&quot;: [], </div><div class="line">                    &quot;uuids&quot;: []</div><div class="line">                &#125;, </div><div class="line">                &quot;model&quot;: null, </div><div class="line">                &quot;partitions&quot;: &#123;</div><div class="line">                    &quot;vda1&quot;: &#123;</div><div class="line">                        &quot;holders&quot;: [], </div><div class="line">                        &quot;links&quot;: &#123;</div><div class="line">                            &quot;ids&quot;: [], </div><div class="line">                            &quot;labels&quot;: [], </div><div class="line">                            &quot;masters&quot;: [], </div><div class="line">                            &quot;uuids&quot;: [</div><div class="line">                                &quot;1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">                            ]</div><div class="line">                        &#125;, </div><div class="line">                        &quot;sectors&quot;: &quot;838847992&quot;, </div><div class="line">                        &quot;sectorsize&quot;: 512, </div><div class="line">                        &quot;size&quot;: &quot;399.99 GB&quot;, </div><div class="line">                        &quot;start&quot;: &quot;2048&quot;, </div><div class="line">                        &quot;uuid&quot;: &quot;1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">                    &#125;</div><div class="line">                &#125;, </div><div class="line">                &quot;removable&quot;: &quot;0&quot;, </div><div class="line">                &quot;rotational&quot;: &quot;1&quot;, </div><div class="line">                &quot;sas_address&quot;: null, </div><div class="line">                &quot;sas_device_handle&quot;: null, </div><div class="line">                &quot;scheduler_mode&quot;: &quot;mq-deadline&quot;, </div><div class="line">                &quot;sectors&quot;: &quot;838860800&quot;, </div><div class="line">                &quot;sectorsize&quot;: &quot;512&quot;, </div><div class="line">                &quot;size&quot;: &quot;400.00 GB&quot;, </div><div class="line">                &quot;support_discard&quot;: &quot;0&quot;, </div><div class="line">                &quot;vendor&quot;: &quot;0x1af4&quot;, </div><div class="line">                &quot;virtual&quot;: 1</div><div class="line">            &#125;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_distribution&quot;: &quot;CentOS&quot;, </div><div class="line">        &quot;ansible_distribution_file_parsed&quot;: true, </div><div class="line">        &quot;ansible_distribution_file_path&quot;: &quot;/etc/redhat-release&quot;, </div><div class="line">        &quot;ansible_distribution_file_variety&quot;: &quot;RedHat&quot;, </div><div class="line">        &quot;ansible_distribution_major_version&quot;: &quot;7&quot;, </div><div class="line">        &quot;ansible_distribution_release&quot;: &quot;Core&quot;, </div><div class="line">        &quot;ansible_distribution_version&quot;: &quot;7.8&quot;, </div><div class="line">        &quot;ansible_dns&quot;: &#123;</div><div class="line">            &quot;nameservers&quot;: [</div><div class="line">                &quot;100.100.2.136&quot;, </div><div class="line">                &quot;100.100.2.138&quot;</div><div class="line">            ], </div><div class="line">            &quot;options&quot;: &#123;</div><div class="line">                &quot;attempts&quot;: &quot;3&quot;, </div><div class="line">                &quot;rotate&quot;: true, </div><div class="line">                &quot;single-request-reopen&quot;: true, </div><div class="line">                &quot;timeout&quot;: &quot;2&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_docker0&quot;: &#123;</div><div class="line">            &quot;active&quot;: false, </div><div class="line">            &quot;device&quot;: &quot;docker0&quot;, </div><div class="line">            &quot;features&quot;: &#123;</div><div class="line">                &quot;busy_poll&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;highdma&quot;: &quot;on&quot;, </div><div class="line">                &quot;hw_tc_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;l2_fwd_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;loopback&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;netns_local&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_all&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_checksumming&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_fcs&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_gro_hw&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_udp_tunnel_port_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_hw_parse&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_gre_csum_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_gre_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_gso_partial&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_gso_robust&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_ipip_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_lockless&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_nocache_copy&quot;: &quot;off&quot;, </div><div class="line">                &quot;tx_scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_sctp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_sit_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_mangleid_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_udp_tnl_csum_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_vlan_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_vlan_stag_hw_insert&quot;: &quot;on&quot;, </div><div class="line">                &quot;udp_fragmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;vlan_challenged&quot;: &quot;off [fixed]&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;hw_timestamp_filters&quot;: [], </div><div class="line">            &quot;id&quot;: &quot;8000.0242e441b693&quot;, </div><div class="line">            &quot;interfaces&quot;: [], </div><div class="line">            &quot;ipv4&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;172.17.0.1&quot;, </div><div class="line">                &quot;broadcast&quot;: &quot;172.17.255.255&quot;, </div><div class="line">                &quot;netmask&quot;: &quot;255.255.0.0&quot;, </div><div class="line">                &quot;network&quot;: &quot;172.17.0.0&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;macaddress&quot;: &quot;02:42:e4:41:b6:93&quot;, </div><div class="line">            &quot;mtu&quot;: 1500, </div><div class="line">            &quot;promisc&quot;: false, </div><div class="line">            &quot;stp&quot;: false, </div><div class="line">            &quot;timestamping&quot;: [</div><div class="line">                &quot;rx_software&quot;, </div><div class="line">                &quot;software&quot;</div><div class="line">            ], </div><div class="line">            &quot;type&quot;: &quot;bridge&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_domain&quot;: &quot;&quot;, </div><div class="line">        &quot;ansible_effective_group_id&quot;: 1000, </div><div class="line">        &quot;ansible_effective_user_id&quot;: 1000, </div><div class="line">        &quot;ansible_env&quot;: &#123;</div><div class="line">            &quot;HISTCONTROL&quot;: &quot;erasedups&quot;, </div><div class="line">            &quot;HISTFILESIZE&quot;: &quot;30000&quot;, </div><div class="line">            &quot;HISTIGNORE&quot;: &quot;pwd:ls:cd:ll:&quot;, </div><div class="line">            &quot;HISTSIZE&quot;: &quot;30000&quot;, </div><div class="line">            &quot;HISTTIMEFORMAT&quot;: &quot;%d/%m/%y %T &quot;, </div><div class="line">            &quot;HOME&quot;: &quot;/home/admin&quot;, </div><div class="line">            &quot;JAVA_HOME&quot;: &quot;/opt/taobao/java&quot;, </div><div class="line">            &quot;LANG&quot;: &quot;C&quot;, </div><div class="line">            &quot;LC_ADDRESS&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_ALL&quot;: &quot;C&quot;, </div><div class="line">            &quot;LC_IDENTIFICATION&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_MEASUREMENT&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_MONETARY&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_NAME&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_NUMERIC&quot;: &quot;C&quot;, </div><div class="line">            &quot;LC_PAPER&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_TELEPHONE&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_TIME&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LESSOPEN&quot;: &quot;||/usr/bin/lesspipe.sh %s&quot;, </div><div class="line">            &quot;LOGNAME&quot;: &quot;admin&quot;, </div><div class="line">            &quot;MAIL&quot;: &quot;/var/mail/admin&quot;, </div><div class="line">            &quot;PATH&quot;: &quot;/usr/local/bin:/usr/bin:/opt/taobao/java8/bin:/home/admin/tools&quot;, </div><div class="line">            &quot;PROMPT_COMMAND&quot;: &quot;history -a&quot;, </div><div class="line">            &quot;PS4&quot;: &quot;+($&#123;BASH_SOURCE&#125;:$&#123;LINENO&#125;): $&#123;FUNCNAME[0]:+$&#123;FUNCNAME[0]&#125;(): &#125;&quot;, </div><div class="line">            &quot;PWD&quot;: &quot;/home/admin&quot;, </div><div class="line">            &quot;SHELL&quot;: &quot;/bin/bash&quot;, </div><div class="line">            &quot;SHLVL&quot;: &quot;2&quot;, </div><div class="line">            &quot;SSH_CLIENT&quot;: &quot;192.168.1.79 51412 22&quot;, </div><div class="line">            &quot;SSH_CONNECTION&quot;: &quot;192.168.1.79 51412 192.168.1.91 22&quot;, </div><div class="line">            &quot;USER&quot;: &quot;admin&quot;, </div><div class="line">            &quot;XDG_RUNTIME_DIR&quot;: &quot;/run/user/1000&quot;, </div><div class="line">            &quot;XDG_SESSION_ID&quot;: &quot;40120&quot;, </div><div class="line">            &quot;_&quot;: &quot;/usr/bin/python&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_eth0&quot;: &#123;</div><div class="line">            &quot;active&quot;: true, </div><div class="line">            &quot;device&quot;: &quot;eth0&quot;, </div><div class="line">            &quot;features&quot;: &#123;</div><div class="line">                &quot;busy_poll&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;highdma&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;hw_tc_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;l2_fwd_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;loopback&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;netns_local&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_all&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_checksumming&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;rx_fcs&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_gro_hw&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_udp_tunnel_port_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_hw_parse&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_partial&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_ipip_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_lockless&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_nocache_copy&quot;: &quot;off&quot;, </div><div class="line">                &quot;tx_scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_sctp_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_sit_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_mangleid_segmentation&quot;: &quot;off&quot;, </div><div class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_udp_tnl_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_stag_hw_insert&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;udp_fragmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;vlan_challenged&quot;: &quot;off [fixed]&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;hw_timestamp_filters&quot;: [], </div><div class="line">            &quot;ipv4&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.91&quot;, </div><div class="line">                &quot;broadcast&quot;: &quot;192.168.0.255&quot;, </div><div class="line">                &quot;netmask&quot;: &quot;255.255.255.0&quot;, </div><div class="line">                &quot;network&quot;: &quot;192.168.0.0&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;macaddress&quot;: &quot;00:16:3e:30:d9:a4&quot;, </div><div class="line">            &quot;module&quot;: &quot;virtio_net&quot;, </div><div class="line">            &quot;mtu&quot;: 1500, </div><div class="line">            &quot;pciid&quot;: &quot;virtio2&quot;, </div><div class="line">            &quot;promisc&quot;: false, </div><div class="line">            &quot;timestamping&quot;: [</div><div class="line">                &quot;rx_software&quot;, </div><div class="line">                &quot;software&quot;</div><div class="line">            ], </div><div class="line">            &quot;type&quot;: &quot;ether&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_eth1&quot;: &#123;</div><div class="line">            &quot;active&quot;: true, </div><div class="line">            &quot;device&quot;: &quot;eth1&quot;, </div><div class="line">            &quot;features&quot;: &#123;</div><div class="line">                &quot;busy_poll&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;highdma&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;hw_tc_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;l2_fwd_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;loopback&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;netns_local&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_all&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_checksumming&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;rx_fcs&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_gro_hw&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_udp_tunnel_port_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_hw_parse&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_partial&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_ipip_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_lockless&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_nocache_copy&quot;: &quot;off&quot;, </div><div class="line">                &quot;tx_scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_sctp_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_sit_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_mangleid_segmentation&quot;: &quot;off&quot;, </div><div class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_udp_tnl_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_stag_hw_insert&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;udp_fragmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;vlan_challenged&quot;: &quot;off [fixed]&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;hw_timestamp_filters&quot;: [], </div><div class="line">            &quot;ipv4&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.1.91&quot;, </div><div class="line">                &quot;broadcast&quot;: &quot;192.168.1.255&quot;, </div><div class="line">                &quot;netmask&quot;: &quot;255.255.255.0&quot;, </div><div class="line">                &quot;network&quot;: &quot;192.168.1.0&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;macaddress&quot;: &quot;00:16:3e:2c:a2:c2&quot;, </div><div class="line">            &quot;module&quot;: &quot;virtio_net&quot;, </div><div class="line">            &quot;mtu&quot;: 1500, </div><div class="line">            &quot;pciid&quot;: &quot;virtio4&quot;, </div><div class="line">            &quot;promisc&quot;: false, </div><div class="line">            &quot;timestamping&quot;: [</div><div class="line">                &quot;rx_software&quot;, </div><div class="line">                &quot;software&quot;</div><div class="line">            ], </div><div class="line">            &quot;type&quot;: &quot;ether&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_fibre_channel_wwn&quot;: [], </div><div class="line">        &quot;ansible_fips&quot;: false, </div><div class="line">        &quot;ansible_form_factor&quot;: &quot;Other&quot;, </div><div class="line">        &quot;ansible_fqdn&quot;: &quot;jtdb001&quot;, </div><div class="line">        &quot;ansible_hostname&quot;: &quot;jtdb001&quot;, </div><div class="line">        &quot;ansible_hostnqn&quot;: &quot;&quot;, </div><div class="line">        &quot;ansible_interfaces&quot;: [</div><div class="line">            &quot;lo&quot;, </div><div class="line">            &quot;docker0&quot;, </div><div class="line">            &quot;eth1&quot;, </div><div class="line">            &quot;eth0&quot;</div><div class="line">        ], </div><div class="line">        &quot;ansible_is_chroot&quot;: false, </div><div class="line">        &quot;ansible_iscsi_iqn&quot;: &quot;&quot;, </div><div class="line">        &quot;ansible_kernel&quot;: &quot;3.10.0-957.21.3.el7.x86_64&quot;, </div><div class="line">        &quot;ansible_kernel_version&quot;: &quot;#1 SMP Tue Jun 18 16:35:19 UTC 2019&quot;, </div><div class="line">        &quot;ansible_lo&quot;: &#123;</div><div class="line">            &quot;active&quot;: true, </div><div class="line">            &quot;device&quot;: &quot;lo&quot;, </div><div class="line">            &quot;features&quot;: &#123;</div><div class="line">                &quot;busy_poll&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;highdma&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;hw_tc_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;l2_fwd_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;loopback&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;netns_local&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_all&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_checksumming&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;rx_fcs&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_gro_hw&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_udp_tunnel_port_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_hw_parse&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_sctp&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_partial&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_ipip_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_lockless&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_nocache_copy&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_scatter_gather&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_sctp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_sit_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_mangleid_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_udp_tnl_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_stag_hw_insert&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;udp_fragmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;vlan_challenged&quot;: &quot;on [fixed]&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;hw_timestamp_filters&quot;: [], </div><div class="line">            &quot;ipv4&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;127.0.0.1&quot;, </div><div class="line">                &quot;broadcast&quot;: &quot;host&quot;, </div><div class="line">                &quot;netmask&quot;: &quot;255.0.0.0&quot;, </div><div class="line">                &quot;network&quot;: &quot;127.0.0.0&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;mtu&quot;: 65536, </div><div class="line">            &quot;promisc&quot;: false, </div><div class="line">            &quot;timestamping&quot;: [</div><div class="line">                &quot;rx_software&quot;, </div><div class="line">                &quot;software&quot;</div><div class="line">            ], </div><div class="line">            &quot;type&quot;: &quot;loopback&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_local&quot;: &#123;&#125;, </div><div class="line">        &quot;ansible_lsb&quot;: &#123;&#125;, </div><div class="line">        &quot;ansible_machine&quot;: &quot;x86_64&quot;, </div><div class="line">        &quot;ansible_machine_id&quot;: &quot;20190711105006363114529432776998&quot;, </div><div class="line">        &quot;ansible_memfree_mb&quot;: 33368, </div><div class="line">        &quot;ansible_memory_mb&quot;: &#123;</div><div class="line">            &quot;nocache&quot;: &#123;</div><div class="line">                &quot;free&quot;: 41285, </div><div class="line">                &quot;used&quot;: 6079</div><div class="line">            &#125;, </div><div class="line">            &quot;real&quot;: &#123;</div><div class="line">                &quot;free&quot;: 33368, </div><div class="line">                &quot;total&quot;: 47364, </div><div class="line">                &quot;used&quot;: 13996</div><div class="line">            &#125;, </div><div class="line">            &quot;swap&quot;: &#123;</div><div class="line">                &quot;cached&quot;: 0, </div><div class="line">                &quot;free&quot;: 0, </div><div class="line">                &quot;total&quot;: 0, </div><div class="line">                &quot;used&quot;: 0</div><div class="line">            &#125;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_memtotal_mb&quot;: 47364, </div><div class="line">        &quot;ansible_mounts&quot;: [</div><div class="line">            &#123;</div><div class="line">                &quot;block_available&quot;: 0, </div><div class="line">                &quot;block_size&quot;: 2048, </div><div class="line">                &quot;block_total&quot;: 32174, </div><div class="line">                &quot;block_used&quot;: 32174, </div><div class="line">                &quot;device&quot;: &quot;/dev/loop2&quot;, </div><div class="line">                &quot;fstype&quot;: &quot;iso9660&quot;, </div><div class="line">                &quot;inode_available&quot;: 0, </div><div class="line">                &quot;inode_total&quot;: 0, </div><div class="line">                &quot;inode_used&quot;: 0, </div><div class="line">                &quot;mount&quot;: &quot;/mnt/yum&quot;, </div><div class="line">                &quot;options&quot;: &quot;ro,relatime&quot;, </div><div class="line">                &quot;size_available&quot;: 0, </div><div class="line">                &quot;size_total&quot;: 65892352, </div><div class="line">                &quot;uuid&quot;: &quot;2020-07-13-09-57-36-00&quot;</div><div class="line">            &#125;, </div><div class="line">            &#123;</div><div class="line">                &quot;block_available&quot;: 0, </div><div class="line">                &quot;block_size&quot;: 2048, </div><div class="line">                &quot;block_total&quot;: 81981, </div><div class="line">                &quot;block_used&quot;: 81981, </div><div class="line">                &quot;device&quot;: &quot;/dev/loop0&quot;, </div><div class="line">                &quot;fstype&quot;: &quot;iso9660&quot;, </div><div class="line">                &quot;inode_available&quot;: 0, </div><div class="line">                &quot;inode_total&quot;: 0, </div><div class="line">                &quot;inode_used&quot;: 0, </div><div class="line">                &quot;mount&quot;: &quot;/mnt/iso&quot;, </div><div class="line">                &quot;options&quot;: &quot;ro,relatime&quot;, </div><div class="line">                &quot;size_available&quot;: 0, </div><div class="line">                &quot;size_total&quot;: 167897088, </div><div class="line">                &quot;uuid&quot;: &quot;2020-07-12-14-26-47-00&quot;</div><div class="line">            &#125;, </div><div class="line">            &#123;</div><div class="line">                &quot;block_available&quot;: 0, </div><div class="line">                &quot;block_size&quot;: 2048, </div><div class="line">                &quot;block_total&quot;: 89793, </div><div class="line">                &quot;block_used&quot;: 89793, </div><div class="line">                &quot;device&quot;: &quot;/dev/loop1&quot;, </div><div class="line">                &quot;fstype&quot;: &quot;iso9660&quot;, </div><div class="line">                &quot;inode_available&quot;: 0, </div><div class="line">                &quot;inode_total&quot;: 0, </div><div class="line">                &quot;inode_used&quot;: 0, </div><div class="line">                &quot;mount&quot;: &quot;/mnt/drds&quot;, </div><div class="line">                &quot;options&quot;: &quot;ro,relatime&quot;, </div><div class="line">                &quot;size_available&quot;: 0, </div><div class="line">                &quot;size_total&quot;: 183896064, </div><div class="line">                &quot;uuid&quot;: &quot;2020-07-12-20-25-18-00&quot;</div><div class="line">            &#125;, </div><div class="line">            &#123;</div><div class="line">                &quot;block_available&quot;: 96685158, </div><div class="line">                &quot;block_size&quot;: 4096, </div><div class="line">                &quot;block_total&quot;: 103177963, </div><div class="line">                &quot;block_used&quot;: 6492805, </div><div class="line">                &quot;device&quot;: &quot;/dev/vda1&quot;, </div><div class="line">                &quot;fstype&quot;: &quot;ext4&quot;, </div><div class="line">                &quot;inode_available&quot;: 26110896, </div><div class="line">                &quot;inode_total&quot;: 26214400, </div><div class="line">                &quot;inode_used&quot;: 103504, </div><div class="line">                &quot;mount&quot;: &quot;/&quot;, </div><div class="line">                &quot;options&quot;: &quot;rw,relatime,data=ordered&quot;, </div><div class="line">                &quot;size_available&quot;: 396022407168, </div><div class="line">                &quot;size_total&quot;: 422616936448, </div><div class="line">                &quot;uuid&quot;: &quot;1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">            &#125;</div><div class="line">        ], </div><div class="line">        &quot;ansible_nodename&quot;: &quot;jtdb001&quot;, </div><div class="line">        &quot;ansible_os_family&quot;: &quot;RedHat&quot;, </div><div class="line">        &quot;ansible_pkg_mgr&quot;: &quot;yum&quot;, </div><div class="line">        &quot;ansible_proc_cmdline&quot;: &#123;</div><div class="line">            &quot;BOOT_IMAGE&quot;: &quot;/boot/vmlinuz-3.10.0-957.21.3.el7.x86_64&quot;, </div><div class="line">            &quot;LANG&quot;: &quot;en_US.UTF-8&quot;, </div><div class="line">            &quot;biosdevname&quot;: &quot;0&quot;, </div><div class="line">            &quot;console&quot;: [</div><div class="line">                &quot;tty0&quot;, </div><div class="line">                &quot;ttyS0,115200n8&quot;</div><div class="line">            ], </div><div class="line">            &quot;crashkernel&quot;: &quot;auto&quot;, </div><div class="line">            &quot;idle&quot;: &quot;halt&quot;, </div><div class="line">            &quot;net.ifnames&quot;: &quot;0&quot;, </div><div class="line">            &quot;noibrs&quot;: true, </div><div class="line">            &quot;quiet&quot;: true, </div><div class="line">            &quot;rhgb&quot;: true, </div><div class="line">            &quot;ro&quot;: true, </div><div class="line">            &quot;root&quot;: &quot;UUID=1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_processor&quot;: [</div><div class="line">            &quot;0&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;1&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;2&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;3&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;4&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;5&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;6&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;7&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;8&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;9&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;10&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;11&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;</div><div class="line">        ], </div><div class="line">        &quot;ansible_processor_cores&quot;: 6, </div><div class="line">        &quot;ansible_processor_count&quot;: 1, </div><div class="line">        &quot;ansible_processor_threads_per_core&quot;: 2, </div><div class="line">        &quot;ansible_processor_vcpus&quot;: 12, </div><div class="line">        &quot;ansible_product_name&quot;: &quot;Alibaba Cloud ECS&quot;, </div><div class="line">        &quot;ansible_product_serial&quot;: &quot;NA&quot;, </div><div class="line">        &quot;ansible_product_uuid&quot;: &quot;NA&quot;, </div><div class="line">        &quot;ansible_product_version&quot;: &quot;pc-i440fx-2.1&quot;, </div><div class="line">        &quot;ansible_python&quot;: &#123;</div><div class="line">            &quot;executable&quot;: &quot;/usr/bin/python&quot;, </div><div class="line">            &quot;has_sslcontext&quot;: true, </div><div class="line">            &quot;type&quot;: &quot;CPython&quot;, </div><div class="line">            &quot;version&quot;: &#123;</div><div class="line">                &quot;major&quot;: 2, </div><div class="line">                &quot;micro&quot;: 5, </div><div class="line">                &quot;minor&quot;: 7, </div><div class="line">                &quot;releaselevel&quot;: &quot;final&quot;, </div><div class="line">                &quot;serial&quot;: 0</div><div class="line">            &#125;, </div><div class="line">            &quot;version_info&quot;: [</div><div class="line">                2, </div><div class="line">                7, </div><div class="line">                5, </div><div class="line">                &quot;final&quot;, </div><div class="line">                0</div><div class="line">            ]</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_python_version&quot;: &quot;2.7.5&quot;, </div><div class="line">        &quot;ansible_real_group_id&quot;: 1000, </div><div class="line">        &quot;ansible_real_user_id&quot;: 1000, </div><div class="line">        &quot;ansible_selinux&quot;: &#123;</div><div class="line">            &quot;status&quot;: &quot;disabled&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_selinux_python_present&quot;: true, </div><div class="line">        &quot;ansible_service_mgr&quot;: &quot;systemd&quot;, </div><div class="line">        &quot;ansible_ssh_host_key_dsa_public&quot;: &quot;AAAAB3NzaC1kc3MAAACBAIjMSdXjIBwLTRwqzzLzJzw52IikcmHpmM65Idw9Q/CCH23SJdmmYzl9LIWFTEf2ZP4dHYibvgWtqfc6AHLFVgM1lz3wwdJJSyBD1TyFet+MPZEA1A9jw2Ke2K9C942dWATCpi3B0nk0KJDp49+V0QjUUjZmzt7I66wDmPLpW7mNAAAAFQDXmbLv48zsFHUgPiixhcKsk29ZPQAAAIAHHM+jfcL3V/X6EovQGj/2OytDN7k5hb4KRNTzBwh9JU5V44+S3r5ZViJDthKBolVT1CLX8jAivBu6d70ImYcZLa75AImOnlSp9D4xGP4TNfdAYrA7CkYpzn8ky15xjFDjkL0BjVmeEg6In+04tZOp/kIi/Ft9/ld63W4xopspwwAAAIAhBCIAMW37rknrsmv3sXmhgt+FeUQA/o8moZKcX+xI5sv27NEavQGGKOvZM4+nhCggRvjWaxC9N1DnO2g52trhGrUhNF0qwn/4iar/yknZWwRyZXzB3YtOdJXxCoJphuuGeqJRsLPb7OEIAF7c3lFJcfMUrwcjWrRtFMUM6mE+gQ==&quot;, </div><div class="line">        &quot;ansible_ssh_host_key_ecdsa_public&quot;: &quot;AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMffg6EX26f+10IIgg/U7+PsCUDs8Ep0MUttUyVh3+bJ7/K7ROMhuc8BTieA4PRj3MOaKMbUuZTqPTmrK/4srqg=&quot;, </div><div class="line">        &quot;ansible_ssh_host_key_ed25519_public&quot;: &quot;AAAAC3NzaC1lZDI1NTE5AAAAINIKYkm+FKDTvx6VgENoAnXwOJQ+xZjk3rkvUqZ/4F3i&quot;, </div><div class="line">        &quot;ansible_ssh_host_key_rsa_public&quot;: &quot;AAAAB3NzaC1yc2EAAAADAQABAAABAQC1xlLrDTri/jRfph6Uqx6CoY1/+uAE34rR9sR4FtE+2OMM8kUN0+N+hWLL+8r/pzM40RJOUmELYTlibfnjkYDsmYcpxD8kOxonvlYQbpvram8Hx7X8W1thYs//Zdhltmz1ijTiEatCL/yxJnwrpxN1XOtbMtALKgykbOzF+LNevFUG05MxxQR5WVjijXwK/Auf0ce/ei3NISQZLiW+d+IVYPkAQDpbUpH5W/qGDN0W8wT2OGE0bOvrPfDPRhSxeYrcS4mgS7nGvB26sFyeAimgadnxmWaxAveargYKt33jJQhVaA/23kw+/lygQcSN1QJ2mpeHb3ugay0Gv1i/Wd7P&quot;, </div><div class="line">        &quot;ansible_swapfree_mb&quot;: 0, </div><div class="line">        &quot;ansible_swaptotal_mb&quot;: 0, </div><div class="line">        &quot;ansible_system&quot;: &quot;Linux&quot;, </div><div class="line">        &quot;ansible_system_capabilities&quot;: [</div><div class="line">            &quot;&quot;</div><div class="line">        ], </div><div class="line">        &quot;ansible_system_capabilities_enforced&quot;: &quot;True&quot;, </div><div class="line">        &quot;ansible_system_vendor&quot;: &quot;Alibaba Cloud&quot;, </div><div class="line">        &quot;ansible_uptime_seconds&quot;: 11384976, </div><div class="line">        &quot;ansible_user_dir&quot;: &quot;/home/admin&quot;, </div><div class="line">        &quot;ansible_user_gecos&quot;: &quot;&quot;, </div><div class="line">        &quot;ansible_user_gid&quot;: 1000, </div><div class="line">        &quot;ansible_user_id&quot;: &quot;admin&quot;, </div><div class="line">        &quot;ansible_user_shell&quot;: &quot;/bin/bash&quot;, </div><div class="line">        &quot;ansible_user_uid&quot;: 1000, </div><div class="line">        &quot;ansible_userspace_architecture&quot;: &quot;x86_64&quot;, </div><div class="line">        &quot;ansible_userspace_bits&quot;: &quot;64&quot;, </div><div class="line">        &quot;ansible_virtualization_role&quot;: &quot;guest&quot;, </div><div class="line">        &quot;ansible_virtualization_type&quot;: &quot;kvm&quot;, </div><div class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;, </div><div class="line">        &quot;gather_subset&quot;: [</div><div class="line">            &quot;all&quot;</div><div class="line">        ], </div><div class="line">        &quot;module_setup&quot;: true</div><div class="line">    &#125;, </div><div class="line">    &quot;changed&quot;: false</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ansible-xargs-占位符"><a href="#ansible-xargs-占位符" class="headerlink" title="ansible + xargs 占位符"></a>ansible + xargs 占位符</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//批量执行docker exec</div><div class="line">ansible -i host.ini all -m shell -a &quot;docker ps -a | grep pxd-tpcc | grep dn | cut -d &apos; &apos; -f 1 | xargs  -I&#123;&#125; docker exec &#123;&#125; bash -c \&quot;myc -e &apos;shutdown&apos;\&quot;&quot;</div></pre></td></tr></table></figure>
<h2 id="指定ip执行playbook"><a href="#指定ip执行playbook" class="headerlink" title="指定ip执行playbook"></a>指定ip执行playbook</h2><blockquote>
<p>ansible-playbook  -i “10.168.101.179,” all test.yml</p>
</blockquote>
<p>或者：</p>
<blockquote>
<p>ansible -i phy.ini 11.167.60.150 -m shell -a ‘docker run -it -d –net=host -e diamond_server_list=”“ -e diamond_db0=”“ -e diamond_db1=”“ -e diamond_db2=”“ -e HOST_IP=”“ -p 8080:8080 -p 9090:9090 –name diamond  ‘ -vvv</p>
</blockquote>
<p>上面这种还能重用phy.ini中所有的变量配置</p>
<h2 id="创建用户并打通账号"><a href="#创建用户并打通账号" class="headerlink" title="创建用户并打通账号"></a>创建用户并打通账号</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">$cat create_user.yml</div><div class="line"># create user ren with passwd test and sudo privileges.</div><div class="line"># ansible-playbook -i docker.ini create_user.yml</div><div class="line">- hosts: all</div><div class="line">  user: root</div><div class="line">  vars:</div><div class="line">    # created with:</div><div class="line">    # python -c &apos;import crypt; print crypt.crypt(&quot;password&quot;, &quot;$1$SomeSalt$&quot;)&apos;</div><div class="line">    password: $1$SomeSalt$OrX9ouxOCP0ZOpVG9SwnR/</div><div class="line"></div><div class="line">  tasks:</div><div class="line">    - name: create a new user</div><div class="line">      user:</div><div class="line">       name: &apos;&#123;&#123; user &#125;&#125;&apos;</div><div class="line">       password: &apos;&#123;&#123; password &#125;&#125;&apos;</div><div class="line">       home: /home/&#123;&#123; user &#125;&#125;</div><div class="line">       state: present</div><div class="line">       shell: /bin/bash</div><div class="line"></div><div class="line">    - name: Add user to the sudoers</div><div class="line">      copy:</div><div class="line">          dest: &quot;/etc/sudoers.d/&#123;&#123; user &#125;&#125;&quot;</div><div class="line">          content: &quot;&#123;&#123; user &#125;&#125;  ALL=(ALL)  NOPASSWD: ALL&quot;</div><div class="line"></div><div class="line">    - name: Deploy SSH Key</div><div class="line">      authorized_key: user=&#123;&#123; user &#125;&#125;</div><div class="line">           key=&quot;&#123;&#123; lookup(&apos;file&apos;, &apos;/root/.ssh/id_rsa.pub&apos;) &#125;&#125;&quot;</div><div class="line">           state=present</div></pre></td></tr></table></figure>
<p>然后执行： ansible-playbook -i  all.ini create_user.yml -e “user=admin” 。</p>
<p>或者：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"> ansible -i 192.168.2.101, all -m user -a &quot;name=user02 system=yes uid=503 group=root groups=root shell=/etc/nologin home=/home/user02 password=pwd@123&quot;</div><div class="line"> 192.168.2.101 | CHANGED =&gt; &#123;</div><div class="line">    &quot;ansible_facts&quot;: &#123;</div><div class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</div><div class="line">    &#125;, </div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;comment&quot;: &quot;&quot;, </div><div class="line">    &quot;create_home&quot;: true, </div><div class="line">    &quot;group&quot;: 0, </div><div class="line">    &quot;groups&quot;: &quot;root&quot;, </div><div class="line">    &quot;home&quot;: &quot;/home/user02&quot;, </div><div class="line">    &quot;name&quot;: &quot;user02&quot;, </div><div class="line">    &quot;password&quot;: &quot;NOT_LOGGING_PASSWORD&quot;, </div><div class="line">    &quot;shell&quot;: &quot;/etc/nologin&quot;, </div><div class="line">    &quot;state&quot;: &quot;present&quot;, </div><div class="line">    &quot;system&quot;: true, </div><div class="line">    &quot;uid&quot;: 503</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>playbook task规范：</p>
<p><img src="/images/oss/d502a11765273304abd673fb358b482a.png" alt="image.png"></p>
<p><strong>对齐的时候不能用tab和空格混合</strong></p>
<h2 id="部署docker-daemon的playbook"><a href="#部署docker-daemon的playbook" class="headerlink" title="部署docker daemon的playbook"></a>部署docker daemon的playbook</h2><p>执行 ansible-playbook site.yml -v  -i test.ini -u xijun.rxj -e “project=docker” -p</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line">$cat roles/docker/tasks/main.yml </div><div class="line"># filename: main.yml</div><div class="line">---</div><div class="line">#&quot;****************************************************************************&quot;&quot;</div><div class="line">- name: copy docker execute file to remote</div><div class="line">  copy: src=docker/ dest=/usr/bin/ mode=0755 force=yes</div><div class="line">  tags: copytar</div><div class="line"></div><div class="line">- name: create storage dir</div><div class="line">  file: path=&#123;&#123; storage_dir &#125;&#125; state=directory</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: create the dir</div><div class="line">  file: path=/etc/systemd/system/ state=directory</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: template docker.service to server</div><div class="line">  template: src=docker.service dest=/etc/systemd/system/docker.service</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: template docker.socket to server</div><div class="line">  template: src=docker.socket dest=/usr/lib/systemd/system/docker.socket</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: create /etc/docker dir to server</div><div class="line">  file: path=/etc/docker state=directory</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: copy daemon.json to server</div><div class="line">  template: src=&#123;&#123; inventory_hostname &#125;&#125;/daemon.json dest=/etc/docker/daemon.json</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: copy the load ovs modules to server</div><div class="line">  copy: src=openvswitch.modules dest=/etc/sysconfig/modules/openvswitch.modules mode=0755  force=yes</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: kill docker daemon</div><div class="line">  shell: &quot;kill -9 $(cat /var/run/docker.pid)&quot;</div><div class="line">  ignore_errors: true</div><div class="line">  tags: test</div><div class="line"></div><div class="line">- name: reload systemctl daemon-reload</div><div class="line">  shell: &quot;systemctl daemon-reload&quot;</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: enabled the docker service</div><div class="line">  shell: &quot;systemctl enable docker.service&quot;</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: start docker service</div><div class="line">  shell: &quot;systemctl start docker.service&quot;</div><div class="line"></div><div class="line">- name: remove all containers</div><div class="line">  shell: sudo docker ps -a | awk &apos;&#123;print $1&#125;&apos; | xargs sudo docker rm -f -v</div><div class="line">  ignore_errors: true</div><div class="line"></div><div class="line">- name: template /etc/hosts to server</div><div class="line">  template: src=hosts dest=/etc/hosts owner=root group=root mode=0644 force=yes</div><div class="line">  tags: restorehosts</div><div class="line"></div><div class="line">- name: mkdir /tmp/etc/</div><div class="line">  shell: &quot;mkdir /tmp/etc/ &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  tags: hosts</div><div class="line"></div><div class="line">- name: copy remote /etc/hosts to /tmp</div><div class="line">  shell: &quot;cp /etc/hosts /tmp/etc/ &quot;</div><div class="line">  tags: hosts</div><div class="line"></div><div class="line">- name: copy /etc/hosts to server</div><div class="line">  template: src=etc.host dest=/tmp/etc/ owner=&#123;&#123; remote_user &#125;&#125; group=&#123;&#123; remote_user &#125;&#125; mode=0700 force=yes</div><div class="line">  tags: hosts</div><div class="line"></div><div class="line">- name: merge /etc/hosts</div><div class="line">  assemble: src=/tmp/etc dest=/etc/hosts owner=root group=root mode=0644 force=yes</div><div class="line">  tags: hosts</div><div class="line"></div><div class="line">- name: copy docker_rc.sh to server</div><div class="line">  template: src=docker_rc.sh dest=&#123;&#123; docker_rc_dir &#125;&#125;/docker_rc.sh owner=root group=root mode=0755 force=yes</div><div class="line">  when: use_vxlan!=&quot;true&quot;</div><div class="line">  tags: docker_rc</div><div class="line"></div><div class="line">- name: copy docker_rc.sh to server</div><div class="line">  template: src=docker_rc_vm.sh dest=&#123;&#123; docker_rc_dir &#125;&#125;/docker_rc.sh owner=root group=root mode=0755 force=yes</div><div class="line">  when: use_vxlan==&quot;true&quot;</div><div class="line">  tags: docker_rc</div><div class="line"></div><div class="line">- name: clean docker_rc in rc.local</div><div class="line">  command: su - root -c &quot; sed -i &apos;/docker_rc.sh/d&apos; /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div><div class="line">  tags: docker_rc</div><div class="line"></div><div class="line">- name: start the docker when the system reboot</div><div class="line">  command: su - root -c &quot; echo &apos;su - root -c \&quot;&#123;&#123; docker_rc_dir &#125;&#125;/docker_rc.sh\&quot; &apos; &gt;&gt; /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div><div class="line">  tags: docker_rc</div><div class="line"></div><div class="line">- name: chown the /etc/rc.d/rc.local</div><div class="line">  shell: &quot;chmod +x /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div><div class="line">  tags: docker_rc</div><div class="line"></div><div class="line">- name: clean previous space occupier</div><div class="line">  file: path=&#123;&#123; storage_dir &#125;&#125;/ark.disk&#123;&#123; item &#125;&#125;.tmp state=absent</div><div class="line">  with_items:</div><div class="line">    - 1</div><div class="line">    - 2</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: Occupy space for docker</div><div class="line">  shell: &quot;dd if=/dev/zero of=&#123;&#123; storage_dir &#125;&#125;/ark.disk&#123;&#123; item &#125;&#125;.tmp bs=1M count=1024&quot;</div><div class="line">  sudo: yes</div><div class="line">  with_items:</div><div class="line">    - 1</div><div class="line">    - 2</div><div class="line">  tags: docker</div></pre></td></tr></table></figure>
<h2 id="部署zk"><a href="#部署zk" class="headerlink" title="部署zk"></a>部署zk</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">$cat roles/zookeeper/tasks/main.yml</div><div class="line"># filename: main.yml</div><div class="line">---</div><div class="line">#&quot;****************************************************************************&quot;&quot;</div><div class="line">- name: extract zookeeper tgz</div><div class="line">  unarchive: src=&#123;&#123; packages_dir &#125;&#125;/lib/&#123;&#123; zk_package_name &#125;&#125; dest=/opt</div><div class="line">  sudo: yes</div><div class="line"></div><div class="line">- name: create zk data and log dir</div><div class="line">  file: path=&#123;&#123; zk_data_dir &#125;&#125; state=directory mode=0755</div><div class="line">  with_items:</div><div class="line">    - &quot;&#123;&#123; zk_data_dir &#125;&#125;&quot;</div><div class="line">    - &quot;&#123;&#123; zk_logs_dir &#125;&#125;&quot;</div><div class="line"></div><div class="line">- name: set the myid</div><div class="line">  template: src=myid dest=&#123;&#123; zk_myid_file &#125;&#125;  mode=0644</div><div class="line"></div><div class="line">- name: template zoo.cfg</div><div class="line">  template: src=zoo.cfg dest=&#123;&#123; zk_install_dir &#125;&#125;/conf/ mode=0644</div><div class="line"></div><div class="line">- name: copy log4j to remote</div><div class="line">  template: src=log4j.properties dest=&#123;&#123; zk_install_dir &#125;&#125;/conf/log4j.properties</div><div class="line"></div><div class="line">- name: determine zk process</div><div class="line">  command: su - root -c &quot;ps aux | grep java | grep -v grep | grep &#123;&#123; zk_install_dir &#125;&#125;&quot;</div><div class="line">  register: result</div><div class="line">  ignore_errors: true</div><div class="line"></div><div class="line">- name: stop zk server</div><div class="line">  command: su - root -c &quot;sh &#123;&#123; zk_install_dir &#125;&#125;/bin/zkServer.sh  stop&quot;</div><div class="line">  ignore_errors: true</div><div class="line">  when: &quot;result.rc == 0&quot;</div><div class="line"></div><div class="line">- name: start zk server</div><div class="line">  command: su - root -c &quot;sh &#123;&#123; zk_install_dir &#125;&#125;/bin/zkServer.sh start&quot;</div><div class="line"></div><div class="line">- name: get process info</div><div class="line">  command: su - root -c &quot;ps aux | grep java | grep -v grep | grep &#123;&#123; zk_install_dir &#125;&#125;&quot;</div><div class="line">  register: result</div><div class="line"></div><div class="line">- name: clean zk service when the system reboot</div><div class="line">  command: su - root -c &quot; sed -i &apos;/&#123;&#123; zk_dir_name &#125;&#125;/d&apos; /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div><div class="line"></div><div class="line">- name: start the zk service when the system reboot</div><div class="line">  command: su - root -c &quot; echo &apos;su - root -c \&quot;&#123;&#123; zk_install_dir &#125;&#125;/bin/zkServer.sh start\&quot; &apos; &gt;&gt; /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div><div class="line"></div><div class="line">- name: start the zk service when the system reboot</div><div class="line">  shell: &quot;chmod +x /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.mydailytutorials.com/how-to-copy-files-and-directories-in-ansible-using-copy-and-fetch-modules/" target="_blank" rel="external">How to Copy Files and Directories in Ansible Using Copy and Fetch Modules</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2016/03/22/ansible PlayBook 变量/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weibo @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/22/ansible PlayBook 变量/" itemprop="url">在ansible PlayBook中如何定义不同的机器、不同的Role使用不同的变量</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-22T17:30:03+08:00">
                2016-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ansible/" itemprop="url" rel="index">
                    <span itemprop="name">Ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="在ansible-PlayBook中如何定义不同的机器、不同的Role使用不同的变量"><a href="#在ansible-PlayBook中如何定义不同的机器、不同的Role使用不同的变量" class="headerlink" title="在ansible PlayBook中如何定义不同的机器、不同的Role使用不同的变量"></a>在ansible PlayBook中如何定义不同的机器、不同的Role使用不同的变量</h1><h2 id="问题场景1"><a href="#问题场景1" class="headerlink" title="问题场景1"></a>问题场景1</h2><blockquote>
<p> 在安装Edas Agent脚本的时候发现在不同的机房[深圳、杭州、北京]有不同的网络定义[VPC、Normal],希望不同机房的机器在不同网络下使用不同的下载地址</p>
</blockquote>
<h2 id="问题场景2"><a href="#问题场景2" class="headerlink" title="问题场景2"></a>问题场景2</h2><blockquote>
<p> 在同一台机器上安装MySQL和Diamond，需要定义一个Project_Name, 如果定义在Hosts.ini中必然会覆盖，一台机器相当于一个作用域【同一个函数中也不允许你定义两个一样的名字吧！】</p>
</blockquote>
<h2 id="问题场景1的解决"><a href="#问题场景1的解决" class="headerlink" title="问题场景1的解决"></a>问题场景1的解决</h2><h3 id="在hosts-ini文件中定义不同的机器和变量"><a href="#在hosts-ini文件中定义不同的机器和变量" class="headerlink" title="在hosts.ini文件中定义不同的机器和变量"></a>在hosts.ini文件中定义不同的机器和变量</h3><pre><code>[sz_vpc]
10.125.0.169 
10.125.192.40

[sz_normal]
10.125.12.174 

[sz:children]
sz_vpc
sz_normal

[hz_vpc]
10.125.3.33  
[hz_normal]
10.125.14.238

[hz:children]
hz_vpc
hz_normal

############variables
[sz_vpc:vars]
script_url=&quot;sz_vpc&quot;

[sz_normal:vars]
script_url=&quot;sz_normal&quot;

[hz_vpc:vars]
script_url=&quot;hz_vpc&quot;

[hz_normal:vars]
script_url=&quot;hz_normal&quot;
</code></pre><h3 id="执行代码"><a href="#执行代码" class="headerlink" title="执行代码"></a>执行代码</h3><pre><code>- name: test variables
  debug: msg={{ script_url }}  #对所有机器输出他们的url来验证一下我们的定义生效没有
  tags: test
</code></pre><h3 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h3><pre><code>$udp-playbook -i udp-hosts.ini site.yml -b -u admin -t test    

UDP-PLAY-START: [apply common configuration to all nodes] ********************* 

UDP-TASK: [test variables] **************************************************** 
ok =&gt; 10.125.3.33 =&gt; {
    &quot;msg&quot;: &quot;hz_vpc&quot;
}
ok =&gt; 10.125.0.169 =&gt; {
    &quot;msg&quot;: &quot;sz_vpc&quot;
}
ok =&gt; 10.125.192.40 =&gt; {
    &quot;msg&quot;: &quot;sz_vpc&quot;
}
ok =&gt; 10.125.14.238 =&gt; {
    &quot;msg&quot;: &quot;hz_normal&quot;
}
ok =&gt; 10.125.12.174 =&gt; {
    &quot;msg&quot;: &quot;sz_normal&quot;
}
</code></pre><h2 id="问题场景2的解决"><a href="#问题场景2的解决" class="headerlink" title="问题场景2的解决"></a>问题场景2的解决</h2><blockquote>
<p>在这里变量不要放在hosts.ini中，到MySQL、Diamond的roles中新建两个yml文件,在 里面分别写上 MySQL和Diamond的 Project_Name 这样就不会覆盖了</p>
</blockquote>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ find roles</div><div class="line">roles/</div><div class="line">roles/mysql</div><div class="line">roles/mysql/tasks</div><div class="line">roles/mysql/tasks/main.yml</div><div class="line">roles/mysql/defaults</div><div class="line">roles/mysql/defaults/main.yml</div><div class="line">roles/diamond</div><div class="line">roles/diamond/tasks</div><div class="line">roles/diamond/tasks/main.yml</div><div class="line">roles/diamond/defaults</div><div class="line">roles/diamond/defaults/main.yml</div></pre></td></tr></table></figure>
</code></pre><h3 id="变量定义"><a href="#变量定义" class="headerlink" title="变量定义"></a>变量定义</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ cat roles/mysql/defaults/main.yml</div><div class="line"></div><div class="line">project: &#123;</div><div class="line">        &quot;project_name&quot;: mysql,</div><div class="line">		&quot;version&quot;: 5.6.0</div><div class="line">        &#125;</div><div class="line"></div><div class="line">$ cat roles/daimond/defaults/main.yml</div><div class="line"></div><div class="line">project: &#123;</div><div class="line">        &quot;project_name&quot;: daimond,</div><div class="line">		&quot;version&quot;: 3.5.0</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h3 id="变量使用"><a href="#变量使用" class="headerlink" title="变量使用"></a>变量使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- name: print the tar file name</div><div class="line">  debug: msg=&quot;&#123;&#123; project.project_name &#125;&#125;&quot;</div><div class="line">  tags: test</div></pre></td></tr></table></figure>
<h2 id="role-和-playbook-用法"><a href="#role-和-playbook-用法" class="headerlink" title="role 和 playbook 用法"></a>role 和 playbook 用法</h2><p>role中文件夹含义</p>
<ul>
<li>tasks目录：存放task列表。若role要生效，此目录必须要有一个主task文件main.yml，在main.yml中可以使用include包含同目录(即tasks)中的其他文件。</li>
<li>handlers目录：存放handlers的目录，若要生效，则文件必须名为main.yml文件。</li>
<li>files目录：在task中执行copy或script模块时，如果使用的是相对路径，则会到此目录中寻找对应的文件。</li>
<li>templates目录：在task中执行template模块时，如果使用的是相对路径，则会到此目录中寻找对应的模块文件。</li>
<li>vars目录：定义<strong>专属</strong>于该role的变量，如果要有var文件，则必须为main.yml文件。</li>
<li>defaults目录：<strong>定义角色默认变量，角色默认变量的优先级最低</strong>，会被任意其他层次的同名变量覆盖。如果要有var文件，则必须为main.yml文件。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook 11.harbor.yml --list-tasks</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/14/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><span class="page-number current">15</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="weibo @plantegg" />
          <p class="site-author-name" itemprop="name">weibo @plantegg</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">146</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">240</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">weibo @plantegg</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv_footer"></span>次
</span>
<span id="busuanzi_container_site_uv">
  本站访客数<span id="busuanzi_value_site_uv_footer"></span>人次
</span>


        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
