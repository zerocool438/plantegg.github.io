<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="plantegg" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="java mysql tcp performance network docker Linux">
<meta property="og:type" content="website">
<meta property="og:title" content="plantegg">
<meta property="og:url" content="https://plantegg.github.io/page/8/index.html">
<meta property="og:site_name" content="plantegg">
<meta property="og:description" content="java mysql tcp performance network docker Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="plantegg">
<meta name="twitter:description" content="java mysql tcp performance network docker Linux">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://plantegg.github.io/page/8/"/>





  <title>plantegg - java tcp mysql performance network docker Linux</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">plantegg</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">java tcp mysql performance network docker Linux</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-categories"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2018/01/23/10+倍性能提升全过程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/23/10+倍性能提升全过程/" itemprop="url">10+倍性能提升全过程</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-23T17:30:03+08:00">
                2018-01-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/performance/" itemprop="url" rel="index">
                    <span itemprop="name">performance</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="10-倍性能提升全过程–优酷账号绑定淘宝账号的TPS从500到5400的优化历程"><a href="#10-倍性能提升全过程–优酷账号绑定淘宝账号的TPS从500到5400的优化历程" class="headerlink" title="10+倍性能提升全过程–优酷账号绑定淘宝账号的TPS从500到5400的优化历程"></a>10+倍性能提升全过程–优酷账号绑定淘宝账号的TPS从500到5400的优化历程</h1><h2 id="背景说明"><a href="#背景说明" class="headerlink" title="背景说明"></a>背景说明</h2><blockquote>
<p>2016年的双11在淘宝上买买买的时候，天猫和优酷土豆一起做了联合促销，在天猫双11当天购物满XXX元就赠送优酷会员，这个过程需要用户在优酷侧绑定淘宝账号(登录优酷、提供淘宝账号，优酷调用淘宝API实现两个账号绑定）和赠送会员并让会员权益生效(看收费影片、免广告等等）</p>
<p>这里涉及到优酷的两个部门：Passport(在上海，负责登录、绑定账号，下文中的优化过程主要是Passport部分）；会员(在北京，负责赠送会员，保证权益生效）</p>
<p>在双11活动之前，Passport的绑定账号功能一直在运行，只是没有碰到过大促销带来的挑战</p>
</blockquote>
<hr>
<p>整个过程分为两大块：</p>
<ol>
<li>整个系统级别，包括网络和依赖服务的性能等，多从整个系统视角分析问题；</li>
<li>但服务器内部的优化过程，将CPU从si/sy围赶us，然后在us从代码级别一举全歼。</li>
</ol>
<p>系统级别都是最容易被忽视但是成效最明显的，代码层面都是很细致的力气活。</p>
<p>整个过程都是在对业务和架构不是非常了解的情况下做出的。</p>
<h2 id="会员部分的架构改造"><a href="#会员部分的架构改造" class="headerlink" title="会员部分的架构改造"></a>会员部分的架构改造</h2><ul>
<li>接入中间件DRDS，让优酷的数据库支持拆分，分解MySQL压力</li>
<li>接入中间件vipserver来支持负载均衡</li>
<li>接入集团DRC来保障数据的高可用</li>
<li>对业务进行改造支持Amazon的全链路压测</li>
</ul>
<h2 id="主要的压测过程"><a href="#主要的压测过程" class="headerlink" title="主要的压测过程"></a>主要的压测过程</h2><p><img src="/images/oss/6b24a854d91aba4dcdbd4f0155683d93.png" alt="screenshot.png"></p>
<p><strong>上图是压测过程中主要的阶段中问题和改进,主要的问题和优化过程如下：</strong></p>
<pre><code>- docker bridge网络性能问题和网络中断si不均衡    (优化后：500-&gt;1000TPS)
- 短连接导致的local port不够                   (优化后：1000-3000TPS)
- 生产环境snat单核导致的网络延时增大             (优化后生产环境能达到测试环境的3000TPS)
- Spring MVC Path带来的过高的CPU消耗           (优化后：3000-&gt;4200TPS)
- 其他业务代码的优化(比如异常、agent等)          (优化后：4200-&gt;5400TPS)
</code></pre><p><strong>优化过程中碰到的比如淘宝api调用次数限流等一些业务原因就不列出来了</strong></p>
<hr>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>由于用户进来后先要登录并且绑定账号，实际压力先到Passport部分，在这个过程中最开始单机TPS只能到500，经过N轮优化后基本能达到5400 TPS，下面主要是阐述这个优化过程</p>
<h2 id="Passport部分的压力"><a href="#Passport部分的压力" class="headerlink" title="Passport部分的压力"></a>Passport部分的压力</h2><h3 id="Passport-核心服务分两个："><a href="#Passport-核心服务分两个：" class="headerlink" title="Passport 核心服务分两个："></a>Passport 核心服务分两个：</h3><ul>
<li>Login              主要处理登录请求</li>
<li>userservice    处理登录后的业务逻辑，比如将优酷账号和淘宝账号绑定</li>
</ul>
<p>为了更好地利用资源每台物理加上部署三个docker 容器，跑在不同的端口上(8081、8082、8083），通过bridge网络来互相通讯</p>
<h3 id="Passport机器大致结构"><a href="#Passport机器大致结构" class="headerlink" title="Passport机器大致结构"></a>Passport机器大致结构</h3><p><img src="/images/oss/b509b30218dd22e03149985cf5e15f8e.png" alt="screenshot.png"></p>
<!--这里的500 TPS到5400 TPS是指登录和将优酷账号和淘宝账号绑定的TPS，也是促销活动主要的瓶颈-->
<h3 id="userservice服务网络相关的各种问题"><a href="#userservice服务网络相关的各种问题" class="headerlink" title="userservice服务网络相关的各种问题"></a>userservice服务网络相关的各种问题</h3><hr>
<h4 id="太多SocketConnect异常-如上图）"><a href="#太多SocketConnect异常-如上图）" class="headerlink" title="太多SocketConnect异常(如上图）"></a>太多SocketConnect异常(如上图）</h4><p>在userservice机器上通过netstat也能看到大量的SYN_SENT状态，如下图：<br><img src="/images/oss/99bf952b880f17243953da790ff0e710.png" alt="image.png"></p>
<h4 id="因为docker-bridge通过nat来实现，尝试去掉docker，让tomcat直接跑在物理机上"><a href="#因为docker-bridge通过nat来实现，尝试去掉docker，让tomcat直接跑在物理机上" class="headerlink" title="因为docker bridge通过nat来实现，尝试去掉docker，让tomcat直接跑在物理机上"></a>因为docker bridge通过nat来实现，尝试去掉docker，让tomcat直接跑在物理机上</h4><p>这时SocketConnect异常不再出现<br><img src="/images/oss/6ed62fd6b50ad2785e5b57687d95ad6e.png" alt="image.png"></p>
<h4 id="从新梳理一下网络流程"><a href="#从新梳理一下网络流程" class="headerlink" title="从新梳理一下网络流程"></a>从新梳理一下网络流程</h4><p>docker(bridge)—-短连接—&gt;访问淘宝API(淘宝open api只能短连接访问），性能差，cpu都花在si上； </p>
<p>如果 docker(bridge)—-长连接到宿主机的某个代理上(比如haproxy）—–短连接—&gt;访问淘宝API， 性能就能好一点。问题可能是短连接放大了Docker bridge网络的性能损耗</p>
<h4 id="当时看到的cpu-si非常高，截图如下："><a href="#当时看到的cpu-si非常高，截图如下：" class="headerlink" title="当时看到的cpu si非常高，截图如下："></a>当时看到的cpu si非常高，截图如下：</h4><p><img src="/images/oss/4c1eff0f925f59977e2557acff5cf03b.png" alt="image.png"></p>
<p>去掉Docker后，性能有所提升，继续通过perf top看到内核态寻找可用的Local Port消耗了比较多的CPU，gif动态截图如下(可以点击看高清大图）：</p>
<p><img src="/images/oss/fff502ca73e3112e585560ffe4a4dbf1.gif" alt="perf-top-netLocalPort-issue.gif"></p>
<p><strong>注意图中ipv6_rcv_saddr_equal和inet_csk_get_port 总共占了30%的CPU</strong> (系统态的CPU使用率高意味着共享资源有竞争或者I/O设备之间有大量的交互。)</p>
<p><strong>一般来说一台机器默认配置的可用 Local Port 3万多个，如果是短连接的话，一个连接释放后默认需要60秒回收，30000/60 =500 这是大概的理论TPS值【这里只考虑连同一个server IP:port 的时候】</strong></p>
<p>这500的tps算是一个老中医的经验。不过有些系统调整过Local Port取值范围，比如从1024到65534，那么这个tps上限就是1000附近。</p>
<p>同时观察这个时候CPU的主要花在sy上，最理想肯定是希望CPU主要用在us上，截图如下：<br><img src="/images/oss/05703c168e63e96821ea9f921d83712b.png" alt="image.png"></p>
<p><strong>规则：性能优化要先把CPU从SI、SY上的消耗赶到US上去(通过架构、系统配置）；然后提升 US CPU的效率(代码级别的优化）</strong></p>
<p>sy占用了30-50%的CPU，这太不科学了，同时通过 netstat 分析连接状态，确实看到很多TIME_WAIT：<br><img src="/images/oss/2ae2cb8b0cb324b68ca22c48c019e029.png" alt="localportissue-time-wait.png"></p>
<p><strong>cpu要花在us上，这部分才是我们代码吃掉的</strong></p>
<p><strong><em>于是让PE修改了tcp相关参数：降低 tcp_max_tw_buckets和开启tcp_tw_reuse，这个时候TPS能从1000提升到3000</em></strong></p>
<p>鼓掌，赶紧休息，迎接双11啊</p>
<p><img src="/images/oss/91353fb9c88116be3ff109e3528a4651.png" alt="image.png"></p>
<h2 id="测试环境优化到3000-TPS后上线继续压测"><a href="#测试环境优化到3000-TPS后上线继续压测" class="headerlink" title="测试环境优化到3000 TPS后上线继续压测"></a>测试环境优化到3000 TPS后上线继续压测</h2><p><strong>居然性能又回到了500，太沮丧了</strong>，其实最开始账号绑定慢，Passport这边就怀疑taobao api是不是在大压力下不稳定，一般都是认为自己没问题，有问题的一定是对方。我不觉得这有什么问题，要是知道自己有什么问题不早就优化掉了，但是这里缺乏证据支撑，也就是如果你觉得自己没有问题或者问题在对方，一定要拿出证据来(有证据那么大家可以就证据来讨论，而不是互相苍白地推诿）。</p>
<p>这个时候Passport更加理直气壮啊，好不容易在测试环境优化到3000，怎么一调taobao api就掉到500呢，这么点压力你们就扛不住啊。 但是taobao api那边给出调用数据都是1ms以内就返回了(alimonitor监控图表–拿证据说话）。</p>
<p>看到alimonitor给出的api响应时间图表后，我开始怀疑从优酷的机器到淘宝的机器中间链路上有瓶颈，但是需要设计方案来证明这个问题在链路上，要不各个环节都会认为自己没有问题的，问题就会卡死。但是当时Passport的开发也只能拿到Login和Userservice这两组机器的权限，中间的负载均衡、交换机都没有权限接触到。</p>
<p>在没有证据的情况下，肯定机房、PE配合你排查的欲望基本是没有的(被坑过很多回啊，你说我的问题，结果几天配合排查下来发现还是你程序的问题，凭什么我要每次都陪你玩？），所以我要给出证明问题出现在网络链路上，然后拿着这个证据跟网络的同学一起排查。</p>
<p>讲到这里我禁不住要插一句，在出现问题的时候，都认为自己没有问题这是正常反应，毕竟程序是看不见的，好多意料之外逻辑考虑不周全也是常见的，出现问题按照自己的逻辑自查的时候还是没有跳出之前的逻辑所以发现不了问题。但是好的程序员在问题的前面会尝试用各种手段去证明问题在哪里，而不是复读机一样我的逻辑是这样的，不可能出问题的。即使目的是证明问题在对方，只要能给出明确的证据都是负责任的，拿着证据才能理直气壮地说自己没有问题和干净地甩锅。</p>
<p><strong>在尝试过tcpdump抓包、ping等各种手段分析后，设计了场景证明问题在中间链路上。</strong></p>
<h3 id="设计如下三个场景证明问题在中间链路上："><a href="#设计如下三个场景证明问题在中间链路上：" class="headerlink" title="设计如下三个场景证明问题在中间链路上："></a>设计如下三个场景证明问题在中间链路上：</h3><ol>
<li>压测的时候在userservice ping 依赖服务的机器；</li>
<li>将一台userservice机器从负载均衡上拿下来(没有压力），ping 依赖服务的机器；</li>
<li>从公网上非我们机房的机器 ping 依赖服务的机器；</li>
</ol>
<p>这个时候奇怪的事情发现了，压力一上来<strong>场景1、2</strong>的两台机器ping淘宝的rt都从30ms上升到100-150ms，<strong>场景1</strong> 的rt上升可以理解，但是<strong>场景2</strong>的rt上升不应该，同时<strong>场景3</strong>中ping淘宝在压力测试的情况下rt一直很稳定(说明压力下淘宝的机器没有问题），到此确认问题在优酷到淘宝机房的链路上有瓶颈，而且问题在优酷机房出口扛不住这么大的压力。于是从上海Passport的团队找到北京Passport的PE团队，确认在优酷调用taobao api的出口上使用了snat，PE到snat机器上看到snat只能使用单核，而且对应的核早就100%的CPU了，因为之前一直没有这么大的压力所以这个问题一直存在只是没有被发现。</p>
<p><strong>于是PE去掉snat，再压的话 TPS稳定在3000左右</strong></p>
<hr>
<h2 id="到这里结束了吗？-从3000到5400TPS"><a href="#到这里结束了吗？-从3000到5400TPS" class="headerlink" title="到这里结束了吗？ 从3000到5400TPS"></a>到这里结束了吗？ 从3000到5400TPS</h2><p>优化到3000TPS的整个过程没有修改业务代码，只是通过修改系统配置、结构非常有效地把TPS提升了6倍，对于优化来说这个过程是最轻松，性价比也是非常高的。实际到这个时候也临近双11封网了，最终通过计算(机器数量*单机TPS）完全可以抗住双11的压力，所以最终双11运行的版本就是这样的。 但是有工匠精神的工程师是不会轻易放过这么好的优化场景和环境的(基线、机器、代码、工具都具备配套好了）</p>
<p><strong>优化完环境问题后，3000TPS能把CPU US跑上去，于是再对业务代码进行优化也是可行的了</strong>。</p>
<h3 id="进一步挖掘代码中的优化空间"><a href="#进一步挖掘代码中的优化空间" class="headerlink" title="进一步挖掘代码中的优化空间"></a>进一步挖掘代码中的优化空间</h3><p>双11前的这段封网其实是比较无聊的，于是和Passport的开发同学们一起挖掘代码中的可以优化的部分。这个过程中使用到的主要工具是这三个：火焰图、perf、perf-map-java。相关链接：<a href="http://www.brendangregg.com/perf.html" target="_blank" rel="external">http://www.brendangregg.com/perf.html</a> ; <a href="https://github.com/jrudolph/perf-map-agent" target="_blank" rel="external">https://github.com/jrudolph/perf-map-agent</a></p>
<h3 id="通过Perf发现的一个SpringMVC-的性能问题"><a href="#通过Perf发现的一个SpringMVC-的性能问题" class="headerlink" title="通过Perf发现的一个SpringMVC 的性能问题"></a>通过Perf发现的一个SpringMVC 的性能问题</h3><p>这个问题具体参考我之前发表的优化文章。 主要是通过火焰图发现spring mapping path消耗了过多CPU的性能问题，CPU热点都在methodMapping相关部分，于是修改代码去掉spring中的methodMapping解析后性能提升了40%，TPS能从3000提升到4200.</p>
<h3 id="著名的fillInStackTrace导致的性能问题"><a href="#著名的fillInStackTrace导致的性能问题" class="headerlink" title="著名的fillInStackTrace导致的性能问题"></a>著名的fillInStackTrace导致的性能问题</h3><p>代码中的第二个问题是我们程序中很多异常(fillInStackTrace），实际业务上没有这么多错误，应该是一些不重要的异常，不会影响结果，但是异常频率很高，对这种我们可以找到触发的地方，catch住，然后不要抛出去(也就是别触发fillInStackTrace)，打印一行error日志就行，这块也能省出10%的CPU，对应到TPS也有几百的提升。</p>
<p><img src="/images/oss/36ef4b16c3c400abf6eb7e6b0fbb2f58.png" alt="screenshot.png"></p>
<p>部分触发fillInStackTrace的场景和具体代码行(点击看高清大图）：<br><img src="/images/oss/7eb2cbb4afc2c7d7007c35304c95342a.png" alt="screenshot.png"></p>
<p>对应的火焰图(点击看高清大图）：<br><img src="/images/oss/894bd736dd03060e89e3fa49cc98ae5e.png" alt="screenshot.png"></p>
<p><img src="/images/oss/2bb7395a2cc6833c9c7587b38402a301.png" alt="screenshot.png"></p>
<h3 id="解析useragent-代码部分的性能问题"><a href="#解析useragent-代码部分的性能问题" class="headerlink" title="解析useragent 代码部分的性能问题"></a>解析useragent 代码部分的性能问题</h3><p>整个useragent调用堆栈和cpu占用情况，做了个汇总(useragent不启用TPS能从4700提升到5400）<br><img src="/images/oss/8a4a97cb74724b8baa3b90072a1914e0.png" alt="screenshot.png"></p>
<p>实际火焰图中比较分散：<br><img src="/images/oss/afacc681a9550cd087838c2383be54c8.png" alt="screenshot.png"></p>
<p><strong>最终通过对代码的优化勉勉强强将TPS从3000提升到了5400(太不容易了，改代码过程太辛苦，不如改配置来得快）</strong></p>
<p>优化代码后压测tps可以跑到5400，截图：</p>
<p><img src="/images/oss/38bb043c85c7b50007609484c7bf5698.png" alt="image.png"></p>
<h2 id="最后再次总结整个压测过程的问题和优化历程"><a href="#最后再次总结整个压测过程的问题和优化历程" class="headerlink" title="最后再次总结整个压测过程的问题和优化历程"></a>最后再次总结整个压测过程的问题和优化历程</h2><pre><code>- docker bridge网络性能问题和网络中断si不均衡    (优化后：500-&gt;1000TPS)
- 短连接导致的local port不够                   (优化后：1000-3000TPS）
- 生产环境snat单核导致的网络延时增大             (优化后能达到测试环境的3000TPS）
- Spring MVC Path带来的过高的CPU消耗           (优化后：3000-&gt;4200TPS)
- 其他业务代码的优化(比如异常、agent等）         (优化后：4200-&gt;5400TPS)
</code></pre><p><img src="/images/oss/2be2799d1eef982d77e5c0a5c896a0e9.png" alt="image.png"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2018/01/01/通过tcpdump对Unix Socket 进行抓包解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/01/通过tcpdump对Unix Socket 进行抓包解析/" itemprop="url">通过tcpdump对Unix Domain Socket 进行抓包解析</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-01T16:30:03+08:00">
                2018-01-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tcpdump/" itemprop="url" rel="index">
                    <span itemprop="name">tcpdump</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="通过tcpdump对Unix-domain-Socket-进行抓包解析"><a href="#通过tcpdump对Unix-domain-Socket-进行抓包解析" class="headerlink" title="通过tcpdump对Unix domain Socket 进行抓包解析"></a>通过tcpdump对Unix domain Socket 进行抓包解析</h1><h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p>大多时候我们可以通过tcpdump对网络抓包分析请求、响应数据来排查问题。但是如果程序是通过Unix Domain Socket方式来访问的那么tcpdump就看不到Unix Domain Socket里面具体流淌的内容了，本文希望找到一种方法达到如同抓包查看网卡内容一样来抓包查看Unix Domain Socket上具体的请求、响应数据。</p>
<h2 id="socat工具"><a href="#socat工具" class="headerlink" title="socat工具"></a>socat工具</h2><p>类似nc，但是是个超级增强版的nc，<a href="https://payloads.online/tools/socat" target="_blank" rel="external">主要用作两个独立数据通道之间的双向数据传输的继电器（或者说代理）</a></p>
<p>基本原理，通过socat在Unix-Socket和TCP/UDP port之间建立一个代理，然后对代理上的端口进行抓包。</p>
<p>以下案例通过对 docker.sock 抓包来分析方案。大多时候我们都可以通过curl 来将http post请求发送到docker deamon所监听的端口，这些请求和响应都可以通过tcpdump抓包分析得到。但是我们通过 docker ps / docker run 将命令发给本地 docker-deamon的时候就是将请求翻译成 http请求发给了 docker.sock, 这个时候如果需要排查问题就没法用tcpdump来分析http内容了。</p>
<h2 id="通过socat-启动一个tcp端口来代理Unix-Domain-Socket"><a href="#通过socat-启动一个tcp端口来代理Unix-Domain-Socket" class="headerlink" title="通过socat 启动一个tcp端口来代理Unix Domain Socket"></a>通过socat 启动一个tcp端口来代理Unix Domain Socket</h2><p>启动本地8080端口，将docker.sock映射到8080端口,8080收到的东西都会转给docker.sock，docker.sock收到的东西都通过抓8080的包看到,但是要求应用访问8080而不是docker.sock。</p>
<pre><code>socat -d -d TCP-LISTEN:8080,fork,bind=127.0.0.1 UNIX:/var/run/docker.sock
</code></pre><p><strong>缺点：需要修改客户端的访问方式</strong></p>
<pre><code>sudo curl --unix-socket /var/run/docker.sock http://localhost/images/json
</code></pre><p>上面的访问方式对8080抓包还是抓不到，因为绕过了我们的代理。</p>
<p>只能通过如下方式访问8080端口，然后请求通过socat代理转发给docker.sock，整个结果跟访问–unix-socket是一样的，这个时候通过8080端口抓包能看到–unix-socket的工作数据</p>
<pre><code>sudo curl http://localhost:8080/images/json
</code></pre><h2 id="通过socat启动另外一个Unix-Domain-Socket代理，但是不是tcpdump抓包"><a href="#通过socat启动另外一个Unix-Domain-Socket代理，但是不是tcpdump抓包" class="headerlink" title="通过socat启动另外一个Unix Domain Socket代理，但是不是tcpdump抓包"></a>通过socat启动另外一个Unix Domain Socket代理，但是不是tcpdump抓包</h2><pre><code>sudo mv /var/run/docker.sock /var/run/docker.sock.original
sudo socat -t100 -d -x -v UNIX-LISTEN:/var/run/docker.sock,mode=777,reuseaddr,fork UNIX-CONNECT:/var/run/docker.sock.original
</code></pre><p>优点：客户端访问方式不变，还是直接访问–unix-socket<br>缺点：输出的数据不如tcpdump方便，也就不能用wireshark来分析了</p>
<p>本质也还是socat代理，只是不是用的一个tcp端口来代理了，而是通过一个unix-socet代理了另外一个unix-socket，直接在代理上输出所有收发的数据</p>
<h2 id="完美的办法，客户端不用改访问方式，tcpdump也能抓到数据"><a href="#完美的办法，客户端不用改访问方式，tcpdump也能抓到数据" class="headerlink" title="完美的办法，客户端不用改访问方式，tcpdump也能抓到数据"></a>完美的办法，客户端不用改访问方式，tcpdump也能抓到数据</h2><pre><code>sudo mv /var/run/docker.sock /var/run/docker.sock.original
sudo socat TCP-LISTEN:8089,reuseaddr,fork UNIX-CONNECT:/var/run/docker.sock.original
sudo socat UNIX-LISTEN:/var/run/docker.sock,fork TCP-CONNECT:127.0.0.1:8089
</code></pre><p>然后客户端还是直接访问–unix-socket<br>    sudo curl –unix-socket /var/run/docker.sock <a href="http://localhost/images/json" target="_blank" rel="external">http://localhost/images/json</a></p>
<p>这个时候通过tcpdump在8089端口上就能抓到数据了</p>
<pre><code>sudo tcpdump -i lo -netvv port 8089
</code></pre><p>实际是结合前面两种方法，做了两次代理，先将socket映射到8089端口上，然后再将8089端口映射到一个新的socket上，最后client访问这个新的socket。</p>
<p>实际流程如下： client -&gt; 新socket -&gt; 8089 -&gt; 原来的socket  这个时候对8089可以任意抓包了</p>
<p>参考来源：<a href="https://mivehind.net/2018/04/20/sniffing-unix-domain-sockets/" target="_blank" rel="external">https://mivehind.net/2018/04/20/sniffing-unix-domain-sockets/</a>    </p>
<h2 id="一些socat的其它用法"><a href="#一些socat的其它用法" class="headerlink" title="一些socat的其它用法"></a>一些socat的其它用法</h2><p> 把监听在远程主机12.34.56.78上的mysql服务Unix Domain Socket映射到本地的/var/run/mysqld.temp.sock, 这样就可以用mysql -S /var/run/mysqld/mysqld.sock来访问远程主机的mysql服务了。</p>
<pre><code>socat &quot;UNIX-LISTEN:/var/run/mysqld.temp.sock,reuseaddr,fork&quot; EXEC:&quot;ssh root@12.34.56.78 socat STDIO UNIX-CONNECT:/var/run/mysqld/mysqld.sock&quot;
</code></pre><p> 还可以用下面的命令把12.34.56.78上的mysql映射到本地的5500端口，然后使用mysql -p 5500命令访问。</p>
<pre><code>socat TCP-LISTEN:5500 EXEC:&apos;ssh root@12.34.56.78 &quot;socat STDIO UNIX-CONNECT:/var/run/mysqld/mysqld.sock&quot;&apos;
</code></pre><p> 把12.34.56.78的udp 161端口映射到本地的1611端口</p>
<pre><code>socat udp-listen:1611 system:&apos;ssh root@12.34.56.78 &quot;socat stdio udp-connect:remotetarget:161&quot;&apos;    
</code></pre><p> 通过socat启动server，带有各种参数，比nc更灵活</p>
<pre><code>Server: socat -dd tcp-listen:2000,keepalive,keepidle=10,keepcnt=2,reuseaddr,keepintvl=1 -
Client: socat -dd - tcp:localhost:2000,keepalive,keepidle=10,keepcnt=2,keepintvl=1

Drop Connection (Unplug Cable, Shut down Link(WiFi/Interface)): sudo iptables -A INPUT -p tcp --dport 2000 -j DROP
</code></pre><p>启动本地8080端口，将docker.sock映射到8080端口(docker.sock收到的东西都通过抓8080的包看到)。 8080收到的东西都会转给docker.sock</p>
<pre><code>socat -d -d TCP-LISTEN:8080,fork,bind=99.13.252.208 UNIX:/var/run/docker.sock
</code></pre><h3 id="用socat远程Unix-Domain-Socket映射"><a href="#用socat远程Unix-Domain-Socket映射" class="headerlink" title="用socat远程Unix Domain Socket映射"></a>用socat远程Unix Domain Socket映射</h3><p>除了将我们本地服务通过端口映射提供给其它人访问，我们还可以通过端口转发玩一些更high的。比如下面这条命令，它把监听在远程主机12.34.56.78上的mysql服务Unix Domain Socket映射到本地的/var/run/mysqld.temp.sock，这样，小明就可以用mysql -S /var/run/mysqld/mysqld.temp.sock来访问远程主机的mysql服务了。</p>
<pre><code>socat &quot;UNIX-LISTEN:/var/run/mysqld.temp.sock,reuseaddr,fork&quot; EXEC:&quot;ssh root@12.34.56.78 socat STDIO UNIX-CONNECT\:/var/run/mysqld/mysqld.sock&quot;
</code></pre><p>当然，小明如果不喜欢本地Unix Domain Socket，他还可以用下面的命令把12.34.56.78上的mysql映射到本地的5500端口，然后使用mysql -p 5500命令访问。</p>
<pre><code>socat TCP-LISTEN:5500 EXEC:&apos;ssh root@12.34.56.78 &quot;socat STDIO UNIX-CONNECT:/var/run/mysqld/mysqld.sock&quot;&apos;

# 把监听在远程主机12.34.56.78上的mysql服务Unix Domain Socket映射到本地的/var/run/mysqld.temp.sock, 这样就可以用mysql -S /var/run/mysqld/mysqld.sock来访问远程主机的mysql服务了。
socat &quot;UNIX-LISTEN:/var/run/mysqld.temp.sock,reuseaddr,fork&quot; EXEC:&quot;ssh root@12.34.56.78 socat STDIO UNIX-CONNECT:/var/run/mysqld/mysqld.sock&quot;
# 还可以用下面的命令把12.34.56.78上的mysql映射到本地
# 的5500端口，然后使用mysql -p 5500命令访问。
socat TCP-LISTEN:5500 EXEC:&apos;ssh root@12.34.56.78 &quot;socat STDIO UNIX-CONNECT:/var/run/mysqld/mysqld.sock&quot;&apos;
# 把12.34.56.78的udp 161端口映射到本地的1611端口：
socat udp-listen:1611 system:&apos;ssh root@12.34.56.78 &quot;socat stdio udp-connect:remotetarget:161&quot;&apos;
</code></pre><h2 id="socat启动网络服务"><a href="#socat启动网络服务" class="headerlink" title="socat启动网络服务"></a>socat启动网络服务</h2><p>在一个窗口中启动 <code>socat</code> 作为服务端，监听在 1000 端口：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> start a TCP listener at port 1000, and <span class="built_in">echo</span> back the received data</span></div><div class="line"><span class="meta">$</span><span class="bash"> sudo socat TCP4-LISTEN:1000,fork <span class="built_in">exec</span>:cat</span></div></pre></td></tr></table></figure>
<p>另一个窗口用 <code>nc</code> 作为客户端来访问服务端，建立 socket：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> connect to the <span class="built_in">local</span> TCP listener at port 1000</span></div><div class="line"><span class="meta">$</span><span class="bash"> nc localhost 1000</span></div></pre></td></tr></table></figure>
<h2 id="curl-7-57版本可以直接访问-–unix-socket"><a href="#curl-7-57版本可以直接访问-–unix-socket" class="headerlink" title="curl 7.57版本可以直接访问 –unix-socket"></a>curl 7.57版本可以直接访问 –unix-socket</h2><p>7.57之后的版本才支持curl –unix-socket，大大方便了我们的测试</p>
<pre><code>//Leave 测试断开一个网络
curl -H &quot;Content-Type: application/json&quot; -X POST -d &apos;{&quot;NetworkID&quot;:&quot;47866b0071e3df7e8053b9c8e499986dfe5c9c4947012db2d963c66ca971ed4b&quot;,&quot;EndpointID&quot;:&quot;3d716436e629701d3ce8650e7a85c133b0ff536aed173c624e4f62a381656862&quot;}&apos; --unix-socket /run/docker/plugins/vlan.sock http://localhost/NetworkDriver.Leave

//取镜像列表
sudo curl --unix-socket /var/run/docker.sock http://localhost/images/json

curl 11.239.155.97:2376/debug/pprof/goroutine?debug=2
echo -e &quot;GET /debug/pprof/goroutine?debug=2 HTTP/1.1\r\n&quot; | sudo nc -U /run/docker/plugins/vlan.sock
echo -e &quot;GET /debug/pprof/goroutine?debug=2 HTTP/1.1\r\n&quot; | sudo nc -U /var/run/docker.sock
//升级curl到7.57后支持 --unix-socket
sudo curl --unix-socket /var/run/docker.sock http://localh卡路里ost/images/json
sudo curl --unix-socket /run/docker/plugins/vlan.sock http://localhost/NetworkDriver.GetCapabilities
//Leave
curl -H &quot;Content-Type: application/json&quot; -X POST -d &apos;{&quot;NetworkID&quot;:&quot;47866b0071e3df7e8053b9c8e499986dfe5c9c4947012db2d963c66ca971ed4b&quot;,&quot;EndpointID&quot;:&quot;3d716436e629701d3ce8650e7a85c133b0ff536aed173c624e4f62a381656862&quot;}&apos; --unix-socket /run/docker/plugins/vlan.sock http://localhost/NetworkDriver.Leave

sudo curl --no-buffer -XGET --unix-socket /var/run/docker.sock http://localhost/events
</code></pre><h2 id="Unix-Domain-Socket工作原理"><a href="#Unix-Domain-Socket工作原理" class="headerlink" title="Unix Domain Socket工作原理"></a><a href="https://mp.weixin.qq.com/s/fHzKYlW0WMhP2jxh2H_59A" target="_blank" rel="external">Unix Domain Socket工作原理</a></h2><p>接收connect 请求的时候，会申请一个新 socket 给 server 端将来使用，和自己的 socket 建立好连接关系以后，就放到服务器正在监听的 socket 的接收队列中。这个时候，服务器端通过 accept 就能获取到和客户端配好对的新 socket 了。</p>
<p><img src="/images/951413iMgBlog/640-0054201." alt="Image"></p>
<p>主要的连接操作都是在这个函数中完成的。和我们平常所见的 TCP 连接建立过程，这个连接过程简直是太简单了。没有三次握手，也没有全连接队列、半连接队列，更没有啥超时重传。</p>
<p>直接就是将两个 socket 结构体中的指针互相指向对方就行了。就是 unix_peer(newsk) = sk 和 unix_peer(sk) = newsk 这两句。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//file: net/unix/af_unix.c</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_connect</span><span class="params">(struct socket *sock, struct sockaddr *uaddr,</span></span></div><div class="line">          <span class="keyword">int</span> addr_len, <span class="keyword">int</span> flags)</div><div class="line">&#123;</div><div class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> *<span class="title">sunaddr</span> = (<span class="title">struct</span> <span class="title">sockaddr_un</span> *)<span class="title">uaddr</span>;</span></div><div class="line"></div><div class="line"> <span class="comment">// 1. 为服务器侧申请一个新的 socket 对象</span></div><div class="line"> newsk = unix_create1(sock_net(sk), <span class="literal">NULL</span>);</div><div class="line"></div><div class="line"> <span class="comment">// 2. 申请一个 skb，并关联上 newsk</span></div><div class="line"> skb = sock_wmalloc(newsk, <span class="number">1</span>, <span class="number">0</span>, GFP_KERNEL);</div><div class="line"> ...</div><div class="line"></div><div class="line"> <span class="comment">// 3. 建立两个 sock 对象之间的连接</span></div><div class="line"> unix_peer(newsk) = sk;</div><div class="line"> newsk-&gt;sk_state  = TCP_ESTABLISHED;</div><div class="line"> newsk-&gt;sk_type  = sk-&gt;sk_type;</div><div class="line"> ...</div><div class="line"> sk-&gt;sk_state = TCP_ESTABLISHED;</div><div class="line"> unix_peer(sk) = newsk;</div><div class="line"></div><div class="line"> <span class="comment">// 4. 把连接中的一头（新 socket）放到服务器接收队列中</span></div><div class="line"> __skb_queue_tail(&amp;other-&gt;sk_receive_queue, skb);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//file: net/unix/af_unix.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> unix_peer(sk) (unix_sk(sk)-&gt;peer)</span></div></pre></td></tr></table></figure>
<p>收发包过程和复杂的 TCP 发送接收过程相比，这里的发送逻辑简单简单到令人发指。申请一块内存（skb），把数据拷贝进去。根据 socket 对象找到另一端，<strong>直接把 skb 给放到对端的接收队列里了</strong></p>
<p><img src="/images/951413iMgBlog/640-20211221105837677" alt="Image"></p>
<p>Unix Domain Socket和127.0.0.1通信相比，如果包的大小是1K以内，那么性能会有一倍以上的提升，包变大后性能的提升相对会小一些。</p>
<h2 id="tcpdump原理"><a href="#tcpdump原理" class="headerlink" title="tcpdump原理"></a>tcpdump原理</h2><p><img src="/images/oss/0923eefc85c1bf87f47591222532f1f2.png" alt="image.png"></p>
<p>tcpdump 抓包使用的是 libpcap 这种机制。它的大致原理是：在收发包时，如果该包符合 tcpdump 设置的规则（BPF filter），那么该网络包就会被拷贝一份到 tcpdump 的内核缓冲区，然后以 PACKET_MMAP 的方式将这部分内存映射到 tcpdump 用户空间，解析后就会把这些内容给输出了。</p>
<p>通过上图你也可以看到，在收包的时候，如果网络包已经被网卡丢弃了，那么 tcpdump 是抓不到它的；在发包的时候，如果网络包在协议栈里被丢弃了，比如因为发送缓冲区满而被丢弃，tcpdump 同样抓不到它。我们可以将 tcpdump 的能力范围简单地总结为：网卡以内的问题可以交给 tcpdump 来处理；对于网卡以外（包括网卡上）的问题，tcpdump 可能就捉襟见肘了。这个时候，你需要在对端也使用 tcpdump 来抓包。</p>
<h3 id="tcpdump-技巧"><a href="#tcpdump-技巧" class="headerlink" title="tcpdump 技巧"></a>tcpdump 技巧</h3><blockquote>
<p>tcpdump -B/<strong>–buffer-size=*</strong>buffer_size:<em>Set the operating system capture buffer size to </em>buffer_size<em>, in units of KiB (1024 bytes). tcpdump 丢包，造成这种丢包的原因是由于libcap抓到包后，tcpdump上层没有及时的取出，导致libcap缓冲区溢出，从而覆盖了未处理包，此处即显示为<em>*dropped by kernel</em></em>，注意，这里的kernel并不是说是被linux内核抛弃的，而是被tcpdump的内核，即libcap抛弃掉的</p>
</blockquote>
<h3 id="获取接口设备列表"><a href="#获取接口设备列表" class="headerlink" title="获取接口设备列表"></a>获取接口设备列表</h3><p>tcpdump的<code>-D</code>获取接口设备列表。看到此列表后，可以决定要在哪个接口上捕获流量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">#tcpdump -D</div><div class="line">1.eth0</div><div class="line">2.bond0</div><div class="line">3.docker0</div><div class="line">4.nflog (Linux netfilter log (NFLOG) interface)</div><div class="line">5.nfqueue (Linux netfilter queue (NFQUEUE) interface)</div><div class="line">6.eth1</div><div class="line">7.usbmon1 (USB bus number 1)</div><div class="line">8.usbmon2 (USB bus number 2)</div><div class="line">9.veth6f2ee76</div><div class="line">10.veth8cb61c2</div><div class="line">11.veth9d9d363</div><div class="line">12.veth16c25ac</div><div class="line">13.veth190f0fc</div><div class="line">14.veth07103d7</div><div class="line">15.veth09119c0</div><div class="line">16.veth9770e1a</div><div class="line">17.any (Pseudo-device that captures on all interfaces)</div><div class="line">18.lo [Loopback]</div><div class="line"></div><div class="line"># tcpdump -X //解析内容</div></pre></td></tr></table></figure>
<h2 id="TCP-疑难问题的轻量级分析手段：TCP-Tracepoints"><a href="#TCP-疑难问题的轻量级分析手段：TCP-Tracepoints" class="headerlink" title="TCP 疑难问题的轻量级分析手段：TCP Tracepoints"></a>TCP 疑难问题的轻量级分析手段：TCP Tracepoints</h2><p>Tracepoint 是我分析问题常用的手段之一，在遇到一些疑难问题时，我通常都会把一些相关的 Tracepoint 打开，把 Tracepoint 输出的内容保存起来，然后再在线下环境中分析。通常，我会写一些 Python 脚本来分析这些内容，毕竟 Python 在数据分析上还是很方便的。</p>
<p>对于 TCP 的相关问题，我也习惯使用这些 TCP Tracepoints 来分析问题。要想使用这些 Tracepoints，你的内核版本需要为 <strong>4.16</strong> 及以上。这些常用的 TCP Tracepoints 路径位于 /sys/kernel/debug/tracing/events/tcp/ 和 /sys/kernel/debug/tracing/events/sock/，它们的作用如下表所示：</p>
<p><img src="/images/oss/32f29686127beb5a3279e630259903ae.png" alt="image.png"></p>
<h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><p><a href="https://mivehind.net/2018/04/20/sniffing-unix-domain-sockets/" target="_blank" rel="external">https://mivehind.net/2018/04/20/sniffing-unix-domain-sockets/</a>    </p>
<p><a href="https://superuser.com/questions/484671/can-i-monitor-a-local-unix-domain-socket-like-tcpdump" target="_blank" rel="external">https://superuser.com/questions/484671/can-i-monitor-a-local-unix-domain-socket-like-tcpdump</a></p>
<p><a href="https://payloads.online/tools/socat" target="_blank" rel="external">https://payloads.online/tools/socat</a></p>
<p><a href="https://gaia.cs.umass.edu/kurose_ross/wireshark.php" target="_blank" rel="external">计算机网络</a>（Computer Networking: A Top-Down Approach）</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/12/15/从知识到能力，你到底欠缺了什么/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/15/从知识到能力，你到底欠缺了什么/" itemprop="url">从知识到能力，你到底欠缺了什么</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-15T17:30:03+08:00">
                2017-12-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index">
                    <span itemprop="name">network</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="从知识到能力，你到底欠缺了什么"><a href="#从知识到能力，你到底欠缺了什么" class="headerlink" title="从知识到能力，你到底欠缺了什么"></a>从知识到能力，你到底欠缺了什么</h1><h2 id="写在最前面的"><a href="#写在最前面的" class="headerlink" title="写在最前面的"></a>写在最前面的</h2><p>前面推送过文章<a href="https://mp.weixin.qq.com/s/JlXWLpQSyj3Z_KMyUmzBPA" target="_blank" rel="external">《毕业3年，为何技术能力相差越来越大？》</a> 有些同学觉得还是不知道如何落地，那么本文希望借助一个程序员经常遇到的一个问题：网络为什么不通？ 来具体展开实践一下怎么将书本上的死知识真正变成我们解决问题的能力。</p>
<h2 id="大学学到的基本概念"><a href="#大学学到的基本概念" class="headerlink" title="大学学到的基本概念"></a>大学学到的基本概念</h2><p>我相信你脑子里关于网络基础知识的概念都在下面这张图上，但是有点乱，都认识，又都模模糊糊，更谈不上将他们转化成生产力，用来解决实际问题了。这就是因为知识没有贯通、没有实践、没有组织。</p>
<p><img src="/images/oss/d37028807148f8ec630512bdd4223335.png" alt="image.png"></p>
<p>上图中知识点的作用在<a href="https://tools.ietf.org/html/rfc1180" target="_blank" rel="external">RFC1180</a>中讲的无比的通熟易懂了，看第一遍你也许就看懂了，但是一个月后又忘记了。其实这些东西我们在大学也学了，但是还是忘了（能够理解，缺少实操环境和条件），或者碰到问题才发现之前即使觉得看懂了的东西实际没懂</p>
<p><strong>所以接下来我们将示范书本知识到实践的贯通，希望把网络概念之间的联系通过实践来组织起来</strong></p>
<h2 id="还是从一个网络不通的问题入手"><a href="#还是从一个网络不通的问题入手" class="headerlink" title="还是从一个网络不通的问题入手"></a>还是从一个网络不通的问题入手</h2><p>最近的环境碰到一个网络ping不通的问题，当时的网络链路是（大概是这样，略有简化）：</p>
<pre><code>容器1-&gt;容器1所在物理机1-&gt;交换机-&gt;物理机2
</code></pre><h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><ul>
<li>从容器1 ping 物理机2 不通；</li>
<li>从物理机1上的容器2 ping物理机2 通；</li>
<li>同时发现即使是通的，有的容器 ping物理机1只需要0.1ms，有的容器需要200ms以上（都在同一个物理机上），不合理</li>
<li>所有容器 ping 其它外网IP（比如百度）反而是通的</li>
</ul>
<p>这个问题扯了一周才解决是因为容器的网络是我们自己配置的，交换机我们没有权限接触，由客户配置。出问题的时候都会觉得自己没问题对方有问题，另外就是对网络基本知识认识不够所以都觉得自己没问题而不去找证据。</p>
<p>这个问题的答案在大家看完本文的基础知识后会总结出来。</p>
<blockquote>
<p>解决这个问题前大家先想想，假如有个面试题是：输入 ping IP 后敲回车，然后发生了什么？</p>
</blockquote>
<h2 id="复习一下大学课本中的知识点"><a href="#复习一下大学课本中的知识点" class="headerlink" title="复习一下大学课本中的知识点"></a>复习一下大学课本中的知识点</h2><p>要解决一个问题你首先要有基础知识，知识欠缺你的逻辑再好、思路再清晰、智商再高，也不一定有效。</p>
<h3 id="route-路由表"><a href="#route-路由表" class="headerlink" title="route 路由表"></a>route 路由表</h3><pre><code>$route -n
Kernel IP routing table
Destination Gateway Genmask Flags Metric RefUse Iface
0.0.0.0     1.1.15.254   0.0.0.0 UG0  00 eth0
1.0.0.0     1.1.15.254   255.0.0.0   UG0  00 eth0
1.1.0.0     0.0.0.0 255.255.240.0   U 0  00 eth0
11.0.0.0    1.1.15.254   255.0.0.0   UG0  00 eth0
30.0.0.0    1.1.15.254   255.0.0.0   UG0  00 eth0
100.64.0.0  1.1.15.254   255.192.0.0 UG0  00 eth0
169.254.0.0 0.0.0.0 255.255.0.0 U 1002   00 eth0
172.16.0.0  1.1.15.254   255.240.0.0 UG0  00 eth0
172.17.0.0  0.0.0.0 255.255.0.0 U 0  00 docker0
192.168.0.0 1.1.15.254   255.255.0.0 UG0  00 eth0
</code></pre><p>假如你现在在这台机器上ping 172.17.0.2 根据上面的route表得出 172.17.0.2这个IP符合下面这条路由：</p>
<pre><code>172.17.0.0  0.0.0.0 255.255.0.0 U 0  00 docker0
</code></pre><p>这条路由规则，那么ping 包会从docker0这张网卡发出去。</p>
<p>但是如果是ping 1.1.4.4 根据路由规则应该走eth0这张网卡而不是docker0了。</p>
<p>接下来就要判断目标IP是否在同一个子网了</p>
<h2 id="ifconfig"><a href="#ifconfig" class="headerlink" title="ifconfig"></a>ifconfig</h2><p>首先来看看这台机器的网卡情况：</p>
<pre><code>$ifconfig
docker0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500
    inet 172.17.42.1  netmask 255.255.0.0  broadcast 0.0.0.0
    ether 02:42:49:a7:dc:ba  txqueuelen 0  (Ethernet)
    RX packets 461259  bytes 126800808 (120.9 MiB)
    RX errors 0  dropped 0  overruns 0  frame 0
    TX packets 462820  bytes 103470899 (98.6 MiB)
    TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
    inet 1.1.3.33  netmask 255.255.240.0  broadcast 10.125.15.255
    ether 00:16:3e:00:02:67  txqueuelen 1000  (Ethernet)
    RX packets 280918095  bytes 89102074868 (82.9 GiB)
    RX errors 0  dropped 0  overruns 0  frame 0
    TX packets 333504217  bytes 96311277198 (89.6 GiB)
    TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
    inet 127.0.0.1  netmask 255.0.0.0
    loop  txqueuelen 0  (Local Loopback)
    RX packets 1077128597  bytes 104915529133 (97.7 GiB)
    RX errors 0  dropped 0  overruns 0  frame 0
    TX packets 1077128597  bytes 104915529133 (97.7 GiB)
    TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre><p>这里有三个网卡和三个IP，三个子网掩码（netmask)，根据目标路由走哪张网卡，得到这个网卡的子网掩码，来计算目标IP是否在这个子网内。</p>
<h2 id="arp协议"><a href="#arp协议" class="headerlink" title="arp协议"></a>arp协议</h2><p>网络包在物理层传输的时候依赖的mac 地址而不是上面的IP地址，也就是根据mac地址来决定把包发到哪里去。 </p>
<p>arp协议就是查询某个IP地址的mac地址是多少，由于这种对应关系一般不太变化，所以每个os都有一份arp缓存（一般15分钟过期），也可以手工清理，下面是arp缓存的内容：</p>
<pre><code>$arp -a
e010010011202.bja.tbsite.net (1.1.11.202) at 00:16:3e:01:c2:00 [ether] on eth0
? (1.1.15.254) at 0c:da:41:6e:23:00 [ether] on eth0
v125004187.bja.tbsite.net (1.1.4.187) at 00:16:3e:01:cb:00 [ether] on eth0
e010010001224.bja.tbsite.net (1.1.1.224) at 00:16:3e:01:64:00 [ether] on eth0
v125009121.bja.tbsite.net (1.1.9.121) at 00:16:3e:01:b8:ff [ether] on eth0
e010010009114.bja.tbsite.net (1.1.9.114) at 00:16:3e:01:7c:00 [ether] on eth0
v125012028.bja.tbsite.net (1.1.12.28) at 00:16:3e:00:fb:ff [ether] on eth0
e010010005234.bja.tbsite.net (1.1.5.234) at 00:16:3e:01:ee:00 [ether] on eth0
</code></pre><h2 id="进入正题，回车后发生什么"><a href="#进入正题，回车后发生什么" class="headerlink" title="进入正题，回车后发生什么"></a>进入正题，回车后发生什么</h2><p>有了上面的基础知识打底，我们来思考一下 ping IP 到底发生了什么。</p>
<p>首先 OS 的协议栈需要把ping命令封成一个icmp包，要填上包头（包括src-IP、mac地址），那么OS先根据目标IP和本机的route规则计算使用哪个interface(网卡），确定了路由也就基本上知道发送包的src-ip和src-mac了。每条路由规则基本都包含目标IP范围、网关、MAC地址、网卡这样几个基本元素。</p>
<h3 id="如果目标IP和本机使用的IP在同一子网"><a href="#如果目标IP和本机使用的IP在同一子网" class="headerlink" title="如果目标IP和本机使用的IP在同一子网"></a>如果目标IP和本机使用的IP在同一子网</h3><p>如果目标IP和本机IP是同一个子网（根据本机ifconfig上的每个网卡的netmask来判断是否是同一个子网–知识点：子网掩码的作用），并且本机arp缓存没有这条IP对应的mac记录，那么给整个子网的所有机器广播发送一个 arp查询</p>
<p>比如我ping 1.1.3.42，然后tcpdump抓包首先看到的是一个arp请求：</p>
<pre><code>$sudo tcpdump -i eth0  arp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
16:22:01.792501 ARP, Request who-has e010010003042.bja.tbsite.net tell e010125003033.bja, length 28
16:22:01.792566 ARP, Reply e010010003042.bja.tbsite.net is-at 00:16:3e:01:8d:ff (oui Unknown), length 28
</code></pre><p>上面就是本机发送广播消息，1.1.3.42的mac地址是多少？很快1.1.3.42回复了自己的mac地址。<br>收到这个回复后，先缓存起来，下个ping包就不需要再次发arp广播了。<br>然后将这个mac地址填写到ping包的包头的目标Mac（icmp包），然后发出这个icmp request包，按照mac地址，正确到达目标机器，然后对方正确回复icmp reply【对方回复也要查路由规则，arp查发送方的mac，这样回包才能正确路由回来，略过】。</p>
<p>来看一次完整的ping 1.1.3.43，tcpdump抓包结果：</p>
<pre><code>$sudo tcpdump -i eth0  arp or icmp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
16:25:15.195401 ARP, Request who-has e010010003043.bja.tbsite.net tell e010010003033.bja, length 28
16:25:15.195459 ARP, Reply e010010003043.bja.tbsite.net is-at 00:16:3e:01:0c:ff (oui Unknown), length 28
16:25:15.211505 IP e010010003033.bja &gt; e010010003043.bja.tbsite.net: ICMP echo request, id 27990, seq 1, length 64
16:25:15.212056 IP e010010003043.bja.tbsite.net &gt; e010010003033.bja: ICMP echo reply, id 27990, seq 1, length 64
</code></pre><p>我换了个IP地址，接着再ping同一个IP地址，arp有缓存了就看不到arp广播查询过程了。</p>
<h3 id="如果目标IP不是同一个子网"><a href="#如果目标IP不是同一个子网" class="headerlink" title="如果目标IP不是同一个子网"></a>如果目标IP不是同一个子网</h3><p>arp只是同一子网广播查询，如果目标IP不是同一子网的话就要经过本IP网关进行转发(知识点–网关的作用)，如果本机没有缓存网关mac（一般肯定缓存了），那么先发送一次arp查询网关的mac，然后流程跟上面一样，只是这个icmp包发到网关上去了（mac地址填写的是网关的mac）</p>
<p>从本机1.1.3.33 ping 11.239.161.60的过程，因为不是同一子网按照路由规则匹配，根据route表应该走1.1.15.254这个网关，如下截图：</p>
<p><img src="/images/oss/85e8fc6b2614aed26bc3a6d70050bf36.png" alt="image.png"></p>
<p>首先是目标IP 11.239.161.60 符合最上面红框中的路由规则，又不是同一子网，所以查找路由规则中的网关1.1.15.254的Mac地址，arp cache中有，于是将 0c:da:41:6e:23:00 填入包头，那么这个icmp request包就发到1.1.15.254上了，虽然包头的mac是 0c:da:41:6e:23:00，但是IP还是 11.239.161.60.</p>
<p>看看目标IP 11.239.161.60 的真正mac信息（跟ping包包头的Mac是不同的）：</p>
<pre><code>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
    inet 11.239.161.60  netmask 255.255.252.0  broadcast 11.239.163.255
    ether 00:16:3e:00:04:c4  txqueuelen 1000  (Ethernet)
</code></pre><p>这个包根据Mac地址路由到了网关上</p>
<h3 id="网关接下来怎么办"><a href="#网关接下来怎么办" class="headerlink" title="网关接下来怎么办"></a>网关接下来怎么办</h3><p><strong>为了简化问题，假设两个网关直连</strong></p>
<p>网关收到这个包后（因为mac地址是它的），打开一看IP地址是 11.239.161.60，不是自己的，于是继续查自己的route和arp缓存，发现11.239.161.60这个IP的网关是11.239.163.247，于是把包的目的mac地址改成11.239.163.247的mac继续发出去。</p>
<p>11.239.163.247这个网关收到包后，一看 11.239.161.60是自己同一子网的IP，于是该arp广播找mac就广播，cache有就拿cache的，然后这个包才最终到达目的11.239.161.60上。</p>
<p>整个过程中目标mac地址每一跳都在变，IP地址不变，每经过一次MAC变化可以简单理解成一跳。</p>
<p>实际上可能要经过多个网关多次跳跃才能真正到达目标机器</p>
<h3 id="目标机器收到这个icmp包后的回复过程一样，略过。"><a href="#目标机器收到这个icmp包后的回复过程一样，略过。" class="headerlink" title="目标机器收到这个icmp包后的回复过程一样，略过。"></a>目标机器收到这个icmp包后的回复过程一样，略过。</h3><h3 id="arp广播风暴和arp欺骗"><a href="#arp广播风暴和arp欺骗" class="headerlink" title="arp广播风暴和arp欺骗"></a>arp广播风暴和arp欺骗</h3><p>广播风暴：如果一个子网非常大，机器非常多，每次arp查询都是广播的话，也容易因为N*N的问题导致广播风暴。</p>
<p>arp欺骗：同样如果一个子网中的某台机器冒充网关或者其他机器，当收到arp广播查询的时候总是把自己的mac冒充目标机器的mac发给你，然后你的包先走到他，再转发给真正的网关或者目标机器，所以在里面动点什么手脚，看看你发送的内容都还是很容易的。</p>
<h2 id="讲完基础知识再来看开篇问题的答案"><a href="#讲完基础知识再来看开篇问题的答案" class="headerlink" title="讲完基础知识再来看开篇问题的答案"></a>讲完基础知识再来看开篇问题的答案</h2><p>读完上面的基础知识相信现在我们已经能够回答 ping IP 后发生了什么，这些已经足够解决99%程序员日常网络中的网络为什么不通的问题了。但是前面问题比这个要稍微复杂一点，不过还是依靠这些基础知识就能解决的–这是基础知识的威力。</p>
<h3 id="现场网络同学所做的一些其它测试："><a href="#现场网络同学所做的一些其它测试：" class="headerlink" title="现场网络同学所做的一些其它测试："></a>现场网络同学所做的一些其它测试：</h3><ol>
<li>怀疑不通的IP所使用的mac地址冲突，在交换机上清理了交换机的arp缓存，没有帮助，还是不通；</li>
<li>新拿出一台物理机配置上不通的容器的IP，这是通的，所以负责网络的同学坚持是容器网络的配置导致了问题。</li>
</ol>
<p>对于1能通，我认为这个测试不严格，新物理机所用的mac不一样，并且所接的交换机口也不一样，影响了测试结果。</p>
<h3 id="祭出万能手段–抓包"><a href="#祭出万能手段–抓包" class="headerlink" title="祭出万能手段–抓包"></a>祭出万能手段–抓包</h3><p><strong>抓包在网络问题中是万能的，但是第一次容易被tcpdump抓包命令的众多参数吓晕，不去操作你永远上不了手，差距也就拉开了，你看差距有时候只是你对一条命令的执行</strong></p>
<p>在物理机2上抓包：</p>
<p><img src="/images/oss/cab05a87298fc4b6ff6152b2ff4c061b.png" alt="image.png"></p>
<pre><code>tcpdump: listening on em1, link-type EN10MB (Ethernet), capture size 65535 bytes
f4:0f:1b:ae:15:fb &gt; 18:66:da:f0:15:90, ethertype 802.1Q (0x8100), length 102: vlan 134, p 0, ethertype IPv4, (tos 0x0, ttl 63, id 5654, offset 0, flags [DF], proto ICMP (1), length 84)
10.159.43.162 &gt; 10.159.43.1: ICMP echo request, id 6285, seq 1, length 64
18:66:da:f0:15:90 &gt; 00:00:0c:9f:f0:86, ethertype 802.1Q (0x8100), length 102: vlan 134, p 0, ethertype IPv4, (tos 0x0, ttl 64, id 21395, offset 0, flags [none], proto ICMP (1), length 84)
10.159.43.1 &gt; 10.159.43.162: ICMP echo reply, id 6285, seq 1, length 64
</code></pre><p>这个抓包能看到核心证据，ping包有到达物理机2，同时物理机2也正确回复了（mac、ip都对）</p>
<p>同时在物理机1上抓包（抓包截图略掉）只能看到ping包出去，回包没有到物理机1（所以回包肯定不会回到容器里了）</p>
<p><strong>到这里问题的核心在交换机没有正确把物理机2的回包送到物理机1上面。</strong></p>
<p>同时观察到的不正常延时都在网关那一跳：</p>
<p><img src="/images/oss/7a6acf5f4897118e511e7165059b33c5.png" alt="image.png"></p>
<h3 id="最终的原因"><a href="#最终的原因" class="headerlink" title="最终的原因"></a>最终的原因</h3><p>最后在交换机上分析包没正确发到物理机1上的原因跟客户交换机使用了HSRP（热备份路由器协议，就是多个交换机HA高可用，也就是同一子网可以有多个网关的IP），停掉HSRP后所有IP容器都能通了，并且前面的某些容器延时也恢复正常了。</p>
<p><strong>通俗点说就是HSRP把回包拐跑了，有些回包拐跑了又送回来了（延时200ms那些）</strong></p>
<p>至于HSRP为什么会这么做，要厂家出来解释了。这里关键在于能让客户认同问题出现在交换机上还是前面的抓包证据充分，无可辩驳。实际中我们都习惯不给证据就说：我的程序没问题，就是你的问题。这样表述没有一点意义，我们是要拿着证据这么说，对方也好就着证据来反驳，这叫优雅地甩锅。</p>
<h2 id="网络到底通不通是个复杂的问题吗？"><a href="#网络到底通不通是个复杂的问题吗？" class="headerlink" title="网络到底通不通是个复杂的问题吗？"></a>网络到底通不通是个复杂的问题吗？</h2><p>讲这个过程的核心目的是除了真正的网络不通，有些是服务不可用了也怪网络。很多现场的同学根本讲不清自己的服务（比如80端口上的tomcat服务）还在不在，网络通不通，是网络不通呢还是服务出了问题。一看到SocketTimeoutException 就想把网络同学抓过来羞辱两句：网络不通了，网络抖动导致我的程序异常了（网络抖动是个万能的扛包侠）。</p>
<p>实际这里涉及到四个节点（以两个网关直连为例），srcIP -&gt; src网关 -&gt; dest网关 -&gt; destIP。如果ping不通(也有特殊的防火墙限制ping包不让过的），那么在这四段中分段ping（二分查找程序员应该最熟悉了）。 比如前面的例子就是网关没有把包转发回来</p>
<p>抓包看ping包有没有出去，对方抓包看有没有收到，收到后有没有回复。</p>
<p>ping自己网关能不能通，ping对方网关能不能通。</p>
<h2 id="接下来说点跟程序员日常相关的"><a href="#接下来说点跟程序员日常相关的" class="headerlink" title="接下来说点跟程序员日常相关的"></a>接下来说点跟程序员日常相关的</h2><h3 id="如果网络能ping通，服务无法访问"><a href="#如果网络能ping通，服务无法访问" class="headerlink" title="如果网络能ping通，服务无法访问"></a>如果网络能ping通，服务无法访问</h3><p>那么尝试telnet IP port 看看你的服务是否还在监听端口，在的话再看看服务进程是否能正常响应新的请求。有时候是进程死掉了，端口也没人监听了；有时候是进程还在但是假死了，所以端口也不响应新的请求了；<a href="https://mp.weixin.qq.com/s/yH3PzGEFopbpA-jw4MythQ" target="_blank" rel="external">还有的是TCP连接队列满了不能响应新的连接</a></p>
<p>如果端口还在也是正常的话，telnet应该是好的：</p>
<pre><code>$telnet 1.1.161.60 2376
Trying 1.1.161.60...
Connected to 1.1.161.60.
Escape character is &apos;^]&apos;.
^C
Connection closed by foreign host.
</code></pre><p>假如我故意换成一个不存在的端口，目标机器上的OS直接就拒绝了这个连接（抓包的话一般是看到reset标识）：</p>
<pre><code>$telnet 1.1.161.60 2379
Trying 1.1.161.60...
telnet: connect to address 11.239.161.60: Connection refused
</code></pre><h3 id="一个SocketTimeoutException，程序员首先怀疑网络丢包的Case"><a href="#一个SocketTimeoutException，程序员首先怀疑网络丢包的Case" class="headerlink" title="一个SocketTimeoutException，程序员首先怀疑网络丢包的Case"></a>一个SocketTimeoutException，程序员首先怀疑网络丢包的Case</h3><p>当时的反馈应用代码抛SocketTimeoutException，怀疑网络问题：</p>
<ol>
<li>业务应用连接Server 偶尔会出现超时异常；</li>
<li>有很多这样的异常日志：[Server  SocketTimeoutException]</li>
</ol>
<p>检查一下当时的网络状态非常好，出问题时间段的网卡的流量信息也非常正常：</p>
<p><img src="/images/oss/81199130d4b2d5cf441944d9e11cc5fd.png" alt="image.png"></p>
<p>上图是通过sar监控到的9号 v24d9e0f23d40 这个网卡的流量，看起来也是正常，流量没有出现明显的波动</p>
<p>为了监控网络到底有没有问题，接着在出问题的两个容器上各启动一个http server，然后在对方每1秒钟互相发一次发http get请求访问这个http server，基本认识告诉我们如果网络丢包、卡顿严重，那么我这个http server的监控日志时间戳也会跳跃，如果应用是因为网络出现异常那么我启动的http服务也会出现异常–宁愿写个工具都不背锅（主要是背了锅也不一定能解决掉问题）。</p>
<p>从实际监控来看，应用出现异常的时候我的http服务是正常的（写了脚本判断日志的连续性）：</p>
<p><img src="/images/oss/c9d5ff245eac6a023acd7148b7676b4f.png" alt="image.png"></p>
<p>这也强有力地证明了网络没问题，所以写业务代码的同学一门心思集中火力查看应用的问题。后来的实际调查发现是应用假死掉了（内部线程太多，卡死了），服务端口不响应请求了。</p>
<p>如果基础知识缺乏一点那么甩过来的这个锅网络是扛不动的，同时也阻碍了问题的真正发现。</p>
<h3 id="TCP建连接过程跟前面ping一样，只是把ping的icmp协议换成TCP协议，也是要先根据route，然后arp"><a href="#TCP建连接过程跟前面ping一样，只是把ping的icmp协议换成TCP协议，也是要先根据route，然后arp" class="headerlink" title="TCP建连接过程跟前面ping一样，只是把ping的icmp协议换成TCP协议，也是要先根据route，然后arp"></a>TCP建连接过程跟前面ping一样，只是把ping的icmp协议换成TCP协议，也是要先根据route，然后arp</h3><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>网络丢包，卡顿，抖动很容易做扛包侠，只有找到真正的原因解决问题才会更快，要不在错误的方向上怎么发力都不对。准确的方向要靠好的基础知识和正确的逻辑以及证据来支撑，而不是猜测</strong></p>
<ul>
<li>基础知识是决定你能否干到退休的关键因素；</li>
<li>有了基础知识不代表你能真正转化成生产力；</li>
<li>越是基础，越是几十年不变的基础越是重要；</li>
<li>知识到灵活运用要靠实践，同时才能把知识之间的联系建立起来；</li>
<li>简而言之缺的是融会贯通和运用；</li>
<li>做一个有礼有节的甩包侠；</li>
<li>在别人不给证据愚昧甩包的情况下你的机会就来了。</li>
</ul>
<h2 id="留几个小问题"><a href="#留几个小问题" class="headerlink" title="留几个小问题"></a>留几个小问题</h2><ol>
<li>server回复client的时候是如何确定回复包中的src-ip和dest-mac的？一定是请求包中的dest-ip当成src-ip吗？</li>
<li>上面问题中如果是TCP或者UDP协议，他们回复包中的src-ip和dest-mac获取会不一样吗？</li>
<li>既然局域网中都是依赖Mac地址来定位，那么IP的作用又是什么呢？</li>
</ol>
<hr>
<h3 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h3><p><a href="https://tools.ietf.org/html/rfc1180" target="_blank" rel="external">https://tools.ietf.org/html/rfc1180</a></p>
<p>《计算机基础》</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/12/07/如何追踪网络流量/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/07/如何追踪网络流量/" itemprop="url">如何追踪网络流量</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-07T17:30:03+08:00">
                2017-12-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index">
                    <span itemprop="name">network</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="如何追踪网络流量"><a href="#如何追踪网络流量" class="headerlink" title="如何追踪网络流量"></a>如何追踪网络流量</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>某些场景下通过监控发现了流量比较大，不太合理，需要知道这些流量都是哪些进程访问哪些服务触发的</p>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><ol>
<li>定位流量是由哪个进程触发的</li>
<li>定位流量主要是访问哪些ip导致的</li>
<li>定位具体的端口有较大的流量</li>
</ol>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>nethogs/iftop/tcptrack</p>
<h2 id="定位进程"><a href="#定位进程" class="headerlink" title="定位进程"></a>定位进程</h2><pre><code>sudo nethogs 
</code></pre><p><img src="/images/oss/e89eaf27aa98a6192d109ee22f9c0da8.png" alt="image.png"></p>
<p>从上图可以看到总的流量，以及每个进程的流量大小。这里可以确认流量主要是3820的java进程消耗的</p>
<h2 id="定位ip"><a href="#定位ip" class="headerlink" title="定位ip"></a>定位ip</h2><pre><code>sudo iftop -p -n -B
</code></pre><p><img src="/images/oss/1f03abbebbfc173b5af3163d017fd901.png" alt="image.png"></p>
<p>通过上图可以看到流量主要是消耗在 10.0.48.1的ip上</p>
<h2 id="定位端口"><a href="#定位端口" class="headerlink" title="定位端口"></a>定位端口</h2><p>10.0.48.1 有可能是一个mapping ip，需要进一步查看具体</p>
<pre><code>sudo tcptrack -r 5 -i eth0  //然后输入小写s，按流量排序
sudo tcptrack -r 5 -i eth0 host 10.0.48.1 //filter 语法和tcpdump一样
</code></pre><p><img src="/images/oss/07f0fceb6af4c4387832561b630c00b3.png" alt="image.png"></p>
<p>可以看到4355/4356端口上流量相对较大</p>
<h2 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h2><p>后续发布新镜像都会带上这三个软件的rpm安装包<br>目前可以手动下载这三个rpm安装包：</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/10/31/磁盘爆掉的几种情况/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/31/磁盘爆掉的几种情况/" itemprop="url">磁盘爆掉的几种情况</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-31T12:30:03+08:00">
                2017-10-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Docker宿主机磁盘爆掉的几种情况"><a href="#Docker宿主机磁盘爆掉的几种情况" class="headerlink" title="Docker宿主机磁盘爆掉的几种情况"></a>Docker宿主机磁盘爆掉的几种情况</h1><h2 id="磁盘爆掉的几种情况"><a href="#磁盘爆掉的几种情况" class="headerlink" title="磁盘爆掉的几种情况"></a>磁盘爆掉的几种情况</h2><ol>
<li>系统磁盘没有空间，解决办法：删掉 /var/log/ 下边的带日期的日志，清空 /var/log/messages 内容</li>
<li>容器使用的大磁盘但是仍然空间不够，有三个地方会使用大量的磁盘<ul>
<li>容器内部日志非常大，处理办法见方法一</li>
<li>容器内部产生非常多或者非常大的文件，但是这个文件的位置又通过volume 挂载到了物理机上，处理办法见方法二</li>
<li>对特别老的部署环境，还有可能是容器的系统日志没有限制大小，处理办法见方法三</li>
</ul>
</li>
</ol>
<h2 id="现场的同学按如下方法依次检查"><a href="#现场的同学按如下方法依次检查" class="headerlink" title="现场的同学按如下方法依次检查"></a>现场的同学按如下方法依次检查</h2><h3 id="方法零：-检查系统根目录下每个文件夹的大小"><a href="#方法零：-检查系统根目录下每个文件夹的大小" class="headerlink" title="方法零： 检查系统根目录下每个文件夹的大小"></a>方法零： 检查系统根目录下每个文件夹的大小</h3><p><code>sudo du / -lh --max-depth=1 --exclude=overlay --exclude=proc</code></p>
<p>看看除了容器之外有没有其它目录使用磁盘特别大，如果有那么一层层进去通过du命令来查看，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#sudo du / -lh --max-depth=1 --exclude=overlay --exclude=proc</div><div class="line">16K	/dev</div><div class="line">16K	/lost+found</div><div class="line">4.0K	/media</div><div class="line">17G	/home</div><div class="line">136M	/boot</div><div class="line">832K	/run</div><div class="line">1.9G	/usr</div><div class="line">75M	/tmp</div><div class="line">12K	/log</div><div class="line">8.5G	/var</div><div class="line">4.0K	/srv</div><div class="line">0	/proc</div><div class="line">22M	/etc</div><div class="line">84G	/root</div><div class="line">4.0K	/mnt</div><div class="line">508M	/opt</div><div class="line">0	/sys</div><div class="line">112G	/</div></pre></td></tr></table></figure>
<p>那么这个案例中应该查看 /root下为什么用掉了84G（总共用了112G）， 先 cd /root 然后执行： sudo du . -lh –max-depth=1 –exclude=overlay 进一步查看 /root 目录下每个文件夹的大小</p>
<p><strong>如果方法零没找到占用特别大的磁盘文件，那么一般来说是容器日志占用太多的磁盘空间，请看方法一</strong></p>
<h3 id="方法一：-容器内部日志非常大（请确保先按方法零检查过了）"><a href="#方法一：-容器内部日志非常大（请确保先按方法零检查过了）" class="headerlink" title="方法一： 容器内部日志非常大（请确保先按方法零检查过了）"></a>方法一： 容器内部日志非常大（请确保先按方法零检查过了）</h3><p>在磁盘不够的物理机上执行如下脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sudo docker ps -a -q &gt;containers.list</div><div class="line"></div><div class="line">sudo cat containers.list | xargs sudo docker inspect $1 | grep merged | awk -F \&quot; &apos;&#123; print $4 &#125;&apos; | sed &apos;s/\/merged//g&apos; | xargs sudo du  --max-depth=0 $1 &gt;containers.size </div><div class="line"></div><div class="line">sudo paste containers.list containers.size | awk &apos;&#123; print $1, $2 &#125;&apos;  | sort -nk2 &gt;real_size.log</div><div class="line"></div><div class="line">sudo tail -10 real_size.log  | awk &apos;BEGIN &#123;print &quot;\tcontainer     size\tunit&quot;&#125; &#123; print NR&quot;:\t&quot; $0&quot;\t kB&quot; &#125;&apos;</div></pre></td></tr></table></figure>
<h5 id="执行完后会输出如下格式："><a href="#执行完后会输出如下格式：" class="headerlink" title="执行完后会输出如下格式："></a>执行完后会输出如下格式：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">container     size	unit</div><div class="line">1:	22690f16822f 3769980	 kb</div><div class="line">2:	82b4ae98eeed 4869324	 kb</div><div class="line">3:	572a1b7c8ef6 10370404	 kb</div><div class="line">4:	9f9250d98df6 10566776	 kb</div><div class="line">5:	7fab70481929 13745648	 kb</div><div class="line">6:	4a14b58e3732 29873504	 kb</div><div class="line">7:	8a01418b6df2 30432068	 kb</div><div class="line">8:	83dc85caaa5c 31010960	 kb</div><div class="line">9:	433e51df88b1 35647052	 kb</div><div class="line">10:	4b42818a8148 61962416	 kb</div></pre></td></tr></table></figure>
<p>第二列是容器id，第三列是磁盘大小，第四列是单位， 占用最大的排在最后面</p>
<h5 id="然后进到容器后通过-du-–max-depth-2-快速发现大文件"><a href="#然后进到容器后通过-du-–max-depth-2-快速发现大文件" class="headerlink" title="然后进到容器后通过 du / –max-depth=2 快速发现大文件"></a>然后进到容器后通过 du / –max-depth=2 快速发现大文件</h5><h3 id="方法二：-容器使用的volume使用过大"><a href="#方法二：-容器使用的volume使用过大" class="headerlink" title="方法二： 容器使用的volume使用过大"></a>方法二： 容器使用的volume使用过大</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$sudo du -l /data/lib/docker/defaultVolumes --max-depth=1 | sort -rn</div><div class="line">456012884	/data/lib/docker/defaultVolumes</div><div class="line">42608332	/data/lib/docker/defaultVolumes/task_3477_g0_ark-metadb_miniDBPaaS-MetaDB_1</div><div class="line">32322220	/data/lib/docker/defaultVolumes/task_3477_g0_dbpaas-metadb_dbpaas_1</div><div class="line">27461120	/data/lib/docker/defaultVolumes/task_3001_g0_ark-metadb_miniDBPaaS-MetaDB_1</div><div class="line">27319360	/data/lib/docker/defaultVolumes/task_36000_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27313836	/data/lib/docker/defaultVolumes/task_3600_g0_dbpaas-metadb_minidbpaas</div><div class="line">27278692	/data/lib/docker/defaultVolumes/task_3604_g0_ark-metadb_miniDBPaaS-MetaDB_1</div><div class="line">27277004	/data/lib/docker/defaultVolumes/task_3603_g0_ark-metadb_miniDBPaaS-MetaDB_1</div><div class="line">27275736	/data/lib/docker/defaultVolumes/task_3542_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27271428	/data/lib/docker/defaultVolumes/task_3597_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27270840	/data/lib/docker/defaultVolumes/task_3603_g0_dbpaas-metadb_minidbpaas_1</div><div class="line">27270492	/data/lib/docker/defaultVolumes/task_3603_g0_dbpaas-metadb_minidbpaas</div><div class="line">27270468	/data/lib/docker/defaultVolumes/task_3600_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27270252	/data/lib/docker/defaultVolumes/task_3535_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27270244	/data/lib/docker/defaultVolumes/task_3538_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27270244	/data/lib/docker/defaultVolumes/task_3536_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">25312404	/data/lib/docker/defaultVolumes/task_3477_g0_dncs-server_middleware-dncs_2</div></pre></td></tr></table></figure>
<p>/data/lib/docker/defaultVolumes 参数是默认设置的volume存放的目录（一般是docker的存储路径下 –graph=/data/lib/docker) ，第一列是大小，后面是容器名</p>
<p>volume路径在物理机上也有可能是 /var/lib/docker 或者 /mw/mvdocker/ 之类的路径下，这个要依据安装参数来确定，可以用如下命令来找到这个路径：</p>
<p><code>sudo systemctl status docker -l | grep --color graph</code></p>
<p>结果如下，红色参数后面的路径就是docker 安装目录，到里面去找带volume的字眼：</p>
<p><img src="/images/oss/1558521949392-d1ab9886-9f08-4ebf-bfdb-5283461ed9de.png#align=left&amp;display=inline&amp;height=165&amp;originHeight=165&amp;originWidth=930&amp;size=0&amp;status=done&amp;width=930" alt=""></p>
<p>找到 volume很大的文件件后同样可以进到这个文件夹中执行如下命令快速发现大文件：</p>
<p><code>du . --max-depth=2</code></p>
<h3 id="方法三-容器的系统日志没有限制大小"><a href="#方法三-容器的系统日志没有限制大小" class="headerlink" title="方法三 容器的系统日志没有限制大小"></a>方法三 容器的系统日志没有限制大小</h3><p>这种情况只针对2017年上半年之前的部署环境，后面部署的环境默认都控制了这些日志不会超过150M</p>
<p>按照方法二的描述先找到docker 安装目录，cd 进去，然后 ：</p>
<p><code>du ./containers --max-depth=2</code></p>
<p>就很快找到那个大json格式的日志文件了,然后执行清空这个大文件的内容：</p>
<p><code>echo &#39;&#39; | sudo tee 大文件名</code></p>
<h3 id="一些其他可能占用空间的地方"><a href="#一些其他可能占用空间的地方" class="headerlink" title="一些其他可能占用空间的地方"></a>一些其他可能占用空间的地方</h3><ul>
<li>机器上镜像太多，可以删掉一些没用的： sudo docker images -q | xargs sudo docker rmi</li>
<li>机器上残留的volume太多，删：sudo docker volume ls -q | xargs sudo docker volume rm</li>
<li>物理文件被删了，但是还有进程占用这个文件句柄，导致文件对应的磁盘空间没有释放，检查： lsof |　grep deleted  如果这个文件非常大的话，只能通过重启这个进程来真正释放磁盘空间</li>
</ul>
<h3 id="OverlayFS（overlay）的镜像分层与共享"><a href="#OverlayFS（overlay）的镜像分层与共享" class="headerlink" title="OverlayFS（overlay）的镜像分层与共享"></a><a href="https://hhbbz.github.io/2018/03/28/Docker%E5%AE%B9%E5%99%A8%E5%8D%A0%E7%94%A8%E7%A3%81%E7%9B%98%E5%86%85%E5%AD%98%E8%BF%87%E5%A4%A7%E7%9A%84%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" target="_blank" rel="external">OverlayFS（overlay）的镜像分层与共享</a></h3><p>OverlayFS使用两个目录，把一个目录置放于另一个之上，并且对外提供单个统一的视角。这两个目录通常被称作层，这个分层的技术被称作union mount。术语上，下层的目录叫做lowerdir，上层的叫做upperdir。对外展示的统一视图称作merged。 　　</p>
<p>如下图所示，Overlay在主机上用到2个目录，这2个目录被看成是overlay的层。 upperdir为容器层、lowerdir为镜像层使用联合挂载技术将它们挂载在同一目录(merged)下，提供统一视图。</p>
<p><img src="/images/951413iMgBlog/overlay_constructs.jpg" alt="图片"></p>
<p>注意镜像层和容器层是如何处理相同的文件的：容器层（upperdir）的文件是显性的，会隐藏镜像层（lowerdir）相同文件的存在。容器映射（merged）显示出统一的视图。 　　overlay驱动只能工作在两层之上。也就是说多层镜像不能用多层OverlayFS实现。替代的，每个镜像层在/var/lib/docker/overlay中用自己的目录来实现，使用硬链接这种有效利用空间的方法，来引用底层分享的数据。注意：Docker1.10之后，镜像层ID和/var/lib/docker中的目录名不再一一对应。 　　创建一个容器，overlay驱动联合镜像层和一个新目录给容器。镜像顶层是overlay中的只读lowerdir，容器的新目录是可写的upperdir。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/08/28/netstat 等网络工具/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/28/netstat 等网络工具/" itemprop="url">netstat timer keepalive RTO explain</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-28T10:30:03+08:00">
                2017-08-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index">
                    <span itemprop="name">network</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="netstat-等网络工具"><a href="#netstat-等网络工具" class="headerlink" title="netstat 等网络工具"></a>netstat 等网络工具</h1><h2 id="netstat-和重传–-timer"><a href="#netstat-和重传–-timer" class="headerlink" title="netstat 和重传– timer"></a>netstat 和重传– timer</h2><p>经常碰到一些断网环境下需要做快速切换，那么断网后需要多久tcp才能感知到这个断网，并断开连接触发上层的重连（一般会连向新的server）</p>
<p>netstat -st命令中，tcp: 部分取自/proc/net/snmp，而TCPExt部分取自/proc/net/netstat，该文件对TCP记录了更多的统计。sysstat包也会采集/proc/net/snmp</p>
<h3 id="keepalive"><a href="#keepalive" class="headerlink" title="keepalive"></a>keepalive</h3><p>from: <a href="https://superuser.com/questions/240456/how-to-interpret-the-output-of-netstat-o-netstat-timers" target="_blank" rel="external">https://superuser.com/questions/240456/how-to-interpret-the-output-of-netstat-o-netstat-timers</a></p>
<p>The timer column has two fields (from your o/p above):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">keepalive     (6176.47/0/0)  </div><div class="line">&lt;1st field&gt;   &lt;2nd field&gt;</div></pre></td></tr></table></figure>
<p>The 1st field can have values:<br>keepalive - when the keepalive timer is ON for the socket  </p>
<p>on - when the retransmission timer is ON for the socket  </p>
<p>off - none of the above is ON</p>
<p>on - #表示是重发（retransmission）的时间计时</p>
<p>off - #表示没有时间计时</p>
<p>timewait - #表示等待（timewait）时间计时</p>
<p>keepalive 是指在连接闲置状态发送心跳包来检测连接是否还有效（比如对方掉电后肯定就无效了，tcp得靠这个keepalive来感知）。如果有流量在传输过程中对方掉电后会不停地 retransmission ，这个时候看到的就是 on，然后重传间隔和次数跟keepalive参数无关，只和 net.ipv4.tcp_retries1、net.ipv4.tcp_retries2相关了。</p>
<p>keepalive 状态下的连接：</p>
<p><img src="/images/oss/f1a219a2bd99690fd3ed391bf5ab65cb.png" alt="image.png"></p>
<p>The 2nd field has THREE subfields:</p>
<p>(6176.47/0/0) -&gt; (a/b/c)<br>a=timer value (a=keepalive timer, when 1st field=“keepalive”; a=retransmission timer, when 1st field=“on”)  </p>
<p>b=number of retransmissions that have occurred  </p>
<p>c=number of keepalive probes that have been sent</p>
<blockquote>
<p>/proc/sys/net/ipv4/tcp_keepalive_time<br>当keepalive起用的时候，TCP发送keepalive消息的频度。缺省是2小时。</p>
<p>/proc/sys/net/ipv4/tcp_keepalive_intvl<br>当探测没有确认时，重新发送探测的频度。缺省是75秒。</p>
<p>/proc/sys/net/ipv4/tcp_keepalive_probes<br>在认定连接失效之前，发送多少个TCP的keepalive探测包。缺省值是9。这个值乘以tcp_keepalive_intvl之后决定了，一个连接发送了keepalive之后可以有多少时间没有回应</p>
</blockquote>
<p>For example, I had two sockets opened between a client &amp; a server (not loopback). The keepalive setting are:</p>
<p>KEEPALIVE_IDLETIME   30<br>KEEPALIVE_NUMPROBES   4<br>KEEPALIVE_INTVL      10  </p>
<p>And I did a shutdown of the client machine, so at …SHED on (2.47/254/2)  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tcp        0    210 192.0.0.1:36483             192.0.68.1:43881            ESTABLISHED on (1.39/254/2)  </div><div class="line">tcp        0    210 192.0.0.1:36483             192.0.68.1:43881            ESTABLISHED on (0.31/254/2)  </div><div class="line">tcp        0    210 192.0.0.1:36483             192.0.68.1:43881            ESTABLISHED on (2.19/255/2)  </div><div class="line">tcp        0    210 192.0.0.1:36483             192.0.68.1:43881            ESTABLISHED on (1.12/255/2)</div></pre></td></tr></table></figure>
<p>As you can see, in this case things are a little different. When the client went down, my server started sending keepalive messages, but while it was still sending those keepalives, my server tried to send a message to the client. Since the client had gone down, the server couldn’t get any ACK from the client, so the TCP retransmission started and the server tried to send the data again, each time incrementing the retransmit count (2nd field) when the retransmission timer (1st field) expired.</p>
<p>Hope this explains the netstat –timer option well.</p>
<h2 id="RTO-重传"><a href="#RTO-重传" class="headerlink" title="RTO 重传"></a><a href="https://pracucci.com/linux-tcp-rto-min-max-and-tcp-retries2.html" target="_blank" rel="external">RTO</a> 重传</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#define TCP_RTO_MAX ((unsigned)(120*HZ)) //HZ 通常为1秒 </div><div class="line">#define TCP_RTO_MIN ((unsigned)(HZ/5))</div></pre></td></tr></table></figure>
<p>Linux 2.6+ uses HZ of 1000ms, so <code>TCP_RTO_MIN</code> is ~200 ms and <code>TCP_RTO_MAX</code> is ~120 seconds. Given a default value of <code>tcp_retries</code> set to <code>15</code>, it means that <strong>it takes 924.6 seconds</strong> before a broken network link is notified to the upper layer (ie. application), since the connection is detected as broken when the last (15th) retry expires.</p>
<p><img src="https://pracucci.com/assets/2018-04-27-linux-tcp-rto-retries2-b71ad2ef586126c2ad4180543f78d8b0a4bf66925fb88d69889f04c4b7aedeaa.png" alt="2018-04-27-linux-tcp-rto-retries2.png"></p>
<p>The <code>tcp_retries2</code> sysctl can be <strong>tuned</strong> via <code>/proc/sys/net/ipv4/tcp_retries2</code> or the sysctl <code>net.ipv4.tcp_retries2</code>.</p>
<h3 id="查看重传状态"><a href="#查看重传状态" class="headerlink" title="查看重传状态"></a>查看重传状态</h3><p>重传状态的连接：</p>
<p><img src="/images/oss/88c5df7d5709e5c8b264ee0deacda0a2.png" alt="image.png"></p>
<p>前两个 syn_sent 状态明显是 9031端口不work了，握手不上。</p>
<p>最后 established 状态的连接, 是22端口给53795发了136字节的数据但是没有收到ack，所以在倒计时准备重传中。</p>
<blockquote>
<p><strong>net.ipv4.tcp_retries1 = 3</strong></p>
</blockquote>
<p>放弃回应一个TCP <strong>连接请求前</strong>﹐需要进行多少次重试。RFC 规定最低的数值是3﹐这也是默认值﹐根据RTO的值大约在3秒 - 8分钟之间。(注意:这个值同时还决定进入的syn连接)</p>
<p><strong>(第二种解释：它表示的是TCP传输失败时不检测路由表的最大的重试次数，当超过了这个值，我们就需要检测路由表了)</strong></p>
<p>从kernel代码可以看到，一旦重传超过阈值tcp_retries1，主要的动作就是更新路由缓存。<br>用以避免由于路由选路变化带来的问题。<strong>这个时候tcp连接没有关闭</strong></p>
<blockquote>
<p> <strong>net.ipv4.tcp_retries2 = 15</strong></p>
</blockquote>
<p><strong>在丢弃激活(已建立通讯状况)</strong>的TCP连接之前﹐需要进行多少次重试。默认值为15，根据RTO的值来决定，相当于13-30分钟(RFC1122规定，必须大于100秒).(这个值根据目前的网络设置,可以适当地改小,我的网络内修改为了5)</p>
<p><strong>(第二种解释：表示重试最大次数，只不过这个值一般要比上面的值大。和上面那个不同的是，当重试次数超过这个值，我们就必须关闭连接了)</strong></p>
<p>from：Documentation/networking/ip-sysctl.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">tcp_retries1 - INTEGER</div><div class="line">    This value influences the time, after which TCP decides, that</div><div class="line">    something is wrong due to unacknowledged RTO retransmissions,</div><div class="line">    and reports this suspicion to the network layer.</div><div class="line">    See tcp_retries2 for more details.</div><div class="line"></div><div class="line">    RFC 1122 recommends at least 3 retransmissions, which is the</div><div class="line">    default.</div><div class="line"></div><div class="line">tcp_retries2 - INTEGER</div><div class="line">    This value influences the timeout of an alive TCP connection,</div><div class="line">    when RTO retransmissions remain unacknowledged.</div><div class="line">    Given a value of N, a hypothetical TCP connection following</div><div class="line">    exponential backoff with an initial RTO of TCP_RTO_MIN would</div><div class="line">    retransmit N times before killing the connection at the (N+1)th RTO.</div><div class="line"></div><div class="line">    The default value of 15 yields a hypothetical timeout of 924.6</div><div class="line">    seconds and is a lower bound for the effective timeout.</div><div class="line">    TCP will effectively time out at the first RTO which exceeds the</div><div class="line">    hypothetical timeout.</div><div class="line"></div><div class="line">    RFC 1122 recommends at least 100 seconds for the timeout,</div><div class="line">    which corresponds to a value of at least 8.</div></pre></td></tr></table></figure>
<p><img src="/images/oss/1571230725657-b2b7ea40-06bc-41fb-a374-daa8de1f857d.png" alt="img"></p>
<h3 id="retries限制的重传次数吗"><a href="#retries限制的重传次数吗" class="headerlink" title="retries限制的重传次数吗"></a>retries限制的重传次数吗</h3><p>咋一看文档，很容易想到retries的数字就是限定的重传的次数，甚至源码中对于retries常量注释中都写着”This is how many retries it does…”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#define TCP_RETR1       3   /*</div><div class="line">                             * This is how many retries it does before it</div><div class="line">                             * tries to figure out if the gateway is</div><div class="line">                             * down. Minimal RFC value is 3; it corresponds</div><div class="line">                             * to ~3sec-8min depending on RTO.</div><div class="line">                             */</div><div class="line"></div><div class="line">#define TCP_RETR2       15  /*</div><div class="line">                             * This should take at least</div><div class="line">                             * 90 minutes to time out.</div><div class="line">                             * RFC1122 says that the limit is 100 sec.</div><div class="line">                             * 15 is ~13-30min depending on RTO.</div><div class="line">                             */</div></pre></td></tr></table></figure>
<p>那就就来看看retransmits_timed_out的具体实现，看看到底是不是限制的重传次数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">/* This function calculates a &quot;timeout&quot; which is equivalent to the timeout of a</div><div class="line"> * TCP connection after &quot;boundary&quot; unsuccessful, exponentially backed-off</div><div class="line"> * retransmissions with an initial RTO of TCP_RTO_MIN or TCP_TIMEOUT_INIT if</div><div class="line"> * syn_set flag is set.</div><div class="line"> */</div><div class="line">static bool retransmits_timed_out(struct sock *sk,</div><div class="line">                              unsigned int boundary,</div><div class="line">                              unsigned int timeout,</div><div class="line">                              bool syn_set)</div><div class="line">&#123;</div><div class="line">    unsigned int linear_backoff_thresh, start_ts;</div><div class="line">    // 如果是在三次握手阶段，syn_set为真</div><div class="line">    unsigned int rto_base = syn_set ? TCP_TIMEOUT_INIT : TCP_RTO_MIN;</div><div class="line"></div><div class="line">    if (!inet_csk(sk)-&gt;icsk_retransmits)</div><div class="line">            return false;</div><div class="line"></div><div class="line">    // retrans_stamp记录的是数据包第一次发送的时间，在tcp_retransmit_skb()中设置</div><div class="line">    if (unlikely(!tcp_sk(sk)-&gt;retrans_stamp))</div><div class="line">            start_ts = TCP_SKB_CB(tcp_write_queue_head(sk))-&gt;when;</div><div class="line">    else</div><div class="line">            start_ts = tcp_sk(sk)-&gt;retrans_stamp;</div><div class="line"></div><div class="line">    // 如果用户态未指定timeout，则算一个出来</div><div class="line">    if (likely(timeout == 0)) &#123;</div><div class="line">            /* 下面的计算过程，其实就是算一下如果以rto_base为第一次重传间隔，</div><div class="line">             * 重传boundary次需要多长时间</div><div class="line">             */</div><div class="line">            linear_backoff_thresh = ilog2(TCP_RTO_MAX/rto_base);</div><div class="line"></div><div class="line">            if (boundary &lt;= linear_backoff_thresh)</div><div class="line">                    timeout = ((2 &lt;&lt; boundary) - 1) * rto_base;</div><div class="line">            else</div><div class="line">                    timeout = ((2 &lt;&lt; linear_backoff_thresh) - 1) * rto_base +</div><div class="line">                            (boundary - linear_backoff_thresh) * TCP_RTO_MAX;</div><div class="line">    &#125;</div><div class="line">    // 如果数据包第一次发送的时间距离现在的时间间隔，超过了timeout值，则认为重传超于阈值了</div><div class="line">    return (tcp_time_stamp - start_ts) &gt;= timeout;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从以上的代码分析可以看到，真正起到限制重传次数的并不是真正的重传次数。<br>而是以tcp_retries1或tcp_retries2为boundary，以rto_base(如TCP_RTO_MIN 200ms)为初始RTO，计算得到一个timeout值出来。如果重传间隔超过这个timeout，则认为超过了阈值。<br>上面这段话太绕了，下面举两个个例子来说明</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; 以判断是否放弃TCP流为例，如果tcp_retries2=15，那么计算得到的timeout=924600ms。</div><div class="line">&gt; </div><div class="line">&gt; 1. 如果RTT比较小，那么RTO初始值就约等于下限200ms</div><div class="line">&gt;    由于timeout总时长是924600ms，表现出来的现象刚好就是重传了15次，超过了timeout值，从而放弃TCP流</div><div class="line">&gt; </div><div class="line">&gt; 2. 如果RTT较大，比如RTO初始值计算得到的是1000ms</div><div class="line">&gt;    那么根本不需要重传15次，重传总间隔就会超过924600ms。</div><div class="line">&gt;    比如我测试的一个RTT=400ms的情况，当tcp_retries2=10时，仅重传了3次就放弃了TCP流</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>一些重传的其它问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&gt;&gt; effective timeout指的是什么？  </div><div class="line">&lt;&lt; 就是retransmits_timed_out计算得到的timeout值</div><div class="line"></div><div class="line">&gt;&gt; 924.6s是怎么算出来的？</div><div class="line">&lt;&lt; 924.6s = (( 2 &lt;&lt; 9) -1) * 200ms + (15 - 9) * 120s</div><div class="line"></div><div class="line">&gt;&gt; 为什么924.6s是lower bound？</div><div class="line">&lt;&lt; 重传总间隔必须大于timeout值，即 (tcp_time_stamp - start_ts) &gt;= timeout</div><div class="line"></div><div class="line">&gt;&gt; 那RTO超时的间隔到底是不是源码注释的&quot;15 is ~13-30min depending on RTO.&quot;呢？  </div><div class="line">&lt;&lt; 显然不是! 虽然924.6s(15min)是一个lower bound，但是它同时也是一个upper bound!</div><div class="line">   怎么理解？举例说明  </div><div class="line">        1. 如果某个RTO值导致，在已经重传了14次后，总重传间隔开销是924s</div><div class="line">        那么它还需要重传第15次，即使离924.6s只差0.6s。这就是发挥了lower bound的作用</div><div class="line">        2. 如果某个RTO值导致，在重传了10次后，总重传间隔开销是924s</div><div class="line">        重传第11次后，第12次超时触发时计算得到的总间隔变为1044s，超过924.6s</div><div class="line">        那么此时会放弃第12次重传，这就是924.6s发挥了upper bound的作用</div><div class="line">   总的来说，在Linux3.10中，如果tcp_retres2设置为15。总重传超时周期应该在如下范围内</div><div class="line">        [924.6s, 1044.6s)</div></pre></td></tr></table></figure>
<h3 id="RTO重传案例"><a href="#RTO重传案例" class="headerlink" title="RTO重传案例"></a>RTO重传案例</h3><p>我们来看如下这个51432端口向9627端口上传过程，十分缓慢，重传包间隔基本是122秒，速度肯定没法快</p>
<p><img src="/images/oss/4f1e9afd7ccd8ac6d69cf08c60ce8b84.png" alt="image.png"></p>
<p>上图中垂直方向基本都是发出3-5个包，然后休息120秒，继续发3-5个 包，速度肯定慢，下图可以看到具体的包：</p>
<p><img src="/images/oss/79ea2c2c5473d61cd1e780944ab0d0c5.png" alt="image.png"></p>
<p>来看下到9627的RTT，基本稳定在245秒或者122秒，这RTT也实在太大了。可以看到：</p>
<ol>
<li><p>网络质量很不好，丢包有点多；</p>
</li>
<li><p>rtt高得离谱，导致rto计算出来120秒了，所以一旦丢包就卡120秒以上。</p>
</li>
</ol>
<p>下图是RTT图</p>
<p><img src="/images/oss/932b5124b7d445ee82c82a5f65a98321.png" alt="image.png"></p>
<p>两个原因一叠加，就出现了奇慢无比.</p>
<p>正常情况下RTO是从200ms开始翻倍，实际上OS层面限制了最小RTO 200ms、最大RTO 120秒，由于RTT都超过120秒了，计算所得的RTO必定也大于120秒，所以最终就是我们看到的一上来第一个RTO不是常见的200ms，直接干到了120秒。</p>
<h2 id="netstat-s"><a href="#netstat-s" class="headerlink" title="netstat -s"></a>netstat -s</h2><p>netstat -s统计，有两个和timestamp stamp reject相关的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">netstat -st | grep stamp | grep reject</div><div class="line">18 passive connections rejected because of time stamp</div><div class="line">1453 packets rejects in established connections because of timestamp</div></pre></td></tr></table></figure>
<p>丢包统计：</p>
<blockquote>
<p>netstat -s |egrep -i “drop|route|overflow|filter|retran|fails|listen”</p>
<p>nstat -z -t 1 | egrep -i “drop|route|overflow|filter|retran|fails|listen”</p>
</blockquote>
<p>netstat -st命令中，Tcp: 部分取自/proc/net/snmp，而TCPExt部分取自/proc/net/netstat，该文件对TCP记录了更多的统计。sysstat包也会采集/proc/net/snmp</p>
<h2 id="nc-测试"><a href="#nc-测试" class="headerlink" title="nc 测试"></a>nc 测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nc -v -u -z -w 3 10.101.0.1 53 //测试server 的53端口上的udp服务能否通</div></pre></td></tr></table></figure>
<h3 id="nc-6-5-快速fin"><a href="#nc-6-5-快速fin" class="headerlink" title="nc 6.5 快速fin"></a>nc 6.5 快速fin</h3><p><img src="/images/951413iMgBlog/1607660605575-1305739f-1621-4a01-89ad-0f81eef94922.png" alt="img"></p>
<p> nc -i 3 10.97.170.11 3306 -w 4 -p 1234</p>
<p>-i 3 表示握手成功后 等三秒钟nc退出（发fin）</p>
<p>nc 6.5 握手后立即发fin断开连接，导致可能收不到Greeting，换成7.5或者mysql client就OK了</p>
<p>也就是用nc 6.5来验证mysql 服务是否正常可能会碰到nc自己断的太快，实际mysql还是正常的，从而像是mysql没有回复Greeting，从而产生误判。</p>
<p>nc 7.5的抓包，明显可以看到nc在发fin前会先等3秒钟：</p>
<p><img src="/images/951413iMgBlog/1607660937618-d66c4074-9aa2-44cb-8054-f7d3680d1181.png" alt="img"></p>
<h2 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h2><p>sudo ping -f ip 大批量的icmp包</p>
<p>ping -D  带时间戳 或者：ping -i 5 google.com | xargs -L 1 -I ‘{}’ date ‘+%Y-%m-%d %H:%M:%S: {}’  或者 ping www.google.fr | while read pong; do echo “$(date): $pong”; done</p>
<p>ping -O  不通的时候输出：no answer yet for icmp_seq=xxx </p>
<p>或者-D + awk</p>
<blockquote>
<p>ping -D 114.114.114.114 | awk ‘{ if(gsub(/[|]/, “”, $1)) $1=strftime(“[%F %T]”, $1); print}’</p>
</blockquote>
<p>Linux 下直接增加如下函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ping.ts()&#123;</div><div class="line">    if [ -t 1 ]; then</div><div class="line">        ping -D &quot;$@&quot; | awk &apos;&#123; if(gsub(/\[|\]/, &quot;&quot;, $1)) $1=strftime(&quot;[\033[34m%F %T\033[0m]&quot;, $1); print; fflush()&#125;&apos;</div><div class="line">    else</div><div class="line">        ping -D &quot;$@&quot; | awk &apos;&#123; if(gsub(/\[|\]/, &quot;&quot;, $1)) $1=strftime(&quot;[%F %T]&quot;, $1); print; fflush()&#125;&apos;</div><div class="line">    fi  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="mtr"><a href="#mtr" class="headerlink" title="mtr"></a>mtr</h2><p>若需要将mtr的结果提供给第三方，建议可以使用-rc参数，r代表不使用交互界面，而是在最后给出一个探测结果报告；c参数指定需要作几次探测（一般建议是至少200个包，可以配合-i参数减少包间隔来加快得到结果的时间）。</p>
<h2 id="traceroute"><a href="#traceroute" class="headerlink" title="traceroute"></a>traceroute</h2><p>和mtr不同的是，traceroute默认使用UDP作为四层协议，下层还是依靠IP头的TTL来控制中间的节点返回ICMP差错报文，来获得中间节点的IP和延时。唯一的区别是，在达到目标节点时，若是ICMP协议，目标大概率是会回复ICMP reply；如果是UDP协议，按照RFC协议规定，系统是要回复ICMP 端口不可达的差错报文，虽然三大平台Windows/MacOS/Linux都实现了这个行为，但出于某些原因，这个包可能还是会在链路上被丢弃，导致路由跟踪的结果无法显示出最后一跳。所以建议在一般的情况下，traceroute命令可以加上-I参数，让程序使用ICMP协议来发送探测数据包。</p>
<h2 id="dstat"><a href="#dstat" class="headerlink" title="dstat"></a>dstat</h2><p><a href="https://www.huaweicloud.com/articles/9fc282e450af6f9b2878008a9e938d4d.html" target="_blank" rel="external">dstat 监控</a></p>
<p><img src="/images/951413iMgBlog/image-20210425082343156.png" alt="image-20210425082343156"></p>
<p>dstat -cdgilmnrsy –aio –fs –lock –raw</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://perthcharles.github.io/2015/09/07/wiki-tcp-retries/" target="_blank" rel="external">http://perthcharles.github.io/2015/09/07/wiki-tcp-retries/</a></p>
<p><a href="ttps://github.com/huigher/tcpping2" target="_blank" rel="external">tcpping2</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/06/07/就是要你懂TCP--半连接队列和全连接队列/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/07/就是要你懂TCP--半连接队列和全连接队列/" itemprop="url">就是要你懂TCP--半连接队列和全连接队列</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-07T17:30:03+08:00">
                2017-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TCP/" itemprop="url" rel="index">
                    <span itemprop="name">TCP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="关于TCP-半连接队列和全连接队列"><a href="#关于TCP-半连接队列和全连接队列" class="headerlink" title="关于TCP 半连接队列和全连接队列"></a>关于TCP 半连接队列和全连接队列</h1><blockquote>
<p>最近碰到一个client端连接异常问题，然后定位分析发现是因为全连接队列满了导致的。查阅各种资料文章和通过一系列的实验对TCP连接队列有了更深入的理解</p>
<p>查资料过程中发现没有文章把这两个队列以及怎么观察他们的指标说清楚，希望通过这篇文章能说清楚:</p>
<p>1)  这两个队列是干什么用的；</p>
<p>2）怎么设置和观察他们的最大值；</p>
<p>3）怎么查看这两个队列当前使用到了多少；</p>
<p>4）一旦溢出的后果和现象是什么</p>
</blockquote>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><pre><code>场景：JAVA的client和server，使用socket通信。server使用NIO。

1.间歇性的出现client向server建立连接三次握手已经完成，但server的selector没有响应到这连接。
2.出问题的时间点，会同时有很多连接出现这个问题。
3.selector没有销毁重建，一直用的都是一个。
4.程序刚启动的时候必会出现一些，之后会间歇性出现。
</code></pre><h2 id="分析问题"><a href="#分析问题" class="headerlink" title="分析问题"></a>分析问题</h2><h3 id="正常TCP建连接三次握手过程："><a href="#正常TCP建连接三次握手过程：" class="headerlink" title="正常TCP建连接三次握手过程："></a>正常TCP建连接三次握手过程：</h3><p><img src="/images/oss/159a331ff8cdd4b8994dfe6a209d035f.png" alt="image.png"></p>
<ul>
<li>第一步：client 发送 syn 到server 发起握手；</li>
<li>第二步：server 收到 syn后回复syn+ack给client；</li>
<li>第三步：client 收到syn+ack后，回复server一个ack表示收到了server的syn+ack（此时client的56911端口的连接已经是established）</li>
</ul>
<p>从问题的描述来看，有点像TCP建连接的时候全连接队列（accept队列，后面具体讲）满了，尤其是症状2、4. 为了证明是这个原因，马上通过 netstat -s | egrep “listen” 去看队列的溢出统计数据：</p>
<pre><code>667399 times the listen queue of a socket overflowed
</code></pre><p>反复看了几次之后发现这个overflowed 一直在增加，那么可以明确的是server上全连接队列一定溢出了</p>
<p>接着查看溢出后，OS怎么处理：</p>
<pre><code># cat /proc/sys/net/ipv4/tcp_abort_on_overflow
0
</code></pre><p><strong>tcp_abort_on_overflow 为0表示如果三次握手第三步的时候全连接队列满了那么server扔掉client 发过来的ack（在server端认为连接还没建立起来）</strong></p>
<p>为了证明客户端应用代码的异常跟全连接队列满有关系，我先把tcp_abort_on_overflow修改成 1，1表示第三步的时候如果全连接队列满了，server发送一个reset包给client，表示废掉这个握手过程和这个连接（本来在server端这个连接就还没建立起来）。</p>
<p>接着测试，这时在客户端异常中可以看到很多connection reset by peer的错误，<strong>到此证明客户端错误是这个原因导致的（逻辑严谨、快速证明问题的关键点所在）</strong>。</p>
<p>于是开发同学翻看java 源代码发现socket 默认的backlog（这个值控制全连接队列的大小，后面再详述）是50，于是改大重新跑，经过12个小时以上的压测，这个错误一次都没出现了，同时观察到 overflowed 也不再增加了。</p>
<p>到此问题解决，<strong>简单来说TCP三次握手后有个accept队列，进到这个队列才能从Listen变成accept，默认backlog 值是50，很容易就满了</strong>。满了之后握手第三步的时候server就忽略了client发过来的ack包（隔一段时间server重发握手第二步的syn+ack包给client），如果这个连接一直排不上队就异常了。</p>
<blockquote>
<p>但是不能只是满足问题的解决，而是要去复盘解决过程，中间涉及到了哪些知识点是我所缺失或者理解不到位的；这个问题除了上面的异常信息表现出来之外，还有没有更明确地指征来查看和确认这个问题。</p>
</blockquote>
<h2 id="深入理解TCP握手过程中建连接的流程和队列"><a href="#深入理解TCP握手过程中建连接的流程和队列" class="headerlink" title="深入理解TCP握手过程中建连接的流程和队列"></a>深入理解TCP握手过程中建连接的流程和队列</h2><p><img src="/images/oss/bcf463efeb677d5749d8d7571274ee79.png" alt="image.png"></p>
<p>如上图所示，这里有两个队列：syns queue(半连接队列）；accept queue（全连接队列）</p>
<p>三次握手中，在第一步server收到client的syn后，把这个连接信息放到半连接队列中，同时回复syn+ack给client（第二步）；</p>
<pre><code>题外话，比如syn floods 攻击就是针对半连接队列的，攻击方不停地建连接，但是建连接的时候只做第一步，第二步中攻击方收到server的syn+ack后故意扔掉什么也不做，导致server上这个队列满其它正常请求无法进来
</code></pre><p>第三步的时候server收到client的ack，如果这时全连接队列没满，那么从半连接队列拿出这个连接的信息放入到全连接队列中，同时将连接状态从 SYN_RECV 改成 ESTABLISHED 状态，否则按tcp_abort_on_overflow指示的执行。</p>
<p>这时如果全连接队列满了并且tcp_abort_on_overflow是0的话，server会扔掉三次握手中第三步收到的ack（假装没有收到一样），过一段时间再次发送syn+ack给client（也就是重新走握手的第二步），如果client超时等待比较短，就很容易异常了。其实这个时候client认为连接已经建立了，可以发数据或者可以断开，而实际server上连接还没建立好（还没能力）。</p>
<p>在我们的os中retry 第二步的默认次数是2（centos默认是5次）：</p>
<pre><code>net.ipv4.tcp_synack_retries = 2
</code></pre><h2 id="如果TCP连接队列溢出，有哪些指标可以看呢？"><a href="#如果TCP连接队列溢出，有哪些指标可以看呢？" class="headerlink" title="如果TCP连接队列溢出，有哪些指标可以看呢？"></a>如果TCP连接队列溢出，有哪些指标可以看呢？</h2><p>上述解决过程有点绕，听起来蒙逼，那么下次再出现类似问题有什么更快更明确的手段来确认这个问题呢？</p>
<p>（<em>通过具体的、感性的东西来强化我们对知识点的理解和吸收</em>）</p>
<h3 id="netstat-s"><a href="#netstat-s" class="headerlink" title="netstat -s"></a>netstat -s</h3><pre><code>[root@server ~]#  netstat -s | egrep &quot;listen|LISTEN&quot; 
667399 times the listen queue of a socket overflowed
667399 SYNs to LISTEN sockets ignored
</code></pre><p>比如上面看到的 667399 times ，表示全连接队列溢出的次数，隔几秒钟执行下，如果这个数字一直在增加的话肯定全连接队列偶尔满了。</p>
<h3 id="ss-命令"><a href="#ss-命令" class="headerlink" title="ss 命令"></a>ss 命令</h3><pre><code>[root@server ~]# ss -lnt
Recv-Q Send-Q Local Address:Port  Peer Address:Port 
0        50               *:3306             *:* 
</code></pre><p><strong>上面看到的第二列Send-Q 值是50，表示第三列的listen端口上的全连接队列最大为50，第一列Recv-Q为全连接队列当前使用了多少</strong></p>
<p><strong>全连接队列的大小取决于：min(backlog, somaxconn) . backlog是在socket创建的时候传入的，somaxconn是一个os级别的系统参数</strong></p>
<p>《Unix Network Programming》中关于backlog的描述</p>
<blockquote>
<p>The backlog argument to the listen function has historically specified the maximum value for the sum of both queues.</p>
<p>There has never been a formal definition of what the backlog means. The 4.2BSD man page says that it “defines the maximum length the queue of pending connections may grow to.” Many man pages and even the POSIX specification copy this definition verbatim, but this definition does not say whether a pending connection is one in the SYN_RCVD state, one in the ESTABLISHED state that has not yet been accepted, or either. The historical definition in this bullet is the Berkeley implementation, dating back to 4.2BSD, and copied by many others.</p>
</blockquote>
<p>关于 <a href="https://github.com/torvalds/linux/commit/19f92a030ca6d772ab44b22ee6a01378a8cb32d4" target="_blank" rel="external">somaxconn 终于在2019年将默认值从128调整到了2048</a>, 这个调整合并到了kernel 5.17中</p>
<blockquote>
<p>SOMAXCONN is /proc/sys/net/core/somaxconn default value.</p>
<p>It has been defined as 128 more than 20 years ago.</p>
<p>Since it caps the listen() backlog values, the very small value has<br>caused numerous problems over the years, and many people had<br>to raise it on their hosts after beeing hit by problems.</p>
<p>Google has been using 1024 for at least 15 years, and we increased<br>this to 4096 after TCP listener rework has been completed, more than<br>4 years ago. We got no complain of this change breaking any<br>legacy application.</p>
<p>Many applications indeed setup a TCP listener with listen(fd, -1);<br>meaning they let the system select the backlog.</p>
<p>Raising SOMAXCONN lowers chance of the port being unavailable under<br>even small SYNFLOOD attack, and reduces possibilities of side channel<br>vulnerabilities.</p>
</blockquote>
<p>这个时候可以跟我们的代码建立联系了，比如Java创建ServerSocket的时候会让你传入backlog的值：</p>
<pre><code>ServerSocket()
    Creates an unbound server socket.
ServerSocket(int port)
    Creates a server socket, bound to the specified port.
ServerSocket(int port, int backlog)
    Creates a server socket and binds it to the specified local port number, with the specified backlog.
ServerSocket(int port, int backlog, InetAddress bindAddr)
    Create a server with the specified port, listen backlog, and local IP address to bind to.
</code></pre><p>（来自JDK帮助文档：<a href="https://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html）" target="_blank" rel="external">https://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html）</a></p>
<p><strong>半连接队列的大小取决于：max(64,  /proc/sys/net/ipv4/tcp_max_syn_backlog)。 <a href="https://developer.aliyun.com/article/804896" target="_blank" rel="external">不同版本的os会有些差异</a></strong></p>
<blockquote>
<p>我们写代码的时候从来没有想过这个backlog或者说大多时候就没给他值（那么默认就是50），直接忽视了他，首先这是一个知识点的忙点；其次也许哪天你在哪篇文章中看到了这个参数，当时有点印象，但是过一阵子就忘了，这是知识之间没有建立连接，不是体系化的。但是如果你跟我一样首先经历了这个问题的痛苦，然后在压力和痛苦的驱动自己去找为什么，同时能够把为什么从代码层推理理解到OS层，那么这个知识点你才算是比较好地掌握了，也会成为你的知识体系在TCP或者性能方面成长自我生长的一个有力抓手</p>
</blockquote>
<h4 id="netstat-命令"><a href="#netstat-命令" class="headerlink" title="netstat 命令"></a>netstat 命令</h4><p>netstat跟ss命令一样也能看到Send-Q、Recv-Q这些状态信息，不过如果这个连接不是<strong>Listen状态</strong>的话，Recv-Q就是指收到的数据还在缓存中，还没被进程读取，这个值就是还没被进程读取的 bytes；而 Send 则是发送队列中没有被远程主机确认的 bytes 数</p>
<pre><code>$netstat -tn  
Active Internet connections (w/o servers)
Proto Recv-Q Send-Q Local Address   Foreign Address State  
tcp    0  0 server:8182  client-1:15260 SYN_RECV   
tcp    0 28 server:22    client-1:51708  ESTABLISHED
tcp    0  0 server:2376  client-1:60269 ESTABLISHED
</code></pre><p><strong>netstat -tn 看到的 Recv-Q 跟全连接半连接中的Queue没有关系，这里特意拿出来说一下是因为容易跟 ss -lnt 的 Recv-Q 搞混淆</strong>  </p>
<p>所以ss看到的 Send-Q、Recv-Q是目前全连接队列使用情况和最大设置<br>netstat看到的 Send-Q、Recv-Q，如果这个连接是Established状态的话就是发出的bytes并且没有ack的包、和os接收到的bytes还没交给应用</p>
<p>我们看到的 Recv-Q、Send-Q获取源代码如下（ net/ipv4/tcp_diag.c ）：   </p>
<pre><code>static void tcp_diag_get_info(struct sock *sk, struct inet_diag_msg *r,
  void *_info)
{
    const struct tcp_sock *tp = tcp_sk(sk);
    struct tcp_info *info = _info;

    if (sk-&gt;sk_state == TCP_LISTEN) {  //LISTEN状态下的 Recv-Q、Send-Q
        r-&gt;idiag_rqueue = sk-&gt;sk_ack_backlog;
        r-&gt;idiag_wqueue = sk-&gt;sk_max_ack_backlog; //Send-Q 最大backlog
    } else {                           //其它状态下的 Recv-Q、Send-Q
        r-&gt;idiag_rqueue = max_t(int, tp-&gt;rcv_nxt - tp-&gt;copied_seq, 0);
        r-&gt;idiag_wqueue = tp-&gt;write_seq - tp-&gt;snd_una;
    }
    if (info != NULL)
        tcp_get_info(sk, info);
}
</code></pre><p>比如如下netstat -t 看到的Recv-Q有大量数据堆积，那么一般是CPU处理不过来导致的：</p>
<p><img src="/images/oss/77ed9ba81f70f7940546f0a22dabf010.png" alt="image.png"></p>
<h4 id="netstat看到的listen状态的Recv-Q-Send-Q"><a href="#netstat看到的listen状态的Recv-Q-Send-Q" class="headerlink" title="netstat看到的listen状态的Recv-Q/Send-Q"></a>netstat看到的listen状态的Recv-Q/Send-Q</h4><p>netstat 看到的listen状态下的Recv-Q/Send-Q意义跟 ss -lnt看到的完全不一样。上面的 netstat 对非listen的描述没问题，但是listen状态似乎Send-Q这个值总是0，这要去看netstat的代码了，实际上Listen状态它不是一个连接，所以肯定统计不到流量，netstat似乎只是针对连接的统计</p>
<p>从网上找了两个Case，server的8765端口故意不去读取对方发过来的2000字节，所看到的是：</p>
<pre><code>$ netstat -ano | grep 8765  
tcp0  0 0.0.0.0:87650.0.0.0:*   LISTEN  off (0.00/0/0)  
tcp 2000  0 10.100.70.140:8765  10.100.70.139:43634 ESTABLISHED off (0.00/0/0)
</code></pre><p>第二个Case，8000端口的半连接满了（129），但是这个时候Send-Q还是看到的0</p>
<pre><code>$ netstat -ntap | grep 8000 
tcp      129      0 0.0.0.0:8000            0.0.0.0:*               LISTEN      1526/XXXXX- 
tcp        0      0 9.11.6.36:8000          9.11.6.37:48306         SYN_RECV    - 
tcp        0      0 9.11.6.36:8000          9.11.6.34:44936         SYN_RECV    - 
tcp      365      0 9.11.6.36:8000          9.11.6.37:58446         CLOSE_WAIT  -  
</code></pre><h2 id="案列：如果TCP连接队列溢出，抓包是什么现象呢？"><a href="#案列：如果TCP连接队列溢出，抓包是什么现象呢？" class="headerlink" title="案列：如果TCP连接队列溢出，抓包是什么现象呢？"></a>案列：如果TCP连接队列溢出，抓包是什么现象呢？</h2><p><img src="/images/oss/c0849615ae52531887ce6b0313d7d2d1.png" alt="image.png"></p>
<p>如上图server端8989端口的服务全连接队列已经满了（设置最大5，已经6了，通过后面步骤的ss -lnt可以验证）， 所以 server尝试过一会假装继续三次握手的第二步，跟client说我们继续谈恋爱吧。可是这个时候client比较性急，忙着分手了，server觉得都没恋上那什么分手啊。所以接下来两边自说自话也就是都不停滴重传</p>
<h3 id="通过ss和netstat所观察到的状态"><a href="#通过ss和netstat所观察到的状态" class="headerlink" title="通过ss和netstat所观察到的状态"></a>通过ss和netstat所观察到的状态</h3><p><img src="/images/oss/ec25ccb6cce8f554b7ef6927f05bd530.png" alt="image.png"></p>
<p><img src="/images/oss/2fbdd05162e9fd51e803682b8a18cc51.png" alt="image.png"></p>
<p><a href="/2019/08/31/%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82TCP%E9%98%9F%E5%88%97--%E9%80%9A%E8%BF%87%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E6%9D%A5%E5%B1%95%E7%A4%BA%E9%97%AE%E9%A2%98/">另外一个案例，虽然最终的锅不是TCP全连接队列太小，但是也能从重传、队列溢出找到根因</a></p>
<h2 id="实践验证一下上面的理解"><a href="#实践验证一下上面的理解" class="headerlink" title="实践验证一下上面的理解"></a>实践验证一下上面的理解</h2><p>上面是通过一些具体的工具、指标来认识全连接队列，接下来结合文章开始的问题来具体验证一下 </p>
<p>把java中backlog改成10（越小越容易溢出），继续跑压力，这个时候client又开始报异常了，然后在server上通过 ss 命令观察到：</p>
<pre><code>Fri May  5 13:50:23 CST 2017
Recv-Q Send-QLocal Address:Port  Peer Address:Port
11         10         *:3306               *:*
</code></pre><p>按照前面的理解，这个时候我们能看到3306这个端口上的服务全连接队列最大是10，但是现在有11个在队列中和等待进队列的，肯定有一个连接进不去队列要overflow掉，同时也确实能看到overflow的值在不断地增大。</p>
<p><strong>能够进入全连接队列的 Socket 最大数量始终比配置的全连接队列最大长度 + 1</strong>，结合内核代码，发现<strong>内核在判断全连接队列是否满的情况下，使用的是 &gt; 而非 &gt;=</strong> 。</p>
<blockquote>
<p>Linux下发SIGSTOP信号发给用户态进程，就可以让进程stop不再accept，模拟accept溢出的效果</p>
<p>kill -19 pid 即可； kill -18 pid 恢复暂停进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; #define SIGKILL     9    /* Kill, unblockable (POSIX). */</div><div class="line">&gt; #define SIGCONT     18   /* Continue (POSIX).  */</div><div class="line">&gt; #define SIGSTOP     19   /* Stop, unblockable (POSIX). */</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>tsar监控accept队列的溢出</p>
<blockquote>
<p>tsar –tcpx -s=lisove -li 1</p>
</blockquote>
<h3 id="Tomcat和Nginx中的Accept队列参数"><a href="#Tomcat和Nginx中的Accept队列参数" class="headerlink" title="Tomcat和Nginx中的Accept队列参数"></a>Tomcat和Nginx中的Accept队列参数</h3><p>Tomcat默认短连接，backlog（Tomcat里面的术语是Accept count）Ali-tomcat默认是200, Apache Tomcat默认100. </p>
<pre><code>#ss -lnt
Recv-Q Send-Q   Local Address:Port Peer Address:Port
0       100                 *:8080            *:*
</code></pre><p>Nginx默认是511</p>
<pre><code>$sudo ss -lnt
State  Recv-Q Send-Q Local Address:PortPeer Address:Port
LISTEN    0     511              *:8085           *:*
LISTEN    0     511              *:8085           *:*
</code></pre><p>因为Nginx是多进程模式，所以看到了多个8085，也就是多个进程都监听同一个端口以尽量避免上下文切换来提升性能   </p>
<p><img src="/images/oss/01dc036aca4b445ed86e3e295bf245b8.png" alt="image.png"></p>
<h2 id="进一步思考-client-fooling-问题"><a href="#进一步思考-client-fooling-问题" class="headerlink" title="进一步思考 client fooling 问题"></a>进一步思考 client fooling 问题</h2><p>如果client走完第三步在client看来连接已经建立好了，但是server上的对应的连接有可能因为accept queue满了而仍然是syn_recv状态，这个时候如果client发数据给server，server会怎么处理呢？（有同学说会reset，还是实践看看）</p>
<p>先来看一个例子：</p>
<p><img src="/images/oss/9179e08ac24ce3d53e74b92dbd044906.png" alt="image.png"></p>
<p>如上图，图中3号包是三次握手中的第三步，client发送ack给server，这个时候在client看来握手完成，然后4号包中client发送了一个长度为238的包给server，因为在这个时候client认为连接建立成功，但是server上这个连接实际没有ready，所以server没有回复，一段时间后client认为丢包了然后重传这238个字节的包，等到server reset了该连接（或者client一直重传这238字节到超时，client主动发fin包断开该连接，如下图）</p>
<p><img src="/images/oss/3f5f1eeb0646a3af8afd6bbff2a9ea0b.png" alt="image.png"></p>
<p>这个问题也叫client fooling，可以看这个patch在4.10后修复了：<a href="https://github.com/torvalds/linux/commit/5ea8ea2cb7f1d0db15762c9b0bb9e7330425a071" target="_blank" rel="external">https://github.com/torvalds/linux/commit/5ea8ea2cb7f1d0db15762c9b0bb9e7330425a071</a> ，修复的逻辑就是，如果全连接队列满了就不再回复syn+ack了，免得client误认为这个连接建立起来了，这样client端收不到syn+ack就只能重发syn。</p>
<p><strong>从上面的实际抓包来看不是reset，而是server忽略这些包，然后client重传，一定次数后client认为异常，然后断开连接。</strong></p>
<p>如果这个连接已经放入了全连接队列但是应用没有accept（比如应用卡住了），那么这个时候client发过来的包是不会被扔掉，OS会先收下放到接收buffer中，知道buffer满了再扔掉新进来的。</p>
<h2 id="过程中发现的一个奇怪问题"><a href="#过程中发现的一个奇怪问题" class="headerlink" title="过程中发现的一个奇怪问题"></a>过程中发现的一个奇怪问题</h2><pre><code>[root@server ~]# date; netstat -s | egrep &quot;listen|LISTEN&quot; 
Fri May  5 15:39:58 CST 2017
1641685 times the listen queue of a socket overflowed
1641685 SYNs to LISTEN sockets ignored

[root@server ~]# date; netstat -s | egrep &quot;listen|LISTEN&quot; 
Fri May  5 15:39:59 CST 2017
1641906 times the listen queue of a socket overflowed
1641906 SYNs to LISTEN sockets ignored
</code></pre><p>如上所示：<br>overflowed和ignored居然总是一样多，并且都是同步增加，overflowed表示全连接队列溢出次数，socket ignored表示半连接队列溢出次数，没这么巧吧。</p>
<p>翻看内核源代码（<a href="http://elixir.free-electrons.com/linux/v3.18/source/net/ipv4/tcp_ipv4.c）：" target="_blank" rel="external">http://elixir.free-electrons.com/linux/v3.18/source/net/ipv4/tcp_ipv4.c）：</a></p>
<p><img src="/images/oss/a5616904df3a505572d99d557b534db2.png" alt="image.png"></p>
<p>可以看到overflow的时候一定会drop++（socket ignored），也就是drop一定大于等于overflow。</p>
<p>同时我也查看了另外几台server的这两个值来证明drop一定大于等于overflow：</p>
<pre><code>server1
150 SYNs to LISTEN sockets dropped

server2
193 SYNs to LISTEN sockets dropped

server3
16329 times the listen queue of a socket overflowed
16422 SYNs to LISTEN sockets dropped

server4
20 times the listen queue of a socket overflowed
51 SYNs to LISTEN sockets dropped

server5
984932 times the listen queue of a socket overflowed
988003 SYNs to LISTEN sockets dropped
</code></pre><h2 id="那么全连接队列满了会影响半连接队列吗？"><a href="#那么全连接队列满了会影响半连接队列吗？" class="headerlink" title="那么全连接队列满了会影响半连接队列吗？"></a>那么全连接队列满了会影响半连接队列吗？</h2><p>来看三次握手第一步的源代码（<a href="http://elixir.free-electrons.com/linux/v2.6.33/source/net/ipv4/tcp_ipv4.c#L1249）：" target="_blank" rel="external">http://elixir.free-electrons.com/linux/v2.6.33/source/net/ipv4/tcp_ipv4.c#L1249）：</a></p>
<p><img src="/images/oss/0c6bbb5d4a10f40c8b3c4ba6cab82292.png" alt="image.png"></p>
<p>TCP三次握手第一步的时候如果全连接队列满了会影响第一步drop 半连接的发生。大概流程的如下：</p>
<pre><code>tcp_v4_do_rcv-&gt;tcp_rcv_state_process-&gt;tcp_v4_conn_request
//如果accept backlog队列已满，且未超时的request socket的数量大于1，则丢弃当前请求  
  if(sk_acceptq_is_full(sk) &amp;&amp; inet_csk_reqsk_queue_yong(sk)&gt;1)
      goto drop;
</code></pre><h2 id="半连接队列的长度"><a href="#半连接队列的长度" class="headerlink" title="半连接队列的长度"></a>半连接队列的长度</h2><p><strong>半连接队列的长度由三个参数指定：</strong></p>
<ul>
<li><strong>调用</strong> <strong>listen</strong> <strong>时，传入的 backlog</strong></li>
<li><strong>/proc/sys/net/core/somaxconn</strong> <strong>默认值为 128</strong></li>
<li><em>/proc/sys/net/ipv4/tcp_max_syn_backlog<strong> </strong>默认值为 1024*</em></li>
</ul>
<p>假设 listen 传入的 backlog = 128，其他配置采用默认值，来计算下半连接队列的最大长度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">backlog = min(somaxconn, backlog) = min(128, 128) = 128</div><div class="line">nr_table_entries = backlog = 128</div><div class="line">nr_table_entries = min(backlog, sysctl_max_syn_backlog) = min(128, 1024) = 128</div><div class="line">nr_table_entries = max(nr_table_entries, 8) = max(128, 8) = 128</div><div class="line">nr_table_entries = roundup_pow_of_two(nr_table_entries + 1) = 256</div><div class="line">max_qlen_log = max(3, log2(nr_table_entries)) = max(3, 8) = 8</div><div class="line">max_queue_length = 2^max_qlen_log = 2^8 = 256</div></pre></td></tr></table></figure>
<p>可以得到半队列大小是 256，以上计算方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">backlog = min(somaxconn, backlog)</div><div class="line">nr_table_entries = backlog</div><div class="line">nr_table_entries = min(backlog, sysctl_max_syn_backlog)</div><div class="line">nr_table_entries = max(nr_table_entries, 8)</div><div class="line">// roundup_pow_of_two: 将参数向上取整到最小的 2^n，注意这里存在一个 +1</div><div class="line">nr_table_entries = roundup_pow_of_two(nr_table_entries + 1)</div><div class="line">max_qlen_log = max(3, log2(nr_table_entries))</div><div class="line">max_queue_length = 2^max_qlen_log</div></pre></td></tr></table></figure>
<p><img src="/images/951413iMgBlog/5f63b8e0-952c-47a2-8179-48793034f86b.png" alt=""></p>
<p>没开启tcp_syncookies的话，到tcp_max_syn_backlog 75%水位就开始drop syn包了</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Linux内核就引入半连接队列（用于存放收到SYN，但还没收到ACK的连接）和全连接队列（用于存放已经完成3次握手，但是<strong>应用层代码还没有完成 accept() 的连接</strong>）两个概念，用于存放在握手中的连接。</p>
<p>全连接队列、半连接队列溢出这种问题很容易被忽视，但是又很关键，特别是对于一些短连接应用（比如Nginx、PHP，当然他们也是支持长连接的）更容易爆发。 一旦溢出，从cpu、线程状态看起来都比较正常，但是压力上不去，在client看来rt也比较高（rt=网络+排队+真正服务时间），但是从server日志记录的真正服务时间来看rt又很短。</p>
<p>另外就是jdk、netty等一些框架默认backlog比较小，可能有些情况下导致性能上不去，比如 @毕玄 碰到的这个 <a href="https://www.atatech.org/articles/12919" target="_blank" rel="external">《netty新建连接并发数很小的case》 </a><br>都是类似原因</p>
<p>希望通过本文能够帮大家理解TCP连接过程中的半连接队列和全连接队列的概念、原理和作用，更关键的是有哪些指标可以明确看到这些问题。</p>
<p>另外每个具体问题都是最好学习的机会，光看书理解肯定是不够深刻的，请珍惜每个具体问题，碰到后能够把来龙去脉弄清楚。</p>
<hr>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://veithen.github.io/2014/01/01/how-tcp-backlog-works-in-linux.html" target="_blank" rel="external">http://veithen.github.io/2014/01/01/how-tcp-backlog-works-in-linux.html</a></p>
<p><a href="http://www.cnblogs.com/zengkefu/p/5606696.html" target="_blank" rel="external">http://www.cnblogs.com/zengkefu/p/5606696.html</a></p>
<p><a href="http://www.cnxct.com/something-about-phpfpm-s-backlog/" target="_blank" rel="external">http://www.cnxct.com/something-about-phpfpm-s-backlog/</a></p>
<p><a href="http://jaseywang.me/2014/07/20/tcp-queue-%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/" target="_blank" rel="external">http://jaseywang.me/2014/07/20/tcp-queue-%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/</a></p>
<p><a href="http://jin-yang.github.io/blog/network-synack-queue.html#" target="_blank" rel="external">http://jin-yang.github.io/blog/network-synack-queue.html#</a></p>
<p><a href="http://blog.chinaunix.net/uid-20662820-id-4154399.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-20662820-id-4154399.html</a></p>
<p><a href="https://www.atatech.org/articles/12919" target="_blank" rel="external">https://www.atatech.org/articles/12919</a></p>
<p><a href="https://blog.cloudflare.com/syn-packet-handling-in-the-wild/" target="_blank" rel="external">https://blog.cloudflare.com/syn-packet-handling-in-the-wild/</a></p>
<p><a href="https://ops.tips/blog/how-linux-tcp-introspection/" target="_blank" rel="external">How Linux allows TCP introspection The inner workings of bind and listen on Linux.</a></p>
<p><a href="https://www.cnblogs.com/xiaolincoding/p/12995358.html" target="_blank" rel="external">https://www.cnblogs.com/xiaolincoding/p/12995358.html</a></p>
<p><a href="https://developer.aliyun.com/article/804896" target="_blank" rel="external">从一次线上问题说起，详解 TCP 半连接队列、全连接队列–详细的实验验证各种溢出</a></p>
<p><a href="https://mp.weixin.qq.com/s/YWzuKBK3TMclejeN2ziAvQ" target="_blank" rel="external">案例三：诡异的幽灵连接，全连接队列满后4.10内核不再回复syn+ack, 但是3.10会回syn+ack</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">commit 5ea8ea2cb7f1d0db15762c9b0bb9e7330425a071</div><div class="line">Author: Eric Dumazet &lt;edumazet@google.com&gt;</div><div class="line">Date:   Thu Oct 27 00:27:57 2016</div><div class="line"></div><div class="line"> tcp/dccp: drop SYN packets if accept queue is full</div><div class="line"></div><div class="line"> Per listen(fd, backlog) rules, there is really no point accepting a SYN,</div><div class="line"> sending a SYNACK, and dropping the following ACK packet if accept queue</div><div class="line"> is full, because application is not draining accept queue fast enough.</div><div class="line"></div><div class="line"> This behavior is fooling TCP clients that believe they established a</div><div class="line"> flow, while there is nothing at server side. They might then send about</div><div class="line"> 10 MSS (if using IW10) that will be dropped anyway while server is under</div><div class="line"> stress.</div><div class="line"></div><div class="line">   -       /* Accept backlog is full. If we have already queued enough</div><div class="line">   -        * of warm entries in syn queue, drop request. It is better than</div><div class="line">   -        * clogging syn queue with openreqs with exponentially increasing</div><div class="line">   -        * timeout.</div><div class="line">   -        */</div><div class="line">   -       if (sk_acceptq_is_full(sk) &amp;&amp; inet_csk_reqsk_queue_young(sk) &gt; 1) &#123;</div><div class="line">   +       if (sk_acceptq_is_full(sk)) &#123;</div><div class="line">                   NET_INC_STATS(sock_net(sk), LINUX_MIB_LISTENOVERFLOWS);</div><div class="line">                   goto drop;</div><div class="line">           &#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/06/02/就是要你懂TCP--连接和握手/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/02/就是要你懂TCP--连接和握手/" itemprop="url">就是要你懂TCP--握手和挥手</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-02T17:30:03+08:00">
                2017-06-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TCP/" itemprop="url" rel="index">
                    <span itemprop="name">TCP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="就是要你懂TCP–握手和挥手"><a href="#就是要你懂TCP–握手和挥手" class="headerlink" title="就是要你懂TCP–握手和挥手"></a>就是要你懂TCP–握手和挥手</h1><blockquote>
<p>看过太多tcp相关文章，但是看完总是不过瘾，似懂非懂，反复考虑过后，我觉得是那些文章太过理论，看起来没有体感，所以吸收不了。</p>
<p>希望这篇文章能做到言简意赅，帮助大家透过案例来理解原理</p>
</blockquote>
<h2 id="tcp的特点"><a href="#tcp的特点" class="headerlink" title="tcp的特点"></a>tcp的特点</h2><p>这个大家基本都能说几句，面试的时候候选人也肯定会告诉你这些：</p>
<ul>
<li>三次握手</li>
<li>四次挥手</li>
<li>可靠连接</li>
<li>丢包重传</li>
<li>速度自我调整</li>
</ul>
<p>但是我只希望大家记住一个核心的：<strong>tcp是可靠传输协议，它的所有特点都为这个可靠传输服务</strong>。</p>
<h3 id="那么tcp是怎么样来保障可靠传输呢？"><a href="#那么tcp是怎么样来保障可靠传输呢？" class="headerlink" title="那么tcp是怎么样来保障可靠传输呢？"></a>那么tcp是怎么样来保障可靠传输呢？</h3><p>tcp在传输过程中都有一个ack，接收方通过ack告诉发送方收到那些包了。这样发送方能知道有没有丢包，进而确定重传</p>
<h3 id="tcp建连接的三次握手"><a href="#tcp建连接的三次握手" class="headerlink" title="tcp建连接的三次握手"></a>tcp建连接的三次握手</h3><p>来看一个java代码连接数据库的三次握手过程</p>
<p><img src="/images/oss/6d66dadecb72e11e3e5ab765c6c3ea2e.png" alt="image.png"></p>
<p>三个红框表示建立连接的三次握手：</p>
<ul>
<li>第一步：client 发送 syn 到server 发起握手；</li>
<li>第二步：server 收到 syn后回复syn+ack给client；</li>
<li>第三步：client 收到syn+ack后，回复server一个ack表示收到了server的syn+ack（此时client的48287端口的连接已经是established）</li>
</ul>
<p>握手的核心目的是告知对方seq（绿框是client的初始seq，蓝色框是server 的初始seq），对方回复ack（收到的seq+包的大小），这样发送端就知道有没有丢包了</p>
<p>握手的次要目的是告知和协商一些信息，图中黄框。</p>
<ul>
<li>MSS–最大传输包</li>
<li>SACK_PERM–是否支持Selective ack(用户优化重传效率）</li>
<li>WS–窗口计算指数（有点复杂的话先不用管）</li>
</ul>
<p><img src="/images/oss/1423013fe76719cfa3088ebc4704c023.png" alt="image.png"></p>
<p>全连接队列（accept queue）的长度是由 listen(sockfd, backlog) 这个函数里的 backlog 控制的，而该 backlog 的最大值则是 somaxconn。somaxconn 在 5.4 之前的内核中，默认都是 128（5.4 开始调整为了默认 4096）</p>
<p>当服务器中积压的全连接个数超过该值后，新的全连接就会被丢弃掉。Server 在将新连接丢弃时，有的时候需要发送 reset 来通知 Client，这样 Client 就不会再次重试了。不过，默认行为是直接丢弃不去通知 Client。至于是否需要给 Client 发送 reset，是由 tcp_abort_on_overflow 这个配置项来控制的，该值默认为 0，即不发送 reset 给 Client。推荐也是将该值配置为 0</p>
<blockquote>
<p>net.ipv4.tcp_abort_on_overflow = 0</p>
</blockquote>
<p><strong>这就是tcp为什么要握手建立连接，就是为了解决tcp的可靠传输</strong></p>
<p>物理上没有一个连接的东西在这里，udp也类似会占用端口、ip，但是大家都没说过udp的连接。而本质上我们说tcp的连接是指tcp是拥有和维护一些状态信息的，这个状态信息就包含seq、ack、窗口/buffer，tcp握手就是协商出来这些初始值。这些状态才是我们平时所说的tcp连接的本质。</p>
<h3 id="unres-qlen-和-握手"><a href="#unres-qlen-和-握手" class="headerlink" title="unres_qlen  和 握手"></a>unres_qlen  和 握手</h3><p>tcp connect 的本地流程是这样的：</p>
<p>1、tcp发出SYN建链报文后，报文到ip层需要进行路由查询</p>
<p>2、路由查询完成后，报文到arp层查询下一跳mac地址</p>
<p>3、如果本地没有对应网关的arp缓存，就需要缓存住这个报文，发起arp请求</p>
<p>4、arp层收到arp回应报文之后，从缓存中取出SYN报文，完成mac头填写并发送给驱动。</p>
<p>问题在于，arp层报文缓存队列长度默认为3。如果你运气不好，刚好赶上缓存已满，这个报文就会被丢弃。</p>
<p>TCP层发现SYN报文发出去3s（默认值）还没有回应，就会重发一个SYN。这就是为什么少数连接会3s后才能建链。</p>
<p>幸运的是，arp层缓存队列长度是可配置的，用 sysctl -a | grep unres_qlen 就能看到，默认值为3。</p>
<h3 id="建连接失败经常碰到的问题"><a href="#建连接失败经常碰到的问题" class="headerlink" title="建连接失败经常碰到的问题"></a>建连接失败经常碰到的问题</h3><p>内核扔掉syn的情况（握手失败，建不上连接）：</p>
<ul>
<li>rp_filter 命中(rp_filter=1, 多网卡环境）， troubleshooting:  netstat -s | grep -i filter ;</li>
<li>snat/dnat的时候宿主机port冲突，内核会扔掉 syn包。 troubleshooting: sudo conntrack -S | grep  insert_failed //有不为0的</li>
<li>全连接队列满的情况</li>
<li>syn flood攻击</li>
<li>若远端服务器的内核参数 net.ipv4.tcp_tw_recycle 和 net.ipv4.tcp_timestamps 的值都为 1，则远端服务器会检查每一个报文中的时间戳（Timestamp），若 Timestamp 不是递增的关系，不会响应这个报文。配置 NAT 后，远端服务器看到来自不同的客户端的源 IP 相同，但 NAT 前每一台客户端的时间可能会有偏差，报文中的 Timestamp 就不是递增的情况。nat后的连接，开启timestamp。因为快速回收time_wait的需要，会校验时间该ip上次tcp通讯的timestamp大于本次tcp(nat后的不同机器经过nat后ip一样，保证不了timestamp递增）</li>
<li>NAT 哈希表满导致 ECS 实例丢包 nf_conntrack full</li>
</ul>
<h3 id="tcp断开连接的四次挥手"><a href="#tcp断开连接的四次挥手" class="headerlink" title="tcp断开连接的四次挥手"></a>tcp断开连接的四次挥手</h3><p>再来看java连上mysql后，执行了一个SQL： select sleep(2); 然后就断开了连接</p>
<p><img src="/images/oss/b6f4a952cdf8ffbb8f6e9434d1432e05.png" alt="image.png"></p>
<p>四个红框表示断开连接的四次挥手：</p>
<ul>
<li>第一步： client主动发送fin包给server</li>
<li>第二步： server回复ack（对应第一步fin包的ack）给client，表示server知道client要断开了</li>
<li>第三步： server发送fin包给client，表示server也可以断开了</li>
<li>第四部： client回复ack给server，表示既然双发都发送fin包表示断开，那么就真的断开吧</li>
</ul>
<p><img src="/images/oss/321f96243eef2f6437fe4e1559c15efe.png" alt="image.png"></p>
<p>除了 CLOSE_WAIT 状态外，其余两个状态都有对应的系统配置项来控制。</p>
<p>我们首先来看 FIN_WAIT_2 状态，TCP 进入到这个状态后，如果本端迟迟收不到对端的 FIN 包，那就会一直处于这个状态，于是就会一直消耗系统资源。Linux 为了防止这种资源的开销，设置了这个状态的超时时间 tcp_fin_timeout，默认为 60s，超过这个时间后就会自动销毁该连接。</p>
<p>至于本端为何迟迟收不到对端的 FIN 包，通常情况下都是因为对端机器出了问题，或者是因为太繁忙而不能及时 close()。所以，通常我们都建议将 tcp_fin_timeout 调小一些，以尽量避免这种状态下的资源开销。对于数据中心内部的机器而言，将它调整为 2s 足以：</p>
<blockquote>
<p>net.ipv4.tcp_fin_timeout = 2</p>
</blockquote>
<p>TIME_WAIT 状态存在的意义是：最后发送的这个 ACK 包可能会被丢弃掉或者有延迟，这样对端就会再次发送 FIN 包。如果不维持 TIME_WAIT 这个状态，那么再次收到对端的 FIN 包后，本端就会回一个 Reset 包，这可能会产生一些异常。</p>
<p><img src="/images/oss/9fbe15fa8b913ba76048f3b2ad2b923a.png" alt="image.png"></p>
<h3 id="为什么握手三次、挥手四次"><a href="#为什么握手三次、挥手四次" class="headerlink" title="为什么握手三次、挥手四次"></a>为什么握手三次、挥手四次</h3><p>这个问题太恶心，面试官太喜欢问，其实大部分面试官只会背诵：因为TCP是双向的，所以关闭需要四次挥手……。</p>
<p>你要是想怼面试官的话可以问他握手也是双向的但是只需要三次呢？</p>
<p>我也不知道怎么回答。网上都说tcp是双向的，所以断开要四次。但是我认为建连接也是双向的（双向都协调告知对方自己的seq号），为什么不需要四次握手呢，所以网上说的不一定精准。</p>
<p>你再看三次握手的第二步发 syn+ack，如果拆分成两步先发ack再发syn完全也是可以的（效率略低），这样三次握手也变成四次握手了。</p>
<p>看起来挥手的时候多一次，主要是收到第一个fin包后单独回复了一个ack包，如果能回复fin+ack那么四次挥手也就变成三次了。 来看一个案例：</p>
<p><img src="/images/oss/9db33f9304f8236b1ebcb215064bb2af.png" alt="image.png"></p>
<p>图中第二个红框就是回复的fin+ack，这样四次挥手变成三次了（如果一个包就是一次的话）。</p>
<p>我的理解：之所以绝大数时候我们看到的都是四次挥手，是因为收到fin后，知道对方要关闭了，然后OS通知应用层要关闭，这里应用层可能需要做些准备工作，可能还有数据没发送完，所以内核先回ack，等应用准备好了主动调close时再发fin 。 握手过程没有这个准备过程所以可以立即发送syn+ack（把这里的两步合成一步了）。 内核收到对方的fin后，只能ack，不能主动替应用来fin，因为他不清楚应用能不能关闭。</p>
<h3 id="ack-seq-len"><a href="#ack-seq-len" class="headerlink" title="ack=seq+len"></a>ack=seq+len</h3><p>ack总是seq+len（包的大小），这样发送方明确知道server收到那些东西了</p>
<p>但是特例是三次握手和四次挥手，虽然len都是0，但是syn和fin都要占用一个seq号，所以这里的ack都是seq+1</p>
<p><img src="/images/oss/45c6d36ce8b17a5c0442e66fce002ab4.png" alt="image.png"></p>
<p>看图中左边红框里的len+seq就是接收方回复的ack的数字，表示这个包接收方收到了。然后下一个包的seq就是前一个包的len+seq，依次增加，一旦中间发出去的东西没有收到ack就是丢包了，过一段时间（或者其他方式）触发重传，保障了tcp传输的可靠性。</p>
<h3 id="三次握手中协商的其它信息"><a href="#三次握手中协商的其它信息" class="headerlink" title="三次握手中协商的其它信息"></a>三次握手中协商的其它信息</h3><p>MSS 最大一个包中能传输的信息（不含tcp、ip包头），MSS+包头就是MTU（最大传输单元），如果MTU过大可能在传输的过程中被卡住过不去造成卡死（这个大小的包一直传输不过去），跟丢包还不一样</p>
<p>MSS的问题具体可以看我这篇文章： <a href="https://www.atatech.org/articles/60633" target="_blank" rel="external">scp某个文件的时候卡死问题的解决过程</a></p>
<p>SACK_PERM 用于丢包的话提升重传效率，比如client一次发了1、2、3、4、5 这5个包给server，实际server收到了 1、3、4、5这四个包，中间2丢掉了。这个时候server回复ack的时候，都只能回复2，表示2前面所有的包都收到了，给我发第二个包吧，如果server 收到3、4、5还是没有收到2的话，也是回复ack 2而不是回复ack 3、4、5、6的，表示快点发2过来。</p>
<p>但是这个时候client虽然知道2丢了，然后会重发2，但是不知道3、4、5有没有丢啊，实际3、4、5 server都收到了，如果支持sack，那么可以ack 2的时候同时告诉client 3、4、5都收到了，这样client重传的时候只重传2就可以，如果没有sack的话那么可能会重传2、3、4、5，这样效率就低了。</p>
<p>来看一个例子：</p>
<p><img src="/images/oss/5322d0cf77a3a1ae6c87a972cc5843d0.png" alt="image.png"></p>
<p>图中的红框就是SACK。</p>
<p>知识点：ack数字表示这个数字前面的数据<strong>都</strong>收到了</p>
<h2 id="TIME-WAIT-和-CLOSE-WAIT"><a href="#TIME-WAIT-和-CLOSE-WAIT" class="headerlink" title="TIME_WAIT 和 CLOSE_WAIT"></a>TIME_WAIT 和 CLOSE_WAIT</h2><p>假设服务端和客户端跑在同一台机器上，服务端监听在 18080端口上，客户端使用18089端口建立连接。</p>
<p>如果client主动断开连接那么就会看到client端的连接在 TIME_WAIT：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># netstat -ant |grep 1808</div><div class="line">tcp        0      0 0.0.0.0:18080           0.0.0.0:*               LISTEN      </div><div class="line">tcp        0      0 192.168.1.79:18089      192.168.1.79:18080      TIME_WAIT</div></pre></td></tr></table></figure>
<p>如果Server主动断开连接(也就是18080）那么就会看到client端的连接在CLOSE_WAIT 而Server在FIN_WAIT2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># netstat -ant |grep 1808</div><div class="line">tcp    0      0 192.168.1.79:18080      192.168.1.79:18089      FIN_WAIT2  --&lt;&lt; server</div><div class="line">tcp    0      0 192.168.1.79:18089      192.168.1.79:18080      CLOSE_WAIT --&lt;&lt; client</div></pre></td></tr></table></figure>
<p><strong>TIME_WAIT是主动断连方出现的状态（ 2MSL）</strong></p>
<h3 id="被动关闭方收到fin后有两种选择"><a href="#被动关闭方收到fin后有两种选择" class="headerlink" title="被动关闭方收到fin后有两种选择"></a>被动关闭方收到fin后有两种选择</h3><p>如下描述是server端主动关闭的情况</p>
<p>1 如果client也立即断开，那么Server的这个连接会进入 TIME_WAIT状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># netstat -ant |grep 1808</div><div class="line">tcp    0      0 0.0.0.0:18080           0.0.0.0:*            LISTEN  --&lt;&lt; server还在  </div><div class="line">tcp    0      0 192.168.1.79:18080      192.168.1.79:18089   TIME_WAIT --&lt;&lt; server</div></pre></td></tr></table></figure>
<p>2 client 坚持不断开过 Server 一段时间后（3.10：net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120， 4.19：net.ipv4.tcp_fin_timeout = 15）会结束这个连接但是client还是会 在CLOSE_WAIT 直到client进程退出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># netstat -ant |grep 1808</div><div class="line">tcp        0      0 192.168.1.79:18089      192.168.1.79:18080      CLOSE_WAIT</div></pre></td></tr></table></figure>
<h3 id="CLOSE-WAIT"><a href="#CLOSE-WAIT" class="headerlink" title="CLOSE_WAIT"></a>CLOSE_WAIT</h3><p><strong>CLOSE_WAIT是被动关闭端在等待应用进程的关闭</strong></p>
<p>通常，CLOSE_WAIT 状态在服务器停留时间很短，如果你发现大量的 CLOSE_WAIT 状态，那么就意味着被动关闭的一方没有及时发出 FIN 包，一般有如下几种可能：</p>
<ul>
<li><strong>程序问题</strong>：如果代码层面忘记了 close 相应的 socket 连接，那么自然不会发出 FIN 包，从而导致 CLOSE_WAIT 累积；或者代码不严谨，出现死循环之类的问题，导致即便后面写了 close 也永远执行不到。</li>
<li>响应太慢或者超时设置过小：如果连接双方不和谐，一方不耐烦直接 timeout，另一方却还在忙于耗时逻辑，就会导致 close 被延后。响应太慢是首要问题，不过换个角度看，也可能是 timeout 设置过小。</li>
<li>BACKLOG 太大：此处的 backlog 不是 syn backlog，而是 accept 的 backlog，如果 backlog 太大的话，设想突然遭遇大访问量的话，即便响应速度不慢，也可能出现来不及消费的情况，导致多余的请求还在<a href="http://jaseywang.me/2014/07/20/tcp-queue-的一些问题/" target="_blank" rel="external">队列</a>里就被对方关闭了。</li>
</ul>
<p>如果你通过「netstat -ant」或者「ss -ant」命令发现了很多 CLOSE_WAIT 连接，请注意结果中的「Recv-Q」和「Local Address」字段，通常「Recv-Q」会不为空，它表示应用还没来得及接收数据，而「Local Address」表示哪个地址和端口有问题，我们可以通过「lsof -i:<port>」来确认端口对应运行的是什么程序以及它的进程号是多少。</port></p>
<p>如果是我们自己写的一些程序，比如用 HttpClient 自定义的蜘蛛，那么八九不离十是程序问题，如果是一些使用广泛的程序，比如 Tomcat 之类的，那么更可能是响应速度太慢或者 timeout 设置太小或者 BACKLOG 设置过大导致的故障。</p>
<h4 id="server端大量close-wait案例"><a href="#server端大量close-wait案例" class="headerlink" title="server端大量close_wait案例"></a>server端大量close_wait案例</h4><p>看了这么多理论，下面用个案例来检查自己对close_wait理论（tcp握手本质）的掌握。同时也可以看看自己从知识到问题的推理能力（跟文章最后的知识效率呼应一下）。</p>
<p>问题描述：</p>
<blockquote>
<p>服务端出现大量CLOSE_WAIT 个数正好 等于somaxconn（调整somaxconn后 CLOSE_WAIT 也会跟着变成一样的值）</p>
</blockquote>
<p>根据这个描述先不要往下看，自己推理分析下可能的原因。</p>
<p>我的推理如下：</p>
<p>从这里看起来，client跟server成功建立了somaxconn个连接（somaxconn小于backlog，所以accept queue只有这么大），但是应用没有accept这个连接，导致这些连接一直在accept queue中。但是这些连接的状态已经是ESTABLISHED了，也就是client可以发送数据了，数据发送到server后OS ack了，并放在os的tcp buffer中，应用一直没有accept也就没法读取数据。client于是发送fin（可能是超时、也可能是简单发送数据任务完成了得结束连接），这时Server上这个连接变成了CLOSE_WAIT .</p>
<p>也就是从开始到结束这些连接都在accept queue中，没有被应用accept，很快他们又因为client 发送 fin 包变成了CLOSE_WAIT ，所以始终看到的是服务端出现大量CLOSE_WAIT 并且个数正好等于somaxconn（调整somaxconn后 CLOSE_WAIT 也会跟着变成一样的值）。</p>
<p>如下图所示，在连接进入accept queue后状态就是ESTABLISED了，也就是可以正常收发数据和fin了。client是感知不到server是否accept()了，只是发了数据后server的os代为保存在OS的TCP buffer中，因为应用没来取自然在CLOSE_WAIT 后应用也没有close()，所以一直维持CLOSE_WAIT 。</p>
<p>得检查server 应用为什么没有accept。</p>
<p><img src="/images/oss/2703fc07dfc4dd5b6e1bb4c2ce620e59.png" alt="image.png"></p>
<p>结论：</p>
<blockquote>
<p>这个case的最终原因是因为<strong>OS的open files设置的是1024,达到了上限</strong>，进而导致server不能accept，但这个时候的tcp连接状态已经是ESTABLISHED了（这个状态变换是取决于内核收发包，跟应用是否accept()无关）。</p>
<p>同时从这里可以推断 netstat 即使看到一个tcp连接状态是ESTABLISHED也不能代表占用了 open files句柄。此时client可以正常发送数据了，只是应用服务在accept之前没法receive数据和close连接。</p>
</blockquote>
<h2 id="TCP连接状态图"><a href="#TCP连接状态图" class="headerlink" title="TCP连接状态图"></a>TCP连接状态图</h2><p><img src="/images/oss/b3d075782450b0c8d2615c5d2b75d923.png" alt="image.png"></p>
<h2 id="总结下"><a href="#总结下" class="headerlink" title="总结下"></a>总结下</h2><p>tcp所有特性基本上核心都是为了<strong>可靠传输</strong>这个目标来服务的，然后有一些是出于优化性能的目的</p>
<p>三次握手建连接的详细过程可以参考我这篇： <a href="https://www.atatech.org/articles/78858" target="_blank" rel="external">关于TCP 半连接队列和全连接队列</a></p>
<p>后续希望再通过几个案例来深化一下上面的知识。</p>
<hr>
<p>为什么要案例来深化一下上面的知识，说点关于学习的题外话</p>
<h2 id="什么是工程效率，什么是知识效率"><a href="#什么是工程效率，什么是知识效率" class="headerlink" title="什么是工程效率，什么是知识效率"></a>什么是工程效率，什么是知识效率</h2><p>有些人纯看理论就能掌握好一门技能，还能举三反一，这是知识效率，这种人非常少；</p>
<p>大多数普通人都是看点知识然后结合实践来强化理解理论，要经过反反复复才能比较好地掌握一个知识，这就是工程效率，讲究技巧、工具来达到目的。</p>
<p>对于费曼（参考费曼学习法）这样的聪明人就是很容易看到一个理论知识就能理解这个理论知识背后的本质。</p>
<p>肯定知识效率最牛逼，但是拥有这种能力的人毕竟非常少。从小我们周边那种不怎么学的学霸型基本都是这类，这种学霸都还能触类旁通非常快地掌握一个新知识。剩下的绝大部分只能拼时间(刷题)+方法+总结等也能掌握一些知识</p>
<p>非常遗憾我就是工程效率型，只能羡慕那些知识效率型的学霸。但是这事又不能独立看待有些人在某些方向上是工程效率型，有些方向就又是知识效率型（有一种知识效率型是你掌握的实在太多也就比较容易触类旁通了，这算灰色知识效率型）</p>
<p>使劲挖掘自己在知识效率型方面的能力吧，即使灰色地带也行啊。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/06/02/就是要你懂TCP--wireshark-dup-ack-issue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/02/就是要你懂TCP--wireshark-dup-ack-issue/" itemprop="url">就是要你懂TCP--wireshark-dup-ack-issue</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-02T15:30:03+08:00">
                2017-06-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TCP/" itemprop="url" rel="index">
                    <span itemprop="name">TCP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="就是要你懂TCP–wireshark-dup-ack-issue"><a href="#就是要你懂TCP–wireshark-dup-ack-issue" class="headerlink" title="就是要你懂TCP–wireshark-dup-ack-issue"></a>就是要你懂TCP–wireshark-dup-ack-issue</h1><h2 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h2><p>很多同学学会抓包后，经常拿着这样一个抓包来问我是怎么回事：</p>
<p>在wireshark中看到一个tcp会话中的两台机器突然一直互相发dup ack包，但是没有触发重传。每次重复ack都是间隔精确的20秒</p>
<h2 id="如下截图："><a href="#如下截图：" class="headerlink" title="如下截图："></a>如下截图：</h2><p><img src="/images/951413iMgBlog/bm3W68Q.png" alt=""></p>
<p>client都一直在回复收到2号包（ack=2）了，可是server跟傻了一样居然还发seq=1的包（按理，应该发比2大的包啊）</p>
<h2 id="系统配置："><a href="#系统配置：" class="headerlink" title="系统配置："></a>系统配置：</h2><pre><code>net.ipv4.tcp_keepalive_time = 20
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 3
</code></pre><h2 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h2><p>抓包不全的话wireshark有缺陷，把keepalive包识别成了dup ack包，看内容这种dup ack和keepalive似乎是一样的，flags都是0x010。keep alive的定义的是后退一格(seq少1）。</p>
<p>2、4、6、8……号包，都有一个“tcp acked unseen segment”。这个一般表示它ack的这个包，没有被抓到。Wirshark如何作出此判断呢？前面一个包是seq=1, len=0，所以正常情况下是ack = seq + len = 1，然而Wireshark看到的确是ack = 2, 它只能判断有一个seq =1, len = 1的包没有抓到。<br>dup ack也是类似道理，这些包完全符合dup ack的定义，因为“ack = ” 某个数连续多次出现了。</p>
<p>这一切都是因为keep alive的特殊性导致的。打开66号包的tcp层（见后面的截图），可以看到它的 next sequence number = 12583，表示正常情况下server发出的下一个包应该是seq = 12583。可是在下一个包，也就是68号包中，却是seq = 12582。keep alive的定义的确是这样，即后退一格。<br>Wireshark只有在抓到数据包（66号包）和keep alive包的情况下才有可能正确识别，前面的抓包中恰好在keep alive之前丢失了数据包，所以Wireshark就蒙了。</p>
<h2 id="构造重现"><a href="#构造重现" class="headerlink" title="构造重现"></a>构造重现</h2><p>如果用“frame.number &gt;= 68” 过滤这个包，然后File–&gt;export specified packets保存成一个新文件，再打开那个新文件，就会发现Wireshark又蒙了。本来能够正常识别的keep alive包又被错看成dup ack了，所以一旦碰到这种情况不要慌要稳</p>
<p>下面是知识点啦</p>
<h2 id="Keepalive"><a href="#Keepalive" class="headerlink" title="Keepalive"></a>Keepalive</h2><p>TCP报文接收方必须回复的场景：</p>
<p>TCP携带字节数据<br>没有字节数据，携带SYN状态位<br>没有字节数据，携带FIN状态位</p>
<p>keepalive 提取历史发送的最后一个字节，充当心跳字节数据，依然使用该字节的最初序列号。也就是前面所说的seq回退了一个</p>
<p>对方收到后因为seq小于TCP滑动窗口的左侧，被判定为duplicated数据包，然后扔掉了，并回复一个duplicated ack</p>
<p>所以keepalive跟duplicated本质是一回事，就看wireshark能够正确识别了。</p>
<h2 id="Duplication-ack是指："><a href="#Duplication-ack是指：" class="headerlink" title="Duplication ack是指："></a>Duplication ack是指：</h2><p>server收到了3和8号包，但是没有收到中间的4/5/6/7，那么server就会ack 3，如果client还是继续发8/9号包，那么server会继续发dup ack 3#1 ; dup ack 3#2 来向客户端说明只收到了3号包，不要着急发后面的大包，把4/5/6/7给我发过来</p>
<h2 id="TCP-Window-Update"><a href="#TCP-Window-Update" class="headerlink" title="TCP Window Update"></a>TCP Window Update</h2><p><img src="/images/oss/1558941016099-bc4504f1-e9c7-4d84-85e1-a7f5c6554306.png" alt=""></p>
<p>如上图，当接收方的tcp Window Size不足一个MSS的时候，为了避免 Silly Window Syndrome，Client不再发小包，而是发送探测包（跟keepalive一样，发一个回退一格的包，触发server ack同时server ack的时候会带过来新的window size）探测包间隔时间是200/400/800/1600……ms这样</p>
<h2 id="正常的keep-alive-Case："><a href="#正常的keep-alive-Case：" class="headerlink" title="正常的keep-alive Case："></a>正常的keep-alive Case：</h2><p><img src="/images/951413iMgBlog/DsTWFZr.png" alt=""></p>
<p>keep-alive 通过发一个比实际seq小1的包，比如server都已经 ack 12583了，client故意发一个seq 12582来标识这是一个keep-Alive包</p>
<h2 id="Duplication-ack是指：-1"><a href="#Duplication-ack是指：-1" class="headerlink" title="Duplication ack是指："></a>Duplication ack是指：</h2><p>server收到了3和8号包，但是没有收到中间的4/5/6/7，那么server就会ack 3，如果client还是继续发8/9号包，那么server会继续发dup ack 3#1 ; dup ack 3#2 来向客户端说明只收到了3号包，不要着急发后面的大包，把4/5/6/7给我发过来</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/03/24/docker daemon添加label/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/24/docker daemon添加label/" itemprop="url">如何手动为docker daemon添加label</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-24T17:30:03+08:00">
                2017-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="如何手动为docker-daemon添加label"><a href="#如何手动为docker-daemon添加label" class="headerlink" title="如何手动为docker daemon添加label"></a>如何手动为docker daemon添加label</h1><ol>
<li><p>编辑或创建/etc/docker/daemon.json</p>
</li>
<li><p>将一个或多个lable以json格式写入文件，示例如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 为docker分配两个label，分别是nodetype和red</div><div class="line">&#123;"labels":["nodetype=dbpaas", "color=red"]&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>重启docker daemon</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service docker restart</div></pre></td></tr></table></figure>
</li>
</ol>
<p>4 /etc/docker/daemon.json 参考</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;api-cors-header&quot;: &quot;&quot;,</div><div class="line">    &quot;authorization-plugins&quot;: [],</div><div class="line">    &quot;bip&quot;: &quot;&quot;,</div><div class="line">    &quot;bridge&quot;: &quot;&quot;,</div><div class="line">    &quot;cgroup-parent&quot;: &quot;&quot;,</div><div class="line">    &quot;cluster-store&quot;: &quot;&quot;,</div><div class="line">    &quot;cluster-store-opts&quot;: &#123;&#125;,</div><div class="line">    &quot;cluster-advertise&quot;: &quot;&quot;,</div><div class="line">    &quot;debug&quot;: true,</div><div class="line">    &quot;default-gateway&quot;: &quot;&quot;,</div><div class="line">    &quot;default-gateway-v6&quot;: &quot;&quot;,</div><div class="line">    &quot;default-runtime&quot;: &quot;runc&quot;,</div><div class="line">    &quot;default-ulimits&quot;: &#123;&#125;,</div><div class="line">    &quot;disable-legacy-registry&quot;: false,</div><div class="line">    &quot;dns&quot;: [],</div><div class="line">    &quot;dns-opts&quot;: [],</div><div class="line">    &quot;dns-search&quot;: [],</div><div class="line">    &quot;exec-opts&quot;: [],</div><div class="line">    &quot;exec-root&quot;: &quot;&quot;,</div><div class="line">    &quot;fixed-cidr&quot;: &quot;&quot;,</div><div class="line">    &quot;fixed-cidr-v6&quot;: &quot;&quot;,</div><div class="line">    &quot;graph&quot;: &quot;&quot;,</div><div class="line">    &quot;group&quot;: &quot;&quot;,</div><div class="line">    &quot;hosts&quot;: [],</div><div class="line">    &quot;icc&quot;: false,</div><div class="line">    &quot;insecure-registries&quot;: [],</div><div class="line">    &quot;ip&quot;: &quot;0.0.0.0&quot;,</div><div class="line">    &quot;iptables&quot;: false,</div><div class="line">    &quot;ipv6&quot;: false,</div><div class="line">    &quot;ip-forward&quot;: false,</div><div class="line">    &quot;ip-masq&quot;: false,</div><div class="line">    &quot;labels&quot;: [&quot;nodetype=drds-server&quot;, &quot;ark.ip=11.239.155.83&quot;],</div><div class="line">    &quot;live-restore&quot;: true,</div><div class="line">    &quot;log-driver&quot;: &quot;&quot;,</div><div class="line">    &quot;log-level&quot;: &quot;&quot;,</div><div class="line">    &quot;log-opts&quot;: &#123;&#125;,</div><div class="line">    &quot;max-concurrent-downloads&quot;: 3,</div><div class="line">    &quot;max-concurrent-uploads&quot;: 5,</div><div class="line">    &quot;mtu&quot;: 0,</div><div class="line">    &quot;oom-score-adjust&quot;: -500,</div><div class="line">    &quot;pidfile&quot;: &quot;&quot;,</div><div class="line">    &quot;raw-logs&quot;: false,</div><div class="line">    &quot;registry-mirrors&quot;: [],</div><div class="line">    &quot;runtimes&quot;: &#123;</div><div class="line">        &quot;runc&quot;: &#123;</div><div class="line">            &quot;path&quot;: &quot;runc&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;custom&quot;: &#123;</div><div class="line">            &quot;path&quot;: &quot;/usr/local/bin/my-runc-replacement&quot;,</div><div class="line">            &quot;runtimeArgs&quot;: [</div><div class="line">                &quot;--debug&quot;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;selinux-enabled&quot;: false,</div><div class="line">    &quot;storage-driver&quot;: &quot;&quot;,</div><div class="line">    &quot;storage-opts&quot;: [],</div><div class="line">    &quot;swarm-default-advertise-addr&quot;: &quot;&quot;,</div><div class="line">    &quot;tls&quot;: true,</div><div class="line">    &quot;tlscacert&quot;: &quot;&quot;,</div><div class="line">    &quot;tlscert&quot;: &quot;&quot;,</div><div class="line">    &quot;tlskey&quot;: &quot;&quot;,</div><div class="line">    &quot;tlsverify&quot;: true,</div><div class="line">    &quot;userland-proxy&quot;: false,</div><div class="line">    &quot;userns-remap&quot;: &quot;&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Daemon.json 指定 ulimit等参考</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">cat &gt;&gt; /etc/docker/daemon.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  &quot;data-root&quot;: &quot;/var/lib/docker&quot;,</div><div class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</div><div class="line">  &quot;log-opts&quot;: &#123;</div><div class="line">    &quot;max-size&quot;: &quot;200m&quot;,</div><div class="line">    &quot;max-file&quot;: &quot;5&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;default-ulimits&quot;: &#123;</div><div class="line">    &quot;nofile&quot;: &#123;</div><div class="line">      &quot;Name&quot;: &quot;nofile&quot;,</div><div class="line">      &quot;Hard&quot;: 655360,</div><div class="line">      &quot;Soft&quot;: 655360</div><div class="line">    &#125;,</div><div class="line">    &quot;nproc&quot;: &#123;</div><div class="line">      &quot;Name&quot;: &quot;nproc&quot;,</div><div class="line">      &quot;Hard&quot;: 655360,</div><div class="line">      &quot;Soft&quot;: 655360</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;live-restore&quot;: true,</div><div class="line">  &quot;oom-score-adjust&quot;: -1000,</div><div class="line">  &quot;max-concurrent-downloads&quot;: 10,</div><div class="line">  &quot;max-concurrent-uploads&quot;: 10,</div><div class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</div><div class="line">  &quot;storage-opts&quot;: [&quot;overlay2.override_kernel_check=true&quot;],</div><div class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</div><div class="line">  &quot;registry-mirrors&quot;: [</div><div class="line">    &quot;https://yssx4sxy.mirror.aliyuncs.com/&quot;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/03/24/docker swarm的Label使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/24/docker swarm的Label使用/" itemprop="url">docker、swarm的Label使用</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-24T17:30:03+08:00">
                2017-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="docker、swarm的Label使用"><a href="#docker、swarm的Label使用" class="headerlink" title="docker、swarm的Label使用"></a>docker、swarm的Label使用</h1><h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><p>广发银行需要把方舟集群部署在多个机房（多个机房组成一个大集群），这样物理机和容器vlan没法互相完全覆盖，</p>
<p>也就是可能会出现A机房的网络subnet:192.168.1.0/24, B 机房的网络subnet：192.168.100.0/24 但是他们属于同一个vlan，要求如果容器在A机房的物理机拉起，分到的是192.168.1.0/24中的IP，B机房的容器分到的IP是：192.168.100.0/24</p>
<p><strong>功能实现：</strong></p>
<ul>
<li><strong>本质就是对所有物理机打标签，同一个asw下的物理机用同样的标签，不同asw下的物理机标签不同；</strong></li>
<li><strong>创建容器网络的时候也加标签，不同asw下的网络标签不一样，同时跟这个asw下的物理机标签匹配；</strong></li>
<li><strong>创建容器的时候使用 –net=driver:vlan 来动态选择多个vlan网络中的任意一个，然后swarm根据网络的标签要和物理机的标签一致，从而把容器调度到正确的asw下的物理机上。</strong></li>
</ul>
<p><strong>分为如下三个改造点</strong></p>
<p><strong>1：</strong></p>
<p>daemon启动的时候增加标签（其中一个就行）：</p>
<table>
<thead>
<tr>
<th>上联交换机组的名称，多个逗号隔开</th>
<th>com.alipay.acs.engine.asw.hostname</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p><strong>2：</strong><br>创建网络的时候使用对应的标签：</p>
<table>
<thead>
<tr>
<th>网络域交换机组asw列表的名称，多个逗号隔开</th>
<th>com.alipay.acs.network.asw.hostname</th>
</tr>
</thead>
<tbody>
<tr>
<td>该VLAN网络是否必须显式指定，默认为0即不必须，此时当传入–net driver:vlan时ACS会根据调度结果自行选择一个可用的VLAN网络并拼装到参数中</td>
<td>com.alipay.acs.network.explicit</td>
</tr>
</tbody>
</table>
<p><strong>3：</strong></p>
<p>Swarm manager增加可选启动选项netarch.multiscope，值为true</p>
<h3 id="功能实现逻辑"><a href="#功能实现逻辑" class="headerlink" title="功能实现逻辑"></a>功能实现逻辑</h3><ol>
<li>Swarm manager增加可选启动选项netarch.multiscope，当为1时，network create时强制要求必须指定label描述配置VLAN的ASW信息</li>
<li>Swarm manager在创建容器时检查网络类型，VLAN网络时则将网络ASW的label放入过滤器中，在调度时按照机器的ASW标签过滤</li>
<li>如果使用者如果不关心具体使用哪个VLAN，则可以指定–net=”driver:vlan”，会自动查找driver=vlan的network，并根据调度结果（Node所关联的ASW）自动选择合适的network填入Config.HostConfig.NetworkMode传递给Docker daemon.</li>
</ol>
<p>如果是现存的环境，修改zk来更新网络标签：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 21] get /Cluster/docker/network/v1.0/network/c79e533e4444294ac9cb7838608115c961c6e403d3610367ff4b197ef6b981fc </div><div class="line">&#123;&quot;addrSpace&quot;:&quot;GlobalDefault&quot;,&quot;enableIPv6&quot;:false,&quot;generic&quot;:&#123;&quot;com.docker.network.enable_ipv6&quot;:false,&quot;com.docker.network.generic&quot;:&#123;&quot;VlanId&quot;:&quot;192&quot;&#125;&#125;,&quot;id&quot;:&quot;c79e533e4444294ac9cb7838608115c961c6e403d3610367ff4b197ef6b981fc&quot;,&quot;inDelete&quot;:false,&quot;internal&quot;:false,&quot;ipamOptions&quot;:&#123;&quot;VlanId&quot;:&quot;192&quot;&#125;,&quot;ipamType&quot;:&quot;default&quot;,&quot;ipamV4Config&quot;:&quot;[&#123;\&quot;PreferredPool\&quot;:\&quot;192.168.8.0/24\&quot;,\&quot;SubPool\&quot;:\&quot;\&quot;,\&quot;Gateway\&quot;:\&quot;192.168.8.1\&quot;,\&quot;AuxAddresses\&quot;:null&#125;]&quot;,&quot;ipamV4Info&quot;:&quot;[&#123;\&quot;IPAMData\&quot;:\&quot;&#123;\\\&quot;AddressSpace\\\&quot;:\\\&quot;\\\&quot;,\\\&quot;Gateway\\\&quot;:\\\&quot;192.168.8.1/24\\\&quot;,\\\&quot;Pool\\\&quot;:\\\&quot;192.168.8.0/24\\\&quot;&#125;\&quot;,\&quot;PoolID\&quot;:\&quot;GlobalDefault/192.168.8.0/24\&quot;&#125;]&quot;,&quot;labels&quot;:&#123;&#125;,&quot;name&quot;:&quot;vlan192-8&quot;,&quot;networkType&quot;:&quot;vlan&quot;,&quot;persist&quot;:true,&quot;postIPv6&quot;:false,&quot;scope&quot;:&quot;global&quot;&#125;</div><div class="line">cZxid = 0x4100008cce</div><div class="line">ctime = Fri Mar 09 12:46:44 CST 2018</div><div class="line">mZxid = 0x4100008cce</div><div class="line">mtime = Fri Mar 09 12:46:44 CST 2018</div><div class="line">pZxid = 0x4100008cce</div><div class="line">cversion = 0</div><div class="line">dataVersion = 0</div><div class="line">aclVersion = 0</div><div class="line">ephemeralOwner = 0x0</div><div class="line">dataLength = 716</div><div class="line">numChildren = 0</div></pre></td></tr></table></figure>
<p>//注意上面的网络还没有标签，修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[zk: localhost:2181(CONNECTED) 28] set /Cluster/docker/network/v1.0/network/c79e533e4444294ac9cb7838608115c961c6e403d3610367ff4b197ef6b981fc &#123;&quot;addrSpace&quot;:&quot;GlobalDefault&quot;,&quot;enableIPv6&quot;:false,&quot;generic&quot;:&#123;&quot;com.docker.network.enable_ipv6&quot;:false,&quot;com.docker.network.generic&quot;:&#123;&quot;VlanId&quot;:&quot;192&quot;&#125;&#125;,&quot;id&quot;:&quot;c79e533e4444294ac9cb7838608115c961c6e403d3610367ff4b197ef6b981fc&quot;,&quot;inDelete&quot;:false,&quot;internal&quot;:false,&quot;ipamOptions&quot;:&#123;&quot;VlanId&quot;:&quot;192&quot;&#125;,&quot;ipamType&quot;:&quot;default&quot;,&quot;ipamV4Config&quot;:&quot;[&#123;\&quot;PreferredPool\&quot;:\&quot;192.168.8.0/24\&quot;,\&quot;SubPool\&quot;:\&quot;\&quot;,\&quot;Gateway\&quot;:\&quot;192.168.8.1\&quot;,\&quot;AuxAddresses\&quot;:null&#125;]&quot;,&quot;ipamV4Info&quot;:&quot;[&#123;\&quot;IPAMData\&quot;:\&quot;&#123;\\\&quot;AddressSpace\\\&quot;:\\\&quot;\\\&quot;,\\\&quot;Gateway\\\&quot;:\\\&quot;192.168.8.1/24\\\&quot;,\\\&quot;Pool\\\&quot;:\\\&quot;192.168.8.0/24\\\&quot;&#125;\&quot;,\&quot;PoolID\&quot;:\&quot;GlobalDefault/192.168.8.0/24\&quot;&#125;]&quot;,**&quot;labels&quot;:&#123;&quot;com.alipay.acs.network.asw.hostname&quot;:&quot;238&quot;&#125;,**&quot;name&quot;:&quot;vlan192-8&quot;,&quot;networkType&quot;:&quot;vlan&quot;,&quot;persist&quot;:true,&quot;postIPv6&quot;:false,&quot;scope&quot;:&quot;global&quot;&#125;</div></pre></td></tr></table></figure>
<p>example：</p>
<p>创建网络：//–label=”com.alipay.acs.network.asw.hostname=vlan902-63”<br>docker network create -d vlan –label=”com.alipay.acs.network.asw.hostname=vlan902-63” –subnet=11.162.63.0/24  –gateway=11.162.63.247  –opt VlanId=902 –ipam-opt VlanId=902 hanetwork2<br>跟daemon中的标签：com.alipay.acs.engine.asw.hostname=vlan902-63 对应，匹配调度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$sudo cat /etc/docker/daemon.json</div><div class="line">&#123;&quot;labels&quot;:[&quot;com.alipay.acs.engine.hostname=11.239.142.46&quot;,&quot;com.alipay.acs.engine.ip=11.239.142.46&quot;,&quot;com.alipay.acs.engine.device_type=Server&quot;,&quot;com.alipay.acs.engine.status=free&quot;,&quot;ark.network.vlan.range=vlan902-63&quot;,&quot;com.alipay.acs.engine.asw.hostname=vlan902-63&quot;,&quot;com.alipay.acs.network.asw.hostname=vlan902-63&quot;]&#125;</div><div class="line">//不指定具体网络，有多个网络的时候自动调度  --net driver:vlan 必须是network打过标签了</div><div class="line">docker run -d -it --name=&quot;udp10&quot; --net driver:vlan --restart=always reg.docker.alibaba-inc.com/middleware.udp</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/03/24/方舟环境容器调度/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/24/方舟环境容器调度/" itemprop="url">方舟环境容器调度</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-24T17:30:03+08:00">
                2017-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="方舟环境容器调度"><a href="#方舟环境容器调度" class="headerlink" title="方舟环境容器调度"></a>方舟环境容器调度</h1><h2 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h2><ul>
<li>恢复宿主机死机或者断网后上面需要调度的所有容器</li>
<li>恢复非正常的容器状态到正常</li>
<li>调度的容器能够支持vlan网络和Host模式</li>
<li>调度容器本身通过Leader-Follower的模式保证高可用性</li>
<li>调度容器支持cron定时任务（精确到秒级）</li>
<li>查询哪个节点是Leader</li>
<li>停止或者打开调度（方便容器维护、正常启停）</li>
</ul>
<h2 id="通过-ark-schedule-镜像启动调度"><a href="#通过-ark-schedule-镜像启动调度" class="headerlink" title="通过 ark-schedule 镜像启动调度"></a>通过 ark-schedule 镜像启动调度</h2><p>必须在swarm manager节点上以 docker 容器的方式来启动，下面的 -e 参数对应后面的 export 参数和作用注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d --restart=always --name=ark-schedule -e ACS_CLUSTER_SECURITY_GROUP=false -e ACS_CLUSTER_SCHEME=tcp -e ACS_CLUSTER_ENDPOINT=11.239.155.112:3376 -e ACS_NETWORK_NAME=vlan701 -e ACS_CRONTAB=&quot;7 * * * * *&quot; -e ACS_PORT=3375 -e ACS_ADVERTISE=11.239.155.112:3375 -e ACS_NETWORK_STORE_CLUSTER=zk://11.239.155.112:2181,11.239.155.103:2181,11.239.155.97:2181/Cluster -e affinity:container==swarm-manager --net=host reg.docker.alibaba-inc.com/ark/ark-schedule:0.6-20180530-68e7bed /ark-schedule/ark-schedule --debug start</div></pre></td></tr></table></figure>
<p>如果需要调度容器本身高可以用，需要在不同的宿主机上启动多个 ark-schedule 容器， 同时可以给调度容器自己增加调度标签</p>
<h3 id="环境变量参数说明"><a href="#环境变量参数说明" class="headerlink" title="环境变量参数说明"></a>环境变量参数说明</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">export ACS_CLUSTER_ENDPOINT=10.125.14.238:3376; //跟自己在同一台宿主机的swarm-manager</div><div class="line">export ACS_NETWORK_NAME=vlan192;  //方舟网络名称 docker network ls 看到vlan开头的名字</div><div class="line">export ACS_NETWORK_STORE_CLUSTER=zk://10.125.26.108:2181,10.125.14.238:2181,10.125.1.45:2181/Cluster; //方舟zk集群，同部署的ark.properties中的</div><div class="line">export ACS_CRONTAB=&quot;*/7 * * * * *&quot; </div><div class="line">export ACS_PORT=&quot;3375&quot; //schedule 自身api暴露端口</div><div class="line">export ACS_ADVERTISE=&quot;10.125.14.238:3375&quot; //宿主机ip+自身api暴露端口 多个schedule容器唯一</div><div class="line">./ark-schedule --debug start</div></pre></td></tr></table></figure>
<p>ark-schedule 容器默认占用3375端口，如果要用别的端口需要通过 -e ACS_PORT 参数传入</p>
<p><code>-e ACS_CRONTAB=&quot;7 * * * * *&quot; （秒 分 时 天 月 星期）</code></p>
<p>这个参数如果没有，那么需要外部来触发调度API（见下面）</p>
<p>ACS_ADVERTISE=”10.125.26.108:3375”  这个参数是多容器选举用的，每个容器用自己的IP+PORT来标识</p>
<p>容器日志主要在 /root/logs/ark-schedule-container-2017-12-12.log 中， 可以映射到宿主机上，查看更方便</p>
<h3 id="镜像版本"><a href="#镜像版本" class="headerlink" title="镜像版本"></a>镜像版本</h3><p>0.1 带cron功能，自动定时扫描并恢复容器<br>0.2-election 有多个ark-schedule节点选举功能，抢到主的开始cron，没有抢到或者失去主的stop cron<br>0.3-election 在0.2的基础上修复了docker/libkv的bug，能够在弱网络、断网的条件下正常运行<br>0.4-switch 增加查询leader节点和cron是否开始的API，增加对Leader的cron启停的API<br>0.5-labels 增加对restart/recreate 标签的支持<br>0.6 去掉了对多个zk的支持，简化启动参数<br>0.7 修复了重复endpoint导致的容器的域名不通、inspect notfound（集群多个同名容器的时候）等各种问题</p>
<h2 id="所有需要调度的容器增加调度标志标签"><a href="#所有需要调度的容器增加调度标志标签" class="headerlink" title="所有需要调度的容器增加调度标志标签"></a>所有需要调度的容器增加调度标志标签</h2><p>在docker run中增加一个标签： –label “ark.labels.schedule=haproxy”</p>
<p>详细命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo docker update --label-add=&quot;ark.labels.schedule=haproxy&quot; --label-add=&quot;ark.enable_restart=true&quot; --label-add=&quot;ark.enable_recreate=true&quot; 容器名1 容器名2</div></pre></td></tr></table></figure>
<p><strong>上述命令不需要重启容器，但是要重新调snapshot API 做一次快照，让他们生效</strong></p>
<p>ark-schedule容器在调度容器的时候，先检查快照中的容器，如果容器不见了或者状态不是up，又包含如上标签，就会重新在其它机器上把这个容器拉起来</p>
<ul>
<li><p>ark.enable_restart<br>是否允许通过重启来恢复容器（默认是true）。true为可以，false不可以</p>
</li>
<li><p>ark.enable_recreate<br>是否允许将消失的容器在其他宿主机重建（默认是true）。true为可以，false不可以</p>
</li>
</ul>
<h2 id="API-（如下ip：10-125-14-238-在现场换成客户物理机IP）"><a href="#API-（如下ip：10-125-14-238-在现场换成客户物理机IP）" class="headerlink" title="API （如下ip：10.125.14.238 在现场换成客户物理机IP）"></a>API （如下ip：10.125.14.238 在现场换成客户物理机IP）</h2><ol>
<li>中间件部署完毕，并检查无误，调用： curl -v “<a href="http://10.125.14.238:3375/schedule/snapshot" target="_blank" rel="external">http://10.125.14.238:3375/schedule/snapshot</a>“ 对中间件做快照，将来会按快照的状态来进行恢复，执行一次就可以</li>
<li>手动恢复容器不见了，调用 curl -v “<a href="http://10.125.14.238:3375/schedule/snapshot/restore" target="_blank" rel="external">http://10.125.14.238:3375/schedule/snapshot/restore</a>“ 会将所有异常容器恢复回来</li>
<li>schedule 容器本身的健康检查接口 curl <a href="http://10.125.14.238:3375/schedule/leader" target="_blank" rel="external">http://10.125.14.238:3375/schedule/leader</a> http code 值是 200,说明schedule容器是健康的</li>
<li>查询哪个节点是Leader curl 以及是否是停止调度（维护时）： “<a href="http://10.125.14.238:3375/schedule/leader" target="_blank" rel="external">http://10.125.14.238:3375/schedule/leader</a>“</li>
<li>停止调度，先查询谁是leader，然后调： “<a href="http://leader-ip:3375/schedule/stop" target="_blank" rel="external">http://leader-ip:3375/schedule/stop</a>“</li>
</ol>
<h2 id="维护状态"><a href="#维护状态" class="headerlink" title="维护状态"></a>维护状态</h2><p>通过调度容器API停止调度，所有容器都不再被调度了，维护完毕再调snapshot、start API恢复调度。</p>
<p>如果只想对某个容器进行维护，其它容器还是希望被调度监控、调度可以通过下面的方式来实现：</p>
<p><code>docker update --label-rm=&quot;ark.labels.schedule=haproxy&quot; 容器1 容器2 //还可以跟多个容器名</code><br><strong>然后调 snapshot API让刚刚的update生效</strong></p>
<p>运维完毕，恢复运维后的容器进入可以调度状态，具体命令如下：</p>
<p><code>docker update --label-add=&quot;ark.labels.schedule=haproxy&quot; 容器1 容器2 //还可以跟多个容器名</code></p>
<p><strong>然后调 snapshot API让刚刚的update生效</strong></p>
<p><img src="/images/oss/b055cf8f275749491fc768fab1ffd1a5.png" alt="image.png"></p>
<h2 id="升级ark-schedule步骤："><a href="#升级ark-schedule步骤：" class="headerlink" title="升级ark-schedule步骤："></a>升级ark-schedule步骤：</h2><h3 id="下载并导入新镜像"><a href="#下载并导入新镜像" class="headerlink" title="下载并导入新镜像"></a>下载并导入新镜像</h3><p>下载镜像：<a href="http://fzpackages.oss-cn-shanghai.aliyuncs.com/ark%2Fpatch%2Fark-schedule-0.6-20180530-68e7bed.tgz" target="_blank" rel="external">http://fzpackages.oss-cn-shanghai.aliyuncs.com/ark%2Fpatch%2Fark-schedule-0.6-20180530-68e7bed.tgz</a><br>sudo docker load -i ark-schedule-0.6-20180530-68e7bed.tgz</p>
<h3 id="停止原来的ark-schedule"><a href="#停止原来的ark-schedule" class="headerlink" title="停止原来的ark-schedule"></a>停止原来的ark-schedule</h3><p>停止两个crontab(新的ark-schedule自带crontab，每分钟执行一次调度)</p>
<p>停止两个ark-schedule容器</p>
<h3 id="启动新的ark-schdule"><a href="#启动新的ark-schdule" class="headerlink" title="启动新的ark-schdule"></a>启动新的ark-schdule</h3><p>在停止的两个ark-schedule的两台机器上启动两个新的ark-schedule容器，启动参数需要修改参考前面的描述(用现场环境信息替换下面的信息)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">export ACS_CLUSTER_ENDPOINT=10.125.14.238:3376; //跟自己在同一台宿主机的swarm-manager</div><div class="line">export ACS_NETWORK_NAME=vlan192;  //方舟网络名称 docker network ls 看到vlan开头的名字</div><div class="line">export ACS_NETWORK_STORE_CLUSTER=zk://10.125.26.108:2181,10.125.14.238:2181,10.125.1.45:2181/Cluster; //方舟zk集群，同部署的ark.properties中的</div><div class="line">export ACS_CRONTAB=&quot;*/7 * * * * *&quot;  ----不需要改</div><div class="line">export ACS_PORT=&quot;3375&quot; //schedule 自身api暴露端口----不需要改</div><div class="line">export ACS_ADVERTISE=&quot;10.125.14.238:3375&quot; //宿主机ip+自身api暴露端口 多个schedule容器唯一</div><div class="line">./ark-schedule --debug start //----不需要改</div></pre></td></tr></table></figure>
<h2 id="检查调度日志"><a href="#检查调度日志" class="headerlink" title="检查调度日志"></a>检查调度日志</h2><p>检查两个ark-schedule 谁是主： curl <a href="http://ark-schedule所在的宿主机-ip:3375/schedule/leader" target="_blank" rel="external">http://ark-schedule所在的宿主机-ip:3375/schedule/leader</a> </p>
<p>进到是主的ark-schedule容器中看日志：cat /root/logs/ark-schedule-2018-日期.log</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>如何打标签 <a href="http://panama.alibaba-inc.com/qa/faq?id=1124" title="http://panama.alibaba-inc.com/qa/faq?id=1124" target="_blank" rel="external">http://panama.alibaba-inc.com/qa/faq?id=1124</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/03/24/物理机磁盘空间去哪了/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/24/物理机磁盘空间去哪了/" itemprop="url">物理机磁盘空间都去哪里了</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-24T17:30:03+08:00">
                2017-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="磁盘爆掉的几种情况"><a href="#磁盘爆掉的几种情况" class="headerlink" title="磁盘爆掉的几种情况"></a>磁盘爆掉的几种情况</h1><ol>
<li>系统磁盘没有空间，解决办法：删掉 /var/log/ 下边的带日期的日志，清空 /var/log/messages 内容</li>
<li>容器使用的大磁盘空间不够，又有三个地方会使用大量的磁盘<ul>
<li>容器内部日志非常大，处理办法见方法一</li>
<li>容器内部产生非常多或者非常大的文件，但是这个文件的位置又通过volume 挂载到了物理机上，处理办法见方法二</li>
<li>对特别老的部署环境，还有可能是容器的系统日志没有限制大小，处理办法见方法三</li>
</ul>
</li>
</ol>
<h2 id="现场的同学按如下方法依次检查"><a href="#现场的同学按如下方法依次检查" class="headerlink" title="现场的同学按如下方法依次检查"></a>现场的同学按如下方法依次检查</h2><h3 id="方法零：-检查系统根目录下每个文件夹的大小"><a href="#方法零：-检查系统根目录下每个文件夹的大小" class="headerlink" title="方法零： 检查系统根目录下每个文件夹的大小"></a>方法零： 检查系统根目录下每个文件夹的大小</h3><p><code>sudo du / -lh --max-depth=1 --exclude=overlay --exclude=proc</code></p>
<p>看看除了容器之外有没有其它目录使用磁盘特别大，如果有那么一层层进去通过du命令来查看，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#sudo du / -lh --max-depth=1 --exclude=overlay --exclude=proc</div><div class="line">16K	/dev</div><div class="line">16K	/lost+found</div><div class="line">4.0K	/media</div><div class="line">17G	/home</div><div class="line">136M	/boot</div><div class="line">832K	/run</div><div class="line">1.9G	/usr</div><div class="line">75M	/tmp</div><div class="line">12K	/log</div><div class="line">8.5G	/var</div><div class="line">4.0K	/srv</div><div class="line">0	/proc</div><div class="line">22M	/etc</div><div class="line">84G	/root</div><div class="line">4.0K	/mnt</div><div class="line">508M	/opt</div><div class="line">0	/sys</div><div class="line">112G	/</div></pre></td></tr></table></figure>
<p>那么这个案例中应该查看 /root下为什么用掉了84G（总共用了112G）， 先 cd /root 然后执行： sudo du . -lh –max-depth=1 –exclude=overlay 进一步查看 /root 目录下每个文件夹的大小</p>
<p><strong>如果方法零没找到占用特别大的磁盘文件，那么一般来说是容器日志占用太多的磁盘空间，请看方法一</strong></p>
<h3 id="方法一：-容器内部日志非常大（请确保先按方法零检查过了）"><a href="#方法一：-容器内部日志非常大（请确保先按方法零检查过了）" class="headerlink" title="方法一： 容器内部日志非常大（请确保先按方法零检查过了）"></a>方法一： 容器内部日志非常大（请确保先按方法零检查过了）</h3><p>在磁盘不够的物理机上执行如下脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sudo docker ps -a -q &gt;containers.list</div><div class="line"></div><div class="line">sudo cat containers.list | xargs sudo docker inspect $1 | grep merged | awk -F \&quot; &apos;&#123; print $4 &#125;&apos; | sed &apos;s/\/merged//g&apos; | xargs sudo du  --max-depth=0 $1 &gt;containers.size </div><div class="line"></div><div class="line">sudo paste containers.list containers.size | awk &apos;&#123; print $1, $2 &#125;&apos;  | sort -nk2 &gt;real_size.log</div><div class="line"></div><div class="line">sudo tail -10 real_size.log  | awk &apos;BEGIN &#123;print &quot;\tcontainer     size\tunit&quot;&#125; &#123; print NR&quot;:\t&quot; $0&quot;\t kB&quot; &#125;&apos;</div></pre></td></tr></table></figure>
<h5 id="执行完后会输出如下格式："><a href="#执行完后会输出如下格式：" class="headerlink" title="执行完后会输出如下格式："></a>执行完后会输出如下格式：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">   	container     size	unit</div><div class="line">1:	22690f16822f 3769980	 kb</div><div class="line">2:	82b4ae98eeed 4869324	 kb</div><div class="line">3:	572a1b7c8ef6 10370404	 kb</div><div class="line">4:	9f9250d98df6 10566776	 kb</div><div class="line">5:	7fab70481929 13745648	 kb</div><div class="line">6:	4a14b58e3732 29873504	 kb</div><div class="line">7:	8a01418b6df2 30432068	 kb</div><div class="line">8:	83dc85caaa5c 31010960	 kb</div><div class="line">9:	433e51df88b1 35647052	 kb</div><div class="line">10:	4b42818a8148 61962416	 kb</div></pre></td></tr></table></figure>
<p>第二列是容器id，第三列是磁盘大小，第四列是单位， 占用最大的排在最后面</p>
<h5 id="然后进到容器后通过-du-–max-depth-2-快速发现大文件"><a href="#然后进到容器后通过-du-–max-depth-2-快速发现大文件" class="headerlink" title="然后进到容器后通过 du / –max-depth=2 快速发现大文件"></a>然后进到容器后通过 du / –max-depth=2 快速发现大文件</h5><h3 id="方法二：-容器使用的volume使用过大"><a href="#方法二：-容器使用的volume使用过大" class="headerlink" title="方法二： 容器使用的volume使用过大"></a>方法二： 容器使用的volume使用过大</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$sudo du -l /data/lib/docker/defaultVolumes --max-depth=1 | sort -rn</div><div class="line">456012884	/data/lib/docker/defaultVolumes</div><div class="line">42608332	/data/lib/docker/defaultVolumes/task_3477_g0_ark-metadb_miniDBPaaS-MetaDB_1</div><div class="line">32322220	/data/lib/docker/defaultVolumes/task_3477_g0_dbpaas-metadb_dbpaas_1</div><div class="line">27461120	/data/lib/docker/defaultVolumes/task_3001_g0_ark-metadb_miniDBPaaS-MetaDB_1</div><div class="line">27319360	/data/lib/docker/defaultVolumes/task_36000_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27313836	/data/lib/docker/defaultVolumes/task_3600_g0_dbpaas-metadb_minidbpaas</div><div class="line">27278692	/data/lib/docker/defaultVolumes/task_3604_g0_ark-metadb_miniDBPaaS-MetaDB_1</div><div class="line">27277004	/data/lib/docker/defaultVolumes/task_3603_g0_ark-metadb_miniDBPaaS-MetaDB_1</div><div class="line">27275736	/data/lib/docker/defaultVolumes/task_3542_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27271428	/data/lib/docker/defaultVolumes/task_3597_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27270840	/data/lib/docker/defaultVolumes/task_3603_g0_dbpaas-metadb_minidbpaas_1</div><div class="line">27270492	/data/lib/docker/defaultVolumes/task_3603_g0_dbpaas-metadb_minidbpaas</div><div class="line">27270468	/data/lib/docker/defaultVolumes/task_3600_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27270252	/data/lib/docker/defaultVolumes/task_3535_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27270244	/data/lib/docker/defaultVolumes/task_3538_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">27270244	/data/lib/docker/defaultVolumes/task_3536_g0_ark-metadb_miniDBPaaS-MetaDB</div><div class="line">25312404	/data/lib/docker/defaultVolumes/task_3477_g0_dncs-server_middleware-dncs_2</div></pre></td></tr></table></figure>
<p>/data/lib/docker/defaultVolumes 参数是方舟默认volume存放的目录（一般是docker的存储路径下 –graph=/data/lib/docker) ，第一列是大小，后面是容器名</p>
<p>volume路径在物理机上也有可能是 /var/lib/docker 或者 /mw/mvdocker/ 之类的路径下，这个要依据安装参数来确定，可以用如下命令来找到这个路径：</p>
<p><code>sudo systemctl status docker -l | grep --color graph</code></p>
<p>结果如下，红色参数后面的路径就是docker 安装目录，到里面去找带volume的字眼：</p>
<p><img src="https://plantegg.oss-cn-beijing.aliyuncs.com/images/oss/9b7e489576840f72a5bd13e969abce39.png" alt="image.png"></p>
<p>找到 volume很大的文件件后同样可以进到这个文件夹中执行如下命令快速发现大文件：</p>
<p><code>du . --max-depth=2</code></p>
<h3 id="方法三-容器的系统日志没有限制大小"><a href="#方法三-容器的系统日志没有限制大小" class="headerlink" title="方法三 容器的系统日志没有限制大小"></a>方法三 容器的系统日志没有限制大小</h3><p>这种情况只针对2017年上半年之前的部署环境，后面部署的环境默认都控制了这些日志不会超过150M</p>
<p>按照方法二的描述先找到docker 安装目录，cd 进去，然后 ： </p>
<p><code>du ./containers --max-depth=2</code></p>
<p>就很快找到那个大json格式的日志文件了,然后执行清空这个大文件的内容：</p>
<p><code>echo &#39;&#39; | sudo tee 大文件名</code></p>
<h3 id="一些其他可能占用空间的地方"><a href="#一些其他可能占用空间的地方" class="headerlink" title="一些其他可能占用空间的地方"></a>一些其他可能占用空间的地方</h3><ul>
<li>机器上镜像太多，可以删掉一些没用的： sudo docker images -q | xargs sudo docker rmi </li>
<li>机器上残留的volume太多，删：sudo docker volume ls -q | xargs sudo docker volume rm</li>
<li>物理文件被删了，但是还有进程占用这个文件句柄，导致文件对应的磁盘空间没有释放，检查： lsof |　grep deleted  如果这个文件非常大的话，只能通过重启这个进程来真正释放磁盘空间</li>
</ul>
<hr>
<h4 id="检查是否restart能支持只重启deamon，容器还能正常运行："><a href="#检查是否restart能支持只重启deamon，容器还能正常运行：" class="headerlink" title="检查是否restart能支持只重启deamon，容器还能正常运行："></a>检查是否restart能支持只重启deamon，容器还能正常运行：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$sudo docker info | grep Restore</div><div class="line">Live Restore Enabled: true</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/01/14/通过分析tcp包来确认服务调用的响应时间/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/14/通过分析tcp包来确认服务调用的响应时间/" itemprop="url">通过分析tcp包来确认服务调用的响应时间</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-14T10:30:03+08:00">
                2017-01-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TCP/" itemprop="url" rel="index">
                    <span itemprop="name">TCP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="通过分析tcp包来确认服务调用的响应时间"><a href="#通过分析tcp包来确认服务调用的响应时间" class="headerlink" title="通过分析tcp包来确认服务调用的响应时间"></a>通过分析tcp包来确认服务调用的响应时间</h1><h2 id="不需要在应用中打点，不限定于具体语言（php、cpp、java都可以）-分析服务调用的响应时间"><a href="#不需要在应用中打点，不限定于具体语言（php、cpp、java都可以）-分析服务调用的响应时间" class="headerlink" title="不需要在应用中打点，不限定于具体语言（php、cpp、java都可以）, 分析服务调用的响应时间"></a>不需要在应用中打点，不限定于具体语言（php、cpp、java都可以）, 分析服务调用的响应时间</h2><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">当时的问题，客户现场不管怎么样增加应用机器，tps就是上不去，同时增加应用机器后，增加的机器CPU还都能被用完，但是tps没有变化（这点比较奇怪，也就是cpu用的更多了，tps没变化），客户感觉 整体服务调用慢，数据库没有慢查询，不知道到具体时间花在哪里，各个环节都尝试过增加服务器（或提升配置），但是问题一直得不到解决</div></pre></td></tr></table></figure>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><h3 id="数据库服务器网卡中断瓶颈导致rtt非常高，进一步导致每个Query的ResponseTime非常高（图中左边都是出问题、右边都是问题解决后的响应时间）"><a href="#数据库服务器网卡中断瓶颈导致rtt非常高，进一步导致每个Query的ResponseTime非常高（图中左边都是出问题、右边都是问题解决后的响应时间）" class="headerlink" title="数据库服务器网卡中断瓶颈导致rtt非常高，进一步导致每个Query的ResponseTime非常高（图中左边都是出问题、右边都是问题解决后的响应时间）"></a>数据库服务器网卡中断瓶颈导致rtt非常高，进一步导致每个Query的ResponseTime非常高（图中左边都是出问题、右边都是问题解决后的响应时间）</h3><blockquote>
<p>通过程序把每个请求、响应时间等数据分析出来并存入数据库中（缺一个图形展示界面，有图形展示界面后会更直观）</p>
<p>图一中是每一秒中的平均 rtt 时间（round trip time）</p>
</blockquote>
<p><img src="/images/951413iMgBlog/image-20220524155218723.png" alt="image"></p>
<h4 id="问题修复后数据库每个查询的平均响应时间从47毫秒下降到了4-5毫秒"><a href="#问题修复后数据库每个查询的平均响应时间从47毫秒下降到了4-5毫秒" class="headerlink" title="问题修复后数据库每个查询的平均响应时间从47毫秒下降到了4.5毫秒"></a>问题修复后数据库每个查询的平均响应时间从47毫秒下降到了4.5毫秒</h4><blockquote>
<p>图中的每一行都是是一个查询的数据库执行时间</p>
</blockquote>
<p><img src="/images/951413iMgBlog/image-20220524155221182.png" alt="image"></p>
<h4 id="从wireshark中也可以看到类似的rtt不正常（超过150ms的比较多）"><a href="#从wireshark中也可以看到类似的rtt不正常（超过150ms的比较多）" class="headerlink" title="从wireshark中也可以看到类似的rtt不正常（超过150ms的比较多）"></a>从wireshark中也可以看到类似的rtt不正常（超过150ms的比较多）</h4><p><img src="/images/951413iMgBlog/image.png" alt="image"></p>
<h4 id="从wireshark中也可以看到类似的rtt正常-99-都在10ms以内）"><a href="#从wireshark中也可以看到类似的rtt正常-99-都在10ms以内）" class="headerlink" title="从wireshark中也可以看到类似的rtt正常(99%都在10ms以内）"></a>从wireshark中也可以看到类似的rtt正常(99%都在10ms以内）</h4><p><img src="/images/951413iMgBlog/image-20220524155217000.png" alt="image"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><blockquote>
<p>实际上通过抓包发现所有发往后面的SQL查询(请求链路：app -&gt; slb -&gt; drds -&gt; slb -&gt;rds) ，在app上抓包发现每个请求发出去到收到结果平均需要差不多100ms（无论SQL复杂与否），通过统计网络往返时间（rtt）发现rtt非常高，好多都是50ms以上。<br>降低压力比较rtt，发现rtt降到了20ms以内，同时SQL响应时间也相应地减短了。<br>已经排除了drds到rds响应慢的问题，问题应该在slb或者drds上，进一步发现drds（16Core 16GMem）绑定网卡中断的cpu用到了95%以上，尝试绑定到多个cpu内核，似乎ecs不支持，接下来将配置，增加多个低配置的drds来解决问题。</p>
</blockquote>
<p><strong>简单来说ecs默认网卡中断只能用到一个核，如果ecs配置太高，网卡中断会成为瓶颈，导致rtt变高、不稳定</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2017/01/01/top_linux_commands/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/01/top_linux_commands/" itemprop="url">最牛B的Linux Shell命令</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-01T17:30:03+08:00">
                2017-01-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="最牛B的Linux-Shell命令"><a href="#最牛B的Linux-Shell命令" class="headerlink" title="最牛B的Linux Shell命令"></a>最牛B的Linux Shell命令</h1><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>Shell作为Unix系操作系统当中最有魅力且不可或缺的组件，经过数十载的洗礼不仅没有被淘汰，而且愈加变得成熟稳健，究其原因，大概因为它是个非常稳固的粘合剂，能够把大量功能强大的组件任意配搭，总能很好很快地完成用户的任务。</p>
<p>本文的一些命令很可能看起来是“雕虫小技”，我们只好仰慕一下Shell大牛了，但是有些细节我会稍加发掘加以说明，遇到有趣的地方希望能博您一笑了。</p>
<h2 id="1-以sudo运行上条命令"><a href="#1-以sudo运行上条命令" class="headerlink" title="1.以sudo运行上条命令"></a>1.以sudo运行上条命令</h2><table>
<thead>
<tr>
<th>1</th>
<th>$ <strong>sudo</strong> <strong>!!</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>大家应该都知sudo，不解释。但通常出现的情况是，敲完命令执行后报错才发现忘了sudo。这时候，新手用户就会：按上箭头，按左箭头，盯着光标回到开始处，输入sudo，回车；高手用户就蛋定多了，按Ctrl-p，按Ctrl-a，输入sudo，回车。</p>
<p>这里介绍这个是天外飞仙级别的，对，就直接sudo !!。</p>
<p>当然这几种解决方式效果是完全一样的，只是款不一样，嗯，不解释。</p>
<p>两个感叹号其实是bash的一个特性，称为事件引用符（event designators）。!!其实相当于!-1，引用前一条命令，当然也可以!-2，!-50。默认情况下bash会在~/.bash_history文件内记录用户执行的最近500条命令，history命令可以显示这些命令。</p>
<p>关于事件引用符的更多用法可以深入阅读<a href="http://www.catonmat.net/blog/the-definitive-guide-to-bash-command-line-history/" target="_blank" rel="external">The Definitive Guide to Bash Command Line History</a>。</p>
<h2 id="2-以HTTP方式共享当前文件夹的文件"><a href="#2-以HTTP方式共享当前文件夹的文件" class="headerlink" title="2.以HTTP方式共享当前文件夹的文件"></a>2.以HTTP方式共享当前文件夹的文件</h2><table>
<thead>
<tr>
<th>1</th>
<th>$ python -m  SimpleHTTPServer 8080</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这命令启动了Python的SimpleHTTPServer模块，考虑到Python在绝大多数的Linux发行版当中都默认安装，所以这个命令很可能是最简单的跨平台传文件的方法。</p>
<p>命令执行后将在本机8000端口开放HTTP服务，在其他能访问本机的机器的浏览器打开ttp://ip:8000即打开一个目录列表，点击即可下载。</p>
<p>python3的话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python3 -m http.server 8080</div></pre></td></tr></table></figure>
<h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">#最近一天修改的md文档</div><div class="line">find . -maxdepth 1 -type f -mtime -1 -name &quot;*.md&quot; -not -name &quot;template.md&quot; -not -name &quot;temp.md&quot; -exec ls -lh &quot;&#123;&#125;&quot; \;</div><div class="line"></div><div class="line">find . -size 0  -type f -exec ls -lh &quot;&#123;&#125;&quot; \;</div><div class="line"></div><div class="line">find . -maxdepth 1 -type f -mtime -2 -name &quot;*margin*&quot; -exec mv &quot;&#123;&#125;&quot; /tmp/img/ \;</div><div class="line"></div><div class="line">#clean the big file, but exclude spill dir</div><div class="line">sudo find /home/admin/ -not -path &quot;*/spill/*&quot; -type f -size +3G -exec cp /dev/null &#123;&#125; \;</div><div class="line">sudo find /home/admin/ -type f -name &quot;*.hprof&quot; -mtime +1 -exec rm -f &#123;&#125; \;</div><div class="line">#clean the spill temp file which before 7 days ago</div><div class="line">sudo find /home/admin/ -type f -mtime +7 -exec cp /dev/null &#123;&#125; \;</div><div class="line">sudo find /home/admin/logs/ -type f -mtime +7 -exec rm -f &#123;&#125; \;</div><div class="line">sudo find /var/log/ -type f -size +500M -exec cp /dev/null &#123;&#125; \;</div><div class="line"></div><div class="line">#备份匹配的文件</div><div class="line">find . -name &apos;*.ibd&apos; | grep tpcc1000 | grep -v mysql_global | xargs -I&#123;&#125; cp --path &#123;&#125; /tmp/bak/</div><div class="line"></div><div class="line">#将yaml 备份，保留目录结构</div><div class="line">find . -name &apos;*.yaml&apos; | xargs -I&#123;&#125; cp --path &#123;&#125; /tmp/</div><div class="line"></div><div class="line"></div><div class="line">find $srcDir -maxdepth 1 -type f -mtime -$1 -name &quot;*.md&quot; -not -name &quot;template.md&quot; -not -name &quot;temp.md&quot; -exec ls -lh &quot;&#123;&#125;&quot; \;</div><div class="line"></div><div class="line">find $srcDir -maxdepth 1 -type f -mtime -$1 -name &quot;*.md&quot; -not -name &quot;template.md&quot; -not -name &quot;temp.md&quot; -exec cp &quot;&#123;&#125;&quot; ./source/_posts/ \;</div><div class="line"></div><div class="line">#sudo find /media/sf_D_DRIVE/case/ -maxdepth 1 -type f -mtime -$1 -name &quot;*.md&quot; -not -name &quot;template.md&quot; -print -exec cp &quot;&#123;&#125;&quot; ./source/_posts/ \;</div><div class="line"></div><div class="line">cat的时候输出文件名：</div><div class="line">find . -type f -print -exec cat &#123;&#125; \;</div></pre></td></tr></table></figure>
<p>xargs 参数：</p>
<blockquote>
<p>-I [replace-str]：将xargs的输出每一项参数，单独赋值给后面的命令，参数需要用指定的代替字符串replace-str代替，也就是说replace-str不可缺省，必须显示指明，可以使用{} $ @等符号，其主要作用是<strong>当xargs command后有多个参数时，调整参数位置</strong></p>
</blockquote>
<h2 id="top"><a href="#top" class="headerlink" title="top"></a>top</h2><p>默认配置文件：~/.toprc （on Ubuntu, it is <em>~/.config/procps/toprc</em>）</p>
<p>增加列：f (此时可以调整用 → 选择列并调整位置， 此时也有4个窗口可以选择)</p>
<p>按node展示cpu：2(3 选择需要展示的node)</p>
<p>按core展示cpu: 1</p>
<p>切换颜色：z (有4个窗口可以选择，按 g 可以选择1-4)</p>
<p>配置颜色: Z </p>
<p><strong>V</strong> 切换成森林视图，也就是展示进程父子关系</p>
<p>保存配置: W</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dG9wJ3MgQ29uZmlnIEZpbGUgKExpbnV4IHByb2Nlc3NlcyB3aXRoIHdpbmRvd3MpCklkOmksIE1vZGVfYWx0c2NyPTAsIE1vZGVfaXJpeHBzPTEsIERlbGF5X3RpbWU9My4wLCBDdXJ3aW49MApDcHUJZmllbGRzY3VyPaWmqLWztLu9wMS3urg5xScpKissLS4vMDEyNjw+P0FCQ0ZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWoKCXdpbmZsYWdzPTE5NTM4MCwgc29ydGluZHg9MTgsIG1heHRhc2tzPTAsIGdyYXBoX2NwdXM9MCwgZ3JhcGhfbWVtcz0wCglzdW1tY2xyPTQsIG1zZ3NjbHI9MSwgaGVhZGNscj0zLCB0YXNrY2xyPTQKTWVtCWZpZWxkc2N1cj2lu73AvMPBws3OJjk3uigzNEQnxSkqKywtLi8wMTI1Njg+P0ZHSElKS0xPUFFSU1RVVldYWVpbXF1eX2BhYmNkZWZnaGlqCgl3aW5mbGFncz0xOTUzODAsIHNvcnRpbmR4PTIxLCBtYXh0YXNrcz0wLCBncmFwaF9jcHVzPTAsIGdyYXBoX21lbXM9MAoJc3VtbWNscj02LCBtc2dzY2xyPTYsIGhlYWRjbHI9MywgdGFza2Nscj02ClNjaAlmaWVsZHNjdXI9pTo7PD0+P0BBTUJOQ7WztMfEtre5xcYmJygpKissLS4vMDEyOEhJSktMT1BRUlNUVVZXWFlaW1xdXl9gYWJjZGVmZ2hpagoJd2luZmxhZ3M9MTk0ODY4LCBzb3J0aW5keD0wLCBtYXh0YXNrcz0wLCBncmFwaF9jcHVzPTAsIGdyYXBoX21lbXM9MAoJc3VtbWNscj01LCBtc2dzY2xyPTUsIGhlYWRjbHI9MywgdGFza2Nscj01CkNncAlmaWVsZHNjdXI9paanqCowOTc6RCkrLC0uLzEyMzQ1Njg7PD0+P0BBQkNGR8hJSktMTU5P0NHS09TVxVZXWFlaW1xdXl9gYWJjZGVmZ2hpagoJd2luZmxhZ3M9MTk0ODY4LCBzb3J0aW5keD0wLCBtYXh0YXNrcz0wLCBncmFwaF9jcHVzPTAsIGdyYXBoX21lbXM9MAoJc3VtbWNscj0yLCBtc2dzY2xyPTMsIGhlYWRjbHI9MywgdGFza2Nscj0yCkZpeGVkX3dpZGVzdD0wLCBTdW1tX21zY2FsZT0wLCBUYXNrX21zY2FsZT0wLCBaZXJvX3N1cHByZXNzPTAKCnBpcGUJTmV0RmlsZXMJbHNvZiAtYSAtbCAtbiAtUCAtaTQgLXAgJWQgMj4mMQpwaXBlCU9wZW5GaWxlcwlsc29mIC1hIC1sIC1uIC1QIC1wICVkIDI+JjEKZmlsZQlOVU1BSW5mbwkvcHJvYy8lZC9udW1hX21hcHMK</div></pre></td></tr></table></figure>
<h2 id="xargs-传参数"><a href="#xargs-传参数" class="headerlink" title="xargs 传参数"></a>xargs 传参数</h2><blockquote>
<p>ls /xx | xargs -t -I{}  cp {} /tmp/{}</p>
</blockquote>
<p>-t ： 打印内容，去掉\n之后的字符串</p>
<p>-I :  后面定义占位符，上例子是{}  ，后面命令行中可以多次使用占位符</p>
<p>挂载多台苹果的例子</p>
<blockquote>
<p> idevice_id -l|xargs -t -I{} mkdir {};idevice_id -l |xargs -t -I{} ifuse {} {}</p>
</blockquote>
<p>批量执行docker exec</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible -i host.ini all -m shell -a &quot;docker ps -a | grep tpcc | grep dn | cut -d &apos; &apos; -f 1 | xargs  -I&#123;&#125; docker exec &#123;&#125; bash -c \&quot;myc -e &apos;shutdown&apos;\&quot;&quot;</div></pre></td></tr></table></figure>
<p>批量推送镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker images |grep &quot;docker.io:5000&quot; | awk &apos;&#123; print $1&quot;:&quot;$2 &#125;&apos; | xargs -I &#123;&#125; docker push &#123;&#125;</div></pre></td></tr></table></figure>
<h2 id="非贪婪匹配"><a href="#非贪婪匹配" class="headerlink" title="非贪婪匹配"></a>非贪婪匹配</h2><p>vim中默认匹配：abc.*d 是贪婪匹配，也就是尽可能长地匹配，改用 abc.{-}d 匹配到第一个 d字符就结束</p>
<blockquote>
<p>贪婪模式是: .*</p>
<p>非贪婪模式是: .\{-}</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">\&#123;n,m&#125; Matches n to m of the preceding atom, as many as possible</div><div class="line">\&#123;n&#125; Matches n of the preceding atom</div><div class="line">\&#123;n,&#125; Matches at least n of the preceding atom, as many as possible</div><div class="line">\&#123;,m&#125; Matches 0 to m of the preceding atom, as many as possible</div><div class="line">\&#123;&#125; Matches 0 or more of the preceding atom, as many as possible (like *)</div><div class="line">*/\&#123;-*</div><div class="line">\&#123;-n,m&#125; matches n to m of the preceding atom, as few as possible</div><div class="line">\&#123;-n&#125; matches n of the preceding atom</div><div class="line">\&#123;-n,&#125; matches at least n of the preceding atom, as few as possible</div><div class="line">\&#123;-,m&#125; matches 0 to m of the preceding atom, as few as possible</div><div class="line">\&#123;-&#125; matches 0 or more of the preceding atom, as few as possibles</div></pre></td></tr></table></figure>
<p>grep 非贪婪匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">grep --color -P &quot;agHost.*?,&quot; test.table  //匹配 agHost后带有多个任意字符直到第一个 逗号 结束，-P表示用 perl 的匹配语法，而perl默认是不支持贪婪的</div><div class="line"></div><div class="line">grep --color -o -P &quot;agHost.*?,&quot; test.table  //-o 只打印匹配部分</div></pre></td></tr></table></figure>
<p>匹配数字至少4次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -E &quot;,rows=[0-9]&#123;4,&#125;&quot;</div></pre></td></tr></table></figure>
<h2 id="MacOS-sed-删除行"><a href="#MacOS-sed-删除行" class="headerlink" title="MacOS sed 删除行"></a>MacOS sed 删除行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//查找匹配的行：|      |                               |</div><div class="line">grep -E &quot;\| [[:space:]]*\| [[:space:]]*\|&quot; top_linux_commands.md -B3</div><div class="line"></div><div class="line">//删除行 -i &quot;.bak&quot;是直接操作文件并添加.bak作为备份文件名称，如果不需要备份文件，则使用-i &quot;&quot;</div><div class="line">sed -i &apos;&apos; -e  &apos;/\| [[:space:]]*\| [[:space:]]*\|/d&apos;  top_linux_commands.md</div><div class="line"></div><div class="line">//先备份文件为.bak, 再删除行 -i &quot;.bak&quot;是添加.bak作为备份文件名称</div><div class="line">sed -i &apos;.bak&apos; &apos;s/\| [[:space:]]*\| [[:space:]]*\|/d&apos;  top_linux_commands.md</div></pre></td></tr></table></figure>
<h2 id="ps-查看进程"><a href="#ps-查看进程" class="headerlink" title="ps 查看进程"></a>ps 查看进程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps -Tfp pid // -T 展开进程下的线程 -f full -p pid</div></pre></td></tr></table></figure>
<h2 id="循环按行处理"><a href="#循环按行处理" class="headerlink" title="循环按行处理"></a>循环按行处理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">while  read i ; do echo $i ; done &lt;./prometheus.list</div></pre></td></tr></table></figure>
<h2 id="3-在以普通用户打开的vim当中保存一个root用户文件"><a href="#3-在以普通用户打开的vim当中保存一个root用户文件" class="headerlink" title="3.在以普通用户打开的vim当中保存一个root用户文件"></a>3.在以普通用户打开的vim当中保存一个root用户文件</h2><table>
<thead>
<tr>
<th>1</th>
<th>:<strong>w</strong> <strong>!sudo</strong> <strong>tee</strong> <strong>%</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这题目读起来纠结，其实是很常见的，常常忘记了sudo就直接用vim编辑/etc内的文件，（不过也不一定，vim发现保存的文件无法保存时候会提示）等编辑好了，保存时候才发现没权限。曲线方法是先保存个临时文件，退出后再sudo cp回去。不过实际上在vim里面可以直接完成这个过程的，命令就是如此。</p>
<p>查阅vim的文档（输入:help :w），会提到命令:w!{cmd}，让vim执行一个外部命令{cmd}，然后把当前缓冲区的内容从stdin传入。</p>
<p>tee是一个把stdin保存到文件的小工具。</p>
<p>而%，是vim当中一个只读寄存器的名字，总保存着当前编辑文件的文件路径。</p>
<p>所以执行这个命令，就相当于从vim外部修改了当前编辑的文件，好完工。</p>
<h2 id="4-切换回上一个目录"><a href="#4-切换回上一个目录" class="headerlink" title="4.切换回上一个目录"></a>4.切换回上一个目录</h2><table>
<thead>
<tr>
<th>1</th>
<th>$ <strong>cd</strong> -</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>应该不少人都知道这个，横杆-代表上一个目录的路径。</p>
<p>实际上cd -就是cd $OLDPWD的简写，bash的固定变量$OLDPWD总保存着之前一个目录的路径。</p>
<p>相对地，$PWD总保存着当前目录的路径。这些变量在编写shell脚本时候相当有用。</p>
<h2 id="5-替换上一条命令中的一个短语"><a href="#5-替换上一条命令中的一个短语" class="headerlink" title="5.替换上一条命令中的一个短语"></a>5.替换上一条命令中的一个短语</h2><table>
<thead>
<tr>
<th>1</th>
<th>$ ^foo^bar^</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>又是另外一个事件引用符（event designator），可以把上一条命令当中的foo替换成bar。</p>
<p>在需要重复运行调试一道长长的命令，需要测试某个参数时候，用这个命令会比较实用；但多数人会首先选择按上箭头提出上道命令，再移动光标去修改某参数，这样更直观，但效率上就不够使用引用符高，而且在脚本中用这个方法可以简化很多。</p>
<p>这道命令的原始样式应该是这样的:</p>
<table>
<thead>
<tr>
<th>1</th>
<th><strong>!!</strong>:s<strong>/</strong>foo<strong>/</strong>bar<strong>/</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>本文一开始介绍过!!，后面的一段大家应该很熟悉，vim、sed的替换操作都是这样的语法。</p>
<p>关于事件引用符的更多用法可以深入阅读<a href="http://www.catonmat.net/blog/the-definitive-guide-to-bash-command-line-history/" target="_blank" rel="external">The Definitive Guide to Bash Command Line History</a></p>
<h2 id="6-快速备份一个文件"><a href="#6-快速备份一个文件" class="headerlink" title="6.快速备份一个文件"></a>6.快速备份一个文件</h2><table>
<thead>
<tr>
<th>1</th>
<th>$ <strong>cp</strong>  filename<strong>{</strong>,.bak<strong>}</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这道命令把filename文件拷贝成filename.bak，大家应该在一些比较复杂的安装教程里面见过这样的用法。其原理就在于bash对大括号的展开操作，filename{,.bak}这一段会被展开成filename filename.bak再传给cp，于是就有了备份的命令了。</p>
<p>大括号在bash里面是一个排列的意义，可以试试这个：</p>
<table>
<thead>
<tr>
<th>1</th>
<th>$ <strong>echo</strong> <strong>{</strong>a,b,c<strong>}{</strong>a,b,c<strong>}{</strong>a,b,c<strong>}</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>将输出三个集合的全排列:</p>
<p>aaa aab aac aba abb abc aca acb acc</p>
<p>baa bab bac bba bbb bbc bca bcb bcc</p>
<p>caa cab cac cba cbb cbc cca ccb ccc</p>
<p>关于shell当中的集合操作，可深入阅读<a href="http://www.catonmat.net/blog/set-operations-in-unix-shell/" target="_blank" rel="external">“Set Operations in the Unix Shell”</a></p>
<h2 id="7-免密码ssh登录主机"><a href="#7-免密码ssh登录主机" class="headerlink" title="7.免密码ssh登录主机"></a>7.免密码ssh登录主机</h2><table>
<thead>
<tr>
<th>1</th>
<th>$ ssh-copy-id remote-machine</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这个命令把当前用户的公钥串写入到远程主机的~/.ssh/authorized_keys内，这样下次使用ssh登录的时候，远程主机就直接根据这串密钥完成身份校验，不再询问密码了。前提是你当前用户有生成了公钥，默认是没有的，先执行ssh-keygen试试吧！</p>
<p>这个命令如果用手工完成，是这样的：</p>
<table>
<thead>
<tr>
<th>1  2  3</th>
<th>your-machine$ scp  ~/.ssh/identity.pub  remote-machine:  your-machine$ ssh  remote-machine  remote-machine$ cat  identity.pub &gt;&gt; ~/.ssh/authorized_keys</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>如果你想删掉远程主机上的密钥，直接打开authorized_keys，搜索你的用户名，删除那行，即可。</p>
<h2 id="8-抓取Linux桌面的视频"><a href="#8-抓取Linux桌面的视频" class="headerlink" title="8.抓取Linux桌面的视频"></a>8.抓取Linux桌面的视频</h2><table>
<thead>
<tr>
<th>1</th>
<th>$ <strong>ffmpeg</strong> -f x11grab -s  wxga -r 25  -i :0.0 -sameq <strong>/</strong>tmp<strong>/</strong>out.mpg</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>我们在一些视频网站上看到别人的3D桌面怎么怎么酷的视频，通常就是这么来的，ffmpeg可以直接解码X11的图形，并转换到相应输出格式。</p>
<p>ffmpeg的通常用法是，根据一堆参数，输出一个文件，输出文件通常放最后，下面解析下几个参数：</p>
<p>-f x11grab 指定输入类型。因为x11的缓冲区不是普通的视频文件可以侦测格式，必须指定后ffmpeg才知道如何获得输入。</p>
<p>-s wxga 设置抓取区域的大小。wxga是1366*768的标准说法，也可以换成-s 800×600的写法。</p>
<p>-r 25 设置帧率，即每秒抓取的画面数。</p>
<p>-i :0.0 设置输入源，本地X默认在0.0</p>
<p>-sameq 保持跟输入流一样的图像质量，以用来后期处理。</p>
<p>至于其他ffmpeg的用法，可以参考下面两篇文章：</p>
<p>·    <a href="http://www.catonmat.net/blog/how-to-extract-audio-tracks-from-youtube-videos/" target="_blank" rel="external">How to Extract Audio Tracks from YouTube Videos</a></p>
<p>·    <a href="http://www.catonmat.net/blog/converting-youtube-flvs-to-a-better-format-with-ffmpeg" target="_blank" rel="external">Converting YouTube Flash Videos to a Better Format with ffmpeg</a></p>
<p>后记</p>
<p>说Shell是一种编程语言，可能有些尴尬，虽然很多人每天都在用Shell，但从来没见它荣登TIOBE编程语言排行榜之类的，可以说毫无名分，因为很多用户没意识到它是一种语言，只当做这是一个能够很好完成任务的工具，基本得理所当然，就好像GUI程序的菜单、按钮一样。</p>
<p>掌握Shell，通常能够让任务在数秒钟内完成，这就让Shell跟C、Perl、Python这些语言区别开来，没人否认后者更能胜任更多的任务，但是他们是在不同的层面上去做，Shell依赖大量的系统组件黏合调用，而后者依赖各种库，各所擅长不同的应用领域，比喻就是，Shell是混凝土，可以很方便地粘合一些建筑组件而成为稳固的高楼大厦；但同样是粘合剂，粘玻璃窗、粘书报、粘皮鞋，混凝土是绝对不合适的，Shell并不擅长一些细致操作，比如它连浮点运算都不支持，更别提什么图形运算什么的。但这并不妨碍Shell来帮我们完成很多粗重任务。</p>
<p>Shell的工作方式，大多数入门用户会觉得枯燥难学，而所谓的经典教材也离不开《Advanced Bash-Scripting》、《Bash Guide for Beginners》，但类似本文这样的一些“雕虫小技”因为难登大雅之堂绝不会收录进去。这情况如果象国外一些unix用户比较多的地方会有很好改善，即使是新手，偶尔看看别人的操作都能“偷师”一手，我编译本系列文章其实也就希望稍微改善一下这个状况。</p>
<h2 id="1-用你最喜欢的编辑器来敲命令"><a href="#1-用你最喜欢的编辑器来敲命令" class="headerlink" title="1.用你最喜欢的编辑器来敲命令"></a>1.用你最喜欢的编辑器来敲命令</h2><table>
<thead>
<tr>
<th>1</th>
<th><strong>command</strong> <strong>&lt;</strong>CTRL-x  CTRL-e<strong>&gt;</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>在已经敲完的命令后按<ctrl-x ctrl-e="">，会打开一个你指定的编辑器（比如vim，通过环境变量$EDITOR指定），里面就是你刚输入的命令，然后爱怎么编辑就怎么编辑吧，特别是那些参数异常复杂的程序，比如mencoder/ffmpeg，一个命令动辄3、4行的，要修改其中的参数，这个方法最合适不过了，保存退出后自动执行这个程序。</ctrl-x></p>
<p>实际上这是<a href="http://tiswww.case.edu/php/chet/readline/rltop.html" target="_blank" rel="external">readline库</a>的功能，在默认情况下，bash使用的是emacs模式的命令行操作方式，<ctrl-x ctrl-e="">是调用这个功能的一个绑定。如果你习惯使用vi模式，按<esc v="">可以实现同样功能。</esc></ctrl-x></p>
<p>如果你喜欢别的编辑器，可以在~/.bashrc里面放上比如export EDITOR=nano的命令。</p>
<p>另外一个修改命令的方法是使用fc命令（Fix Command），在编辑器里面打开上一句命令。我们的<a href="http://www.isspy.com/most_useful_linux_commands_1/" target="_blank" rel="external">第一辑连载</a>提过一个^foo^bar^命令可以用fc来实现：fc -s foo=bar。</p>
<h2 id="2-清空或创建一个文件"><a href="#2-清空或创建一个文件" class="headerlink" title="2.清空或创建一个文件"></a>2.清空或创建一个文件</h2><table>
<thead>
<tr>
<th>1</th>
<th><strong>&gt;</strong> file.txt</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>>在shell里面是标准输出重定向符，即把（前部个命令的）命令行输出转往一个文件内，但这里没有“前部命令”，输出为空，于是就覆盖（或创建）成一个空文件了。</p>
<p>有些脚本的写法是:&gt;file.txt，因为:是bash默认存在的空函数。</p>
<p>单纯创建文件也可以用$touch file.txt，touch本来是用作修改文件的时间戳，但如果文件不存在，就自动创建了。</p>
<h2 id="3-用ssh创建端口转发通道"><a href="#3-用ssh创建端口转发通道" class="headerlink" title="3.用ssh创建端口转发通道"></a>3.用ssh创建端口转发通道</h2><table>
<thead>
<tr>
<th>1</th>
<th><strong>ssh</strong> -N  -L2001:remotehost:80 user<strong>@</strong>somemachine</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这个命令在本机打开了2001端口，对本机2001端口的请求通过somemachine作为跳板，转到remotehost的80端口上。</p>
<p>实现效果跟术语反向代理是相似的，实际上就是端口转发，注意上面的描述涉及了3台主机，但当然somemachine可以变成localhost。</p>
<p>这个命令比较抽象，但有时候是很有用的，比如因为众所周知的原因国内的IP的80端口无法使用，又或者公司的防火墙只给外网开了ssh端口，需要访问内部服务器一个web应用，以及需要访问某些限定了来源IP的服务，就可以用上这个方法了。</p>
<p>举一个具体例子，运行：</p>
<table>
<thead>
<tr>
<th>1  2</th>
<th><strong>ssh</strong> -f -N -L  0.0.0.0:443:twitter.com:443 shell.cjb.net  <strong>ssh</strong> -f -N -L  0.0.0.0:80:twitter.com:80 shell.cjb.net</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>然后在/etc/hosts里面添加127.0.0.1 twitter.com，好吧剩下的你懂的。</p>
<p>当然通常做这个功能的反向代理，应该要用squid、nginx之类，ssh就算是轻量级的尝试吧！</p>
<h2 id="4-重置终端"><a href="#4-重置终端" class="headerlink" title="4.重置终端"></a>4.重置终端</h2><table>
<thead>
<tr>
<th>1</th>
<th>reset</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>如果你试过不小心cat了某个二进制文件，很可能整个终端就傻掉了，可能不会换行，没法回显，大堆乱码之类的，这时候敲入reset回车，不管命令有没有显示，就能回复正常了。</p>
<p>实际上reset命令只是输出了一些特殊字符，我们看BusyBox里面最简单的reset程序的实现：</p>
<table>
<thead>
<tr>
<th>1</th>
<th>printf(“<strong>\033</strong>c<strong>\033</strong>(K<strong>\033</strong>[J<strong>\033</strong>[0m<strong>\033</strong>[?25h”);</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>输出的这些字符对Shell是有特殊意义的：</p>
<p>·    \033c: “ESC c” – 发送重置命令;</p>
<p>·    \033(K: “ESC ( K” – 重载终端的字符映射;</p>
<p>·    \033[J: “ESC [ J” – 清空终端内容;</p>
<p>·    \033[0m: “ESC [ 0 m” – 初始化字符显示属性;</p>
<p>·    \033[?25h: “ESC [ ? 25 h” – 让光标可见;</p>
<p>其中<em>字符显示属性</em>经常用来设定打印字符的颜色等，可参考<a href="http://linuxshellaccount.blogspot.com/2008/03/using-color-in-linux-or-unix-shell.html" target="_blank" rel="external">这个博文</a>。</p>
<h2 id="5-在午夜的时候执行某命令"><a href="#5-在午夜的时候执行某命令" class="headerlink" title="5.在午夜的时候执行某命令"></a>5.在午夜的时候执行某命令</h2><table>
<thead>
<tr>
<th>1</th>
<th><strong>echo</strong> cmd **\</th>
<th>** at  midnight</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>说的就是at这个组件，通常跟cron相提并论，不过at主要用于定时一次性任务，而cron定时周期性任务。</p>
<p>at的参数比较人性化，跟英语语法一样，可以tomorrow, next week之类的，详细的查看手册man at。</p>
<h2 id="6-远程传送麦克风语音"><a href="#6-远程传送麦克风语音" class="headerlink" title="6.远程传送麦克风语音"></a>6.远程传送麦克风语音</h2><table>
<thead>
<tr>
<th>1</th>
<th><strong>dd</strong> if=<strong>/</strong>dev<strong>/</strong>dsp  **\</th>
<th><strong> </strong>ssh<strong>  username</strong>@<strong>host </strong>dd<strong> of=</strong>/<strong>dev</strong>/**dsp</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>没错就是实现一个喊话器的功能。</p>
<p>/dev/dsp是Linux下声卡的文件映射（Digital Signal Proccessor），从其中读数据就是录音，往里面写数据就是播放，相当简单！</p>
<p>dd是常用的数据拷贝程序，如果不同时指定if、of，就直接使用stdin/stdout来传输。</p>
<p>如果你没有远程主机，可以试试这样：</p>
<table>
<thead>
<tr>
<th>1</th>
<th><strong>dd</strong> if=<strong>/</strong>dev<strong>/</strong>dsp  of=<strong>/</strong>dev<strong>/</strong>dsp</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>直接回放麦克风的声音，只是有一点延时。</p>
<p>但是如果有别的程序正在使用声卡，这个方法就不凑效了，因为一般的声卡都不允许多个音频流同时处理，可以借用alsa组件的工具，arecord跟aplay:</p>
<table>
<thead>
<tr>
<th>1</th>
<th><strong>arecord</strong> **\</th>
<th><strong> </strong>ssh<strong> username</strong>@<strong>host  </strong>aplay**</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>本地回放就是：</p>
<table>
<thead>
<tr>
<th>1</th>
<th><strong>arecord</strong> **\</th>
<th><strong> </strong>aplay**</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>如果你想吓吓别人：</p>
<table>
<thead>
<tr>
<th>1</th>
<th><strong>cat</strong> <strong>/</strong>dev<strong>/</strong>urandom **\</th>
<th><strong>  </strong>ssh<strong> username</strong>@<strong>host </strong>aplay**</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h2 id="7-映射一个内存目录"><a href="#7-映射一个内存目录" class="headerlink" title="7.映射一个内存目录"></a>7.映射一个内存目录</h2><table>
<thead>
<tr>
<th>1</th>
<th><strong>mount</strong> -t tmpfs -o size=1024m  tmpfs <strong>/</strong>mnt<strong>/</strong>ram</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这个命令开了一块1G内存来当目录用。不过放心，如果里面没文件，是不会占用内存的，用多少占多少。</p>
<p>不过一般来说没必要手动挂载，因为多数发行版都会在fstab内预留了一个内存目录，挂载在/dev/shm，直接使用即可；</p>
<p>最常见的用途是用内存空间来放Firefox的配置，可以让慢吞吞的FF快很多，参见Shellex的博文：<a href="http://shellex.info/speeding-up-firefox-with-tmpfs/" target="_blank" rel="external">用tmpfs让Firefox在内存中飞驰</a>，以及后来的改进：<a href="http://shellex.info/speeding-up-firefox-with-tmpfs-ii/" target="_blank" rel="external">用tmpfs让Firefox在内存中飞驰II</a>，其中提到的脚本来自<a href="http://www.linuxized.com/2009/05/speeding-up-firefox-with-tmpfs-and-automatic-rsync/" target="_blank" rel="external">speeding up firefox with tmpfs and automatic rsync</a>。</p>
<p>那个破烂LinuxQQ也可以用这个方法，减少因为大量磁盘IO导致的问题。</p>
<h2 id="8-用diff对比远程文件跟本地文件"><a href="#8-用diff对比远程文件跟本地文件" class="headerlink" title="8.用diff对比远程文件跟本地文件"></a>8.用diff对比远程文件跟本地文件</h2><table>
<thead>
<tr>
<th>1</th>
<th><strong>ssh</strong> user<strong>@</strong>host <strong>cat</strong> <strong>/</strong>path<strong>/</strong>to<strong>/</strong>remotefile  **\</th>
<th><strong> </strong>diff<strong>  </strong>/<strong>path</strong>/<strong>to</strong>/**localfile -</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>diff通常的用法是从参数读入两个文件，而命令里面的-则是指从stdin读入了。</p>
<p>善用ssh可以让web开发减少很多繁琐，还有比如sshfs，可以从<strong>编辑**</strong>-<strong><strong>上传</strong></strong>-<strong><strong>编辑</strong></strong>-<strong>**上传</strong>的人工循环里面解脱出来。</p>
<h2 id="9-查看系统中占用端口的进程"><a href="#9-查看系统中占用端口的进程" class="headerlink" title="9.查看系统中占用端口的进程"></a>9.查看系统中占用端口的进程</h2><table>
<thead>
<tr>
<th>1</th>
<th><strong>netstat</strong> -tulnp</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Netstat是很常用的用来查看Linux网络系统的工具之一，这个参数可以背下来：</p>
<p>·    -t: 显示TCP链接信息</p>
<p>·    -u: 显示UDP链接信息</p>
<p>·    -l: 显示监听状态的端口</p>
<p>·    -n: 直接显示ip，不做名称转换</p>
<p>·    -p: 显示相应的进程PID以及名称（要root权限）</p>
<p>如果要查看关于sockets更详细占用信息等，可以使用lsof工具。</p>
<h2 id="1-更友好的显示当前挂载的文件系统"><a href="#1-更友好的显示当前挂载的文件系统" class="headerlink" title="1. 更友好的显示当前挂载的文件系统"></a>1. 更友好的显示当前挂载的文件系统</h2><table>
<thead>
<tr>
<th><code>1</code></th>
<th>`<strong>mount</strong> **</th>
<th>** column -t`</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这条命令适用于任何文件系统，column 用于把输出结果进行列表格式化操作，这里最主要的目的是让大家熟悉一下 columnt 的用法。 下面是单单使用 mount 命令的结果：</p>
<table>
<thead>
<tr>
<th><code>1``2``3``4``5</code></th>
<th><code>$ **mount**`` ``**/**dev**/**root on **/** **type** ext3 **(**rw**)**``**/**proc on **/**proc **type** proc **(**rw**)**``**/**dev**/**mapper**/**lvmraid-home on **/**home **type** ext3 **(**rw,noatime**)**</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>而加了 column -t 命令后就成为这样了：</p>
<table>
<thead>
<tr>
<th><code>1``2``3``4``5</code></th>
<th>`$ <strong>mount</strong> **</th>
<th><strong> column -t<code> </code></strong>/<strong>dev</strong>/<strong>root on </strong>/<strong> </strong>type<strong> ext3 </strong>(<strong>rw</strong>)<strong>``</strong>/<strong>proc on </strong>/<strong>proc </strong>type<strong> proc </strong>(<strong>rw</strong>)<strong>``</strong>/<strong>dev</strong>/<strong>mapper</strong>/<strong>lvmraid-home on </strong>/<strong>home </strong>type<strong> ext3 </strong>(<strong>rw,noatime</strong>)**`</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>另外你可加上列名称来改善输出结果</p>
<table>
<thead>
<tr>
<th><code>1``2``3``4``5``6</code></th>
<th>`$ <strong>(echo</strong> “DEVICE - PATH - TYPE FLAGS” <strong>&amp;&amp;</strong> <strong>mount)</strong> **</th>
<th><strong> column -t<code>``DEVICE          -  PATH  -   TYPE  FLAGS</code></strong>/<strong>dev</strong>/<strong>root         on </strong>/<strong>   </strong>type<strong> ext3  </strong>(<strong>rw</strong>)<strong>``</strong>/<strong>proc           on </strong>/<strong>proc </strong>type<strong> proc  </strong>(<strong>rw</strong>)<strong>``</strong>/<strong>dev</strong>/<strong>mapper</strong>/<strong>lvmraid-home on </strong>/<strong>home </strong>type<strong> ext3  </strong>(<strong>rw,noatime</strong>)**`</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>列2和列4并不是很友好，我们可以用 awk 来再处理一下</p>
<table>
<thead>
<tr>
<th><code>1``2``3``4``5``6</code></th>
<th>`$ <strong>(echo</strong> “DEVICE PATH TYPE FLAGS” <strong>&amp;&amp;</strong> <strong>mount</strong> **</th>
<th><strong> </strong>awk<strong> ‘$2=$4=””;1’</strong>)<strong> </strong></th>
<th><strong> column -t<code>``DEVICE          PATH  TYPE  FLAGS</code></strong>/<strong>dev</strong>/<strong>root         </strong>/<strong>   ext3  </strong>(<strong>rw</strong>)<strong>``</strong>/<strong>proc           </strong>/<strong>proc proc  </strong>(<strong>rw</strong>)<strong>``</strong>/<strong>dev</strong>/<strong>mapper</strong>/<strong>lvmraid-home </strong>/<strong>home ext3  </strong>(<strong>rw,noatime</strong>)**`</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>最后我们可以设置一个别名，为 nicemount</p>
<table>
<thead>
<tr>
<th><code>1</code></th>
<th>`$ nicemount<strong>()</strong> <strong>{</strong> <strong>(echo</strong> “DEVICE PATH TYPE FLAGS” <strong>&amp;&amp;</strong> <strong>mount</strong> **</th>
<th><strong> </strong>awk<strong> ‘$2=$4=””;1’</strong>)<strong> </strong></th>
<th><strong> column -t; </strong>}**`</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>试一下</p>
<table>
<thead>
<tr>
<th><code>1``2``3``4``5``6</code></th>
<th><code>$ nicemount`` ``DEVICE          PATH  TYPE  FLAGS``**/**dev**/**root         **/**   ext3  **(**rw**)**``**/**proc           **/**proc proc  **(**rw**)**``**/**dev**/**mapper**/**lvmraid-home **/**home ext3  **(**rw,noatime**)**</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h2 id="2-运行前一个-Shell-命令，同时用-“bar”-替换掉命令行中的每一个-“foo”"><a href="#2-运行前一个-Shell-命令，同时用-“bar”-替换掉命令行中的每一个-“foo”" class="headerlink" title="2. 运行前一个 Shell 命令，同时用 “bar” 替换掉命令行中的每一个 “foo”"></a>2. 运行前一个 Shell 命令，同时用 “bar” 替换掉命令行中的每一个 “foo”</h2><table>
<thead>
<tr>
<th><code>1</code></th>
<th><code>**!!**:gs**/**foo**/**bar</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p><code>!!</code> 表示重复执行上一条命令，并用 <code>:gs/foo/bar</code> 进行替换操作。 关于 <code>!!</code> 这个用法在<a href="http://www.isspy.com/most_useful_linux_commands_1/" target="_blank" rel="external">前一篇文章中</a>已有详细的介绍。</p>
<h2 id="3-实时某个目录下查看最新改动过的文件"><a href="#3-实时某个目录下查看最新改动过的文件" class="headerlink" title="3. 实时某个目录下查看最新改动过的文件"></a>3. 实时某个目录下查看最新改动过的文件</h2><table>
<thead>
<tr>
<th><code>1</code></th>
<th><code>**watch** -d -n 1 &#39;df; ls -FlAt /path&#39;</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>watch 是实时监控工具，-d 参数会高亮显示变化的区域，-n 1 参数表示刷新间隔为 1 秒。 df; ls -FlAt /path 运行了两条命令，df 是输出磁盘使用情况，<code>ls -FlAt</code> 则列出 /path 下面的所有文件。 ls -FlAt 的参数详解：</p>
<p>·    -F 在文件后面加一个文件符号表示文件类型，共有 <em>/=&gt;@|</em> <em>这几种类型，</em> 表示可执行文件，/ 表示目录，= 表示接口( sockets) ，&gt; 表示门， @ 表示符号链接， | 表示管道。</p>
<p>·    -l 以列表方式显示</p>
<p>·    -A 显示 <code>.</code> 和 <code>..</code></p>
<p>·    -t 根据时间排序文件</p>
<h2 id="4-通过-SSH-挂载远程主机上的文件夹"><a href="#4-通过-SSH-挂载远程主机上的文件夹" class="headerlink" title="4. 通过 SSH 挂载远程主机上的文件夹"></a>4. 通过 SSH 挂载远程主机上的文件夹</h2><table>
<thead>
<tr>
<th><code>1</code></th>
<th><code>sshfs name**@**server:**/**path**/**to**/**folder **/**path**/**to**/**mount**/**point</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这条命令可以让你通过 SSH 加载远程主机上的文件系统为本地磁盘，前提是你需要安装 FUSE 及 sshfs 这两个软件。 <strong>译者注</strong>：关于 sshfs 实际上我之前写过一篇文章介绍过，详见<a href="http://wowubuntu.com/sshfs.html" target="_blank" rel="external">在 Ubuntu 上使用 sshfs 映射远程 ssh 文件系统为本地磁盘</a>。 卸载的话使用 fusermount 或 umount 命令：</p>
<table>
<thead>
<tr>
<th><code>1``2</code></th>
<th><code>$ fusermount -u **/**path**/**to**/**mount**/**point``*# umount /path/to/mount/point*</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h2 id="5-通过-DNS-来读取-Wikipedia-的词条"><a href="#5-通过-DNS-来读取-Wikipedia-的词条" class="headerlink" title="5. 通过 DNS 来读取 Wikipedia 的词条"></a>5. 通过 DNS 来读取 Wikipedia 的词条</h2><table>
<thead>
<tr>
<th><code>1</code></th>
<th><code>**dig** +short txt .wp.dg.cx</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这也许是最有趣的一条技巧了，David Leadbeater 创建了一个 <a href="https://dgl.cx/wikipedia-dns" target="_blank" rel="external">DNS 服务器</a>，通过它当你查询一个 TXT 记录类型时，会返回一条来自于 Wikipedia 的简短的词条文字，这是<a href="https://dgl.cx/2008/11/wpdns-pres/" target="_blank" rel="external">他的介绍</a>。 这里有一个样例，来查询 “hacker” 的含义：</p>
<table>
<thead>
<tr>
<th><code>1``2``3``4``5``6``7``8</code></th>
<th><code>$ **dig** +short txt hacker.wp.dg.cx`` ``&quot;Hacker may refer to: Hacker (computer security), someone involved``in computer security/insecurity, Hacker (programmer subculture), a``programmer subculture originating in the US academia in the 1960s,``which is nowadays mainly notable for the free software/” “open``source movement, Hacker (hobbyist), an enthusiastic home computer``hobbyist http://a.vu/w:Hacker&quot;</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这里使用了 dig 命令，这是标准的用来查询 DNS 的系统管理工具，+short 参数是让其仅仅返回文字响应，txt 则是指定查询 TXT 记录类型。 更简单的做法是你可以为这个技巧创建一个函数：</p>
<table>
<thead>
<tr>
<th><code>1``2``3``4``5</code></th>
<th><code>wiki**()** **{** **dig** +short txt $1.wp.dg.cx; **}**``*#**然后试试吧：*``wiki hacker`` ``&quot;Hacker may refer to: Hacker (computer security), …&quot;</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>如果你不想用 dig ，也可以用 host 命令：</p>
<table>
<thead>
<tr>
<th><code>1</code></th>
<th><code>host -t txt hacker.wp.dg.cx</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>另外在Twitter上看过某人的创意，用普通的dns来作为程序版本更新的查询服务器：设定域名<code>software-version-check.example.com</code>的A记录为<code>1.2.40.3</code>，对比自己的版本号，嗯，有更新了！</p>
<h2 id="6-用-Wget-的递归方式下载整个网站"><a href="#6-用-Wget-的递归方式下载整个网站" class="headerlink" title="6. 用 Wget 的递归方式下载整个网站"></a>6. 用 Wget 的递归方式下载整个网站</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nohup wget --random-wait -nc -q -r -l 0 --reject=html -np -e robots=off -U Mozilla www.example.com &amp;</div></pre></td></tr></table></figure>
<p>参数解释： <em>–random-wait</em> <em>等待</em> <em>0.5</em> <em>到</em> <em>1.5</em> <em>秒的时间来进行下一次请求</em> -r 开启递归检索 <em>-e robots=off</em> <em>忽略</em> <em>robots.txt</em> -U Mozilla 设置 User-Agent 头为 Mozilla 其它一些有用的参数：</p>
<p>·    –limit-rate=20K 限制下载速度为 20K</p>
<p>·    -o logfile.txt 记录下载日志</p>
<p>·    -l 0 删除深度（默认为5）</p>
<p>·    -wait=1h 每下载一个文件后等待1小时</p>
<p>-np 不下载父目录 </p>
<p>–reject=html 不下载html</p>
<p>-nc 本地已有的不再下载</p>
<h2 id="7-复制最后使用的命令中的参数"><a href="#7-复制最后使用的命令中的参数" class="headerlink" title="7. 复制最后使用的命令中的参数"></a>7. 复制最后使用的命令中的参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Ctrl + . or ESC + . </div><div class="line">command + . //macos</div></pre></td></tr></table></figure>
<p>这个快捷键只能工作于 shell 的 emacs 编辑模式，它可以从最后使用的命令行中复制参数到当前命令行中，下面是一个样例：</p>
<table>
<thead>
<tr>
<th><code>1``2``3``4``5</code></th>
<th><code>$ **echo** a b c``a b c`` ``$ **echo**``$ **echo** c</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>你可以重复执行该快捷键，以便获取自已需要的参数， 以下是样例：</p>
<table>
<thead>
<tr>
<th><code>1``2``3``4``5``6``7``8``9``10</code></th>
<th><code>$ **echo** 1 2 3``1 2 3``$ **echo** a b c``a b c`` ``$ **echo**``$ **echo** c`` ``$ **echo** again``$ **echo** 3</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>另外，假如你想指定第1个或第2个，或者是第 n 个参数的话，可以按 ALT + 1 (或 ESC + 1) 或 ALT + 2 (或 ESC +2) 这样形式的快捷键。 以下是样例：</p>
<table>
<thead>
<tr>
<th><code>1``2``3``4``5``6``7``8``9``10</code></th>
<th><code>$ **echo** a b c``a b c`` ``$ **echo**``$ **echo** a``a`` ``$ **echo**``$ **echo** b``b</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>查看<a href="http://www.catonmat.net/blog/bash-emacs-editing-mode-cheat-sheet/" target="_blank" rel="external">Emacs Editing Mode Keyboard Shortcuts</a>一文获取更多类似的快捷键。</p>
<h2 id="8-执行一条命令但不保存到-history-中"><a href="#8-执行一条命令但不保存到-history-中" class="headerlink" title="8. 执行一条命令但不保存到 history 中"></a>8. 执行一条命令但不保存到 history 中</h2><table>
<thead>
<tr>
<th><code>1</code></th>
<th><code>$ **command**</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这条命令可运行于最新的 Bash shell 里，在其它 shell 中没测试过。 通过在命令行前面添加一个空格，就可以阻止这条命令被保存到 bash history (~/.bash_history) 文件中，这个行为可以通过 $HISTIGNORE shell 变量来控制。我的设置是 HISTIGNORE=”&amp;:[ ]*” ，表示不保存重复的命令到 history 中，并且不保存以空格开头的命令行。$HISTIGNORE 中的值以冒号分隔。 如果你的命令内包含密码，比如<code>mysqladmin</code>，不把它记录在历史当中是好主义。 深入了解的话，可进一步看此文<a href="http://www.catonmat.net/blog/the-definitive-guide-to-bash-command-line-history/" target="_blank" rel="external">The Definitive Guide to Bash Command Line History</a></p>
<h2 id="9-显示当前目录中所有子目录的大小-du"><a href="#9-显示当前目录中所有子目录的大小-du" class="headerlink" title="9. 显示当前目录中所有子目录的大小 du"></a>9. 显示当前目录中所有子目录的大小 du</h2><table>
<thead>
<tr>
<th>sudo du –max-depth=1 -BG //单位 block-size G;  or  -BM MB</th>
<th>du -h –max-depth=1</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>–max-depth=1 参数可以让 du 命令显示当前目录下 1 级子目录的统计信息，当然你也可以把 1 改为 2 ，进一步显示 2 级子目录的统计信息，可以灵活运用。而 -h 参数则是以 Mb 、G 这样的单位来显示大小。 <strong>译者注</strong>：在此推荐一个小工具 ncdu ，可以更方便的达到此效果。</p>
<p> 按单位大小排序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#du -sh * | sort -hr | head</div><div class="line">1.8T	anolis_yum</div><div class="line">1.6T	u02</div><div class="line">1.5T	os</div><div class="line">45G	drds_image</div><div class="line">23G	polarx</div><div class="line">8.3G	src</div><div class="line">7.9G	drds.pcap</div><div class="line">7.8G	root</div><div class="line">4.3G	core.24086</div><div class="line">3.5G	core.112462</div></pre></td></tr></table></figure>
<h2 id="10-显示消耗内存最多的-10-个运行中的进程，以内存使用量排序"><a href="#10-显示消耗内存最多的-10-个运行中的进程，以内存使用量排序" class="headerlink" title="10. 显示消耗内存最多的 10 个运行中的进程，以内存使用量排序"></a>10. 显示消耗内存最多的 10 个运行中的进程，以内存使用量排序</h2><table>
<thead>
<tr>
<th><code>1</code></th>
<th>`<strong>ps</strong> aux **</th>
<th><strong> </strong>sort<strong> -nk +4 </strong></th>
<th><strong> </strong>tail**`</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>显然这并不是最好的方法，但它确实用起还不错。 这是一个典型的管道应用，通过 ps aux 来输出到 sort 命令，并用 sort 排序列出 4 栏，再进一步转到 tail 命令，最终输出 10 行显示使用内存最多的进程情况。 假如想要发现哪个进程使用了大量内存的话，我通常会使用 htop 或 top 而非 ps 。</p>
<h2 id="11-用-python-快速开启一个-SMTP-服务"><a href="#11-用-python-快速开启一个-SMTP-服务" class="headerlink" title="11. 用 python 快速开启一个 SMTP 服务"></a>11. 用 python 快速开启一个 SMTP 服务</h2><table>
<thead>
<tr>
<th><code>1</code></th>
<th><code>python -m smtpd -n -c DebuggingServer localhost:1025</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这是一个用 Python 标准库 smtpd （用 -m smtpd 指定) 实现在简易 SMTP 服务，运行于 1025 端口 。 另外三个参数的解释： <em>-n</em> <em>参数让</em> <em>Python</em> <em>不要进行</em> <em>setuid (</em> <em>改变用户）为</em> <em>“nobody”</em> <em>，也就是说直接用你的帐号来运行</em> -c DebuggingServer 参数是让 Python 运行时在屏幕上输出调试及运行信息 * localhost:1025 参数则是让 Python 在本地的 1025 端口上开启 SMTP 服务 另外，假如你想让程序运行于标准的 25 的端口上的话，你必须使用 sudo 命令，因为只有 root 才能在 1-1024 端口上开启服务。如下：</p>
<table>
<thead>
<tr>
<th><code>1</code></th>
<th><code>**sudo** python -m smtpd -n -c DebuggingServer localhost:25</code></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>1.查看ascii码表</p>
<table>
<thead>
<tr>
<th>1</th>
<th><strong>man</strong> 7 ascii</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>很多人初学编程都会接触到ascii码的概念，有时候为了查某个符号的ascii值，可能还得翻箱倒柜找出当年的课本？<a href="http://www.kernel.org/doc/man-pages/" target="_blank" rel="external">Linux Manpage</a>里面其实包含了很多类似的实用资料，上述命令就能很详细的方式解释ascii编码，<a href="http://www.kernel.org/doc/man-pages/online/pages/man7/ascii.7.html" target="_blank" rel="external">当然这里还有在线版</a>。</p>
<p>man命令的第二个参数是区域码，用来区分索引词的范围，比如printf，在C标准库里面的printf跟bash当中的printf是不同的，前者的查询是man 3 printf，后者是man 1 printf。如果这个区域码省略，就会从1开始搜索，直到找到为止。</p>
<p>命令man man可以<a href="http://www.kernel.org/doc/man-pages/online/pages/man7/man-pages.7.html" target="_blank" rel="external">看到详细的解释</a>。</p>
<p>manpages里面还有一些有趣而且实用的资料，可能鲜为人知：</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man1/intro.1.html" target="_blank" rel="external">man 1 intro </a>– 一篇对从未接触过Linux的用户的简明教程。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/syscalls.2.html" target="_blank" rel="external">man 2 syscalls </a>– 内核系统请求的列表，按内核版本注释分类，系统编程必备。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/select_tut.2.html" target="_blank" rel="external">man 2 select_tut </a>– 关于select()系统请求的教程。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man3/string.3.html" target="_blank" rel="external">man 3 string </a>– 在头文件内的所有函数。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man3/stdio.3.html" target="_blank" rel="external">man 3 stdio </a>– 关于头文件的使用，标准输入/输出库的说明。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man3/errno.3.html" target="_blank" rel="external">man 3 errno </a>– 所有errorno的取值及说明。（C语言内类似其他语言的异常告知机制）</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man4/console_codes.4.html" target="_blank" rel="external">man 4 console_codes </a>– Linux的终端控制码及其使用解释。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man4/full.4.html" target="_blank" rel="external">man 4 full </a>– 介绍/dev/full这个总是处于“满”状态的磁盘。（对应/dev/null这个总是空的设备）</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man5/proc.5.html" target="_blank" rel="external">man 5 proc </a>– 介绍/proc下的文件系统。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man5/filesystems.5.html" target="_blank" rel="external">man 5 filesystems </a>– 各种Linux文件系统。</p>
<p>第7区里面的资料通常最酷：</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/bootparam.7.html" target="_blank" rel="external">man 7 bootparam </a>– 详细解释内核启动参数。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/charsets.7.html" target="_blank" rel="external">man 7 charsets </a>– 解释各种语言的编码集。（gbk，gb2312等）</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/glob.7.html" target="_blank" rel="external">man 7 glob </a>– 解释glob文件名管理机制的工作过程。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/hier.7.html" target="_blank" rel="external">man 7 hier </a>– 解释Linux文件系统结构各个部分的作用。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/operator.7.html" target="_blank" rel="external">man 7 operator </a>– C语言的运算符的列表。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/regex.7.html" target="_blank" rel="external">man 7 regex </a>– 介绍正则表达式。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/suffixes.7.html" target="_blank" rel="external">man 7 suffixes </a>– 常见文件后缀名的列表跟解释。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/time.7.html" target="_blank" rel="external">man 7 time </a>– Linux的时钟机制解释。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/units.7.html" target="_blank" rel="external">man 7 units </a>– 数值单位及其数值的解释。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/utf8.7.html" target="_blank" rel="external">man 7 utf8 </a>– 描述UTF-8编码。</p>
<p>·    <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/url.7.html" target="_blank" rel="external">man 7 url </a>– 解释URL、URI、URN等的标准。</p>
<p>2.简易计时器</p>
<table>
<thead>
<tr>
<th>1</th>
<th><strong>time</strong> <strong>read</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>运行命令开始算起，到结束时按一下Enter，就显示出整个过程的时间，精确到ms级别。</p>
<p>time是用来计算一个进程在运行到结束过程耗费多少时间的程序，它的输出通常有三项：</p>
<table>
<thead>
<tr>
<th>1  2  3  4  5</th>
<th>$ time ls /opt  …  real    0m0.008s  user    0m0.003s  sys    0m0.007s</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>real指整个程序对真实世界而言运行所需时间，user指程序在用户空间运行的时间，sys指程序对系统调用锁占用时间。</p>
<p>read本来是一个读取用户输入的命令，常见用法是read LINE，用户输入并回车后，键入的内容就被保存到$LINE变量内，但在键入回车前，这个命令是一直阻塞的。</p>
<p>可见time read这命令灵活地利用了操作系统的阻塞。用这个命令来测试一壶水多久煮滚应该是不错的。</p>
<p>3.远程关掉一台Windows机器</p>
<table>
<thead>
<tr>
<th>1</th>
<th>net rpc shutdown -I  IP_ADDRESS -U username<strong>%</strong>password</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Windows平台上的net命令是比较强大的，因为其后台是一个RPC类的系统服务，大家应该看过win下用net use \ip\ipc$ *这样一个命令建立IPC空连接，入侵主机的事情。</p>
<p>Linux下的net命令是samba组件的程序，通常包含在smbclient内，可以跟windows主机的文件、打印机共享等服务进行通讯，但是也支持rpc命令。</p>
<p>上述命令就是在远程Windows主机上执行了shutdown命令。当然这不一定成功，关系到win主机上面的安全设置。net命令能够控制到win主机就是了。</p>
<h2 id="4-在一个子shell中运行一个命令"><a href="#4-在一个子shell中运行一个命令" class="headerlink" title="4.在一个子shell中运行一个命令"></a>4.在一个子shell中运行一个命令</h2><table>
<thead>
<tr>
<th>1</th>
<th><strong>(cd</strong> <strong>/</strong>tmp <strong>&amp;&amp;</strong> <strong>ls)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>当然这只是演示，要查看目录当然可以ls /tmp。</p>
<p>好处就是不会改变当前shell的目录，以及如果命令中设计环境变量，也不会对当前shell有任何修改。</p>
<p>在Shell编程中还有很多使用上引号来括住一个命令：<code>ls /tmp</code>，这也是子shell过程。可是上引号的方法无法嵌套，而使用小括号的方法可以，一个比较纠结的例子是：</p>
<table>
<thead>
<tr>
<th>1</th>
<th><strong>echo</strong> $<strong>(echo</strong> -e \x$<strong>(printf</strong>  “%x” 65<strong>))</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>5.利用中间管道嵌套使用SSH</p>
<table>
<thead>
<tr>
<th>1</th>
<th><strong>ssh</strong> -t host_A <strong>ssh</strong> host_B</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>如果目标机器host_B处于比较复杂的网络环境，本机无法直接访问，但另外一台host_A能够访问到host_B，而且也能被本机访问到，那上述命令就解决了方便登录host_B的问题。</p>
<p>但理论上这个过程是可以无限嵌套的，比如：</p>
<table>
<thead>
<tr>
<th>1</th>
<th><strong>ssh</strong> -t host1 <strong>ssh</strong> -t  host2 <strong>ssh</strong> -t  host3 <strong>ssh</strong> -t  host4 …</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>嗯那神马FBI CIA的，有本事来捉我吧～</p>
<p>6.清空屏幕</p>
<table>
<thead>
<tr>
<th>1</th>
<th><strong>&lt;</strong>CTRL+l<strong>&gt;</strong>;</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这个跟之前介绍的reset命令重置终端的作用有些类似，其实都只是发送一段控制序列，让终端的显示复位。</p>
<p>还可以这样运行：</p>
<table>
<thead>
<tr>
<th>1</th>
<th>tput <strong>clear</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>tput是专门用来控制终端的一个小工具，也挺强大的，详细信息运行man tput查看。</p>
<h2 id="7-我想知道一台服务器什么时候重启完"><a href="#7-我想知道一台服务器什么时候重启完" class="headerlink" title="7.我想知道一台服务器什么时候重启完"></a>7.我想知道一台服务器什么时候重启完</h2><table>
<thead>
<tr>
<th>1</th>
<th><strong>ping</strong> -a IP</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>系统管理员最常做的事情是重启系统。但是服务器的重启过程往往得花上好几分钟，什么你的服务器4个scsi卡？16个硬盘？系统是Redhat？还完全安装所有组件？好吧，它重启的时间都够你吃顿饭了，所以我很想知道它什么时候回来。</p>
<p>ping命令有个audible ping参数，-a，当它终于ping通你的服务器时会让小喇叭叫起来。</p>
<h2 id="8-列出你最常用的10条命令"><a href="#8-列出你最常用的10条命令" class="headerlink" title="8.列出你最常用的10条命令"></a>8.列出你最常用的10条命令</h2><table>
<thead>
<tr>
<th>1</th>
<th><strong>history</strong> **\</th>
<th><strong> </strong>awk<strong> ‘{a[$2]++}END{for(i  in a){print a[i] “ “ i}}’ </strong>\</th>
<th><strong>  </strong>sort<strong> -rn  </strong>\</th>
<th><strong> </strong>head**</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>这行命令组合得很妙：</p>
<p>history输出用户了命令历史；awk统计并输出列表；sort排序；head截出前10行。</p>
<h2 id="9-检查Gmail新邮件"><a href="#9-检查Gmail新邮件" class="headerlink" title="9.检查Gmail新邮件"></a>9.检查Gmail新邮件</h2><table>
<thead>
<tr>
<th>1  2  3  4  5  6</th>
<th>curl -u you<strong>@</strong>gmail.com –silent  “<a href="https://mail.google.com/mail/feed/atom" target="_blank" rel="external">https://mail.google.com/mail/feed/atom</a>“  **\</th>
<th><strong>   </strong>perl** -ne  \   ‘      print “Subject: $1 “ if /<title>(.+?)&lt;\/title&gt;/  &amp;&amp; $title++;      print “(from $1)\n” if /<email>(.+?)&lt;\/email&gt;/;   ‘</email></title></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Gmail的一个特色是支持Atom feed输出邮件列表，所以总是见到很多Gmail邮件提醒器之类的，因为开发特简单，atom很方便。</p>
<p>这里只是利用了perl的正则来解析atom（sed/awk也能做到）。</p>
<h2 id="10-用Telnet看《星球大战》"><a href="#10-用Telnet看《星球大战》" class="headerlink" title="10.用Telnet看《星球大战》"></a>10.用Telnet看《星球大战》</h2><table>
<thead>
<tr>
<th>1</th>
<th>telnet towel.blinkenlights.nl</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>没什么好解释的，就是ASCII艺术之一。如果你有ipv6连接，还能看到彩色版的。牛吧？</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2016/10/12/ss用法大全/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/12/ss用法大全/" itemprop="url">就是要你懂网络监控--ss用法大全</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-12T15:30:03+08:00">
                2016-10-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/network/" itemprop="url" rel="index">
                    <span itemprop="name">network</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="就是要你懂网络监控–ss用法大全"><a href="#就是要你懂网络监控–ss用法大全" class="headerlink" title="就是要你懂网络监控–ss用法大全"></a>就是要你懂网络监控–ss用法大全</h1><p>ss是Socket Statistics的缩写。</p>
<p>netstat命令大家肯定已经很熟悉了，但是在2001年的时候netstat 1.42版本之后就没更新了，之后取代的工具是ss命令，是iproute2 package的一员。</p>
<blockquote>
<p>​    rpm -ql iproute | grep ss<br>​    /usr/sbin/ss</p>
</blockquote>
<p>netstat的替代工具是nstat，当然netstat的大部分功能ss也可以替代</p>
<p>ss可以显示跟netstat类似的信息，但是速度却比netstat快很多，netstat是基于/proc/net/tcp获取 TCP socket 的相关统计信息，用strace跟踪一下netstat查询tcp的连接，会看到他open的是/proc/net/tcp的信息。ss快的秘密就在于它利用的是TCP协议的tcp_diag模块，而且是从内核直接读取信息，<strong>当内核不支持  tcp_diag 内核模块时，会回退到 /proc/net/tcp 模式</strong>。</p>
<p>/proc/net/snmp 存放的是系统启动以来的累加值，netstat -s 读取它<br>/proc/net/tcp  是存放目前活跃的tcp连接的统计值，连接断开统计值清空， ss -it 读取它</p>
<h2 id="ss-查看Buffer窗口"><a href="#ss-查看Buffer窗口" class="headerlink" title="ss 查看Buffer窗口"></a><a href="https://access.redhat.com/discussions/3624151" target="_blank" rel="external">ss 查看Buffer窗口</a></h2><p>ss参数说明<a href="https://man7.org/linux/man-pages/man8/ss.8.html" target="_blank" rel="external">权威参考</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">-m, --memory  //查看每个连接的buffer使用情况</div><div class="line">              Show socket memory usage. The output format is:</div><div class="line"></div><div class="line">              skmem:(r&lt;rmem_alloc&gt;,rb&lt;rcv_buf&gt;,t&lt;wmem_alloc&gt;,tb&lt;snd_buf&gt;,</div><div class="line">                            f&lt;fwd_alloc&gt;,w&lt;wmem_queued&gt;,o&lt;opt_mem&gt;,</div><div class="line">                            bl&lt;back_log&gt;,d&lt;sock_drop&gt;)</div><div class="line"></div><div class="line">              &lt;rmem_alloc&gt;</div><div class="line">                     the memory allocated for receiving packet</div><div class="line"></div><div class="line">              &lt;rcv_buf&gt;</div><div class="line">                     the total memory can be allocated for receiving</div><div class="line">                     packet</div><div class="line"></div><div class="line">              &lt;wmem_alloc&gt;</div><div class="line">                     the memory used for sending packet (which has been</div><div class="line">                     sent to layer 3)</div><div class="line"></div><div class="line">              &lt;snd_buf&gt;</div><div class="line">                     the total memory can be allocated for sending</div><div class="line">                     packet</div><div class="line"></div><div class="line">              &lt;fwd_alloc&gt;</div><div class="line">                     the memory allocated by the socket as cache, but</div><div class="line">                     not used for receiving/sending packet yet. If need</div><div class="line">                     memory to send/receive packet, the memory in this</div><div class="line">                     cache will be used before allocate additional</div><div class="line">                     memory.</div><div class="line"></div><div class="line">              &lt;wmem_queued&gt;</div><div class="line">                     The memory allocated for sending packet (which has</div><div class="line">                     not been sent to layer 3)</div><div class="line"></div><div class="line">              &lt;ropt_mem&gt;</div><div class="line">                     The memory used for storing socket option, e.g.,</div><div class="line">                     the key for TCP MD5 signature</div><div class="line"></div><div class="line">              &lt;back_log&gt;</div><div class="line">                     The memory used for the sk backlog queue. On a</div><div class="line">                     process context, if the process is receiving</div><div class="line">                     packet, and a new packet is received, it will be</div><div class="line">                     put into the sk backlog queue, so it can be</div><div class="line">                     received by the process immediately</div><div class="line"></div><div class="line">              &lt;sock_drop&gt;</div><div class="line">                     the number of packets dropped before they are de-</div><div class="line">                     multiplexed into the socket</div></pre></td></tr></table></figure>
<p>The entire print format of <code>ss -m</code> is given in the source:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">      printf(&quot; skmem:(r%u,rb%u,t%u,tb%u,f%u,w%u,o%u&quot;,</div><div class="line">               skmeminfo[SK_MEMINFO_RMEM_ALLOC],</div><div class="line">               skmeminfo[SK_MEMINFO_RCVBUF],</div><div class="line">               skmeminfo[SK_MEMINFO_WMEM_ALLOC],</div><div class="line">               skmeminfo[SK_MEMINFO_SNDBUF],</div><div class="line">               skmeminfo[SK_MEMINFO_FWD_ALLOC],</div><div class="line">               skmeminfo[SK_MEMINFO_WMEM_QUEUED],</div><div class="line">               skmeminfo[SK_MEMINFO_OPTMEM]);</div><div class="line"></div><div class="line">        if (RTA_PAYLOAD(tb[attrtype]) &gt;=</div><div class="line">                (SK_MEMINFO_BACKLOG + 1) * sizeof(__u32))</div><div class="line">                printf(&quot;,bl%u&quot;, skmeminfo[SK_MEMINFO_BACKLOG]);</div><div class="line"></div><div class="line">        if (RTA_PAYLOAD(tb[attrtype]) &gt;=</div><div class="line">                (SK_MEMINFO_DROPS + 1) * sizeof(__u32))</div><div class="line">                printf(&quot;,d%u&quot;, skmeminfo[SK_MEMINFO_DROPS]);</div><div class="line"></div><div class="line">        printf(&quot;)&quot;);</div><div class="line">        </div><div class="line">        </div><div class="line">net/core/sock.c line:3095</div><div class="line">void sk_get_meminfo(const struct sock *sk, u32 *mem)</div><div class="line">&#123;</div><div class="line">	memset(mem, 0, sizeof(*mem) * SK_MEMINFO_VARS);</div><div class="line"></div><div class="line">	mem[SK_MEMINFO_RMEM_ALLOC] = sk_rmem_alloc_get(sk);</div><div class="line">	mem[SK_MEMINFO_RCVBUF] = sk-&gt;sk_rcvbuf;</div><div class="line">	mem[SK_MEMINFO_WMEM_ALLOC] = sk_wmem_alloc_get(sk);</div><div class="line">	mem[SK_MEMINFO_SNDBUF] = sk-&gt;sk_sndbuf;</div><div class="line">	mem[SK_MEMINFO_FWD_ALLOC] = sk-&gt;sk_forward_alloc;</div><div class="line">	mem[SK_MEMINFO_WMEM_QUEUED] = sk-&gt;sk_wmem_queued;</div><div class="line">	mem[SK_MEMINFO_OPTMEM] = atomic_read(&amp;sk-&gt;sk_omem_alloc);</div><div class="line">	mem[SK_MEMINFO_BACKLOG] = sk-&gt;sk_backlog.len;</div><div class="line">	mem[SK_MEMINFO_DROPS] = atomic_read(&amp;sk-&gt;sk_drops);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="/images/951413iMgBlog/image-20210604120011898.png" alt="image-20210604120011898"></p>
<p>–memory/-m ： 展示buffer窗口的大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#ss -m | xargs -L 1 | grep &quot;ESTAB&quot; | awk &apos;&#123; if($3&gt;0 || $4&gt;0) print $0 &#125;&apos;</div><div class="line">tcp ESTAB 0 31 10.97.137.1:7764 10.97.137.2:41019 skmem:(r0,rb7160692,t0,tb87040,f1792,w2304,o0,bl0)</div><div class="line">tcp ESTAB 0 193 ::ffff:10.97.137.1:sdo-tls ::ffff:10.97.137.2:55545 skmem:(r0,rb369280,t0,tb87040,f1792,w2304,o0,bl0)</div><div class="line">tcp ESTAB 0 65 ::ffff:10.97.137.1:splitlock ::ffff:10.97.137.2:47796 skmem:(r0,rb369280,t0,tb87040,f1792,w2304,o0,bl0)</div><div class="line">tcp ESTAB 0 80 ::ffff:10.97.137.1:informer ::ffff:10.97.137.3:49279 skmem:(r0,rb369280,t0,tb87040,f1792,w2304,o0,bl0)</div><div class="line">tcp ESTAB 0 11 ::ffff:10.97.137.1:acp-policy ::ffff:10.97.137.2:41607 skmem:(r0,rb369280,t0,tb87040,f1792,w2304,o0,bl0)</div><div class="line"></div><div class="line">#ss -m -n | xargs -L 1 | grep &quot;tcp EST&quot; | grep &quot;t[1-9]&quot;</div><div class="line">tcp ESTAB 0 281 10.97.169.173:32866 10.97.170.220:3306 skmem:(r0,rb4619516,t2304,tb87552,f1792,w2304,o0,bl0)</div></pre></td></tr></table></figure>
<p><img src="/images/oss/4a09503e6c6e84c25e026248a1b3ebb6.png" alt="image.png"></p>
<p>如上图，tb指可分配的发送buffer大小，不够还可以动态调整（应用没有写死的话），w[The memory allocated for sending packet (which has not been sent to layer 3)]已经预分配好了的size，t[the memory used for sending packet (which has been sent to layer 3)] , 似乎 w总是等于大于t？</p>
<p>example:</p>
<p><img src="/images/oss/4ed3d8aab6ef3ee45decda75e534baab.png" alt="image.png"></p>
<p>对172.16.210.17和172.16.160.1之间的带宽限速50MB后观察(带宽限制后，发送buffer就很容易被撑满了）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash">ss -m | xargs -L 1 | grep <span class="string">"tcp EST"</span> | awk <span class="string">'&#123; if($3&gt;0 || $4&gt;0) print $0 &#125;'</span></span></div><div class="line">Netid State Recv-Q Send-Q Local Address:Port Peer Address:Port</div><div class="line">tcp ESTAB 1431028 0 172.16.210.17:30082 172.16.160.1:4847 skmem:(r2066432,rb2135508,t0,tb46080,f2048,w0,o0,bl0,d72)</div><div class="line">tcp ESTAB 1195628 0 172.16.210.17:30086 172.16.160.1:4847 skmem:(r1742848,rb1915632,t8,tb46080,f190464,w0,o0,bl0,d187)</div><div class="line">tcp ESTAB 86416 0 172.16.210.17:40470 172.16.160.1:4847 skmem:(r127232,rb131072,t0,tb46080,f3840,w0,o0,bl0,d16)</div><div class="line">tcp ESTAB 1909826 0 172.16.210.17:40476 172.16.160.1:4847 skmem:(r2861568,rb2933688,t2,tb46080,f26112,w0,o0,bl0,d15)</div><div class="line">tcp ESTAB 758312 0 172.16.210.17:40286 172.16.160.1:4847 skmem:(r1124864,rb1177692,t0,tb46080,f1536,w0,o0,bl0,d17)</div><div class="line">tcp ESTAB 2238720 0 172.16.210.17:40310 172.16.160.1:4847 skmem:(r3265280,rb3334284,t0,tb46080,f3328,w0,o0,bl0,d30)</div><div class="line">tcp ESTAB 88172 0 172.16.210.17:40508 172.16.160.1:4847 skmem:(r128000,rb131072,t0,tb46080,f3072,w0,o0,bl0,d16)</div><div class="line">tcp ESTAB 87700 0 172.16.210.17:41572 172.16.160.1:4847 skmem:(r130560,rb131072,t0,tb46080,f512,w0,o0,bl0,d10)</div><div class="line">tcp ESTAB 4147293 0 172.16.210.17:40572 172.16.160.1:4847 skmem:(r6064896,rb6291456,t2,tb46080,f75008,w0,o0,bl0,d27)</div><div class="line">tcp ESTAB 1610940 0 172.16.210.17:30100 172.16.160.1:4847 skmem:(r2358784,rb2533092,t6,tb46080,f82432,w0,o0,bl0,d304)</div><div class="line">tcp ESTAB 4216156 0 172.16.210.17:30068 172.16.160.1:4847 skmem:(r6091008,rb6291456,t0,tb46080,f3840,w0,o0,bl0,d112)</div><div class="line">tcp ESTAB 87468 0 172.16.210.17:40564 172.16.160.1:4847 skmem:(r127232,rb131072,t0,tb46080,f3840,w0,o0,bl0,d16)</div><div class="line">tcp ESTAB 0 84608 172.16.210.17:3306 10.100.7.27:43114 skmem:(r0,rb65536,t8352,tb131072,f75648,w92288,o0,bl0,d0)</div><div class="line">tcp ESTAB 4141872 0 172.16.210.17:40584 172.16.160.1:4847 skmem:(r6050560,rb6291456,t2,tb46080,f19712,w0,o0,bl0,d14)</div><div class="line"><span class="meta"></span></div><div class="line">$<span class="bash">ss -itn</span></div><div class="line">State       Recv-Q Send-Q   Local Address:Port                  Peer Address:Port</div><div class="line">ESTAB       965824 0        172.16.210.17:19310                 172.16.160.1:4847</div><div class="line">         cubic wscale:9,7 rto:215 rtt:14.405/0.346 ato:160 mss:1440 rcvmss:1460 advmss:1460 cwnd:10 bytes_acked:1324584 bytes_received:2073688144 segs_out:91806 segs_in:1461520 data_segs_out:4824 data_segs_in:1456130 send 8.0Mbps lastsnd:545583 lastrcv:545276 lastack:13173 pacing_rate 16.0Mbps delivery_rate 8.9Mbps app_limited busy:9071ms rcv_rtt:1.303 rcv_space:164245 minrtt:1.293</div><div class="line">ESTAB       0      84371    172.16.210.17:3306                  10.100.7.147:59664</div><div class="line">         cubic wscale:7,7 rto:217 rtt:16.662/0.581 ato:40 mss:1448 rcvmss:976 advmss:1448 cwnd:375 ssthresh:19 bytes_acked:5087795046 bytes_received:1647 segs_out:3589314 segs_in:358086 data_segs_out:3589313 data_segs_in:8 send 260.7Mbps lastsnd:6 lastrcv:1177745 lastack:4 pacing_rate 312.8Mbps delivery_rate 32.9Mbps busy:1176476ms rwnd_limited:1717ms(0.1%) sndbuf_limited:159867ms(13.6%) unacked:37 retrans:0/214 rcv_space:14600 notsent:32055 minrtt:7.945</div><div class="line">ESTAB       0      83002    172.16.210.17:3306                   10.100.7.28:34066</div><div class="line">         cubic wscale:7,7 rto:215 rtt:14.635/0.432 ato:40 mss:1448 rcvmss:976 advmss:1448 cwnd:144 ssthresh:144 bytes_acked:972464708 bytes_received:1466 segs_out:671667 segs_in:94369 data_segs_out:671666 data_segs_in:8 send 114.0Mbps lastsnd:1 lastrcv:453365 lastack:1 pacing_rate 136.8Mbps delivery_rate 24.0Mbps busy:453493ms sndbuf_limited:200ms(0.0%) unacked:23 rcv_space:14600 notsent:49698 minrtt:9.937</div><div class="line">ESTAB       1239616 0        172.16.210.17:41592                 172.16.160.1:4847</div><div class="line">         cubic wscale:9,7 rto:216 rtt:15.754/0.775 ato:144 mss:1440 rcvmss:1460 advmss:1460 cwnd:10 bytes_acked:20321 bytes_received:1351071 segs_out:269 segs_in:1091 data_segs_out:76 data_segs_in:988 send 7.3Mbps lastsnd:339339 lastrcv:337401 lastack:10100 pacing_rate 14.6Mbps delivery_rate 1.0Mbps app_limited busy:1214ms rcv_rtt:227.156 rcv_space:55581 minrtt:11.38</div><div class="line">ESTAB       3415748 0        172.16.210.17:30090                 172.16.160.1:4847</div><div class="line">         cubic wscale:9,7 rto:202 rtt:1.667/0.011 ato:80 mss:1440 rcvmss:1460 advmss:1460 cwnd:10 bytes_acked:398583 bytes_received:613824362 segs_out:28630 segs_in:437621 data_segs_out:1495 data_segs_in:435792 send 69.1Mbps lastsnd:1179931 lastrcv:1179306 lastack:12149 pacing_rate 138.2Mbps delivery_rate 7.2Mbps app_limited busy:2520ms rcv_rtt:1.664 rcv_space:212976 minrtt:1.601</div><div class="line">ESTAB       86480  0        172.16.210.17:41482                 172.16.160.1:4847</div><div class="line">         cubic wscale:9,7 rto:215 rtt:14.945/1.83 ato:94 mss:1440 rcvmss:1460 advmss:1460 cwnd:10 bytes_acked:3899 bytes_received:93744 segs_out:73 segs_in:136 data_segs_out:20 data_segs_in:83 send 7.7Mbps lastsnd:449541 lastrcv:449145 lastack:19314 pacing_rate 15.4Mbps delivery_rate 964.2Kbps app_limited busy:296ms rcv_rtt:8561.27 rcv_space:14600 minrtt:11.948</div><div class="line">ESTAB       89136  0        172.16.210.17:40480                 172.16.160.1:4847</div><div class="line">         cubic wscale:9,7 rto:213 rtt:12.11/0.79 ato:196 mss:1440 rcvmss:1460 advmss:1460 cwnd:10 bytes_acked:2510 bytes_received:95652 segs_out:102 segs_in:168 data_segs_out:16 data_segs_in:81send 9.5Mbps lastsnd:1099067 lastrcv:1098659 lastack:13686 pacing_rate 19.0Mbps delivery_rate 1.0Mbps app_limited busy:199ms rcv_rtt:2438.63 rcv_space:14600 minrtt:11.178</div><div class="line">ESTAB       0      84288    172.16.210.17:3306                   10.100.7.26:51160</div><div class="line">         cubic wscale:7,7 rto:216 rtt:15.129/0.314 ato:40 mss:1448 rcvmss:976 advmss:1448 cwnd:157 ssthresh:157 bytes_acked:2954689465 bytes_received:1393 segs_out:2041403 segs_in:237797 data_segs_out:2041402 data_segs_in:8 send 120.2Mbps lastsnd:11 lastrcv:1103462 lastack:10 pacing_rate 144.2Mbps delivery_rate 31.3Mbps busy:1103503ms sndbuf_limited:3398ms(0.3%) unacked:24 retrans:0/7rcv_space:14600 notsent:49536 minrtt:9.551</div></pre></td></tr></table></figure>
<p>推荐 -m -i 一起查看状态，比如 rcv_space 表示buffer达到过的最大水位</p>
<blockquote>
<p><strong>rcv_space</strong> is the high water mark of the rate of the local application reading from the receive buffer during any RTT. This is used internally within the kernel to adjust sk_rcvbuf.</p>
</blockquote>
<h2 id="ss-查看拥塞窗口、RTO"><a href="#ss-查看拥塞窗口、RTO" class="headerlink" title="ss 查看拥塞窗口、RTO"></a>ss 查看拥塞窗口、RTO</h2><blockquote>
<p>//rto的定义，不让修改，每个ip的rt都不一样，必须通过rtt计算所得, HZ 一般是1秒</p>
<p>#define TCP_RTO_MAX     ((unsigned)(120*HZ))</p>
<p>#define TCP_RTO_MIN     ((unsigned)(HZ/5)) //在rt很小的环境中计算下来RTO基本等于TCP_RTO_MIN</p>
</blockquote>
<p>下面看到的rto和rtt单位都是毫秒，一般rto最小为200ms、最大为120秒</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#ss -itn |egrep &quot;cwnd|rto&quot;	</div><div class="line">ESTAB       0      165      [::ffff:192.168.0.174]:48074                [::ffff:192.168.0.173]:3306</div><div class="line">	cubic wscale:7,7 rto:201 rtt:0.24/0.112 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:10 bytes_acked:1910206449 bytes_received:8847784416 segs_out:11273005 segs_in:22997562 data_segs_out:9818729 data_segs_in:13341573 send 482.7Mbps lastsnd:1 lastrcv:1 pacing_rate 963.8Mbps delivery_rate 163.2Mbps app_limited busy:2676463ms retrans:0/183 rcv_rtt:1.001 rcv_space:35904 minrtt:0.135</div><div class="line"></div><div class="line">ESTAB       0      0        [::ffff:192.168.0.174]:48082                [::ffff:192.168.0.173]:3306</div><div class="line">	 cubic wscale:7,7 rto:201 rtt:0.262/0.112 ato:40 mss:1448 rcvmss:1448 advmss:1448 cwnd:10 bytes_acked:1852907381 bytes_received:8346503207 segs_out:10913962 segs_in:22169704 data_segs_out:9531411 data_segs_in:12796151 send 442.1Mbps lastsnd:2 lastack:2 pacing_rate 881.3Mbps delivery_rate 164.3Mbps app_limited busy:2736500ms retrans:0/260 rcv_rtt:1.042 rcv_space:31874 minrtt:0.133</div><div class="line">	 </div><div class="line">	 -----</div><div class="line">	 skmem:(r0,rb131072,t0,tb133632,f0,w0,o0,bl0,d0) cubic wscale:8,7 rto:233 rtt:32.489/2.99 ato:40 mss:1380 rcvmss:536 advmss:1460 cwnd:11 ssthresh:8 bytes_acked:99862366 bytes_received:2943 segs_out:78933 segs_in:23388 data_segs_out:78925 data_segs_in:81 send 3.7Mbps lastsnd:1735288 lastrcv:1735252 lastack:1735252 pacing_rate 4.5Mbps delivery_rate 2.9Mbps busy:370994ms retrans:0/6479 reordering:5 rcv_space:14600 minrtt:27.984</div></pre></td></tr></table></figure>
<h3 id="RTO计算算法"><a href="#RTO计算算法" class="headerlink" title="RTO计算算法"></a>RTO计算算法</h3><p>RTO的计算依赖于RTT值，或者说一系列RTT值。rto=f(rtt)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">1.1. 在没有任何rtt sample的时候，RTO &lt;- TCP_TIMEOUT_INIT (1s)</div><div class="line">   多次重传时同样适用指数回避算法(backoff)增加RTO  </div><div class="line"></div><div class="line">1.2. 获得第一个RTT sample后，</div><div class="line">    SRTT &lt;- RTT</div><div class="line">    RTTVAR &lt;- RTT/2</div><div class="line">    RTO &lt;- SRTT + max(G, K * RTTVAR)</div><div class="line">其中K=4, G表示timestamp的粒度(在CONFIG_HZ=1000时，粒度为1ms)</div><div class="line"></div><div class="line">1.3. 后续获得更多RTT sample后，</div><div class="line">    RTTVAR &lt;- (1 - beta) * RTTVAR + beta * |SRTT - R|</div><div class="line">    SRTT &lt;- (1 - alpha) * SRTT + alpha * R</div><div class="line">其中beta = 1/4, alpha = 1/8</div><div class="line"></div><div class="line">1.4. Whenever RTO is computed, if it is less than 1 second, then the</div><div class="line">   RTO SHOULD be rounder up to 1 second.</div><div class="line"></div><div class="line">1.5. A maximum value MAY be placed on RTO provided it is at least 60 seconds.</div></pre></td></tr></table></figure>
<p>RTTVAR表示的是平滑过的平均偏差，SRTT表示的平滑过的RTT。这两个值的具体含义会在后面介绍<br>具体实现的时候进一步的解释。<br>以上是计算一个初始RTO值的过程，当连续出现RTO超时后，<br>RTO值会用一个叫做指数回避的策略进行调整，下面来具体介绍。</p>
<h2 id="从系统cache中查看-tcp-metrics-item"><a href="#从系统cache中查看-tcp-metrics-item" class="headerlink" title="从系统cache中查看 tcp_metrics item"></a>从系统cache中查看 tcp_metrics item</h2><pre><code>$sudo ip tcp_metrics show | grep  100.118.58.7
100.118.58.7 age 1457674.290sec tw_ts 3195267888/5752641sec ago rtt 1000us rttvar 1000us ssthresh 361 cwnd 40 ----这两个值对传输性能很重要

192.168.1.100 age 1051050.859sec ssthresh 4 cwnd 2 rtt 4805us rttvar 4805us source 192.168.0.174 ---这条记录有问题，缓存的ssthresh 4 cwnd 2都太小，传输速度一定慢 

清除 tcp_metrics, sudo ip tcp_metrics flush all 
关闭 tcp_metrics 功能，net.ipv4.tcp_no_metrics_save = 1
sudo ip tcp_metrics delete 100.118.58.7
</code></pre><p>每个连接的ssthresh默认是个无穷大的值，但是内核会cache对端ip上次的ssthresh（大部分时候两个ip之间的拥塞窗口大小不会变），这样大概率到达ssthresh之后就基本拥塞了，然后进入cwnd的慢增长阶段。</p>
<h2 id="ss-过滤地址和端口号，类似tcpdump的用法"><a href="#ss-过滤地址和端口号，类似tcpdump的用法" class="headerlink" title="ss 过滤地址和端口号，类似tcpdump的用法"></a>ss 过滤地址和端口号，类似tcpdump的用法</h2><p>过滤目标端口是80的或者源端口是1723的连接，dst后面要跟空格然后加“：”：</p>
<pre><code># ss -ant dst :80 or src :1723 
State      Recv-Q Send-Q   Local Address:Port Peer Address:Port 
LISTEN     0      3        *:1723              *:*     
TIME-WAIT  0      0                                                     172.31.23.95:37269                                              111.161.68.235:80    
TIME-WAIT  0      0                                                     172.31.23.95:37263                                              111.161.68.235:80    
TIME-WAIT  0      0                                                     172.31.23.95:37267 
</code></pre><p>or：</p>
<pre><code>ss -ant dport = :80 or sport = :1723
</code></pre><p>地址筛选，目标地址是111.161.68.235的连接</p>
<pre><code>ss -ant dst 111.161.68.235
</code></pre><p>端口大小筛选，源端口大于1024的端口：</p>
<pre><code>ss sport gt 1024
</code></pre><p>How Do I Compare Local and/or Remote Port To A Number?<br>Use the following syntax:</p>
<pre><code>## Compares remote port to a number ##
ss dport OP PORT

## Compares local port to a number ##
sport OP PORT
</code></pre><p>Where OP can be one of the following:</p>
<pre><code>&lt;= or le : Less than or equal to port
&gt;= or ge : Greater than or equal to port
== or eq : Equal to port
!= or ne : Not equal to port
&lt; or gt : Less than to port
&gt; or lt : Greater than to port
Note: le, gt, eq, ne etc. are use in unix shell and are accepted as well.

###################################################################################
### Do not forget to escape special characters when typing them in command line ###
###################################################################################

ss  sport = :http
ss  dport = :http
ss  dport \&gt; :1024
ss  sport \&gt; :1024
ss sport \&lt; :32000
ss  sport eq :22
ss  dport != :22
ss  state connected sport = :http
ss \( sport = :http or sport = :https \)
ss -o state fin-wait-1 \( sport = :http or sport = :https \) dst 192.168.1/24
</code></pre><h2 id="ss-查看-timer-状态"><a href="#ss-查看-timer-状态" class="headerlink" title="ss 查看 timer 状态"></a>ss 查看 timer 状态</h2><p>ss -atonp</p>
<h2 id="按连接状态过滤"><a href="#按连接状态过滤" class="headerlink" title="按连接状态过滤"></a>按连接状态过滤</h2><p>Display All Established HTTP Connections</p>
<pre><code>ss -o state established &apos;( dport = :http or sport = :http )&apos;
</code></pre><p>List all the TCP sockets in state -FIN-WAIT-1 for our httpd to network 202.54.1/24 and look at their timers:<br>    ss -o state fin-wait-1 ‘( sport = :http or sport = :https )’ dst 202.54.1/24</p>
<p>Filter Sockets Using TCP States</p>
<pre><code>ss -4 state FILTER-NAME-HERE
</code></pre><p>Where FILTER-NAME-HERE can be any one of the following,</p>
<pre><code>established
syn-sent
syn-recv
fin-wait-1
fin-wait-2
time-wait
closed
close-wait
last-ack
listen
closing
all : All of the above states
connected : All the states except for listen and closed
synchronized : All the connected states except for syn-sent
bucket : Show states, which are maintained as minisockets, i.e. time-wait and syn-recv.
big : Opposite to bucket state.
</code></pre><h2 id="ss分析重传的包数量"><a href="#ss分析重传的包数量" class="headerlink" title="ss分析重传的包数量"></a>ss分析重传的包数量</h2><p>通过抓取ss命令，可以分析出来重传的包数量，然后将重传的流的数量和重传的包的数量按照对端IP:port的维度分段聚合，参考命令：</p>
<pre><code>ss -itn |grep -v &quot;Address:Port&quot; | xargs -L 1  | grep retrans | awk &apos;{gsub(&quot;retrans:.*/&quot;, &quot;&quot;,$21); print $5, $21}&apos; | awk &apos;{arr[$1]+=$2} END {for (i in arr) {print i,arr[i]}}&apos; | sort -rnk 2 
</code></pre><p>xargs <strong>-L 1</strong>  每一行处理一次，但是这个行如果是空格、tab结尾，那么会被认为是连续行，跟下一行合并</p>
<p>高版本Linux内核的话，可以用systemtap或者bcc来获取每个连接的重传包以及发生重传的阶段</p>
<h2 id="当前和最大全连接队列确认"><a href="#当前和最大全连接队列确认" class="headerlink" title="当前和最大全连接队列确认"></a>当前和最大全连接队列确认</h2><pre><code>$ss -lt
State      Recv-Q Send-Q Local Address:Port                 Peer Address:Port         
LISTEN     0      128    127.0.0.1:10248                       *:*                   
LISTEN     0      128           *:2376                        *:*                    
LISTEN     0      128    127.0.0.1:10249                       *:*                   
LISTEN     0      128           *:7337                        *:*                    
LISTEN     0      128           *:10250                       *:*                    
LISTEN     0      128    11.163.187.44:7946                        *:*               
LISTEN     0      128    127.0.0.1:55631                       *:*                   
LISTEN     0      128           *:10256                       *:*                    
LISTEN     0      10            *:6640                        *:*                    
LISTEN     0      128    127.0.0.1:vmware-fdm                  *:*                   
LISTEN     0      128    11.163.187.44:vmware-fdm                  *:*               
LISTEN     0      128           *:ssh                         *:*                    
LISTEN     0      10     127.0.0.1:15772                       *:*                   
LISTEN     0      10     127.0.0.1:15776                       *:*                   
LISTEN     0      10     127.0.0.1:19777                       *:*                   
LISTEN     0      10     11.163.187.44:15778                       *:*               
LISTEN     0      128           *:tr-rsrb-p2                  *:*
</code></pre><h2 id="ss-s"><a href="#ss-s" class="headerlink" title="ss -s"></a>ss -s</h2><p>统计所有连接的状态</p>
<h2 id="nstat"><a href="#nstat" class="headerlink" title="nstat"></a>nstat</h2><p>nstat -z -t 1 类似 netstat -s  (ss –info 展示rto、拥塞算法等更详细信息； netstat -ant -o 展示keepalive是否)</p>
<p>netstat<a href="http://perthcharles.github.io/2015/11/10/wiki-netstat-proc/" target="_blank" rel="external">参考</a></p>
<h2 id="knetstat"><a href="#knetstat" class="headerlink" title="knetstat"></a>knetstat</h2><p>最后给出的一个工具，knetstat（需要单独安装），也可以查看tcp的状态下的各种参数，需要单独安装</p>
<p>example(3306是本地server，4192是后端MySQL）：</p>
<pre><code>Recv-Q Send-Q Local Address           Foreign Address         Stat Diag Options
 0      0 0.0.0.0:3306            0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 0.0.0.0:3406            0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 127.0.0.1:8182          0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 10.0.186.73:8182        0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 0.0.0.0:22              0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 0.0.0.0:8188            0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0
 0      0 127.0.0.1:15778         0.0.0.0:*               LSTN      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=0,TCP_NODELAY=0,TCP_FASTOPEN=0,TCP_DEFER_ACCEPT=0 
 0    138 10.0.186.73:51756       10.0.160.1:4192         ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0      0 10.0.186.73:3306        10.0.186.70:37428       ESTB      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVBUF=32768,SO_SNDBUF=65536,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0    138 10.0.186.73:51476       10.0.160.1:4192         ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0      0 10.0.186.73:3306        10.0.186.70:37304       ESTB      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVBUF=32768,SO_SNDBUF=65536,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0      0 10.0.186.73:51842       10.0.160.1:4192         ESTB      SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
44      0 10.0.186.73:3306        10.0.186.70:36238       ESTB      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVBUF=32768,SO_SNDBUF=65536,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
44      0 10.0.186.73:3306        10.0.186.70:36160       ESTB      SO_REUSEADDR=1,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVBUF=32768,SO_SNDBUF=65536,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
0      0 10.0.186.73:19030       10.0.171.188:8000       TIMW
</code></pre><p>3306对应的client上：</p>
<pre><code>Recv-Q Send-Q Local Address           Foreign Address         Stat Diag Options
 0     44 10.0.186.70:42428       10.0.186.73:3306        ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVTIMEO=31536000000ms,SO_SNDTIMEO=31536000000ms,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0     44 10.0.186.70:42298       10.0.186.73:3306        ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVTIMEO=31536000000ms,SO_SNDTIMEO=31536000000ms,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0     44 10.0.186.70:42296       10.0.186.73:3306        ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVTIMEO=31536000000ms,SO_SNDTIMEO=31536000000ms,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
 0     44 10.0.186.70:42322       10.0.186.73:3306        ESTB &gt;#   SO_REUSEADDR=0,SO_REUSEPORT=0,SO_KEEPALIVE=1,SO_RCVTIMEO=31536000000ms,SO_SNDTIMEO=31536000000ms,TCP_NODELAY=1,TCP_DEFER_ACCEPT=0
</code></pre><p>Diag列的说明<br>    Indicator        Meaning</p>
<pre><code>&gt;|             The sender window (i.e. the window advertised by the remote endpoint) is 0. No data can be sent to the peer.
  &gt;|&lt;             The receiver window (i.e. the window advertised by the local endpoint) is 0. No data can be received from the peer.
&gt;
&gt;#             There are unacknowledged packets and the last ACK was received more than one second ago. This may be an indication that there are network problems or that the peer crashed.
</code></pre><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.cyberciti.biz/tips/linux-investigate-sockets-network-connections.html" target="_blank" rel="external">https://www.cyberciti.biz/tips/linux-investigate-sockets-network-connections.html</a></p>
<p><a href="http://perthcharles.github.io/2015/11/10/wiki-netstat-proc/" target="_blank" rel="external">http://perthcharles.github.io/2015/11/10/wiki-netstat-proc/</a></p>
<p>源代码：<a href="https://github.com/sivasankariit/iproute2/blob/master/misc/ss.c" target="_blank" rel="external">https://github.com/sivasankariit/iproute2/blob/master/misc/ss.c</a></p>
<p><a href="https://github.com/veithen/knetstat/tree/master" target="_blank" rel="external">https://github.com/veithen/knetstat/tree/master</a></p>
<p><a href="https://access.redhat.com/discussions/782343" target="_blank" rel="external">https://access.redhat.com/discussions/782343</a></p>
<p><a href="https://perthcharles.github.io/2015/09/06/wiki-rtt-estimator/" target="_blank" rel="external">RTO的计算方法(基于RFC6298和Linux 3.10)</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2016/08/24/Linux tc qdisc的使用案例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/24/Linux tc qdisc的使用案例/" itemprop="url">Linux tc qdisc的使用案例</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-24T17:30:03+08:00">
                2016-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Linux-tc-qdisc的使用案例"><a href="#Linux-tc-qdisc的使用案例" class="headerlink" title="Linux tc qdisc的使用案例"></a>Linux tc qdisc的使用案例</h1><p>在linux下通过tc qdisc 很容易对rt延时、丢包、带宽进行控制，这样的话方便重现各种网络问题</p>
<h2 id="延时"><a href="#延时" class="headerlink" title="延时"></a>延时</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">1. give packets from eth0 a delay of 2ms</div><div class="line"><span class="meta">bash$</span> tc qdisc add dev eth0 root netem delay 2ms</div><div class="line"> </div><div class="line">2.change the delay to 300ms</div><div class="line"><span class="meta">bash$</span> tc qdisc change dev eth0 root netem delay 3ms</div><div class="line"></div><div class="line">3.display eth0 delay setting</div><div class="line"><span class="meta">bash$</span> tc qdisc show dev eth0</div><div class="line"> </div><div class="line">4.stop the delay</div><div class="line"><span class="meta">bash$</span> tc qdisc del dev eth0 root</div><div class="line"><span class="meta"></span></div><div class="line">#corrupt</div><div class="line">The following rule corrupts 5% of the packets by introducing single bit error at a random offset in the packet:</div><div class="line">tc qdisc change dev eth0 root netem corrupt 5%</div></pre></td></tr></table></figure>
<h2 id="模拟网络丢包"><a href="#模拟网络丢包" class="headerlink" title="模拟网络丢包"></a>模拟网络丢包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tc qdisc add dev eth0 root netem loss 1%</div></pre></td></tr></table></figure>
<p>指定ip 172.31.65.30延时17ms， 测试发现181和183这两句命令顺序无所谓。恢复正常：179行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">179  tc qdisc del dev eth0 root</div><div class="line">180  tc qdisc add dev eth0 root handle 1: prio</div><div class="line">181  tc filter add dev eth0 parent 1:0 protocol ip pref 55 handle ::55 u32 match ip dst 172.31.65.30 flowid 2:1</div><div class="line">182  tc qdisc ls</div><div class="line">183  tc qdisc add dev eth0 parent 1:1 handle 2: netem delay 17ms</div></pre></td></tr></table></figure>
<h2 id="指定ip和端口延时"><a href="#指定ip和端口延时" class="headerlink" title="指定ip和端口延时"></a>指定ip和端口延时</h2><p>指定 eth0 网卡，来源 ip 是 10.0.1.1，目的端口是 3306 的访问延迟 20ms，上下浮动 2ms </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># 指定 eth0 网卡，来源 ip 是 10.0.1.1，目的端口是 3306 的访问延迟 20ms，上下浮动 2ms</div><div class="line">tc qdisc add dev eth0 root handle 1: prio bands 4</div><div class="line">tc qdisc add dev eth0 parent 1:4 handle 40: netem delay 20ms 2ms</div><div class="line">tc filter add dev eth0 parent 1: protocol ip prio 4 basic match &quot;cmp(u16 at 2 layer transport eq 3306)</div><div class="line">                            and cmp(u8 at 16 layer network eq 10)</div><div class="line">                            and cmp(u8 at 17 layer network eq 0)</div><div class="line">                            and cmp(u8 at 18 layer network eq 1)</div><div class="line">                            and cmp(u8 at 19 layer network eq 1)&quot; flowid 1:4</div><div class="line">                            </div><div class="line"># 删除过滤</div><div class="line">sudo tc filter del dev eth0 parent 1: prio 4 basic</div><div class="line">sudo tc qdisc  del dev eth0 root</div></pre></td></tr></table></figure>
<p>0 layer 代表 sport<br>2 layer 代表 dport</p>
<h2 id="指定端口34001上，延时5ms"><a href="#指定端口34001上，延时5ms" class="headerlink" title="指定端口34001上，延时5ms"></a>指定端口34001上，延时5ms</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tc qdisc add dev eth0 root handle 1: prio</div><div class="line">tc qdisc add dev eth0 parent 1:3 handle 30: netem delay 5ms</div><div class="line">tc filter add dev eth0 protocol ip parent 1:0 u32 match ip sport 34001 0xffff flowid 1:3</div></pre></td></tr></table></figure>
<h2 id="控制网卡的带宽、延时、乱序、丢包"><a href="#控制网卡的带宽、延时、乱序、丢包" class="headerlink" title="控制网卡的带宽、延时、乱序、丢包"></a>控制网卡的带宽、延时、乱序、丢包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">sudo tc qdisc add dev bond0 root handle 1: netem delay 10ms reorder 25% 50% loss 0.2%</div><div class="line">sudo tc qdisc add dev bond0 parent 1: handle 2: tbf rate 1mbit burst 32kbit latency 10ms</div><div class="line"></div><div class="line">/sbin/tc qdisc add dev bond0 root tbf rate 500kbit latency 50ms burst 15kb</div><div class="line"></div><div class="line">// 同时模拟20Mbps带宽，50msRTT和0.1%丢包率  </div><div class="line"><span class="meta">#</span> tc qdisc add dev bond0 root handle 1:0 tbf rate 20mbit burst 10kb limit 300000  </div><div class="line"><span class="meta">#</span> tc qdisc add dev bond0 parent 1:0 handle 10:0 netem delay 50ms loss 0.1 limit 300000 </div><div class="line"></div><div class="line">tc qdisc change dev eth0 root netem reorder 50% gap 3 delay 1ms</div><div class="line">tc qdisc change dev eth0 root netem delay 1ms reorder 15%</div><div class="line"></div><div class="line">//在eth0上设置一个tbf队列，网络带宽为200kbit，延迟10ms以内，超出的包会被drop掉，缓冲区为1540个字节</div><div class="line">sudo /sbin/tc qdisc add dev eth0 root tbf rate 200kbit latency 10ms burst 15kb</div><div class="line">sudo /sbin/tc qdisc ls dev eth0</div></pre></td></tr></table></figure>
<p>在eth0上设置一个tbf队列，网络带宽为200kbit，延迟10ms以内，超出的包会被drop掉，缓冲区为1540个字节</p>
<blockquote>
<p>rate表示令牌的产生速率, <em>sustained maximum rate</em><br>latency表示数据包在队列中的最长等待时间, <em>packets with higher latency get dropped</em><br>burst参数表示  maximum allowed burst：<br>  burst means the maximum amount of bytes that tokens can be available for instantaneously.<br>  如果数据包的到达速率与令牌的产生速率一致，即200kbit，则数据不会排队，令牌也不会剩余<br>  如果数据包的到达速率小于令牌的产生速率，则令牌会有一定的剩余。<br>  如果后续某一会数据包的到达速率超过了令牌的产生速率，则可以一次性的消耗一定量的令牌。<br>  burst就是用于限制这“一次性”消耗的令牌的数量的，以字节数为单位。</p>
</blockquote>
<p>tbf: <em>use</em> the <em>token buffer filter to manipulate traffic rates</em></p>
<p>限制10MB，排队等待超过100ms就触发丢包，只限制了出去的流量，没有限制进来的流量:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">tc qdisc ls dev eth0 // 查看eth0上的队列规则  </div><div class="line">sudo tc qdisc add dev eth0 root tbf rate 80mbit burst 1mbit latency 100ms </div><div class="line"></div><div class="line">//限制80MB</div><div class="line">sudo tc qdisc add dev eth0 root tbf rate 80mbps burst 1mbps latency 100ms</div></pre></td></tr></table></figure>
<h2 id="两地三中心模拟"><a href="#两地三中心模拟" class="headerlink" title="两地三中心模拟"></a>两地三中心模拟</h2><p>针对不同的ip地址可以限制不同的带宽和网络延时，htb较prio多了一个带宽控制</p>
<p>通过htb 只限制带宽和延时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">//对10.0.3.228、229延时1ms，对 10.0.3.232延时30ms 两地三中心限制延时和带宽</div><div class="line">tc qdisc add dev eth0 root handle 1: htb</div><div class="line"></div><div class="line">tc class add dev eth0 parent 1: classid 1:1 htb rate 600Gbps</div><div class="line">tc filter add dev eth0 parent 1: protocol ip prio 1 u32 flowid 1:1 match ip dst 10.0.3.228</div><div class="line">tc qdisc add dev eth0 parent 1:1 handle 10: netem delay 1ms</div><div class="line"></div><div class="line">tc class add dev eth0 parent 1: classid 1:2 htb rate 600Gbps</div><div class="line">tc filter add dev eth0 parent 1: protocol ip prio 1 u32 flowid 1:2 match ip dst 10.0.3.229</div><div class="line">tc qdisc add dev eth0 parent 1:2 handle 20: netem delay 1ms</div><div class="line"></div><div class="line">tc class add dev eth0 parent 1: classid 1:3 htb rate 600Gbps</div><div class="line">tc filter add dev eth0 parent 1: protocol ip prio 1 u32 flowid 1:3 match ip dst 10.0.3.232</div><div class="line">tc qdisc add dev eth0 parent 1:3 handle 30: netem delay 30ms</div></pre></td></tr></table></figure>
<p><img src="/images/951413iMgBlog/image-20230607152951762.png" alt="image-20230607152951762"></p>
<p>通过prio 只限制延时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">//两地三中心限制不同的延时，htb才可以加带宽限制</div><div class="line">tc qdisc add dev eth0 root handle 1: prio</div><div class="line"></div><div class="line">//10.0.3.228/10.0.3.229 延时1ms</div><div class="line">tc filter add dev eth0 parent 1: protocol ip prio 1 u32 flowid 1:1 match ip dst 10.0.3.228/31</div><div class="line">tc qdisc add dev eth0 parent 1:1 handle 10: netem delay 1ms</div><div class="line"></div><div class="line">tc filter add dev eth0 parent 1: protocol ip prio 1 u32 flowid 1:2 match ip dst 10.0.3.232</div><div class="line">tc qdisc add dev eth0 parent 1:2 handle 20: netem delay 30ms</div></pre></td></tr></table></figure>
<h2 id="qdisc的类别"><a href="#qdisc的类别" class="headerlink" title="qdisc的类别"></a><a href="https://cloud.tencent.com/developer/article/1409664" target="_blank" rel="external">qdisc的类别</a></h2><p>QDisc(排队规则)是queueing discipline的简写，它是理解流量控制(traffic control)的基础。无论何时，内核如果需要通过某个网络接口发送数据包，它都需要按照为这个接口配置的qdisc(排队规则)把数据包加入队列。然后，内核会尽可能多地从qdisc里面取出数据包，把它们交给网络适配器驱动模块。最简单的QDisc是pfifo它不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列。不过，它会保存网络接口一时无法处理的数据包。</p>
<p>一个网络接口上如果没有设置QDisc，pfifo_fast就作为缺省的QDisc。</p>
<p>CLASSFUL QDISC(分类QDisc)，可分类的qdisc包括： </p>
<ul>
<li>CBQ： CBQ是Class Based Queueing(基于类别排队)的缩写。它实现了一个丰富的连接共享类别结构，既有限制(shaping)带宽的能力，也具有带宽优先级管理的能力。带宽限制是通过计算连接的空闲时间完成的。空闲时间的计算标准是数据包离队事件的频率和下层连接(数据链路层)的带宽。</li>
<li>HTB： HTB是Hierarchy Token Bucket的缩写。通过在实践基础上的改进，它实现了一个丰富的连接共享类别体系。使用HTB可以很容易地保证每个类别的带宽，它也允许特定的类可以突破带宽上限，占用别的类的带宽。HTB可以通过TBF(Token Bucket Filter)实现带宽限制，也能够划分类别的优先级。</li>
<li>PRIO： PRIO QDisc 不能限制带宽，因为属于不同类别的数据包是顺序离队的。使用PRIO QDisc可以很容易对流量进行优先级管理，只有属于高优先级类别的数据包全部发送完毕，才会发送属于低优先级类别的数据包。为了方便管理，需要使用iptables或者ipchains处理数据包的服务类型(Type Of Service,ToS)。</li>
</ul>
<h3 id="htb分类-qdisc"><a href="#htb分类-qdisc" class="headerlink" title="htb分类 qdisc"></a>htb分类 qdisc</h3><p>tbf能对流量无差别控制，htb可以进一步进行更精细的控制</p>
<h4 id="针对IP、端口限速案例"><a href="#针对IP、端口限速案例" class="headerlink" title="针对IP、端口限速案例"></a>针对IP、端口限速案例</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span>cat qdisc_bw.sh</div><div class="line"><span class="meta">#</span>!/bin/bash</div><div class="line"><span class="meta">#</span>针对不同的ip进行限速</div><div class="line"><span class="meta"></span></div><div class="line">#清空原有规则</div><div class="line">tc qdisc del dev eth0 root</div><div class="line"><span class="meta"></span></div><div class="line">#创建根序列</div><div class="line">tc qdisc add dev eth0 root handle 1: htb default 1</div><div class="line"><span class="meta"></span></div><div class="line">#创建一个主分类绑定所有带宽资源（60M）</div><div class="line">tc class add dev eth0 parent 1:0 classid 1:1 htb rate 60Mbps burst 15k</div><div class="line"><span class="meta">#</span>到这里可以使用了，整机速度限制到了60M</div><div class="line"><span class="meta"></span></div><div class="line">#创建子分类，ceil表示最大带宽</div><div class="line">tc class add dev eth0 parent 1:1 classid 1:10 htb rate 2Mbps ceil 1Mbps burst 15k</div><div class="line">tc class add dev eth0 parent 1:1 classid 1:20 htb rate 20Mbps ceil 30Mbps burst 15k</div><div class="line"><span class="meta"></span></div><div class="line">#为了避免一个会话永占带宽,添加随即公平队列sfq.</div><div class="line"><span class="meta">#</span>perturb：是多少秒后重新配置一次散列算法，默认为10秒</div><div class="line"><span class="meta">#</span>sfq,他可以防止一个段内的一个ip占用整个带宽</div><div class="line">tc qdisc add dev eth0 parent 1:10 handle 10: sfq perturb 10</div><div class="line">tc qdisc add dev eth0 parent 1:20 handle 20: sfq perturb 10</div><div class="line"><span class="meta"></span></div><div class="line">#创建过滤器</div><div class="line"><span class="meta">#</span>对所有ip限速到1Mbps</div><div class="line">tc filter add dev eth0 protocol ip parent 1:0 prio 2 u32 match ip dst 0.0.0.0/0 flowid 1:10</div><div class="line"><span class="meta">#</span>对10.0.186.140限速在30Mbps</div><div class="line">tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip dst 10.0.186.140 flowid 1:20</div><div class="line"><span class="meta"></span></div><div class="line">#对端口进行filter限流</div><div class="line"><span class="meta">#</span>tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip sport 22 flowid 1:10</div><div class="line"><span class="meta"></span></div><div class="line">#查看以上规则</div><div class="line">sudo tc class show dev eth0</div><div class="line">sudo tc filter show dev eth0</div></pre></td></tr></table></figure>
<p>限流100MB后的实际监控效果</p>
<p><img src="/images/951413iMgBlog/image-20211031205539407.png" alt="image-20211031205539407"></p>
<h2 id="docker-中使用-tc"><a href="#docker-中使用-tc" class="headerlink" title="docker 中使用 tc"></a>docker 中使用 tc</h2><p>docker里无法使用的bug 可以参考 <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1152231，解决方法就是升级tc版本，tc" target="_blank" rel="external">https://bugzilla.redhat.com/show_bug.cgi?id=1152231，解决方法就是升级tc版本，tc</a> qdisc add 时加上direct_qlen参数</p>
<h3 id="场景："><a href="#场景：" class="headerlink" title="场景："></a>场景：</h3><p>故障注入的docker: 10.1.1.149</p>
<p>10.1.1.149上会模拟各种网络故障，但是中控机到该docker的连接需要不受影响</p>
<p>DEVICE_NAME=eth0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"># 根规则，direct_qlen 1000必须加，否则在docker的虚拟网络跑不了</div><div class="line">tc qdisc add dev $&#123;DEVICE_NAME&#125; root handle 1: htb  default 1024 direct_qlen 1000</div><div class="line"></div><div class="line"></div><div class="line"># 建立两个类继承root</div><div class="line">tc class add dev $&#123;DEVICE_NAME&#125; parent 1:0 classid 1:1 htb rate 10000mbit</div><div class="line">tc class add dev $&#123;DEVICE_NAME&#125; parent 1:0 classid 1:2 htb rate 10000mbit</div><div class="line"></div><div class="line"></div><div class="line">#新版本的tc在filter设置完后，所有网络都会断，类似黑名单，需要加qdisc才能恢复, 所以先让两个通道都能跑</div><div class="line"># 队列采用公平的调度算法，保证网络通畅，perturb参数是每隔10秒换一次hash，进一步保障平均</div><div class="line">tc qdisc add dev $&#123;DEVICE_NAME&#125; parent 1:1 sfq perturb 10</div><div class="line">tc qdisc add dev $&#123;DEVICE_NAME&#125; parent 1:2 sfq perturb 10</div><div class="line"></div><div class="line"></div><div class="line"># 加过滤规则</div><div class="line">#1.队列1是和跳板机交互的网络，需要保持通畅</div><div class="line">tc filter add dev $&#123;DEVICE_NAME&#125; protocol ip parent 1: prio 10 u32 match ip dst 10.0.0.200/32 flowid 1:1</div><div class="line"></div><div class="line"></div><div class="line">#2.其他所有主机走队列2，实现网络模拟</div><div class="line">tc filter add dev $&#123;DEVICE_NAME&#125; protocol ip parent 1: prio 10 u32 match ip dst 0.0.0.0/0 flowid 1:2</div><div class="line"></div><div class="line">#队列2 开始网络模拟</div><div class="line">#该命令将$&#123;DEVICE_NAME&#125;网卡的耗时随机delay 100ms，延迟的尖刺在标准值的正负30ms, 最后的百分比数字是尖刺的相关系数</div><div class="line"></div><div class="line"># 这边用replace是因为之前已经用add加过规则了</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 netem delay 100ms 30ms 25%</div><div class="line"></div><div class="line"></div><div class="line">#该命令将 $&#123;DEVICE_NAME&#125; 网卡的传输设置为随机丢掉10%的数据包, 成功率为50%</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 netem loss 10% 50%</div><div class="line"></div><div class="line"></div><div class="line">#该命令将 $&#123;DEVICE_NAME&#125; 网卡的传输设置为随机产生10%的重复数据包。</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 netem duplicate 10%</div><div class="line"></div><div class="line"></div><div class="line">#该命令将 $&#123;DEVICE_NAME&#125; 网卡的传输设置为:有25%的数据包会被立即发送,其他的延迟10ms,相关性是10%,产生乱序</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 netem delay 10ms reorder 25% 10% </div><div class="line"></div><div class="line"></div><div class="line">#该命令将 $&#123;DEVICE_NAME&#125; 网卡的传输设置为随机产生9%的损坏的数据包</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 netem corrupt 9%</div></pre></td></tr></table></figure>
<p>恢复网络</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#让网络恢复正常</div><div class="line">tc qdisc replace dev $&#123;DEVICE_NAME&#125; parent 1:2 sfq perturb 10</div><div class="line"></div><div class="line"># =================== 查看规则 ======================</div><div class="line">tc filter show dev $&#123;DEVICE_NAME&#125;</div><div class="line">tc class show dev $&#123;DEVICE_NAME&#125;</div><div class="line">tc qdisc show dev $&#123;DEVICE_NAME&#125;</div><div class="line"></div><div class="line">#====================== 清理 ======================</div><div class="line">tc filter delete dev $&#123;DEVICE_NAME&#125; parent 1:0 protocol ip pref 10</div><div class="line">tc qdisc del dev $&#123;DEVICE_NAME&#125; parent 1:2 netem</div><div class="line">tc class del dev $&#123;DEVICE_NAME&#125; parent 1:0 classid 1:2</div><div class="line">tc class del dev $&#123;DEVICE_NAME&#125; parent 1:0 classid 1:1</div><div class="line">tc qdisc del dev $&#123;DEVICE_NAME&#125; root handle 1</div></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/" target="_blank" rel="external">https://netbeez.net/blog/how-to-use-the-linux-traffic-control/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2016/03/24/ansible 使用手册/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/24/ansible 使用手册/" itemprop="url">ansible 手册</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-24T17:30:03+08:00">
                2016-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ansible/" itemprop="url" rel="index">
                    <span itemprop="name">Ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ansible-手册"><a href="#ansible-手册" class="headerlink" title="ansible 手册"></a>ansible 手册</h1><h2 id="获取模块信息"><a href="#获取模块信息" class="headerlink" title="获取模块信息"></a>获取模块信息</h2><p>-<br>获取所有模块信息，100多个</p>
<ul>
<li>ansible-doc -l</li>
</ul>
<p>获取每个模块的具体信息 </p>
<ul>
<li><p>ansible-doc<br>example：ansible-doc ping</p>
<p>   PING</p>
<p>   A trivial test module, this module always returns <code>pong&#39; on
   successful contact. It does not make sense in playbooks, but it is
   useful from</code>/usr/bin/udp’</p>
<p> EXAMPLES:<br> Test ‘webservers’ status</p>
<p> udp webservers -m ping</p>
</li>
</ul>
<h2 id="嵌套执行命令roles"><a href="#嵌套执行命令roles" class="headerlink" title="嵌套执行命令roles"></a>嵌套执行命令roles</h2><pre><code>- name: create jdk home
  file: path={{ remote_jdk_home }} state=directory mode=0755

- name: xxxxxxxxx
  include: ../../init/tasks/main.yml
</code></pre><h2 id="defaults-中变量定义"><a href="#defaults-中变量定义" class="headerlink" title="defaults 中变量定义"></a>defaults 中变量定义</h2><pre><code>1：加双引号；2：变量名和变量之间，有空格；
diamond_db_key: &quot;{{ diamond_db_ip }}_{{ diamond_db_name }}_dbkey&quot;
manager_user1: &quot;{{ manager_user_name }}&quot;
</code></pre><h1 id="tags"><a href="#tags" class="headerlink" title="tags"></a>tags</h1><p>相同的tasks在不同的环境下面执行，通过tag来进行表面，如下图：</p>
<pre><code>  useage: 
    udp-playbook setup.yml -v -kK -i hosts.ini --tags &quot;ta&quot;

- name: 1
  authorized_key: user={{ ansible_ssh_user }}  key=&quot;{{ lookup('file', '~/.ssh/id_rsa.pub') }}&quot;  state=present
  tags: ta

- name: 2
  group: name={{ remote_user }}
  tags: always

- name: 3
  file: path={{ remote_home }} owner={{ remote_user }} group={{ remote_user }} state=directory recurse=yes mode=0755
  tags: tb
</code></pre><h2 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h2><p>ansible 中 scp scp: ambiguous target 错误还是因为ssh 增加了 -t 参数, scp不支持 -t 参数</p>
<h2 id="disable-python-warning"><a href="#disable-python-warning" class="headerlink" title="disable python warning"></a><a href="https://docs.ansible.com/ansible/latest/reference_appendices/interpreter_discovery.html" target="_blank" rel="external">disable python warning</a></h2><p>To control the discovery behavior:</p>
<ul>
<li>for individual hosts and groups, use the <code>ansible_python_interpreter</code> inventory variable</li>
<li>globally, use the <code>interpreter_python</code> key in the <code>[defaults]</code> section of <code>ansible.cfg</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[defaults]</div><div class="line">interpreter_python=auto_silent</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2016/03/24/ansible 常见问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/24/ansible 常见问题/" itemprop="url">ansible 常见问题</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-24T17:30:03+08:00">
                2016-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ansible/" itemprop="url" rel="index">
                    <span itemprop="name">Ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ansible-常见问题"><a href="#ansible-常见问题" class="headerlink" title="ansible 常见问题"></a>ansible 常见问题</h1><h2 id="获取模块信息"><a href="#获取模块信息" class="headerlink" title="获取模块信息"></a>获取模块信息</h2><p>-<br>获取所有模块信息，100多个</p>
<ul>
<li>ansible-doc -l</li>
</ul>
<p>获取每个模块的具体信息 </p>
<ul>
<li><p>ansible-doc<br>example：ansible-doc ping</p>
<p>   PING</p>
<p>   A trivial test module, this module always returns <code>pong&#39; on
   successful contact. It does not make sense in playbooks, but it is
   useful from</code>/usr/bin/udp’</p>
<p> EXAMPLES:<br> Test ‘webservers’ status</p>
<p> udp webservers -m ping</p>
</li>
</ul>
<h2 id="嵌套执行命令roles"><a href="#嵌套执行命令roles" class="headerlink" title="嵌套执行命令roles"></a>嵌套执行命令roles</h2><pre><code>- name: create jdk home
  file: path={{ remote_jdk_home }} state=directory mode=0755

- name: xxxxxxxxx
  include: ../../init/tasks/main.yml
</code></pre><h2 id="defaults-中变量定义"><a href="#defaults-中变量定义" class="headerlink" title="defaults 中变量定义"></a>defaults 中变量定义</h2><pre><code>1：加双引号；2：变量名和变量之间，有空格；
diamond_db_key: &quot;{{ diamond_db_ip }}_{{ diamond_db_name }}_dbkey&quot;
manager_user1: &quot;{{ manager_user_name }}&quot;
</code></pre><h1 id="tags"><a href="#tags" class="headerlink" title="tags"></a>tags</h1><p>相同的tasks在不同的环境下面执行，通过tag来进行表面，如下图：</p>
<pre><code>  useage: 
    udp-playbook setup.yml -v -kK -i hosts.ini --tags &quot;ta&quot;

- name: 1
  authorized_key: user={{ ansible_ssh_user }}  key=&quot;{{ lookup('file', '~/.ssh/id_rsa.pub') }}&quot;  state=present
  tags: ta

- name: 2
  group: name={{ remote_user }}
  tags: always

- name: 3
  file: path={{ remote_home }} owner={{ remote_user }} group={{ remote_user }} state=directory recurse=yes mode=0755
  tags: tb
</code></pre><h2 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h2><p>ansible 中 scp scp: ambiguous target 错误还是因为ssh 增加了 -t 参数, scp不支持 -t 参数</p>
<h2 id="disable-python-warning"><a href="#disable-python-warning" class="headerlink" title="disable python warning"></a><a href="https://docs.ansible.com/ansible/latest/reference_appendices/interpreter_discovery.html" target="_blank" rel="external">disable python warning</a></h2><p>To control the discovery behavior:</p>
<ul>
<li>for individual hosts and groups, use the <code>ansible_python_interpreter</code> inventory variable</li>
<li>globally, use the <code>interpreter_python</code> key in the <code>[defaults]</code> section of <code>ansible.cfg</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[defaults]</div><div class="line">interpreter_python=auto_silent</div></pre></td></tr></table></figure>
<h3 id="其它常见错误"><a href="#其它常见错误" class="headerlink" title="其它常见错误"></a>其它常见错误</h3><table>
<thead>
<tr>
<th>问题</th>
<th>解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td>性能</td>
<td>ansible现在并发执行的任务好像还不够，执行批量传大文件的任务等的比较久 — 用 synchronize  并将 fork 默认的5改大</td>
</tr>
<tr>
<td>sudoers</td>
<td>尝试解决ansible不能执行的问题，搜索各种英文文档，有人说版本的原因，有人反馈是脚本错误，最终无解。 继续在本地进行测试，发现使用原始的ansible命令可以执行ls，但是sudo ls时会提示 sudo need tty 之类的报错。 定位这个错误是因为在/etc/sudoers文件中设置了  Defaults requiretty，修改为 #Defaults requiretty，重试发现问题解决。 手工修改所有机器的配置文件，问题解决。{“msg”: “ssh connection closed waiting for a privilege escalation password prompt”}—实际在部分机器上执行ansible命令时仍然有：sudo: no tty present and no askpass program specified  可以给ssh 增加-t/-tt参数来强制分配一个tty</td>
</tr>
<tr>
<td>failed to transfer file to  xxx</td>
<td>远端机器磁盘已经满,查看df -h，特别是/tmp</td>
</tr>
<tr>
<td>requires a json module, none found</td>
<td>问题已经通过nginx进行解决部署,安装ansible的时候，在目标机器上面安装 python-simplejson 通过如下命令：yum install python-simplejson -y</td>
</tr>
<tr>
<td>openssh升级后无法登录报错</td>
<td>sshrpm 升级后会修改/etc/pam.d/sshd 文件。需要升级前备份此文件最后还原即可登录。</td>
</tr>
<tr>
<td>安装EagleEye出现的问题</td>
<td>1.hadoop name -format 这个需要输入Y/N；2.ssh-key没搞定；3.我们原来可以for循环的地方，古谦脚本只能1条1条的加</td>
</tr>
<tr>
<td>使用lineinfile方法时，内容不能包含”: “(冒号+空格)，这个与ansible底层的分隔符冲突；</td>
<td>让用户在内容中不要包含”: “</td>
</tr>
<tr>
<td>https 相关</td>
<td>SSL validation is not available in your version of python. You can use validate_certs=no, however this is unsafe and not recommended. You can also install python-ssl from EPEL</td>
</tr>
<tr>
<td>You need a C++ compiler for C++ support</td>
<td>yum install -y gcc gcc-c++</td>
</tr>
<tr>
<td>１：udp权限问题，有时候会出现权限认证失败；２：udp如何执行本地命令；　３：udp线上有什么方便的安装方法</td>
<td>问题1:方法一 去掉sudo试试（报访问文件 /opt/aliUDP/logs/udp.log 失败，备份重新建一个udp.log 文件给于 777 权限）; 方法二 指定 –private-key=PRIVATE_KEY_FILE （先试试直接ssh登录某台目标机器行不行）  问题2：udp支持直接运行目标机器上的命令，用法：udp server  -i ~/ali/udp-roles/roles/udp-install/udp-hosts.ini  -m shell -a “ uptime ; df -lh “ -u admin</td>
</tr>
<tr>
<td>同一个ip部署不同的工程时，定义的变量会冲突；例如ip1同时部署mysql和diamond，都定义project_name；这样上面的会生效，下面定义的会被冲掉</td>
<td>Wiki：<a href="http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Different_Hosts_With_Different_Variables" target="_blank" rel="external">http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Different_Hosts_With_Different_Variables</a>  将变量分别定义在 ./roles/mysql/defaults/main.yml 和 ./roles/diamond/defaults/main.yml中 或者使用不同的变量名</td>
</tr>
<tr>
<td>执行udp-play-book 时会报找不到key的问题</td>
<td>在udp机器上执行 ssh-keygen 来生成key，解决</td>
</tr>
<tr>
<td>ssh 的时候需要手工 yes/no</td>
<td>增加参数 -o StrictHostKeyChecking no 就不需要输入了</td>
</tr>
<tr>
<td>防火墙问题，本地可以访问，远程不能</td>
<td>通过抓包/telnet等方式来确认这个问题， 通过iptables stop 来临时关闭防火墙； 修改iptables 的配置永久关闭或者增加所有其它节点到白名单中</td>
</tr>
<tr>
<td></td>
<td>重要！ hostname -i 一定要是本机在局域网内的真实ip地址（不是127.0.0.1 ）。  要绑定etc/hosts 下面 把自己的hostname绑定到对应的真实ip上。</td>
</tr>
<tr>
<td>在UDP PlayBook中如何定义不同的机器、不同的Role使用不同的变量</td>
<td><a href="http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Different_Hosts_With_Different_Variables" target="_blank" rel="external">http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Different_Hosts_With_Different_Variables</a></td>
</tr>
<tr>
<td>Dauth部署问题总结</td>
<td><a href="http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Dauth-UDP-deployment-issues" target="_blank" rel="external">http://gitlab.alibaba-inc.com/middleware-udp/udp-doc/wikis/Dauth-UDP-deployment-issues</a></td>
</tr>
<tr>
<td>Device or resource busy</td>
<td>一般出现在Docker中修改/etc/hosts会有这个问题，ansible会rm它，实际它是-v进去的，通过脚本补丁绕过去</td>
</tr>
</tbody>
</table>
<p>ansible 中 scp scp: ambiguous target 错误还是因为ssh 增加了 -t 参数, scp不支持 -t 参数</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2016/03/24/ansible 命令通道使用手册/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/24/ansible 命令通道使用手册/" itemprop="url">ansible 命令使用手册</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-24T17:30:03+08:00">
                2016-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ansible/" itemprop="url" rel="index">
                    <span itemprop="name">Ansible</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ansible-命令使用手册"><a href="#ansible-命令使用手册" class="headerlink" title="ansible 命令使用手册"></a>ansible 命令使用手册</h1><h2 id="什么是命令通道？"><a href="#什么是命令通道？" class="headerlink" title="什么是命令通道？"></a>什么是命令通道？</h2><p>有时候一些简单任务，没必要写复杂的playbook，所以大多时候我们可以通过ansible命令行来批量操控目标机器</p>
<blockquote>
<p>当我们需要批量操作、查看一组机器，或者在这些机器上批量执行某个命令、修改某个文件，都可以通过命令通道在一台机器上批量并发完成对所有机器的操作</p>
<p>命令通道只是一个帮你将命令发送到多个目标机器，并将执行结果返回来给你的一个执行通道</p>
</blockquote>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li>执行一行命令就能看到几十台机器的负载情况</li>
<li>批量执行远程服务器上已经写好的Shell脚本</li>
<li>查看所有Web服务器最近10000行Log中有没有ERROR</li>
<li>查看所有DB服务器的内存使用情况</li>
<li>批量将所有Diamond服务器的某个端口从7000改成9000</li>
</ul>
<h2 id="开始准备"><a href="#开始准备" class="headerlink" title="开始准备"></a>开始准备</h2><blockquote>
<p>如果不想每次输入ssh密码的话请提前将本地公钥(~/.ssh/id_rsa.pub 没有的话 ssh-keygen生成一对)复制到目标机器的 ~/.ssh/authorized_keys 里面，否则每次执行命令都要输入密码</p>
</blockquote>
<h3 id="编写一个-hosts-ini-配置文件，内容如下"><a href="#编写一个-hosts-ini-配置文件，内容如下" class="headerlink" title="编写一个 hosts.ini 配置文件，内容如下:"></a>编写一个 hosts.ini 配置文件，内容如下:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[server]</div><div class="line">10.125.0.169 ansible_ssh_port=9999 #如果只有这台机器ssh走的是9999端口，其它没有设置的还是默认22端口</div><div class="line">10.125.3.33</div><div class="line">120.26.116.193  </div><div class="line"></div><div class="line">[worker]</div><div class="line">10.125.12.174</div><div class="line">10.125.14.238</div><div class="line"></div><div class="line">[target]</div><div class="line">10.125.192.40 </div><div class="line">10.125.7.151</div><div class="line">192.168.2.[101:107]</div></pre></td></tr></table></figure>
<p>server/worker/target表示将7台机器分成了三组，可以到所有7台机器执行同一个命令，也可以只在server/worker/target中的一组机器上执行某个命令.all代表所有7台机器</p>
<h2 id="运行命令行"><a href="#运行命令行" class="headerlink" title="运行命令行"></a>运行命令行</h2><h3 id="查看-hosts-ini-里面所有服务器的-uptime"><a href="#查看-hosts-ini-里面所有服务器的-uptime" class="headerlink" title="查看 hosts.ini 里面所有服务器的 uptime"></a>查看 hosts.ini 里面所有服务器的 uptime</h3><pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">	$ ansible -i hosts.ini all -m raw -a &quot; uptime  &quot; -u admin</div><div class="line">	/usr/bin/ansible -i hosts.ini all -m raw -a  uptime   -u admin</div><div class="line">	</div><div class="line">	success =&gt; 10.125.12.174 =&gt; rc=0 =&gt;</div><div class="line">	 11:10:50 up 27 days, 15:40,  1 user,  load average: 0.05, 0.03, 0.05</div><div class="line">	success =&gt; 120.26.116.193 =&gt; rc=0 =&gt;</div><div class="line">	 11:10:50 up 13 days, 21:07,  1 user,  load average: 0.00, 0.00, 0.00</div><div class="line"></div><div class="line">命令参数说明</div><div class="line"></div><div class="line">&gt;    __all:__  表示对hosts.ini里面的所有服务器执行后面的命令 </div><div class="line"></div><div class="line">&gt;    __-i:__   指定hosts.ini文件所在的位置</div><div class="line"></div><div class="line">&gt;    __-m raw -a:__ 指定需要执行的命令</div><div class="line"></div><div class="line">&gt;    __&quot; uptime &quot;__ 双引号里面写上需要执行的命令</div><div class="line"></div><div class="line">&gt;    __-u admin__ 表示通过用户名admin 去执行命令【如果没有做好免密码，请加上 -k 参数，会出来提示输入SSH密码】</div><div class="line"></div><div class="line"></div><div class="line">### 查看 hosts.ini 里面 server 组服务器的 home目录下的文件结构</div><div class="line">	$ ansible -i hosts.ini server -m raw -a &quot; ls -lh ~/  &quot; -u admin</div><div class="line">	</div><div class="line">	/usr/bin/ansible -i hosts.ini server -m raw -a  ls -lh ~/   -u admin</div><div class="line">	</div><div class="line">	success =&gt; 10.125.0.169 =&gt; rc=0 =&gt;</div><div class="line">	total 12K</div><div class="line">	drwxr-xr-x  2 root  root  4.0K Nov 13 12:34 files</div><div class="line">	drwxr-xr-x 11 admin admin 4.0K Oct 20 10:49 tomcat</div><div class="line">	drwxr-xr-x  3 test  games 4.0K Nov 18 15:40 ansible-engine</div><div class="line">	success =&gt; 10.125.3.33 =&gt; rc=0 =&gt;</div><div class="line">	total 20K</div><div class="line">	-rw-------  1 admin admin 1.4K Nov 12 13:39 authorized_keys</div><div class="line">	drwxr-xr-x  2 root  root  4.0K Nov 12 16:24 engine</div><div class="line">	drwxr-xr-x  2 root  root  4.0K Nov 13 12:22 files</div><div class="line">	drwxr-xr-x 11 admin admin 4.0K Nov 18 15:43 tomcat</div><div class="line">	drwxr-xr-x  3 test  games 4.0K Nov 18 15:40 ansible-engine</div><div class="line"></div><div class="line">### 查看部分机器 hostname</div></pre></td></tr></table></figure>
</code></pre><h1 id="ansible-i-ccb-test-ini-192-168-2-10-m-shell-a-‘hostname-‘"><a href="#ansible-i-ccb-test-ini-192-168-2-10-m-shell-a-‘hostname-‘" class="headerlink" title="ansible -i ccb_test.ini 192.168.2.10* -m shell -a ‘hostname ‘"></a>ansible -i ccb_test.ini 192.168.2.10* -m shell -a ‘hostname ‘</h1><p>[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details<br>192.168.2.100 | CHANGED | rc=0 &gt;&gt;<br>az2-drds-100<br>192.168.2.106 | CHANGED | rc=0 &gt;&gt;<br>az2-manager-106<br>192.168.2.101 | CHANGED | rc=0 &gt;&gt;<br>az2-alisql-101<br>192.168.2.102 | CHANGED | rc=0 &gt;&gt;<br>az2-alisql-102<br>192.168.2.105 | CHANGED | rc=0 &gt;&gt;<br>az2-alisql-105<br>192.168.2.104 | CHANGED | rc=0 &gt;&gt;<br>az2-alisql-104<br>192.168.2.103 | CHANGED | rc=0 &gt;&gt;<br>az2-alisql-103<br>192.168.2.107 | CHANGED | rc=0 &gt;&gt;<br>az2-manager-107<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### 使用环境变量</div></pre></td></tr></table></figure></p>
<p>#config /etc/hosts<br>ansible -i $1 all -m shell -a  “ sed -i ‘/registry/d’ /etc/hosts “<br>ansible -i $1 all -m shell -a  “ echo ‘    registry’ &gt;/etc/hosts “<br>ansible -i $1 all -m shell -a “ echo ‘ <code>hostname</code>‘ &gt;&gt;/etc/hosts “<br>ansible -i $1 diamond -m shell -a “ echo ‘   jmenv.tbsite.net’ &gt;&gt; /etc/hosts “ -u root<br>//修改机器hostname<br>ansible -i $1 all -m shell -a “ hostnamectl set-hostname=’drds-‘ “ -u root<br>//修改机器hostname -i<br>ansible -i $1 all -m shell -a “ echo ‘  drds-‘ &gt;&gt; /etc/hosts  “ -u root</p>
<p>//hostname 修改机器名</p>
<h1 id="ansible-i-ccb-test-ini-192-168-2-101-m-hostname-a-“-name-az2-alisql-101-“"><a href="#ansible-i-ccb-test-ini-192-168-2-101-m-hostname-a-“-name-az2-alisql-101-“" class="headerlink" title="ansible -i ccb_test.ini 192.168.2.101 -m hostname -a “ name=az2-alisql-101 “"></a>ansible -i ccb_test.ini 192.168.2.101 -m hostname -a “ name=az2-alisql-101 “</h1><p>[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details<br>192.168.2.101 | CHANGED =&gt; {<br>    “ansible_facts”: {<br>        “ansible_domain”: “”,<br>        “ansible_fqdn”: “iZ2ze9aj0re2ggbqa4dgxkZ”,<br>        “ansible_hostname”: “az2-alisql-101”,<br>        “ansible_nodename”: “az2-alisql-101”,<br>        “discovered_interpreter_python”: “/usr/bin/python”<br>    },<br>    “changed”: true,<br>    “name”: “az2-alisql-101”<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### 管理系统service</div><div class="line"></div><div class="line">设置 docker daemon服务重新启动和开机自动启动</div></pre></td></tr></table></figure></p>
<h1 id="ansible-i-ccb-test-ini-192-168-2-101-m-service-a-“-name-docker-enabled-yes-state-restarted-“"><a href="#ansible-i-ccb-test-ini-192-168-2-101-m-service-a-“-name-docker-enabled-yes-state-restarted-“" class="headerlink" title="ansible -i ccb_test.ini 192.168.2.101 -m service -a “ name=docker enabled=yes state=restarted “"></a>ansible -i ccb_test.ini 192.168.2.101 -m service -a “ name=docker enabled=yes state=restarted “</h1><p>[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details<br>192.168.2.101 | CHANGED =&gt; {<br>    “ansible_facts”: {<br>        “discovered_interpreter_python”: “/usr/bin/python”<br>    },<br>    “changed”: true,<br>    “enabled”: true,<br>    “name”: “docker”,<br>    “state”: “started”,<br>    “status”: {<br>        “ActiveEnterTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “ActiveEnterTimestampMonotonic”: “1553024093129”,<br>        “ActiveExitTimestamp”: “二 2020-05-12 19:01:24 CST”,<br>        “ActiveExitTimestampMonotonic”: “1552870910912”,<br>        “ActiveState”: “active”,<br>        “After”: “systemd-journald.socket system.slice docker.socket firewalld.service containerd.service network-online.target basic.target”,<br>        “AllowIsolate”: “no”,<br>        “AmbientCapabilities”: “0”,<br>        “AssertResult”: “yes”,<br>        “AssertTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “AssertTimestampMonotonic”: “1553023902297”,<br>        “Before”: “multi-user.target shutdown.target”,<br>        “BindsTo”: “containerd.service”,<br>        “BlockIOAccounting”: “no”,<br>        “BlockIOWeight”: “18446744073709551615”,<br>        “CPUAccounting”: “no”,<br>        “CPUQuotaPerSecUSec”: “infinity”,<br>        “CPUSchedulingPolicy”: “0”,<br>        “CPUSchedulingPriority”: “0”,<br>        “CPUSchedulingResetOnFork”: “no”,<br>        “CPUShares”: “18446744073709551615”,<br>        “CanIsolate”: “no”,<br>        “CanReload”: “yes”,<br>        “CanStart”: “yes”,<br>        “CanStop”: “yes”,<br>        “CapabilityBoundingSet”: “18446744073709551615”,<br>        “ConditionResult”: “yes”,<br>        “ConditionTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “ConditionTimestampMonotonic”: “1553023902297”,<br>        “Conflicts”: “shutdown.target”,<br>        “ConsistsOf”: “docker.socket”,<br>        “ControlGroup”: “/system.slice/docker.service”,<br>        “ControlPID”: “0”,<br>        “DefaultDependencies”: “yes”,<br>        “Delegate”: “yes”,<br>        “Description”: “Docker Application Container Engine”,<br>        “DevicePolicy”: “auto”,<br>        “Documentation”: “<a href="https://docs.docker.com" target="_blank" rel="external">https://docs.docker.com</a>“,<br>        “ExecMainCode”: “0”,<br>        “ExecMainExitTimestampMonotonic”: “0”,<br>        “ExecMainPID”: “16213”,<br>        “ExecMainStartTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “ExecMainStartTimestampMonotonic”: “1553023907468”,<br>        “ExecMainStatus”: “0”,<br>        “ExecReload”: “{ path=/bin/kill ; argv[]=/bin/kill -s HUP $MAINPID ; ignore_errors=no ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }”,<br>        “ExecStart”: “{ path=/usr/bin/dockerd ; argv[]=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2376 –data-root=/var/lib/docker –log-opt max-size=50m –log-opt max-file=3 –registry-mirror=<a href="https://oqpc6eum.mirror.aliyuncs.com" target="_blank" rel="external">https://oqpc6eum.mirror.aliyuncs.com</a> –containerd=/run/containerd/containerd.sock ; ignore_errors=no ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }”,<br>        “FailureAction”: “none”,<br>        “FileDescriptorStoreMax”: “0”,<br>        “FragmentPath”: “/usr/lib/systemd/system/docker.service”,<br>        “GuessMainPID”: “yes”,<br>        “IOScheduling”: “0”,<br>        “Id”: “docker.service”,<br>        “IgnoreOnIsolate”: “no”,<br>        “IgnoreOnSnapshot”: “no”,<br>        “IgnoreSIGPIPE”: “yes”,<br>        “InactiveEnterTimestamp”: “二 2020-05-12 19:03:43 CST”,<br>        “InactiveEnterTimestampMonotonic”: “1553009791884”,<br>        “InactiveExitTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “InactiveExitTimestampMonotonic”: “1553023907496”,<br>        “JobTimeoutAction”: “none”,<br>        “JobTimeoutUSec”: “0”,<br>        “KillMode”: “process”,<br>        “KillSignal”: “15”,<br>        “LimitAS”: “18446744073709551615”,<br>        “LimitCORE”: “18446744073709551615”,<br>        “LimitCPU”: “18446744073709551615”,<br>        “LimitDATA”: “18446744073709551615”,<br>        “LimitFSIZE”: “18446744073709551615”,<br>        “LimitLOCKS”: “18446744073709551615”,<br>        “LimitMEMLOCK”: “65536”,<br>        “LimitMSGQUEUE”: “819200”,<br>        “LimitNICE”: “0”,<br>        “LimitNOFILE”: “18446744073709551615”,<br>        “LimitNPROC”: “18446744073709551615”,<br>        “LimitRSS”: “18446744073709551615”,<br>        “LimitRTPRIO”: “0”,<br>        “LimitRTTIME”: “18446744073709551615”,<br>        “LimitSIGPENDING”: “379870”,<br>        “LimitSTACK”: “18446744073709551615”,<br>        “LoadState”: “loaded”,<br>        “MainPID”: “16213”,<br>        “MemoryAccounting”: “no”,<br>        “MemoryCurrent”: “58327040”,<br>        “MemoryLimit”: “18446744073709551615”,<br>        “MountFlags”: “0”,<br>        “Names”: “docker.service”,<br>        “NeedDaemonReload”: “no”,<br>        “Nice”: “0”,<br>        “NoNewPrivileges”: “no”,<br>        “NonBlocking”: “no”,<br>        “NotifyAccess”: “main”,<br>        “OOMScoreAdjust”: “0”,<br>        “OnFailureJobMode”: “replace”,<br>        “PermissionsStartOnly”: “no”,<br>        “PrivateDevices”: “no”,<br>        “PrivateNetwork”: “no”,<br>        “PrivateTmp”: “no”,<br>        “ProtectHome”: “no”,<br>        “ProtectSystem”: “no”,<br>        “RefuseManualStart”: “no”,<br>        “RefuseManualStop”: “no”,<br>        “RemainAfterExit”: “no”,<br>        “Requires”: “docker.socket basic.target”,<br>        “Restart”: “always”,<br>        “RestartUSec”: “2s”,<br>        “Result”: “success”,<br>        “RootDirectoryStartOnly”: “no”,<br>        “RuntimeDirectoryMode”: “0755”,<br>        “SameProcessGroup”: “no”,<br>        “SecureBits”: “0”,<br>        “SendSIGHUP”: “no”,<br>        “SendSIGKILL”: “yes”,<br>        “Slice”: “system.slice”,<br>        “StandardError”: “inherit”,<br>        “StandardInput”: “null”,<br>        “StandardOutput”: “journal”,<br>        “StartLimitAction”: “none”,<br>        “StartLimitBurst”: “3”,<br>        “StartLimitInterval”: “60000000”,<br>        “StartupBlockIOWeight”: “18446744073709551615”,<br>        “StartupCPUShares”: “18446744073709551615”,<br>        “StatusErrno”: “0”,<br>        “StopWhenUnneeded”: “no”,<br>        “SubState”: “running”,<br>        “SyslogLevelPrefix”: “yes”,<br>        “SyslogPriority”: “30”,<br>        “SystemCallErrorNumber”: “0”,<br>        “TTYReset”: “no”,<br>        “TTYVHangup”: “no”,<br>        “TTYVTDisallocate”: “no”,<br>        “TasksAccounting”: “no”,<br>        “TasksCurrent”: “58”,<br>        “TasksMax”: “18446744073709551615”,<br>        “TimeoutStartUSec”: “0”,<br>        “TimeoutStopUSec”: “0”,<br>        “TimerSlackNSec”: “50000”,<br>        “Transient”: “no”,<br>        “TriggeredBy”: “docker.socket”,<br>        “Type”: “notify”,<br>        “UMask”: “0022”,<br>        “UnitFilePreset”: “disabled”,<br>        “UnitFileState”: “enabled”,<br>        “WantedBy”: “multi-user.target”,<br>        “Wants”: “network-online.target system.slice”,<br>        “WatchdogTimestamp”: “二 2020-05-12 19:03:57 CST”,<br>        “WatchdogTimestampMonotonic”: “1553024093096”,<br>        “WatchdogUSec”: “0”<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">### 一次执行多个命令</div></pre></td></tr></table></figure>
<p>$ ansible -i hosts.ini server -m raw -a “ which nc ; find /opt/aliUDP/logs/  “ -u admin</p>
<p>/usr/bin/ansible -i hosts.ini server -m raw -a  which nc ; find /opt/aliUDP/logs/   -u admin</p>
<p>FAILED =&gt; 120.26.116.193 =&gt; rc=1 =&gt;<br>which: no nc in (/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin)<br>find: /opt/aliUDP: No such file or directory</p>
<p>success =&gt; 10.125.3.33 =&gt; rc=0 =&gt;<br>/usr/bin/nc<br>/opt/aliUDP/logs/<br>/opt/aliUDP/logs/ansible.log.bak<br>/opt/aliUDP/logs/ansible.log</p>
<p>success =&gt; 10.125.0.169 =&gt; rc=0 =&gt;<br>/usr/bin/nc<br>/opt/aliUDP/logs/<br>/opt/aliUDP/logs/ansible.log.bak<br>/opt/aliUDP/logs/ansible.log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">结果说明</div><div class="line"></div><div class="line">&gt;   其中  120.26.116.193 上没有命令 nc 和 /opt/aliUDP 文件夹所有执行失败，但是其他两台机器都正常返回了结果</div><div class="line"></div><div class="line">### Copy本地的某个文件到服务器上【前面的例子中都是单独在远程机器上执行的命令】</div></pre></td></tr></table></figure>
<p>$ ansible  -i hosts.ini server  -m copy -a “ src=’~/.ssh/id_rsa.pub’ dest=’/tmp/‘ owner=admin “ -u admin</p>
<p>SUCCESS =&gt; 120.26.116.193 =&gt; {<br>    “changed”: true,<br>    “checksum”: “b12ccf236ab788bbaebd7159c563e97411389c9e”,<br>    “dest”: “/tmp/id_rsa.pub”,<br>    “gid”: 0,<br>    “group”: “root”,<br>    “md5sum”: “b6ba28284ab95aaa0f47602bdab49f46”,<br>    “mode”: “0644”,<br>    “owner”: “root”,<br>    “size”: 392,<br>    “src”: “/root/.ansible/ansible-tmp-1449109886.94-70134064194486/source”,<br>    “state”: “file”,<br>    “uid”: 0<br>}</p>
<p>SUCCESS =&gt; 10.125.0.169 =&gt; {<br>    “changed”: true,<br>    “checksum”: “b12ccf236ab788bbaebd7159c563e97411389c9e”,<br>    “dest”: “/tmp/id_rsa.pub”,<br>    “gid”: 500,<br>    “group”: “admin”,<br>    “md5sum”: “b6ba28284ab95aaa0f47602bdab49f46”,<br>    “mode”: “0664”,<br>    “owner”: “admin”,<br>    “size”: 392,<br>    “src”: “/home/admin/.ansible/ansible-tmp-1449109886.78-98797505042348/source”,<br>    “state”: “file”,<br>    “uid”: 500<br>}</p>
<p>SUCCESS =&gt; 10.125.3.33 =&gt; {<br>    “changed”: true,<br>    “checksum”: “b12ccf236ab788bbaebd7159c563e97411389c9e”,<br>    “dest”: “/tmp/id_rsa.pub”,<br>    “gid”: 500,<br>    “group”: “admin”,<br>    “md5sum”: “b6ba28284ab95aaa0f47602bdab49f46”,<br>    “mode”: “0664”,<br>    “owner”: “admin”,<br>    “size”: 392,<br>    “src”: “/home/admin/.ansible/ansible-tmp-1449109886.81-269249309502640/source”,<br>    “state”: “file”,<br>    “uid”: 500<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">参数说明</div><div class="line"></div><div class="line">&gt;    __-m copy -a:__ 指定这是 **copy** 的命令</div><div class="line">&gt;</div><div class="line">&gt;    __&quot;  src=&apos;~/.ssh/id_rsa.pub&apos; dest=&apos;/tmp/&apos; &quot;__ src表示本地文件 dest表示远程目标位置</div><div class="line"></div><div class="line">### 验证一下刚刚copy上去的文件的MD5值</div></pre></td></tr></table></figure></p>
<p>$ ansible  -i hosts.ini server  -m command -a “ md5sum /tmp/id_rsa.pub “ -u admin</p>
<p>success =&gt; 10.125.0.169 =&gt; rc=0 =&gt;<br>b6ba28284ab95aaa0f47602bdab49f46  /tmp/id_rsa.pub</p>
<p>success =&gt; 10.125.3.33 =&gt; rc=0 =&gt;<br>b6ba28284ab95aaa0f47602bdab49f46  /tmp/id_rsa.pub</p>
<p>success =&gt; 120.26.116.193 =&gt; rc=0 =&gt;<br>b6ba28284ab95aaa0f47602bdab49f46  /tmp/id_rsa.pub<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">结果说明</div><div class="line"></div><div class="line">&gt;   md5都是b6ba28284ab95aaa0f47602bdab49f46 跟本地的一致，说明成功复制到目标机器了</div><div class="line"></div><div class="line">### 执行远程服务器上已经写好的Shell脚本</div></pre></td></tr></table></figure></p>
<p>$ cat test.sh </p>
<p>#/bin/sh</p>
<p>ifconfig | grep ‘inet addr’<br>echo “————-“<br>uptime<br>echo “————-“<br>date</p>
<p>df -lh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">执行结果</div><div class="line"></div><div class="line">```shell</div><div class="line">$ ansible  -i hosts.ini server  -m command -a &quot; sh /tmp/test.sh &quot; -u admin</div><div class="line"></div><div class="line">/usr/bin/ansible -i hosts.ini server -m command -a  sh /tmp/test.sh  -u admin</div><div class="line"></div><div class="line">success =&gt; 10.125.3.33 =&gt; rc=0 =&gt;</div><div class="line">          inet addr:10.125.3.33  Bcast:10.125.15.255  Mask:255.255.240.0</div><div class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</div></pre></td></tr></table></figure></p>
<h3 id="copy个人笔记本的公钥到服务器上，以后从笔记本登录服务器不再需要输入密码"><a href="#copy个人笔记本的公钥到服务器上，以后从笔记本登录服务器不再需要输入密码" class="headerlink" title="copy个人笔记本的公钥到服务器上，以后从笔记本登录服务器不再需要输入密码"></a>copy个人笔记本的公钥到服务器上，以后从笔记本登录服务器不再需要输入密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ansible -i ansible-hosts.ini all -m authorized_key -a &quot; user=xijun.rxj key=\&quot;&#123;&#123; lookup(&apos;file&apos;, &apos;/tmp/id_rsa.pub&apos;) &#125;&#125; \&quot;  &quot; -u xijun.rxj -k</div></pre></td></tr></table></figure>
<h3 id="Copying-files-between-different-folders-on-the-same-remote-machine"><a href="#Copying-files-between-different-folders-on-the-same-remote-machine" class="headerlink" title="Copying files between different folders on the same remote machine"></a>Copying files between different folders on the same remote machine</h3><p>You can also copy files between the various locations on the remote servers. You have to set the <strong>remote_src</strong> parameter to yes.</p>
<p>The following example copies the hello6 file in the /tmp directory of the remote server and pastes it in the /etc/ directory.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- hosts: blocks</div><div class="line">  tasks:</div><div class="line">  - name: Ansible copy files remote to remote</div><div class="line">    copy:</div><div class="line">      src: /tmp/hello6</div><div class="line">      dest: /etc</div><div class="line">      remote_src: yes</div></pre></td></tr></table></figure>
<p>or:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible blocks -m copy -a &quot;src=/tmp/hello6 dest=/tmp/hello7etc remote_src=yes&quot; -s -i inventory.ini</div></pre></td></tr></table></figure>
<h3 id="效率更高的-copy：synchronize"><a href="#效率更高的-copy：synchronize" class="headerlink" title="效率更高的 copy：synchronize"></a>效率更高的 copy：synchronize</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible -i xty_172.ini all -m synchronize -a &quot; src=/home/ren/docker.service dest=/usr/lib/systemd/system/docker.socket &quot; -u root</div></pre></td></tr></table></figure>
<h3 id="find-file"><a href="#find-file" class="headerlink" title="find_file"></a>find_file</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">- hosts: all</div><div class="line"></div><div class="line">  tasks:</div><div class="line">    - name: find_file</div><div class="line">      find:</div><div class="line">        paths: /home/admin/.ssh/</div><div class="line">        patterns: &quot;*.rsa&quot;</div><div class="line">        recurse: no</div><div class="line">      register: file_name</div><div class="line"></div><div class="line">    - name: copy_file</div><div class="line">      fetch:</div><div class="line">        src: &quot;&#123;&#123; item.path &#125;&#125;&quot;</div><div class="line">        dest: /tmp/sshbak/</div><div class="line">        flat: no</div><div class="line">      with_items: &quot;&#123;&#123; file_name.files &#125;&#125;&quot;</div></pre></td></tr></table></figure>
<p>test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook -i 127.0.0.1,  ./find_file.yaml</div></pre></td></tr></table></figure>
<h3 id="不使用-hosts-ini文件，从命令行中传入目标机的-ip-列表"><a href="#不使用-hosts-ini文件，从命令行中传入目标机的-ip-列表" class="headerlink" title="不使用 hosts.ini文件，从命令行中传入目标机的 ip 列表"></a>不使用 hosts.ini文件，从命令行中传入目标机的 ip 列表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ ansible -i 10.125.0.169,10.125.192.40 all -e &quot;ansible_ssh_port=22&quot; -a &quot;uptime&quot; -u xijun.rxj</div><div class="line"></div><div class="line">success =&gt; 10.125.192.40 =&gt; rc=0 =&gt;</div><div class="line"> 12:31:50 up 48 days, 17:01,  0 users,  load average: 0.13, 0.06, 0.05</div><div class="line"></div><div class="line">success =&gt; 10.125.0.169 =&gt; rc=0 =&gt;</div><div class="line"> 12:31:50 up 49 days,  2:25,  0 users,  load average: 0.00, 0.01, 0.05</div></pre></td></tr></table></figure>
<p>执行说明</p>
<blockquote>
<p>   -i 后面带入ip列表，注意每个IP后面一定要有 “,” 分割开来，all 关键字也是必须的</p>
<p>   -e 中ansible_ssh_port=22表示ssh使用22端口（默认），如果ssh使用9999端口在这里将22改成9999即可</p>
</blockquote>
<h3 id="使用root-sudo权限来执行命令"><a href="#使用root-sudo权限来执行命令" class="headerlink" title="使用root sudo权限来执行命令"></a>使用root sudo权限来执行命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible -i 10.125.6.93, all -m  shell -a &quot; ls -lh /home/admin/&quot;    -u xijun.rxj --become-user=root --ask-become-pass --become-method=sudo --become -k</div></pre></td></tr></table></figure>
<h3 id="给admin授权登录server不需要输入密码（也不知道admin的密码）"><a href="#给admin授权登录server不需要输入密码（也不知道admin的密码）" class="headerlink" title="给admin授权登录server不需要输入密码（也不知道admin的密码）"></a>给admin授权登录server不需要输入密码（也不知道admin的密码）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">通过 xijun.rxj(已知密码) 以root 权限将本机pub key复制到server上的 /home/admin, 再通过admin账号登录server就不需要密码了：</div><div class="line">ansible -i 10.125.6.93, all -m  authorized_key -a &quot; user=admin key=\&quot;&#123;&#123; lookup(&apos;file&apos;, &apos;/home/ren/.ssh/id_rsa.pub&apos;) &#125;&#125; \&quot;  &quot; -u xijun.rxj --become-user=root --ask-become-pass --become-method=sudo --become -k</div><div class="line"></div><div class="line">不需要密码就可以执行：</div><div class="line">ansible -i 10.125.6.93, all -m shell -a &quot; ls -lha /home/admin/  &quot; -u admin</div></pre></td></tr></table></figure>
<h3 id="fetch-将远程服务器上的public-key-读取到本地"><a href="#fetch-将远程服务器上的public-key-读取到本地" class="headerlink" title="fetch:将远程服务器上的public key 读取到本地"></a>fetch:将远程服务器上的public key 读取到本地</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ansible -i kfc.ini hadoop -m fetch -a &quot; src=/home/admin/.ssh/id_rsa.pub dest=./test/  &quot;  -u admin</div><div class="line"></div><div class="line">find test/ -type f | xargs cat &gt; ./authorized_keys</div><div class="line"></div><div class="line">#push all the public keys to the server</div><div class="line">ansible -i ~/ali/ansible-edas/kfc.ini hadoop -m  copy -a &quot; src=./authorized_keys dest=/home/admin/.ssh/authorized_keys mode=600  &quot; -u admin</div></pre></td></tr></table></figure>
<p>或者循环fetch：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="string">$cat</span> <span class="string">fetch.yaml</span> </div><div class="line"><span class="attr">- hosts:</span> <span class="string">all</span>   </div><div class="line"><span class="attr">  tasks:</span></div><div class="line"><span class="attr">    - name:</span> <span class="string">list</span> <span class="string">the</span> <span class="string">files</span> <span class="string">in</span> <span class="string">the</span> <span class="string">folder</span></div><div class="line">      <span class="comment">#command: ls /u01/nmon/tpcc/ </span></div><div class="line"><span class="attr">      shell:</span> <span class="string">(cd</span> <span class="string">/remote;</span> <span class="string">find</span> <span class="string">.</span> <span class="bullet">-maxdepth</span> <span class="number">1</span> <span class="bullet">-type</span> <span class="string">f)</span> <span class="string">| cut -d'/' -f2</span></div><div class="line"><span class="attr">      register:</span> <span class="string">dir_out</span></div><div class="line"></div><div class="line"><span class="attr">    - name:</span> <span class="string">do</span> <span class="string">the</span> <span class="string">action</span></div><div class="line"><span class="attr">      fetch:</span> <span class="string">src=/u01/nmon/tpcc/&#123;&#123;item&#125;&#125;</span> <span class="string">dest=/home/aliyun/nmon_tpcc/</span> <span class="string">flat=no</span></div><div class="line"><span class="attr">      with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123;dir_out.stdout_lines&#125;&#125;</span>"</span></div></pre></td></tr></table></figure>
<p>执行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">$ansible-playbook -i /home/aliyun/all.ini  fetch.yaml -u admin</div><div class="line"></div><div class="line">PLAY [all] *******************************************************************************************</div><div class="line"></div><div class="line">TASK [Gathering Facts] *******************************************************************************</div><div class="line">ok: [10.88.88.18]</div><div class="line">ok: [10.88.88.16]</div><div class="line">ok: [10.88.88.15]</div><div class="line">ok: [10.88.88.19]</div><div class="line">ok: [10.88.88.17]</div><div class="line">ok: [10.88.88.20]</div><div class="line"></div><div class="line">TASK [list the files in the folder] ******************************************************************</div><div class="line">changed: [10.88.88.15]</div><div class="line">changed: [10.88.88.16]</div><div class="line">changed: [10.88.88.17]</div><div class="line">changed: [10.88.88.18]</div><div class="line">changed: [10.88.88.19]</div><div class="line">changed: [10.88.88.20]</div><div class="line"></div><div class="line">TASK [do the action] *********************************************************************************</div><div class="line">changed: [10.88.88.15] =&gt; (item=uos15_200729_1108.nmon)</div><div class="line">changed: [10.88.88.18] =&gt; (item=uos18_200729_1107.nmon)</div><div class="line">changed: [10.88.88.16] =&gt; (item=uos16_200729_1106.nmon)</div><div class="line">changed: [10.88.88.19] =&gt; (item=adbpg2-PC_200729_1108.nmon)</div><div class="line">changed: [10.88.88.17] =&gt; (item=uos17_200729_1107.nmon)</div><div class="line">changed: [10.88.88.19] =&gt; (item=adbpg2-PC_200729_1936.nmon)</div><div class="line">changed: [10.88.88.20] =&gt; (item=adbpg-PC_200729_1110.nmon)</div><div class="line"></div><div class="line">PLAY RECAP *******************************************************************************************</div><div class="line">10.88.88.15                : ok=3    changed=2    unreachable=0    failed=0   </div><div class="line">10.88.88.16                : ok=3    changed=2    unreachable=0    failed=0   </div><div class="line">10.88.88.17                : ok=3    changed=2    unreachable=0    failed=0   </div><div class="line">10.88.88.18                : ok=3    changed=2    unreachable=0    failed=0   </div><div class="line">10.88.88.19                : ok=3    changed=2    unreachable=0    failed=0   </div><div class="line">10.88.88.20                : ok=3    changed=2    unreachable=0    failed=0</div></pre></td></tr></table></figure>
<h3 id="setup-获取机器配置、参数信息"><a href="#setup-获取机器配置、参数信息" class="headerlink" title="setup:获取机器配置、参数信息"></a>setup:获取机器配置、参数信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div></pre></td><td class="code"><pre><div class="line"># ansible -i 192.168.1.91, all -m setup -u admin</div><div class="line">192.168.1.91 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;ansible_facts&quot;: &#123;</div><div class="line">        &quot;ansible_all_ipv4_addresses&quot;: [</div><div class="line">            &quot;172.17.0.1&quot;, </div><div class="line">            &quot;192.168.0.91&quot;, </div><div class="line">            &quot;192.168.1.91&quot;</div><div class="line">        ], </div><div class="line">        &quot;ansible_all_ipv6_addresses&quot;: [], </div><div class="line">        &quot;ansible_apparmor&quot;: &#123;</div><div class="line">            &quot;status&quot;: &quot;disabled&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_architecture&quot;: &quot;x86_64&quot;, </div><div class="line">        &quot;ansible_bios_date&quot;: &quot;04/01/2014&quot;, </div><div class="line">        &quot;ansible_bios_version&quot;: &quot;8c24b4c&quot;, </div><div class="line">        &quot;ansible_cmdline&quot;: &#123;</div><div class="line">            &quot;BOOT_IMAGE&quot;: &quot;/boot/vmlinuz-3.10.0-957.21.3.el7.x86_64&quot;, </div><div class="line">            &quot;LANG&quot;: &quot;en_US.UTF-8&quot;, </div><div class="line">            &quot;biosdevname&quot;: &quot;0&quot;, </div><div class="line">            &quot;console&quot;: &quot;ttyS0,115200n8&quot;, </div><div class="line">            &quot;crashkernel&quot;: &quot;auto&quot;, </div><div class="line">            &quot;idle&quot;: &quot;halt&quot;, </div><div class="line">            &quot;net.ifnames&quot;: &quot;0&quot;, </div><div class="line">            &quot;noibrs&quot;: true, </div><div class="line">            &quot;quiet&quot;: true, </div><div class="line">            &quot;rhgb&quot;: true, </div><div class="line">            &quot;ro&quot;: true, </div><div class="line">            &quot;root&quot;: &quot;UUID=1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_date_time&quot;: &#123;</div><div class="line">            &quot;date&quot;: &quot;2020-07-15&quot;, </div><div class="line">            &quot;day&quot;: &quot;15&quot;, </div><div class="line">            &quot;epoch&quot;: &quot;1594796084&quot;, </div><div class="line">            &quot;hour&quot;: &quot;14&quot;, </div><div class="line">            &quot;iso8601&quot;: &quot;2020-07-15T06:54:44Z&quot;, </div><div class="line">            &quot;iso8601_basic&quot;: &quot;20200715T145444643628&quot;, </div><div class="line">            &quot;iso8601_basic_short&quot;: &quot;20200715T145444&quot;, </div><div class="line">            &quot;iso8601_micro&quot;: &quot;2020-07-15T06:54:44.643725Z&quot;, </div><div class="line">            &quot;minute&quot;: &quot;54&quot;, </div><div class="line">            &quot;month&quot;: &quot;07&quot;, </div><div class="line">            &quot;second&quot;: &quot;44&quot;, </div><div class="line">            &quot;time&quot;: &quot;14:54:44&quot;, </div><div class="line">            &quot;tz&quot;: &quot;CST&quot;, </div><div class="line">            &quot;tz_offset&quot;: &quot;+0800&quot;, </div><div class="line">            &quot;weekday&quot;: &quot;星期三&quot;, </div><div class="line">            &quot;weekday_number&quot;: &quot;3&quot;, </div><div class="line">            &quot;weeknumber&quot;: &quot;28&quot;, </div><div class="line">            &quot;year&quot;: &quot;2020&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_default_ipv4&quot;: &#123;</div><div class="line">            &quot;address&quot;: &quot;192.168.0.91&quot;, </div><div class="line">            &quot;alias&quot;: &quot;eth0&quot;, </div><div class="line">            &quot;broadcast&quot;: &quot;192.168.0.255&quot;, </div><div class="line">            &quot;gateway&quot;: &quot;192.168.0.253&quot;, </div><div class="line">            &quot;interface&quot;: &quot;eth0&quot;, </div><div class="line">            &quot;macaddress&quot;: &quot;00:16:3e:30:d9:a4&quot;, </div><div class="line">            &quot;mtu&quot;: 1500, </div><div class="line">            &quot;netmask&quot;: &quot;255.255.255.0&quot;, </div><div class="line">            &quot;network&quot;: &quot;192.168.0.0&quot;, </div><div class="line">            &quot;type&quot;: &quot;ether&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_default_ipv6&quot;: &#123;&#125;, </div><div class="line">        &quot;ansible_device_links&quot;: &#123;</div><div class="line">            &quot;ids&quot;: &#123;&#125;, </div><div class="line">            &quot;labels&quot;: &#123;</div><div class="line">                &quot;loop2&quot;: [</div><div class="line">                    &quot;CDROM&quot;</div><div class="line">                ]</div><div class="line">            &#125;, </div><div class="line">            &quot;masters&quot;: &#123;&#125;, </div><div class="line">            &quot;uuids&quot;: &#123;</div><div class="line">                &quot;loop0&quot;: [</div><div class="line">                    &quot;2020-07-12-14-26-47-00&quot;</div><div class="line">                ], </div><div class="line">                &quot;loop1&quot;: [</div><div class="line">                    &quot;2020-07-12-20-25-18-00&quot;</div><div class="line">                ], </div><div class="line">                &quot;loop2&quot;: [</div><div class="line">                    &quot;2020-07-13-09-57-36-00&quot;</div><div class="line">                ], </div><div class="line">                &quot;vda1&quot;: [</div><div class="line">                    &quot;1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_devices&quot;: &#123;</div><div class="line">            &quot;loop0&quot;: &#123;</div><div class="line">                &quot;holders&quot;: [], </div><div class="line">                &quot;host&quot;: &quot;&quot;, </div><div class="line">                &quot;links&quot;: &#123;</div><div class="line">                    &quot;ids&quot;: [], </div><div class="line">                    &quot;labels&quot;: [], </div><div class="line">                    &quot;masters&quot;: [], </div><div class="line">                    &quot;uuids&quot;: [</div><div class="line">                        &quot;2020-07-12-14-26-47-00&quot;</div><div class="line">                    ]</div><div class="line">                &#125;, </div><div class="line">                &quot;model&quot;: null, </div><div class="line">                &quot;partitions&quot;: &#123;&#125;, </div><div class="line">                &quot;removable&quot;: &quot;0&quot;, </div><div class="line">                &quot;rotational&quot;: &quot;1&quot;, </div><div class="line">                &quot;sas_address&quot;: null, </div><div class="line">                &quot;sas_device_handle&quot;: null, </div><div class="line">                &quot;scheduler_mode&quot;: &quot;&quot;, </div><div class="line">                &quot;sectors&quot;: &quot;327924&quot;, </div><div class="line">                &quot;sectorsize&quot;: &quot;512&quot;, </div><div class="line">                &quot;size&quot;: &quot;160.12 MB&quot;, </div><div class="line">                &quot;support_discard&quot;: &quot;4096&quot;, </div><div class="line">                &quot;vendor&quot;: null, </div><div class="line">                &quot;virtual&quot;: 1</div><div class="line">            &#125;, </div><div class="line">            &quot;loop1&quot;: &#123;</div><div class="line">                &quot;holders&quot;: [], </div><div class="line">                &quot;host&quot;: &quot;&quot;, </div><div class="line">                &quot;links&quot;: &#123;</div><div class="line">                    &quot;ids&quot;: [], </div><div class="line">                    &quot;labels&quot;: [], </div><div class="line">                    &quot;masters&quot;: [], </div><div class="line">                    &quot;uuids&quot;: [</div><div class="line">                        &quot;2020-07-12-20-25-18-00&quot;</div><div class="line">                    ]</div><div class="line">                &#125;, </div><div class="line">                &quot;model&quot;: null, </div><div class="line">                &quot;partitions&quot;: &#123;&#125;, </div><div class="line">                &quot;removable&quot;: &quot;0&quot;, </div><div class="line">                &quot;rotational&quot;: &quot;1&quot;, </div><div class="line">                &quot;sas_address&quot;: null, </div><div class="line">                &quot;sas_device_handle&quot;: null, </div><div class="line">                &quot;scheduler_mode&quot;: &quot;&quot;, </div><div class="line">                &quot;sectors&quot;: &quot;359172&quot;, </div><div class="line">                &quot;sectorsize&quot;: &quot;512&quot;, </div><div class="line">                &quot;size&quot;: &quot;175.38 MB&quot;, </div><div class="line">                &quot;support_discard&quot;: &quot;4096&quot;, </div><div class="line">                &quot;vendor&quot;: null, </div><div class="line">                &quot;virtual&quot;: 1</div><div class="line">            &#125;, </div><div class="line">            &quot;loop2&quot;: &#123;</div><div class="line">                &quot;holders&quot;: [], </div><div class="line">                &quot;host&quot;: &quot;&quot;, </div><div class="line">                &quot;links&quot;: &#123;</div><div class="line">                    &quot;ids&quot;: [], </div><div class="line">                    &quot;labels&quot;: [</div><div class="line">                        &quot;CDROM&quot;</div><div class="line">                    ], </div><div class="line">                    &quot;masters&quot;: [], </div><div class="line">                    &quot;uuids&quot;: [</div><div class="line">                        &quot;2020-07-13-09-57-36-00&quot;</div><div class="line">                    ]</div><div class="line">                &#125;, </div><div class="line">                &quot;model&quot;: null, </div><div class="line">                &quot;partitions&quot;: &#123;&#125;, </div><div class="line">                &quot;removable&quot;: &quot;0&quot;, </div><div class="line">                &quot;rotational&quot;: &quot;1&quot;, </div><div class="line">                &quot;sas_address&quot;: null, </div><div class="line">                &quot;sas_device_handle&quot;: null, </div><div class="line">                &quot;scheduler_mode&quot;: &quot;&quot;, </div><div class="line">                &quot;sectors&quot;: &quot;128696&quot;, </div><div class="line">                &quot;sectorsize&quot;: &quot;512&quot;, </div><div class="line">                &quot;size&quot;: &quot;62.84 MB&quot;, </div><div class="line">                &quot;support_discard&quot;: &quot;4096&quot;, </div><div class="line">                &quot;vendor&quot;: null, </div><div class="line">                &quot;virtual&quot;: 1</div><div class="line">            &#125;, </div><div class="line">            &quot;vda&quot;: &#123;</div><div class="line">                &quot;holders&quot;: [], </div><div class="line">                &quot;host&quot;: &quot;SCSI storage controller: Red Hat, Inc. Virtio block device&quot;, </div><div class="line">                &quot;links&quot;: &#123;</div><div class="line">                    &quot;ids&quot;: [], </div><div class="line">                    &quot;labels&quot;: [], </div><div class="line">                    &quot;masters&quot;: [], </div><div class="line">                    &quot;uuids&quot;: []</div><div class="line">                &#125;, </div><div class="line">                &quot;model&quot;: null, </div><div class="line">                &quot;partitions&quot;: &#123;</div><div class="line">                    &quot;vda1&quot;: &#123;</div><div class="line">                        &quot;holders&quot;: [], </div><div class="line">                        &quot;links&quot;: &#123;</div><div class="line">                            &quot;ids&quot;: [], </div><div class="line">                            &quot;labels&quot;: [], </div><div class="line">                            &quot;masters&quot;: [], </div><div class="line">                            &quot;uuids&quot;: [</div><div class="line">                                &quot;1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">                            ]</div><div class="line">                        &#125;, </div><div class="line">                        &quot;sectors&quot;: &quot;838847992&quot;, </div><div class="line">                        &quot;sectorsize&quot;: 512, </div><div class="line">                        &quot;size&quot;: &quot;399.99 GB&quot;, </div><div class="line">                        &quot;start&quot;: &quot;2048&quot;, </div><div class="line">                        &quot;uuid&quot;: &quot;1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">                    &#125;</div><div class="line">                &#125;, </div><div class="line">                &quot;removable&quot;: &quot;0&quot;, </div><div class="line">                &quot;rotational&quot;: &quot;1&quot;, </div><div class="line">                &quot;sas_address&quot;: null, </div><div class="line">                &quot;sas_device_handle&quot;: null, </div><div class="line">                &quot;scheduler_mode&quot;: &quot;mq-deadline&quot;, </div><div class="line">                &quot;sectors&quot;: &quot;838860800&quot;, </div><div class="line">                &quot;sectorsize&quot;: &quot;512&quot;, </div><div class="line">                &quot;size&quot;: &quot;400.00 GB&quot;, </div><div class="line">                &quot;support_discard&quot;: &quot;0&quot;, </div><div class="line">                &quot;vendor&quot;: &quot;0x1af4&quot;, </div><div class="line">                &quot;virtual&quot;: 1</div><div class="line">            &#125;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_distribution&quot;: &quot;CentOS&quot;, </div><div class="line">        &quot;ansible_distribution_file_parsed&quot;: true, </div><div class="line">        &quot;ansible_distribution_file_path&quot;: &quot;/etc/redhat-release&quot;, </div><div class="line">        &quot;ansible_distribution_file_variety&quot;: &quot;RedHat&quot;, </div><div class="line">        &quot;ansible_distribution_major_version&quot;: &quot;7&quot;, </div><div class="line">        &quot;ansible_distribution_release&quot;: &quot;Core&quot;, </div><div class="line">        &quot;ansible_distribution_version&quot;: &quot;7.8&quot;, </div><div class="line">        &quot;ansible_dns&quot;: &#123;</div><div class="line">            &quot;nameservers&quot;: [</div><div class="line">                &quot;100.100.2.136&quot;, </div><div class="line">                &quot;100.100.2.138&quot;</div><div class="line">            ], </div><div class="line">            &quot;options&quot;: &#123;</div><div class="line">                &quot;attempts&quot;: &quot;3&quot;, </div><div class="line">                &quot;rotate&quot;: true, </div><div class="line">                &quot;single-request-reopen&quot;: true, </div><div class="line">                &quot;timeout&quot;: &quot;2&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_docker0&quot;: &#123;</div><div class="line">            &quot;active&quot;: false, </div><div class="line">            &quot;device&quot;: &quot;docker0&quot;, </div><div class="line">            &quot;features&quot;: &#123;</div><div class="line">                &quot;busy_poll&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;highdma&quot;: &quot;on&quot;, </div><div class="line">                &quot;hw_tc_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;l2_fwd_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;loopback&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;netns_local&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_all&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_checksumming&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_fcs&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_gro_hw&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_udp_tunnel_port_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_hw_parse&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_gre_csum_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_gre_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_gso_partial&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_gso_robust&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_ipip_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_lockless&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_nocache_copy&quot;: &quot;off&quot;, </div><div class="line">                &quot;tx_scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_sctp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_sit_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_mangleid_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_udp_tnl_csum_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_vlan_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_vlan_stag_hw_insert&quot;: &quot;on&quot;, </div><div class="line">                &quot;udp_fragmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;vlan_challenged&quot;: &quot;off [fixed]&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;hw_timestamp_filters&quot;: [], </div><div class="line">            &quot;id&quot;: &quot;8000.0242e441b693&quot;, </div><div class="line">            &quot;interfaces&quot;: [], </div><div class="line">            &quot;ipv4&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;172.17.0.1&quot;, </div><div class="line">                &quot;broadcast&quot;: &quot;172.17.255.255&quot;, </div><div class="line">                &quot;netmask&quot;: &quot;255.255.0.0&quot;, </div><div class="line">                &quot;network&quot;: &quot;172.17.0.0&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;macaddress&quot;: &quot;02:42:e4:41:b6:93&quot;, </div><div class="line">            &quot;mtu&quot;: 1500, </div><div class="line">            &quot;promisc&quot;: false, </div><div class="line">            &quot;stp&quot;: false, </div><div class="line">            &quot;timestamping&quot;: [</div><div class="line">                &quot;rx_software&quot;, </div><div class="line">                &quot;software&quot;</div><div class="line">            ], </div><div class="line">            &quot;type&quot;: &quot;bridge&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_domain&quot;: &quot;&quot;, </div><div class="line">        &quot;ansible_effective_group_id&quot;: 1000, </div><div class="line">        &quot;ansible_effective_user_id&quot;: 1000, </div><div class="line">        &quot;ansible_env&quot;: &#123;</div><div class="line">            &quot;HISTCONTROL&quot;: &quot;erasedups&quot;, </div><div class="line">            &quot;HISTFILESIZE&quot;: &quot;30000&quot;, </div><div class="line">            &quot;HISTIGNORE&quot;: &quot;pwd:ls:cd:ll:&quot;, </div><div class="line">            &quot;HISTSIZE&quot;: &quot;30000&quot;, </div><div class="line">            &quot;HISTTIMEFORMAT&quot;: &quot;%d/%m/%y %T &quot;, </div><div class="line">            &quot;HOME&quot;: &quot;/home/admin&quot;, </div><div class="line">            &quot;JAVA_HOME&quot;: &quot;/opt/taobao/java&quot;, </div><div class="line">            &quot;LANG&quot;: &quot;C&quot;, </div><div class="line">            &quot;LC_ADDRESS&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_ALL&quot;: &quot;C&quot;, </div><div class="line">            &quot;LC_IDENTIFICATION&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_MEASUREMENT&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_MONETARY&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_NAME&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_NUMERIC&quot;: &quot;C&quot;, </div><div class="line">            &quot;LC_PAPER&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_TELEPHONE&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LC_TIME&quot;: &quot;zh_CN.UTF-8&quot;, </div><div class="line">            &quot;LESSOPEN&quot;: &quot;||/usr/bin/lesspipe.sh %s&quot;, </div><div class="line">            &quot;LOGNAME&quot;: &quot;admin&quot;, </div><div class="line">            &quot;MAIL&quot;: &quot;/var/mail/admin&quot;, </div><div class="line">            &quot;PATH&quot;: &quot;/usr/local/bin:/usr/bin:/opt/taobao/java8/bin:/home/admin/tools&quot;, </div><div class="line">            &quot;PROMPT_COMMAND&quot;: &quot;history -a&quot;, </div><div class="line">            &quot;PS4&quot;: &quot;+($&#123;BASH_SOURCE&#125;:$&#123;LINENO&#125;): $&#123;FUNCNAME[0]:+$&#123;FUNCNAME[0]&#125;(): &#125;&quot;, </div><div class="line">            &quot;PWD&quot;: &quot;/home/admin&quot;, </div><div class="line">            &quot;SHELL&quot;: &quot;/bin/bash&quot;, </div><div class="line">            &quot;SHLVL&quot;: &quot;2&quot;, </div><div class="line">            &quot;SSH_CLIENT&quot;: &quot;192.168.1.79 51412 22&quot;, </div><div class="line">            &quot;SSH_CONNECTION&quot;: &quot;192.168.1.79 51412 192.168.1.91 22&quot;, </div><div class="line">            &quot;USER&quot;: &quot;admin&quot;, </div><div class="line">            &quot;XDG_RUNTIME_DIR&quot;: &quot;/run/user/1000&quot;, </div><div class="line">            &quot;XDG_SESSION_ID&quot;: &quot;40120&quot;, </div><div class="line">            &quot;_&quot;: &quot;/usr/bin/python&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_eth0&quot;: &#123;</div><div class="line">            &quot;active&quot;: true, </div><div class="line">            &quot;device&quot;: &quot;eth0&quot;, </div><div class="line">            &quot;features&quot;: &#123;</div><div class="line">                &quot;busy_poll&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;highdma&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;hw_tc_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;l2_fwd_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;loopback&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;netns_local&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_all&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_checksumming&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;rx_fcs&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_gro_hw&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_udp_tunnel_port_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_hw_parse&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_partial&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_ipip_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_lockless&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_nocache_copy&quot;: &quot;off&quot;, </div><div class="line">                &quot;tx_scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_sctp_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_sit_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_mangleid_segmentation&quot;: &quot;off&quot;, </div><div class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_udp_tnl_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_stag_hw_insert&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;udp_fragmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;vlan_challenged&quot;: &quot;off [fixed]&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;hw_timestamp_filters&quot;: [], </div><div class="line">            &quot;ipv4&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.91&quot;, </div><div class="line">                &quot;broadcast&quot;: &quot;192.168.0.255&quot;, </div><div class="line">                &quot;netmask&quot;: &quot;255.255.255.0&quot;, </div><div class="line">                &quot;network&quot;: &quot;192.168.0.0&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;macaddress&quot;: &quot;00:16:3e:30:d9:a4&quot;, </div><div class="line">            &quot;module&quot;: &quot;virtio_net&quot;, </div><div class="line">            &quot;mtu&quot;: 1500, </div><div class="line">            &quot;pciid&quot;: &quot;virtio2&quot;, </div><div class="line">            &quot;promisc&quot;: false, </div><div class="line">            &quot;timestamping&quot;: [</div><div class="line">                &quot;rx_software&quot;, </div><div class="line">                &quot;software&quot;</div><div class="line">            ], </div><div class="line">            &quot;type&quot;: &quot;ether&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_eth1&quot;: &#123;</div><div class="line">            &quot;active&quot;: true, </div><div class="line">            &quot;device&quot;: &quot;eth1&quot;, </div><div class="line">            &quot;features&quot;: &#123;</div><div class="line">                &quot;busy_poll&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;highdma&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;hw_tc_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;l2_fwd_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;loopback&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;netns_local&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_all&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_checksumming&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;rx_fcs&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_gro_hw&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_udp_tunnel_port_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_hw_parse&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_partial&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_ipip_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_lockless&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_nocache_copy&quot;: &quot;off&quot;, </div><div class="line">                &quot;tx_scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_sctp_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_sit_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_mangleid_segmentation&quot;: &quot;off&quot;, </div><div class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_udp_tnl_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_stag_hw_insert&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;udp_fragmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;vlan_challenged&quot;: &quot;off [fixed]&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;hw_timestamp_filters&quot;: [], </div><div class="line">            &quot;ipv4&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.1.91&quot;, </div><div class="line">                &quot;broadcast&quot;: &quot;192.168.1.255&quot;, </div><div class="line">                &quot;netmask&quot;: &quot;255.255.255.0&quot;, </div><div class="line">                &quot;network&quot;: &quot;192.168.1.0&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;macaddress&quot;: &quot;00:16:3e:2c:a2:c2&quot;, </div><div class="line">            &quot;module&quot;: &quot;virtio_net&quot;, </div><div class="line">            &quot;mtu&quot;: 1500, </div><div class="line">            &quot;pciid&quot;: &quot;virtio4&quot;, </div><div class="line">            &quot;promisc&quot;: false, </div><div class="line">            &quot;timestamping&quot;: [</div><div class="line">                &quot;rx_software&quot;, </div><div class="line">                &quot;software&quot;</div><div class="line">            ], </div><div class="line">            &quot;type&quot;: &quot;ether&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_fibre_channel_wwn&quot;: [], </div><div class="line">        &quot;ansible_fips&quot;: false, </div><div class="line">        &quot;ansible_form_factor&quot;: &quot;Other&quot;, </div><div class="line">        &quot;ansible_fqdn&quot;: &quot;jtdb001&quot;, </div><div class="line">        &quot;ansible_hostname&quot;: &quot;jtdb001&quot;, </div><div class="line">        &quot;ansible_hostnqn&quot;: &quot;&quot;, </div><div class="line">        &quot;ansible_interfaces&quot;: [</div><div class="line">            &quot;lo&quot;, </div><div class="line">            &quot;docker0&quot;, </div><div class="line">            &quot;eth1&quot;, </div><div class="line">            &quot;eth0&quot;</div><div class="line">        ], </div><div class="line">        &quot;ansible_is_chroot&quot;: false, </div><div class="line">        &quot;ansible_iscsi_iqn&quot;: &quot;&quot;, </div><div class="line">        &quot;ansible_kernel&quot;: &quot;3.10.0-957.21.3.el7.x86_64&quot;, </div><div class="line">        &quot;ansible_kernel_version&quot;: &quot;#1 SMP Tue Jun 18 16:35:19 UTC 2019&quot;, </div><div class="line">        &quot;ansible_lo&quot;: &#123;</div><div class="line">            &quot;active&quot;: true, </div><div class="line">            &quot;device&quot;: &quot;lo&quot;, </div><div class="line">            &quot;features&quot;: &#123;</div><div class="line">                &quot;busy_poll&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;highdma&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;hw_tc_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;l2_fwd_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;loopback&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;netns_local&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_all&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_checksumming&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;rx_fcs&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_gro_hw&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_udp_tunnel_port_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_filter&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;rx_vlan_stag_hw_parse&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </div><div class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_checksum_sctp&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_partial&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_ipip_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_lockless&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_nocache_copy&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_scatter_gather&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;on [fixed]&quot;, </div><div class="line">                &quot;tx_sctp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_sit_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_mangleid_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </div><div class="line">                &quot;tx_udp_tnl_csum_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_offload&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;tx_vlan_stag_hw_insert&quot;: &quot;off [fixed]&quot;, </div><div class="line">                &quot;udp_fragmentation_offload&quot;: &quot;on&quot;, </div><div class="line">                &quot;vlan_challenged&quot;: &quot;on [fixed]&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;hw_timestamp_filters&quot;: [], </div><div class="line">            &quot;ipv4&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;127.0.0.1&quot;, </div><div class="line">                &quot;broadcast&quot;: &quot;host&quot;, </div><div class="line">                &quot;netmask&quot;: &quot;255.0.0.0&quot;, </div><div class="line">                &quot;network&quot;: &quot;127.0.0.0&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;mtu&quot;: 65536, </div><div class="line">            &quot;promisc&quot;: false, </div><div class="line">            &quot;timestamping&quot;: [</div><div class="line">                &quot;rx_software&quot;, </div><div class="line">                &quot;software&quot;</div><div class="line">            ], </div><div class="line">            &quot;type&quot;: &quot;loopback&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_local&quot;: &#123;&#125;, </div><div class="line">        &quot;ansible_lsb&quot;: &#123;&#125;, </div><div class="line">        &quot;ansible_machine&quot;: &quot;x86_64&quot;, </div><div class="line">        &quot;ansible_machine_id&quot;: &quot;20190711105006363114529432776998&quot;, </div><div class="line">        &quot;ansible_memfree_mb&quot;: 33368, </div><div class="line">        &quot;ansible_memory_mb&quot;: &#123;</div><div class="line">            &quot;nocache&quot;: &#123;</div><div class="line">                &quot;free&quot;: 41285, </div><div class="line">                &quot;used&quot;: 6079</div><div class="line">            &#125;, </div><div class="line">            &quot;real&quot;: &#123;</div><div class="line">                &quot;free&quot;: 33368, </div><div class="line">                &quot;total&quot;: 47364, </div><div class="line">                &quot;used&quot;: 13996</div><div class="line">            &#125;, </div><div class="line">            &quot;swap&quot;: &#123;</div><div class="line">                &quot;cached&quot;: 0, </div><div class="line">                &quot;free&quot;: 0, </div><div class="line">                &quot;total&quot;: 0, </div><div class="line">                &quot;used&quot;: 0</div><div class="line">            &#125;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_memtotal_mb&quot;: 47364, </div><div class="line">        &quot;ansible_mounts&quot;: [</div><div class="line">            &#123;</div><div class="line">                &quot;block_available&quot;: 0, </div><div class="line">                &quot;block_size&quot;: 2048, </div><div class="line">                &quot;block_total&quot;: 32174, </div><div class="line">                &quot;block_used&quot;: 32174, </div><div class="line">                &quot;device&quot;: &quot;/dev/loop2&quot;, </div><div class="line">                &quot;fstype&quot;: &quot;iso9660&quot;, </div><div class="line">                &quot;inode_available&quot;: 0, </div><div class="line">                &quot;inode_total&quot;: 0, </div><div class="line">                &quot;inode_used&quot;: 0, </div><div class="line">                &quot;mount&quot;: &quot;/mnt/yum&quot;, </div><div class="line">                &quot;options&quot;: &quot;ro,relatime&quot;, </div><div class="line">                &quot;size_available&quot;: 0, </div><div class="line">                &quot;size_total&quot;: 65892352, </div><div class="line">                &quot;uuid&quot;: &quot;2020-07-13-09-57-36-00&quot;</div><div class="line">            &#125;, </div><div class="line">            &#123;</div><div class="line">                &quot;block_available&quot;: 0, </div><div class="line">                &quot;block_size&quot;: 2048, </div><div class="line">                &quot;block_total&quot;: 81981, </div><div class="line">                &quot;block_used&quot;: 81981, </div><div class="line">                &quot;device&quot;: &quot;/dev/loop0&quot;, </div><div class="line">                &quot;fstype&quot;: &quot;iso9660&quot;, </div><div class="line">                &quot;inode_available&quot;: 0, </div><div class="line">                &quot;inode_total&quot;: 0, </div><div class="line">                &quot;inode_used&quot;: 0, </div><div class="line">                &quot;mount&quot;: &quot;/mnt/iso&quot;, </div><div class="line">                &quot;options&quot;: &quot;ro,relatime&quot;, </div><div class="line">                &quot;size_available&quot;: 0, </div><div class="line">                &quot;size_total&quot;: 167897088, </div><div class="line">                &quot;uuid&quot;: &quot;2020-07-12-14-26-47-00&quot;</div><div class="line">            &#125;, </div><div class="line">            &#123;</div><div class="line">                &quot;block_available&quot;: 0, </div><div class="line">                &quot;block_size&quot;: 2048, </div><div class="line">                &quot;block_total&quot;: 89793, </div><div class="line">                &quot;block_used&quot;: 89793, </div><div class="line">                &quot;device&quot;: &quot;/dev/loop1&quot;, </div><div class="line">                &quot;fstype&quot;: &quot;iso9660&quot;, </div><div class="line">                &quot;inode_available&quot;: 0, </div><div class="line">                &quot;inode_total&quot;: 0, </div><div class="line">                &quot;inode_used&quot;: 0, </div><div class="line">                &quot;mount&quot;: &quot;/mnt/drds&quot;, </div><div class="line">                &quot;options&quot;: &quot;ro,relatime&quot;, </div><div class="line">                &quot;size_available&quot;: 0, </div><div class="line">                &quot;size_total&quot;: 183896064, </div><div class="line">                &quot;uuid&quot;: &quot;2020-07-12-20-25-18-00&quot;</div><div class="line">            &#125;, </div><div class="line">            &#123;</div><div class="line">                &quot;block_available&quot;: 96685158, </div><div class="line">                &quot;block_size&quot;: 4096, </div><div class="line">                &quot;block_total&quot;: 103177963, </div><div class="line">                &quot;block_used&quot;: 6492805, </div><div class="line">                &quot;device&quot;: &quot;/dev/vda1&quot;, </div><div class="line">                &quot;fstype&quot;: &quot;ext4&quot;, </div><div class="line">                &quot;inode_available&quot;: 26110896, </div><div class="line">                &quot;inode_total&quot;: 26214400, </div><div class="line">                &quot;inode_used&quot;: 103504, </div><div class="line">                &quot;mount&quot;: &quot;/&quot;, </div><div class="line">                &quot;options&quot;: &quot;rw,relatime,data=ordered&quot;, </div><div class="line">                &quot;size_available&quot;: 396022407168, </div><div class="line">                &quot;size_total&quot;: 422616936448, </div><div class="line">                &quot;uuid&quot;: &quot;1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">            &#125;</div><div class="line">        ], </div><div class="line">        &quot;ansible_nodename&quot;: &quot;jtdb001&quot;, </div><div class="line">        &quot;ansible_os_family&quot;: &quot;RedHat&quot;, </div><div class="line">        &quot;ansible_pkg_mgr&quot;: &quot;yum&quot;, </div><div class="line">        &quot;ansible_proc_cmdline&quot;: &#123;</div><div class="line">            &quot;BOOT_IMAGE&quot;: &quot;/boot/vmlinuz-3.10.0-957.21.3.el7.x86_64&quot;, </div><div class="line">            &quot;LANG&quot;: &quot;en_US.UTF-8&quot;, </div><div class="line">            &quot;biosdevname&quot;: &quot;0&quot;, </div><div class="line">            &quot;console&quot;: [</div><div class="line">                &quot;tty0&quot;, </div><div class="line">                &quot;ttyS0,115200n8&quot;</div><div class="line">            ], </div><div class="line">            &quot;crashkernel&quot;: &quot;auto&quot;, </div><div class="line">            &quot;idle&quot;: &quot;halt&quot;, </div><div class="line">            &quot;net.ifnames&quot;: &quot;0&quot;, </div><div class="line">            &quot;noibrs&quot;: true, </div><div class="line">            &quot;quiet&quot;: true, </div><div class="line">            &quot;rhgb&quot;: true, </div><div class="line">            &quot;ro&quot;: true, </div><div class="line">            &quot;root&quot;: &quot;UUID=1114fe9e-2309-4580-b183-d778e6d97397&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_processor&quot;: [</div><div class="line">            &quot;0&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;1&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;2&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;3&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;4&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;5&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;6&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;7&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;8&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;9&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;10&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;, </div><div class="line">            &quot;11&quot;, </div><div class="line">            &quot;GenuineIntel&quot;, </div><div class="line">            &quot;Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz&quot;</div><div class="line">        ], </div><div class="line">        &quot;ansible_processor_cores&quot;: 6, </div><div class="line">        &quot;ansible_processor_count&quot;: 1, </div><div class="line">        &quot;ansible_processor_threads_per_core&quot;: 2, </div><div class="line">        &quot;ansible_processor_vcpus&quot;: 12, </div><div class="line">        &quot;ansible_product_name&quot;: &quot;Alibaba Cloud ECS&quot;, </div><div class="line">        &quot;ansible_product_serial&quot;: &quot;NA&quot;, </div><div class="line">        &quot;ansible_product_uuid&quot;: &quot;NA&quot;, </div><div class="line">        &quot;ansible_product_version&quot;: &quot;pc-i440fx-2.1&quot;, </div><div class="line">        &quot;ansible_python&quot;: &#123;</div><div class="line">            &quot;executable&quot;: &quot;/usr/bin/python&quot;, </div><div class="line">            &quot;has_sslcontext&quot;: true, </div><div class="line">            &quot;type&quot;: &quot;CPython&quot;, </div><div class="line">            &quot;version&quot;: &#123;</div><div class="line">                &quot;major&quot;: 2, </div><div class="line">                &quot;micro&quot;: 5, </div><div class="line">                &quot;minor&quot;: 7, </div><div class="line">                &quot;releaselevel&quot;: &quot;final&quot;, </div><div class="line">                &quot;serial&quot;: 0</div><div class="line">            &#125;, </div><div class="line">            &quot;version_info&quot;: [</div><div class="line">                2, </div><div class="line">                7, </div><div class="line">                5, </div><div class="line">                &quot;final&quot;, </div><div class="line">                0</div><div class="line">            ]</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_python_version&quot;: &quot;2.7.5&quot;, </div><div class="line">        &quot;ansible_real_group_id&quot;: 1000, </div><div class="line">        &quot;ansible_real_user_id&quot;: 1000, </div><div class="line">        &quot;ansible_selinux&quot;: &#123;</div><div class="line">            &quot;status&quot;: &quot;disabled&quot;</div><div class="line">        &#125;, </div><div class="line">        &quot;ansible_selinux_python_present&quot;: true, </div><div class="line">        &quot;ansible_service_mgr&quot;: &quot;systemd&quot;, </div><div class="line">        &quot;ansible_ssh_host_key_dsa_public&quot;: &quot;AAAAB3NzaC1kc3MAAACBAIjMSdXjIBwLTRwqzzLzJzw52IikcmHpmM65Idw9Q/CCH23SJdmmYzl9LIWFTEf2ZP4dHYibvgWtqfc6AHLFVgM1lz3wwdJJSyBD1TyFet+MPZEA1A9jw2Ke2K9C942dWATCpi3B0nk0KJDp49+V0QjUUjZmzt7I66wDmPLpW7mNAAAAFQDXmbLv48zsFHUgPiixhcKsk29ZPQAAAIAHHM+jfcL3V/X6EovQGj/2OytDN7k5hb4KRNTzBwh9JU5V44+S3r5ZViJDthKBolVT1CLX8jAivBu6d70ImYcZLa75AImOnlSp9D4xGP4TNfdAYrA7CkYpzn8ky15xjFDjkL0BjVmeEg6In+04tZOp/kIi/Ft9/ld63W4xopspwwAAAIAhBCIAMW37rknrsmv3sXmhgt+FeUQA/o8moZKcX+xI5sv27NEavQGGKOvZM4+nhCggRvjWaxC9N1DnO2g52trhGrUhNF0qwn/4iar/yknZWwRyZXzB3YtOdJXxCoJphuuGeqJRsLPb7OEIAF7c3lFJcfMUrwcjWrRtFMUM6mE+gQ==&quot;, </div><div class="line">        &quot;ansible_ssh_host_key_ecdsa_public&quot;: &quot;AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMffg6EX26f+10IIgg/U7+PsCUDs8Ep0MUttUyVh3+bJ7/K7ROMhuc8BTieA4PRj3MOaKMbUuZTqPTmrK/4srqg=&quot;, </div><div class="line">        &quot;ansible_ssh_host_key_ed25519_public&quot;: &quot;AAAAC3NzaC1lZDI1NTE5AAAAINIKYkm+FKDTvx6VgENoAnXwOJQ+xZjk3rkvUqZ/4F3i&quot;, </div><div class="line">        &quot;ansible_ssh_host_key_rsa_public&quot;: &quot;AAAAB3NzaC1yc2EAAAADAQABAAABAQC1xlLrDTri/jRfph6Uqx6CoY1/+uAE34rR9sR4FtE+2OMM8kUN0+N+hWLL+8r/pzM40RJOUmELYTlibfnjkYDsmYcpxD8kOxonvlYQbpvram8Hx7X8W1thYs//Zdhltmz1ijTiEatCL/yxJnwrpxN1XOtbMtALKgykbOzF+LNevFUG05MxxQR5WVjijXwK/Auf0ce/ei3NISQZLiW+d+IVYPkAQDpbUpH5W/qGDN0W8wT2OGE0bOvrPfDPRhSxeYrcS4mgS7nGvB26sFyeAimgadnxmWaxAveargYKt33jJQhVaA/23kw+/lygQcSN1QJ2mpeHb3ugay0Gv1i/Wd7P&quot;, </div><div class="line">        &quot;ansible_swapfree_mb&quot;: 0, </div><div class="line">        &quot;ansible_swaptotal_mb&quot;: 0, </div><div class="line">        &quot;ansible_system&quot;: &quot;Linux&quot;, </div><div class="line">        &quot;ansible_system_capabilities&quot;: [</div><div class="line">            &quot;&quot;</div><div class="line">        ], </div><div class="line">        &quot;ansible_system_capabilities_enforced&quot;: &quot;True&quot;, </div><div class="line">        &quot;ansible_system_vendor&quot;: &quot;Alibaba Cloud&quot;, </div><div class="line">        &quot;ansible_uptime_seconds&quot;: 11384976, </div><div class="line">        &quot;ansible_user_dir&quot;: &quot;/home/admin&quot;, </div><div class="line">        &quot;ansible_user_gecos&quot;: &quot;&quot;, </div><div class="line">        &quot;ansible_user_gid&quot;: 1000, </div><div class="line">        &quot;ansible_user_id&quot;: &quot;admin&quot;, </div><div class="line">        &quot;ansible_user_shell&quot;: &quot;/bin/bash&quot;, </div><div class="line">        &quot;ansible_user_uid&quot;: 1000, </div><div class="line">        &quot;ansible_userspace_architecture&quot;: &quot;x86_64&quot;, </div><div class="line">        &quot;ansible_userspace_bits&quot;: &quot;64&quot;, </div><div class="line">        &quot;ansible_virtualization_role&quot;: &quot;guest&quot;, </div><div class="line">        &quot;ansible_virtualization_type&quot;: &quot;kvm&quot;, </div><div class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;, </div><div class="line">        &quot;gather_subset&quot;: [</div><div class="line">            &quot;all&quot;</div><div class="line">        ], </div><div class="line">        &quot;module_setup&quot;: true</div><div class="line">    &#125;, </div><div class="line">    &quot;changed&quot;: false</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ansible-xargs-占位符"><a href="#ansible-xargs-占位符" class="headerlink" title="ansible + xargs 占位符"></a>ansible + xargs 占位符</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//批量执行docker exec</div><div class="line">ansible -i host.ini all -m shell -a &quot;docker ps -a | grep pxd-tpcc | grep dn | cut -d &apos; &apos; -f 1 | xargs  -I&#123;&#125; docker exec &#123;&#125; bash -c \&quot;myc -e &apos;shutdown&apos;\&quot;&quot;</div></pre></td></tr></table></figure>
<h2 id="指定ip执行playbook"><a href="#指定ip执行playbook" class="headerlink" title="指定ip执行playbook"></a>指定ip执行playbook</h2><blockquote>
<p>ansible-playbook  -i “10.168.101.179,” all test.yml</p>
</blockquote>
<p>或者：</p>
<blockquote>
<p>ansible -i phy.ini 11.167.60.150 -m shell -a ‘docker run -it -d –net=host -e diamond_server_list=”“ -e diamond_db0=”“ -e diamond_db1=”“ -e diamond_db2=”“ -e HOST_IP=”“ -p 8080:8080 -p 9090:9090 –name diamond  ‘ -vvv</p>
</blockquote>
<p>上面这种还能重用phy.ini中所有的变量配置</p>
<h2 id="创建用户并打通账号"><a href="#创建用户并打通账号" class="headerlink" title="创建用户并打通账号"></a>创建用户并打通账号</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">$cat create_user.yml</div><div class="line"># create user ren with passwd test and sudo privileges.</div><div class="line"># ansible-playbook -i docker.ini create_user.yml</div><div class="line">- hosts: all</div><div class="line">  user: root</div><div class="line">  vars:</div><div class="line">    # created with:</div><div class="line">    # python -c &apos;import crypt; print crypt.crypt(&quot;password&quot;, &quot;$1$SomeSalt$&quot;)&apos;</div><div class="line">    password: $1$SomeSalt$OrX9ouxOCP0ZOpVG9SwnR/</div><div class="line"></div><div class="line">  tasks:</div><div class="line">    - name: create a new user</div><div class="line">      user:</div><div class="line">       name: &apos;&#123;&#123; user &#125;&#125;&apos;</div><div class="line">       password: &apos;&#123;&#123; password &#125;&#125;&apos;</div><div class="line">       home: /home/&#123;&#123; user &#125;&#125;</div><div class="line">       state: present</div><div class="line">       shell: /bin/bash</div><div class="line"></div><div class="line">    - name: Add user to the sudoers</div><div class="line">      copy:</div><div class="line">          dest: &quot;/etc/sudoers.d/&#123;&#123; user &#125;&#125;&quot;</div><div class="line">          content: &quot;&#123;&#123; user &#125;&#125;  ALL=(ALL)  NOPASSWD: ALL&quot;</div><div class="line"></div><div class="line">    - name: Deploy SSH Key</div><div class="line">      authorized_key: user=&#123;&#123; user &#125;&#125;</div><div class="line">           key=&quot;&#123;&#123; lookup(&apos;file&apos;, &apos;/root/.ssh/id_rsa.pub&apos;) &#125;&#125;&quot;</div><div class="line">           state=present</div></pre></td></tr></table></figure>
<p>然后执行： ansible-playbook -i  all.ini create_user.yml -e “user=admin” 。</p>
<p>或者：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"> ansible -i 192.168.2.101, all -m user -a &quot;name=user02 system=yes uid=503 group=root groups=root shell=/etc/nologin home=/home/user02 password=pwd@123&quot;</div><div class="line"> 192.168.2.101 | CHANGED =&gt; &#123;</div><div class="line">    &quot;ansible_facts&quot;: &#123;</div><div class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</div><div class="line">    &#125;, </div><div class="line">    &quot;changed&quot;: true, </div><div class="line">    &quot;comment&quot;: &quot;&quot;, </div><div class="line">    &quot;create_home&quot;: true, </div><div class="line">    &quot;group&quot;: 0, </div><div class="line">    &quot;groups&quot;: &quot;root&quot;, </div><div class="line">    &quot;home&quot;: &quot;/home/user02&quot;, </div><div class="line">    &quot;name&quot;: &quot;user02&quot;, </div><div class="line">    &quot;password&quot;: &quot;NOT_LOGGING_PASSWORD&quot;, </div><div class="line">    &quot;shell&quot;: &quot;/etc/nologin&quot;, </div><div class="line">    &quot;state&quot;: &quot;present&quot;, </div><div class="line">    &quot;system&quot;: true, </div><div class="line">    &quot;uid&quot;: 503</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>playbook task规范：</p>
<p><img src="/images/oss/d502a11765273304abd673fb358b482a.png" alt="image.png"></p>
<p><strong>对齐的时候不能用tab和空格混合</strong></p>
<h2 id="部署docker-daemon的playbook"><a href="#部署docker-daemon的playbook" class="headerlink" title="部署docker daemon的playbook"></a>部署docker daemon的playbook</h2><p>执行 ansible-playbook site.yml -v  -i test.ini -u xijun.rxj -e “project=docker” -p</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line">$cat roles/docker/tasks/main.yml </div><div class="line"># filename: main.yml</div><div class="line">---</div><div class="line">#&quot;****************************************************************************&quot;&quot;</div><div class="line">- name: copy docker execute file to remote</div><div class="line">  copy: src=docker/ dest=/usr/bin/ mode=0755 force=yes</div><div class="line">  tags: copytar</div><div class="line"></div><div class="line">- name: create storage dir</div><div class="line">  file: path=&#123;&#123; storage_dir &#125;&#125; state=directory</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: create the dir</div><div class="line">  file: path=/etc/systemd/system/ state=directory</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: template docker.service to server</div><div class="line">  template: src=docker.service dest=/etc/systemd/system/docker.service</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: template docker.socket to server</div><div class="line">  template: src=docker.socket dest=/usr/lib/systemd/system/docker.socket</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: create /etc/docker dir to server</div><div class="line">  file: path=/etc/docker state=directory</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: copy daemon.json to server</div><div class="line">  template: src=&#123;&#123; inventory_hostname &#125;&#125;/daemon.json dest=/etc/docker/daemon.json</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: copy the load ovs modules to server</div><div class="line">  copy: src=openvswitch.modules dest=/etc/sysconfig/modules/openvswitch.modules mode=0755  force=yes</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: kill docker daemon</div><div class="line">  shell: &quot;kill -9 $(cat /var/run/docker.pid)&quot;</div><div class="line">  ignore_errors: true</div><div class="line">  tags: test</div><div class="line"></div><div class="line">- name: reload systemctl daemon-reload</div><div class="line">  shell: &quot;systemctl daemon-reload&quot;</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: enabled the docker service</div><div class="line">  shell: &quot;systemctl enable docker.service&quot;</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: start docker service</div><div class="line">  shell: &quot;systemctl start docker.service&quot;</div><div class="line"></div><div class="line">- name: remove all containers</div><div class="line">  shell: sudo docker ps -a | awk &apos;&#123;print $1&#125;&apos; | xargs sudo docker rm -f -v</div><div class="line">  ignore_errors: true</div><div class="line"></div><div class="line">- name: template /etc/hosts to server</div><div class="line">  template: src=hosts dest=/etc/hosts owner=root group=root mode=0644 force=yes</div><div class="line">  tags: restorehosts</div><div class="line"></div><div class="line">- name: mkdir /tmp/etc/</div><div class="line">  shell: &quot;mkdir /tmp/etc/ &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  tags: hosts</div><div class="line"></div><div class="line">- name: copy remote /etc/hosts to /tmp</div><div class="line">  shell: &quot;cp /etc/hosts /tmp/etc/ &quot;</div><div class="line">  tags: hosts</div><div class="line"></div><div class="line">- name: copy /etc/hosts to server</div><div class="line">  template: src=etc.host dest=/tmp/etc/ owner=&#123;&#123; remote_user &#125;&#125; group=&#123;&#123; remote_user &#125;&#125; mode=0700 force=yes</div><div class="line">  tags: hosts</div><div class="line"></div><div class="line">- name: merge /etc/hosts</div><div class="line">  assemble: src=/tmp/etc dest=/etc/hosts owner=root group=root mode=0644 force=yes</div><div class="line">  tags: hosts</div><div class="line"></div><div class="line">- name: copy docker_rc.sh to server</div><div class="line">  template: src=docker_rc.sh dest=&#123;&#123; docker_rc_dir &#125;&#125;/docker_rc.sh owner=root group=root mode=0755 force=yes</div><div class="line">  when: use_vxlan!=&quot;true&quot;</div><div class="line">  tags: docker_rc</div><div class="line"></div><div class="line">- name: copy docker_rc.sh to server</div><div class="line">  template: src=docker_rc_vm.sh dest=&#123;&#123; docker_rc_dir &#125;&#125;/docker_rc.sh owner=root group=root mode=0755 force=yes</div><div class="line">  when: use_vxlan==&quot;true&quot;</div><div class="line">  tags: docker_rc</div><div class="line"></div><div class="line">- name: clean docker_rc in rc.local</div><div class="line">  command: su - root -c &quot; sed -i &apos;/docker_rc.sh/d&apos; /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div><div class="line">  tags: docker_rc</div><div class="line"></div><div class="line">- name: start the docker when the system reboot</div><div class="line">  command: su - root -c &quot; echo &apos;su - root -c \&quot;&#123;&#123; docker_rc_dir &#125;&#125;/docker_rc.sh\&quot; &apos; &gt;&gt; /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div><div class="line">  tags: docker_rc</div><div class="line"></div><div class="line">- name: chown the /etc/rc.d/rc.local</div><div class="line">  shell: &quot;chmod +x /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div><div class="line">  tags: docker_rc</div><div class="line"></div><div class="line">- name: clean previous space occupier</div><div class="line">  file: path=&#123;&#123; storage_dir &#125;&#125;/ark.disk&#123;&#123; item &#125;&#125;.tmp state=absent</div><div class="line">  with_items:</div><div class="line">    - 1</div><div class="line">    - 2</div><div class="line">  ignore_errors: true</div><div class="line">  tags: docker</div><div class="line"></div><div class="line">- name: Occupy space for docker</div><div class="line">  shell: &quot;dd if=/dev/zero of=&#123;&#123; storage_dir &#125;&#125;/ark.disk&#123;&#123; item &#125;&#125;.tmp bs=1M count=1024&quot;</div><div class="line">  sudo: yes</div><div class="line">  with_items:</div><div class="line">    - 1</div><div class="line">    - 2</div><div class="line">  tags: docker</div></pre></td></tr></table></figure>
<h2 id="部署zk"><a href="#部署zk" class="headerlink" title="部署zk"></a>部署zk</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">$cat roles/zookeeper/tasks/main.yml</div><div class="line"># filename: main.yml</div><div class="line">---</div><div class="line">#&quot;****************************************************************************&quot;&quot;</div><div class="line">- name: extract zookeeper tgz</div><div class="line">  unarchive: src=&#123;&#123; packages_dir &#125;&#125;/lib/&#123;&#123; zk_package_name &#125;&#125; dest=/opt</div><div class="line">  sudo: yes</div><div class="line"></div><div class="line">- name: create zk data and log dir</div><div class="line">  file: path=&#123;&#123; zk_data_dir &#125;&#125; state=directory mode=0755</div><div class="line">  with_items:</div><div class="line">    - &quot;&#123;&#123; zk_data_dir &#125;&#125;&quot;</div><div class="line">    - &quot;&#123;&#123; zk_logs_dir &#125;&#125;&quot;</div><div class="line"></div><div class="line">- name: set the myid</div><div class="line">  template: src=myid dest=&#123;&#123; zk_myid_file &#125;&#125;  mode=0644</div><div class="line"></div><div class="line">- name: template zoo.cfg</div><div class="line">  template: src=zoo.cfg dest=&#123;&#123; zk_install_dir &#125;&#125;/conf/ mode=0644</div><div class="line"></div><div class="line">- name: copy log4j to remote</div><div class="line">  template: src=log4j.properties dest=&#123;&#123; zk_install_dir &#125;&#125;/conf/log4j.properties</div><div class="line"></div><div class="line">- name: determine zk process</div><div class="line">  command: su - root -c &quot;ps aux | grep java | grep -v grep | grep &#123;&#123; zk_install_dir &#125;&#125;&quot;</div><div class="line">  register: result</div><div class="line">  ignore_errors: true</div><div class="line"></div><div class="line">- name: stop zk server</div><div class="line">  command: su - root -c &quot;sh &#123;&#123; zk_install_dir &#125;&#125;/bin/zkServer.sh  stop&quot;</div><div class="line">  ignore_errors: true</div><div class="line">  when: &quot;result.rc == 0&quot;</div><div class="line"></div><div class="line">- name: start zk server</div><div class="line">  command: su - root -c &quot;sh &#123;&#123; zk_install_dir &#125;&#125;/bin/zkServer.sh start&quot;</div><div class="line"></div><div class="line">- name: get process info</div><div class="line">  command: su - root -c &quot;ps aux | grep java | grep -v grep | grep &#123;&#123; zk_install_dir &#125;&#125;&quot;</div><div class="line">  register: result</div><div class="line"></div><div class="line">- name: clean zk service when the system reboot</div><div class="line">  command: su - root -c &quot; sed -i &apos;/&#123;&#123; zk_dir_name &#125;&#125;/d&apos; /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div><div class="line"></div><div class="line">- name: start the zk service when the system reboot</div><div class="line">  command: su - root -c &quot; echo &apos;su - root -c \&quot;&#123;&#123; zk_install_dir &#125;&#125;/bin/zkServer.sh start\&quot; &apos; &gt;&gt; /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div><div class="line"></div><div class="line">- name: start the zk service when the system reboot</div><div class="line">  shell: &quot;chmod +x /etc/rc.d/rc.local &quot;</div><div class="line">  ignore_errors: true</div><div class="line">  sudo: yes</div></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.mydailytutorials.com/how-to-copy-files-and-directories-in-ansible-using-copy-and-fetch-modules/" target="_blank" rel="external">How to Copy Files and Directories in Ansible Using Copy and Fetch Modules</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="twitter @plantegg" />
          <p class="site-author-name" itemprop="name">twitter @plantegg</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">161</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">252</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">twitter @plantegg</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv_footer"></span>次
</span>
<span id="busuanzi_container_site_uv">
  本站访客数<span id="busuanzi_value_site_uv_footer"></span>人次
</span>


        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
