<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="CPU,perf,IPC,branch_miss," />





  <link rel="alternate" href="/atom.xml" title="plantegg" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="比较不同CPU下的分支预测目的本文通过一段对分支预测是否友好的代码来验证 branch load miss 差异，已经最终带来的 性能差异。同时在x86和aarch64 下各选几款CPU共5款进行差异性对比 CPU 情况intel x86123456789101112131415161718192021222324252627#lscpuArchitecture:          x86_64C">
<meta name="keywords" content="CPU,perf,IPC,branch_miss">
<meta property="og:type" content="article">
<meta property="og:title" content="比较不同CPU下的分支预测">
<meta property="og:url" content="https://plantegg.github.io/2023/04/16/比较不同CPU下的分支预测/index.html">
<meta property="og:site_name" content="plantegg">
<meta property="og:description" content="比较不同CPU下的分支预测目的本文通过一段对分支预测是否友好的代码来验证 branch load miss 差异，已经最终带来的 性能差异。同时在x86和aarch64 下各选几款CPU共5款进行差异性对比 CPU 情况intel x86123456789101112131415161718192021222324252627#lscpuArchitecture:          x86_64C">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20230308145915585.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/v2-475f184ea376484878515491a120bf49_1440w.png">
<meta property="og:updated_time" content="2023-05-06T13:09:48.218Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="比较不同CPU下的分支预测">
<meta name="twitter:description" content="比较不同CPU下的分支预测目的本文通过一段对分支预测是否友好的代码来验证 branch load miss 差异，已经最终带来的 性能差异。同时在x86和aarch64 下各选几款CPU共5款进行差异性对比 CPU 情况intel x86123456789101112131415161718192021222324252627#lscpuArchitecture:          x86_64C">
<meta name="twitter:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20230308145915585.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://plantegg.github.io/2023/04/16/比较不同CPU下的分支预测/"/>





  <title>比较不同CPU下的分支预测 | plantegg</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">plantegg</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">java tcp mysql performance network docker Linux</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-categories"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2023/04/16/比较不同CPU下的分支预测/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="twitter @plantegg">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">比较不同CPU下的分支预测</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-04-16T12:30:03+08:00">
                2023-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CPU/" itemprop="url" rel="index">
                    <span itemprop="name">CPU</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="比较不同CPU下的分支预测"><a href="#比较不同CPU下的分支预测" class="headerlink" title="比较不同CPU下的分支预测"></a>比较不同CPU下的分支预测</h1><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>本文通过一段对分支预测是否友好的代码来验证 branch load miss 差异，已经最终带来的 性能差异。同时在x86和aarch64 下各选几款CPU共5款进行差异性对比</p>
<h2 id="CPU-情况"><a href="#CPU-情况" class="headerlink" title="CPU 情况"></a>CPU 情况</h2><h3 id="intel-x86"><a href="#intel-x86" class="headerlink" title="intel x86"></a>intel x86</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">#lscpu</div><div class="line">Architecture:          x86_64</div><div class="line">CPU op-mode(s):        32-bit, 64-bit</div><div class="line">Byte Order:            Little Endian</div><div class="line">CPU(s):                48</div><div class="line">On-line CPU(s) list:   0-47</div><div class="line">Thread(s) per core:    1</div><div class="line">Core(s) per socket:    24</div><div class="line">Socket(s):             2</div><div class="line">NUMA node(s):          2</div><div class="line">Vendor ID:             GenuineIntel</div><div class="line">CPU family:            6</div><div class="line">Model:                 85</div><div class="line">Model name:            Intel(R) Xeon(R) Platinum 8163 CPU @ 2.50GHz</div><div class="line">Stepping:              4</div><div class="line">CPU MHz:               2500.195</div><div class="line">CPU max MHz:           3100.0000</div><div class="line">CPU min MHz:           1000.0000</div><div class="line">BogoMIPS:              4998.89</div><div class="line">Virtualization:        VT-x</div><div class="line">L1d cache:             32K</div><div class="line">L1i cache:             32K</div><div class="line">L2 cache:              1024K</div><div class="line">L3 cache:              33792K</div><div class="line">NUMA node0 CPU(s):     0-23</div><div class="line">NUMA node1 CPU(s):     24-47</div><div class="line">Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch ida arat epb invpcid_single pln pts dtherm spec_ctrl ibpb_support tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm cqm mpx rdt avx512f avx512dq rdseed adx smap clflushopt avx512cd avx512bw avx512vl xsaveopt xsavec xgetbv1 cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local cat_l3 mba</div></pre></td></tr></table></figure>
<h3 id="hygon-7260"><a href="#hygon-7260" class="headerlink" title="hygon 7260"></a>hygon 7260</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">#lscpu</div><div class="line">Architecture:        x86_64</div><div class="line">CPU op-mode(s):      32-bit, 64-bit</div><div class="line">Byte Order:          Little Endian</div><div class="line">Address sizes:       43 bits physical, 48 bits virtual</div><div class="line">CPU(s):              48</div><div class="line">On-line CPU(s) list: 0-47</div><div class="line">Thread(s) per core:  1</div><div class="line">Core(s) per socket:  24</div><div class="line">Socket(s):           2</div><div class="line">NUMA node(s):        8</div><div class="line">Vendor ID:           HygonGenuine</div><div class="line">CPU family:          24</div><div class="line">Model:               1</div><div class="line">Model name:          Hygon C86 7260 24-core Processor</div><div class="line">Stepping:            1</div><div class="line">Frequency boost:     enabled</div><div class="line">CPU MHz:             1069.534</div><div class="line">CPU max MHz:         2200.0000</div><div class="line">CPU min MHz:         1200.0000</div><div class="line">BogoMIPS:            4399.38</div><div class="line">Virtualization:      AMD-V</div><div class="line">L1d cache:           32K</div><div class="line">L1i cache:           64K</div><div class="line">L2 cache:            512K</div><div class="line">L3 cache:            8192K</div><div class="line">NUMA node0 CPU(s):   0-5</div><div class="line">NUMA node1 CPU(s):   6-11</div><div class="line">NUMA node2 CPU(s):   12-17</div><div class="line">NUMA node3 CPU(s):   18-23</div><div class="line">NUMA node4 CPU(s):   24-29</div><div class="line">NUMA node5 CPU(s):   30-35</div><div class="line">NUMA node6 CPU(s):   36-41</div><div class="line">NUMA node7 CPU(s):   42-47</div></pre></td></tr></table></figure>
<h3 id="ARM-鲲鹏920"><a href="#ARM-鲲鹏920" class="headerlink" title="ARM 鲲鹏920"></a>ARM 鲲鹏920</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">#lscpu</div><div class="line">Architecture:          aarch64</div><div class="line">Byte Order:            Little Endian</div><div class="line">CPU(s):                96</div><div class="line">On-line CPU(s) list:   0-95</div><div class="line">Thread(s) per core:    1</div><div class="line">Core(s) per socket:    48</div><div class="line">Socket(s):             2</div><div class="line">NUMA node(s):          4</div><div class="line">Model:                 0</div><div class="line">CPU max MHz:           2600.0000</div><div class="line">CPU min MHz:           200.0000</div><div class="line">BogoMIPS:              200.00</div><div class="line">L1d cache:             64K</div><div class="line">L1i cache:             64K</div><div class="line">L2 cache:              512K</div><div class="line">L3 cache:              24576K</div><div class="line">NUMA node0 CPU(s):     0-23</div><div class="line">NUMA node1 CPU(s):     24-47</div><div class="line">NUMA node2 CPU(s):     48-71</div><div class="line">NUMA node3 CPU(s):     72-95</div><div class="line">Flags:                 fp asimd evtstrm aes pmull sha1 sha2 crc32 atomics fphp asimdhp cpuid asimdrdm jscvt fcma dcpop asimddp asimdfhm</div></pre></td></tr></table></figure>
<h3 id="ARM-M710"><a href="#ARM-M710" class="headerlink" title="ARM M710"></a>ARM M710</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#lscpu</div><div class="line">Architecture:          aarch64</div><div class="line">Byte Order:            Little Endian</div><div class="line">CPU(s):                128</div><div class="line">On-line CPU(s) list:   0-127</div><div class="line">Thread(s) per core:    1</div><div class="line">Core(s) per socket:    128</div><div class="line">Socket(s):             1</div><div class="line">NUMA node(s):          2</div><div class="line">Model:                 0</div><div class="line">BogoMIPS:              100.00</div><div class="line">L1d cache:             64K</div><div class="line">L1i cache:             64K</div><div class="line">L2 cache:              1024K</div><div class="line">L3 cache:              65536K</div><div class="line">NUMA node0 CPU(s):     0-63</div><div class="line">NUMA node1 CPU(s):     64-127</div><div class="line">Flags:                 fp asimd evtstrm aes pmull sha1 sha2 crc32 atomics fphp asimdhp cpuid asimdrdm jscvt fcma lrcpc dcpop sha3 sm3 sm4 asimddp sha512 sve asimdfhm dit uscat ilrcpc flagm ssbs sb dcpodp sve2 sveaes svepmull svebitperm svesha3 svesm4 flagm2 frint svei8mm svebf16 i8mm bf16 dgh</div></pre></td></tr></table></figure>
<h3 id="ARM-FT-S2500"><a href="#ARM-FT-S2500" class="headerlink" title="ARM FT S2500"></a>ARM FT S2500</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">#lscpu</div><div class="line">Architecture:          aarch64</div><div class="line">Byte Order:            Little Endian</div><div class="line">CPU(s):                128</div><div class="line">On-line CPU(s) list:   0-127</div><div class="line">Thread(s) per core:    1</div><div class="line">Core(s) per socket:    64</div><div class="line">Socket(s):             2</div><div class="line">NUMA node(s):          16</div><div class="line">Model:                 3</div><div class="line">BogoMIPS:              100.00</div><div class="line">L1d cache:             32K</div><div class="line">L1i cache:             32K</div><div class="line">L2 cache:              2048K</div><div class="line">L3 cache:              65536K</div><div class="line">NUMA node0 CPU(s):     0-7</div><div class="line">NUMA node1 CPU(s):     8-15</div><div class="line">NUMA node2 CPU(s):     16-23</div><div class="line">NUMA node3 CPU(s):     24-31</div><div class="line">NUMA node4 CPU(s):     32-39</div><div class="line">NUMA node5 CPU(s):     40-47</div><div class="line">NUMA node6 CPU(s):     48-55</div><div class="line">NUMA node7 CPU(s):     56-63</div><div class="line">NUMA node8 CPU(s):     64-71</div><div class="line">NUMA node9 CPU(s):     72-79</div><div class="line">NUMA node10 CPU(s):    80-87</div><div class="line">NUMA node11 CPU(s):    88-95</div><div class="line">NUMA node12 CPU(s):    96-103</div><div class="line">NUMA node13 CPU(s):    104-111</div><div class="line">NUMA node14 CPU(s):    112-119</div><div class="line">NUMA node15 CPU(s):    120-127</div><div class="line">Flags:                 fp asimd evtstrm aes pmull sha1 sha2 crc32 cpuid</div></pre></td></tr></table></figure>
<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a><a href="https://stackoverflow.com/questions/11227809/why-is-processing-a-sorted-array-faster-than-processing-an-unsorted-array" target="_blank" rel="external">测试代码</a></h2><p>对一个数组中较大的一半的值累加：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 随机产生整数，用分区函数填充，以避免出现分桶不均</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> arraySize = <span class="number">32768</span>;</div><div class="line">    <span class="keyword">int</span> data[arraySize];</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> c = <span class="number">0</span>; c &lt; arraySize; ++c)</div><div class="line">        data[c] = <span class="built_in">std</span>::rand() % <span class="number">256</span>;</div><div class="line"></div><div class="line">    <span class="comment">//排序后数据有序，CPU可以准确预测到if的分支</span></div><div class="line">    <span class="built_in">std</span>::sort(data, data + arraySize); <span class="comment">//预先排序，也可以注释掉，注释掉表示随机乱序几乎无法预测</span></div><div class="line"></div><div class="line">    <span class="comment">// 测试部分</span></div><div class="line">    <span class="keyword">clock_t</span> start = clock();</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> sum = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; ++i)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// 主要计算部分，选一半元素参与计算</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">unsigned</span> c = <span class="number">0</span>; c &lt; arraySize; ++c)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (data[c] &gt;= <span class="number">128</span>)</div><div class="line">                sum += data[c];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">double</span> elapsedTime = <span class="keyword">static_cast</span>&lt;<span class="keyword">double</span>&gt;(clock() - start) / CLOCKS_PER_SEC;</div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; elapsedTime &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"sum = "</span> &lt;&lt; sum &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上代码可以注释掉第15行，也就是不对代码排序直接累加，不排序的话 if (data[c] &gt;= 128) 有50% 概率成立，排序后前一半元素if都不成立，后一半元素if都成立，导致CPU流水线很好预测后面的代码，可以提前加载运算打高IPC</p>
<h2 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h2><h3 id="aarch64-鲲鹏920"><a href="#aarch64-鲲鹏920" class="headerlink" title="aarch64 鲲鹏920"></a>aarch64 鲲鹏920</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-store-misses,L1-dcache-stores,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./aftersort</div><div class="line">11.44</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">           470,740      branch-misses                                                 (59.99%)</div><div class="line">    29,716,627,485      bus-cycles                # 2595.890 M/sec                    (60.03%)</div><div class="line">        96,469,435      cache-misses              #    0.420 % of all cache refs      (60.03%)</div><div class="line">    22,984,316,728      cache-references          # 2007.791 M/sec                    (60.03%)</div><div class="line">    29,716,018,641      cpu-cycles                #    2.596 GHz                      (65.02%)</div><div class="line">    83,666,813,837      instructions              #    2.82  insn per cycle</div><div class="line">                                                  #    0.10  stalled cycles per insn  (65.02%)</div><div class="line">     8,765,807,804      stalled-cycles-backend    #   29.50% backend cycles idle      (65.02%)</div><div class="line">         8,917,112      stalled-cycles-frontend   #    0.03% frontend cycles idle     (65.02%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                 0      bpf-output                #    0.000 K/sec</div><div class="line">                 5      context-switches          #    0.000 K/sec</div><div class="line">         11,447.57 msec cpu-clock                 #    1.000 CPUs utilized</div><div class="line">                 0      cpu-migrations            #    0.000 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               132      minor-faults              #    0.012 K/sec</div><div class="line">               132      page-faults               #    0.012 K/sec</div><div class="line">         11,447.57 msec task-clock                #    1.000 CPUs utilized</div><div class="line">        96,471,779      L1-dcache-load-misses     #    0.42% of all L1-dcache accesses  (65.02%)</div><div class="line">    22,985,408,745      L1-dcache-loads           # 2007.886 M/sec                    (65.02%)</div><div class="line">        96,472,614      L1-dcache-store-misses    #    8.427 M/sec                    (65.02%)</div><div class="line">    22,986,056,706      L1-dcache-stores          # 2007.943 M/sec                    (65.02%)</div><div class="line">           184,402      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (65.02%)</div><div class="line">    14,779,996,797      L1-icache-loads           # 1291.104 M/sec                    (64.99%)</div><div class="line">           330,651      branch-load-misses        #    0.029 M/sec                    (64.96%)</div><div class="line">     6,561,353,921      branch-loads              #  573.166 M/sec                    (64.96%)</div><div class="line">         3,464,612      dTLB-load-misses          #    0.02% of all dTLB cache accesses  (64.96%)</div><div class="line">    23,008,097,187      dTLB-loads                # 2009.868 M/sec                    (59.96%)</div><div class="line">               745      iTLB-load-misses          #    0.00% of all iTLB cache accesses  (59.96%)</div><div class="line">    14,779,577,851      iTLB-loads                # 1291.067 M/sec                    (59.96%)</div><div class="line">    </div><div class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-store-misses,L1-dcache-stores,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./beforesort</div><div class="line">30.92</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">     1,639,558,981      branch-misses                                                 (59.96%)</div><div class="line">    80,284,783,419      bus-cycles                # 2595.949 M/sec                    (59.96%)</div><div class="line">       118,459,436      cache-misses              #    0.356 % of all cache refs      (59.96%)</div><div class="line">    33,285,701,200      cache-references          # 1076.269 M/sec                    (59.96%)</div><div class="line">    80,283,427,379      cpu-cycles                #    2.596 GHz                      (64.96%)</div><div class="line">    83,694,841,472      instructions              #    1.04  insn per cycle</div><div class="line">                                                  #    0.11  stalled cycles per insn  (64.98%)</div><div class="line">     8,849,746,372      stalled-cycles-backend    #   11.02% backend cycles idle      (64.99%)</div><div class="line">     8,064,207,583      stalled-cycles-frontend   #   10.04% frontend cycles idle     (65.00%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                 0      bpf-output                #    0.000 K/sec</div><div class="line">                10      context-switches          #    0.000 K/sec</div><div class="line">         30,926.95 msec cpu-clock                 #    1.000 CPUs utilized</div><div class="line">                 0      cpu-migrations            #    0.000 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               133      minor-faults              #    0.004 K/sec</div><div class="line">               133      page-faults               #    0.004 K/sec</div><div class="line">         30,926.95 msec task-clock                #    1.000 CPUs utilized</div><div class="line">       118,445,576      L1-dcache-load-misses     #    0.36% of all L1-dcache accesses  (65.02%)</div><div class="line">    33,286,586,418      L1-dcache-loads           # 1076.297 M/sec                    (65.03%)</div><div class="line">       118,441,599      L1-dcache-store-misses    #    3.830 M/sec                    (65.04%)</div><div class="line">    33,286,751,407      L1-dcache-stores          # 1076.302 M/sec                    (65.05%)</div><div class="line">           410,040      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (65.05%)</div><div class="line">    51,611,031,810      L1-icache-loads           # 1668.805 M/sec                    (65.04%)</div><div class="line">     1,639,731,725      branch-load-misses        #   53.020 M/sec                    (65.03%)</div><div class="line">     7,520,634,791      branch-loads              #  243.174 M/sec                    (65.02%)</div><div class="line">         3,536,061      dTLB-load-misses          #    0.01% of all dTLB cache accesses  (65.00%)</div><div class="line">    47,898,134,543      dTLB-loads                # 1548.751 M/sec                    (59.99%)</div><div class="line">             2,529      iTLB-load-misses          #    0.00% of all iTLB cache accesses  (59.97%)</div><div class="line">    51,612,575,118      iTLB-loads                # 1668.854 M/sec                    (59.96%)</div></pre></td></tr></table></figure>
<p>以上在相同CPU下数据对比可以看到核心差异是branch-load-misses和branch-misses，当然最终也体现在 IPC 数值上，排序后IPC更高不是因为数据有序取起来更快，而是因为执行逻辑更容易提前预测，也就是可以提前加载if代码到cache中。符合预期</p>
<h3 id="aarch64-M710"><a href="#aarch64-M710" class="headerlink" title="aarch64 M710"></a>aarch64 M710</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-icache-load-misses,L1-icache-loads,LLC-load-misses,LLC-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./aftersort</div><div class="line">8.20237</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">           912,836      branch-misses                                                 (29.86%)</div><div class="line">    22,560,165,604      bus-cycles                # 2748.461 M/sec                    (29.91%)</div><div class="line">       205,068,961      cache-misses              #    0.892 % of all cache refs      (29.96%)</div><div class="line">    22,998,186,284      cache-references          # 2801.824 M/sec                    (30.01%)</div><div class="line">    22,559,518,941      cpu-cycles                #    2.748 GHz                      (35.03%)</div><div class="line">    77,068,271,833      instructions              #    3.42  insn per cycle</div><div class="line">                                                  #    0.06  stalled cycles per insn  (35.08%)</div><div class="line">     4,892,933,264      stalled-cycles-backend    #   21.69% backend cycles idle      (35.13%)</div><div class="line">     1,103,203,963      stalled-cycles-frontend   #    4.89% frontend cycles idle     (35.13%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                 0      bpf-output                #    0.000 K/sec</div><div class="line">                17      context-switches          #    0.002 K/sec</div><div class="line">          8,208.29 msec cpu-clock                 #    1.000 CPUs utilized</div><div class="line">                 3      cpu-migrations            #    0.000 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               227      minor-faults              #    0.028 K/sec</div><div class="line">               227      page-faults               #    0.028 K/sec</div><div class="line">          8,208.30 msec task-clock                #    1.000 CPUs utilized</div><div class="line">       205,384,990      L1-dcache-load-misses     #    0.89% of all L1-dcache accesses  (35.13%)</div><div class="line">    22,997,494,522      L1-dcache-loads           # 2801.739 M/sec                    (35.13%)</div><div class="line">            66,804      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (35.13%)</div><div class="line">    15,486,704,750      L1-icache-loads           # 1886.715 M/sec                    (30.12%)</div><div class="line">            76,066      LLC-load-misses           #    0.00% of all LL-cache accesses  (30.09%)</div><div class="line">                 0      LLC-loads                 #    0.000 K/sec                    (30.03%)</div><div class="line">           672,231      branch-load-misses        #    0.082 M/sec                    (29.98%)</div><div class="line">     9,844,109,024      branch-loads              # 1199.288 M/sec                    (29.93%)</div><div class="line">           107,198      dTLB-load-misses          #    0.00% of all dTLB cache accesses  (29.89%)</div><div class="line">    22,998,647,232      dTLB-loads                # 2801.880 M/sec                    (29.84%)</div><div class="line">             9,497      iTLB-load-misses          #    0.08% of all iTLB cache accesses  (29.81%)</div><div class="line">        11,755,825      iTLB-loads                #    1.432 M/sec                    (29.82%)</div><div class="line"></div><div class="line">       8.210235171 seconds time elapsed</div><div class="line"></div><div class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-icache-load-misses,L1-icache-loads,LLC-load-misses,LLC-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./beforesort</div><div class="line">16.8872</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">     1,229,182,485      branch-misses                                                 (29.93%)</div><div class="line">    46,401,675,872      bus-cycles                # 2747.200 M/sec                    (29.95%)</div><div class="line">       206,116,950      cache-misses              #    0.546 % of all cache refs      (29.97%)</div><div class="line">    37,773,036,315      cache-references          # 2236.343 M/sec                    (30.01%)</div><div class="line">    46,410,071,081      cpu-cycles                #    2.748 GHz                      (35.03%)</div><div class="line">    77,083,625,280      instructions              #    1.66  insn per cycle</div><div class="line">                                                  #    0.06  stalled cycles per insn  (35.07%)</div><div class="line">     1,961,071,890      stalled-cycles-backend    #    4.23% backend cycles idle      (35.11%)</div><div class="line">     4,988,241,014      stalled-cycles-frontend   #   10.75% frontend cycles idle     (35.11%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                 0      bpf-output                #    0.000 K/sec</div><div class="line">             1,100      context-switches          #    0.065 K/sec</div><div class="line">         16,890.39 msec cpu-clock                 #    0.997 CPUs utilized</div><div class="line">                 7      cpu-migrations            #    0.000 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               229      minor-faults              #    0.014 K/sec</div><div class="line">               229      page-faults               #    0.014 K/sec</div><div class="line">         16,890.69 msec task-clock                #    0.997 CPUs utilized</div><div class="line">       205,761,970      L1-dcache-load-misses     #    0.54% of all L1-dcache accesses  (35.09%)</div><div class="line">    37,832,336,945      L1-dcache-loads           # 2239.854 M/sec                    (35.06%)</div><div class="line">           207,158      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (35.04%)</div><div class="line">    41,944,228,741      L1-icache-loads           # 2483.298 M/sec                    (30.00%)</div><div class="line">           135,144      LLC-load-misses           #    0.00% of all LL-cache accesses  (29.97%)</div><div class="line">                 0      LLC-loads                 #    0.000 K/sec                    (29.97%)</div><div class="line">     1,232,325,180      branch-load-misses        #   72.960 M/sec                    (29.96%)</div><div class="line">    14,776,289,690      branch-loads              #  874.827 M/sec                    (29.96%)</div><div class="line">           177,790      dTLB-load-misses          #    0.00% of all dTLB cache accesses  (29.97%)</div><div class="line">    37,839,288,998      dTLB-loads                # 2240.266 M/sec                    (29.95%)</div><div class="line">            46,301      iTLB-load-misses          #    0.00% of all iTLB cache accesses  (29.94%)</div><div class="line">    12,631,307,441      iTLB-loads                #  747.833 M/sec                    (29.92%)</div><div class="line"></div><div class="line">      16.943678377 seconds time elapsed</div></pre></td></tr></table></figure>
<p>M710上排序与否和鲲鹏差不多，但是 M710比 鲲鹏要快一些，差别只要有主频高一点点(6%)，另外M710编译后的指令数量也略少(8%)。</p>
<p>最大的差别是没有排序的话 branch-load-misses(1,232,325,180)/branch-loads(14,776,289,690) 比例只有鲲鹏的50%，导致整体 IPC 比鲲鹏高不少(1.66 VS 1.04)</p>
<p>如果是排序后的数据来看 M710比鲲鹏好40%，IPC 好了20%，iTLB-loads 差异特别大</p>
<h3 id="aarch64-FT-S2500"><a href="#aarch64-FT-S2500" class="headerlink" title="aarch64 FT S2500"></a>aarch64 FT S2500</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-store-misses,L1-dcache-stores,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,iTLB-load-misses ./aftersort</div><div class="line">16.63</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">         1,298,873      branch-misses             #    0.078 M/sec                    (37.49%)</div><div class="line">    34,893,306,641      bus-cycles                # 2096.049 M/sec                    (37.51%)</div><div class="line">       211,447,452      cache-misses              #    0.913 % of all cache refs      (37.53%)</div><div class="line">    23,154,909,673      cache-references          # 1390.921 M/sec                    (37.54%)</div><div class="line">    34,891,766,353      cpu-cycles                #    2.096 GHz                      (43.79%)</div><div class="line">    83,918,069,835      instructions              #    2.41  insns per cycle          (43.79%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">               102      context-switches          #    0.006 K/sec</div><div class="line">      16647.131540      cpu-clock (msec)</div><div class="line">                35      cpu-migrations            #    0.002 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               384      minor-faults              #    0.023 K/sec</div><div class="line">               384      page-faults               #    0.023 K/sec</div><div class="line">      16647.178560      task-clock (msec)         #    1.000 CPUs utilized</div><div class="line">       211,277,069      L1-dcache-load-misses     #    0.91% of all L1-dcache hits    (43.79%)</div><div class="line">    23,168,806,437      L1-dcache-loads           # 1391.756 M/sec                    (43.77%)</div><div class="line">       211,376,611      L1-dcache-store-misses    #   12.697 M/sec                    (43.75%)</div><div class="line">    23,172,492,978      L1-dcache-stores          # 1391.977 M/sec                    (43.73%)</div><div class="line">         6,060,438      L1-icache-load-misses     #    0.364 M/sec                    (43.72%)</div><div class="line">    23,283,174,318      L1-icache-loads           # 1398.626 M/sec                    (37.48%)</div><div class="line">         1,201,268      branch-load-misses        #    0.072 M/sec                    (37.47%)</div><div class="line">     6,626,003,512      branch-loads              #  398.026 M/sec                    (37.47%)</div><div class="line">         4,417,981      dTLB-load-misses          #    0.265 M/sec                    (37.47%)</div><div class="line">            58,242      iTLB-load-misses          #    0.003 M/sec                    (37.47%)</div><div class="line"></div><div class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-store-misses,L1-dcache-stores,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,iTLB-load-misses ./beforesort</div><div class="line">39.8</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">     1,641,714,982      branch-misses             #   41.244 M/sec                    (37.50%)</div><div class="line">    83,450,971,727      bus-cycles                # 2096.514 M/sec                    (37.51%)</div><div class="line">       209,942,920      cache-misses              #    0.625 % of all cache refs      (37.51%)</div><div class="line">    33,584,108,027      cache-references          #  843.724 M/sec                    (37.51%)</div><div class="line">    83,446,991,284      cpu-cycles                #    2.096 GHz                      (43.76%)</div><div class="line">    83,872,213,462      instructions              #    1.01  insns per cycle          (43.75%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">               165      context-switches          #    0.004 K/sec</div><div class="line">      39804.395840      cpu-clock (msec)</div><div class="line">               104      cpu-migrations            #    0.003 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               728      minor-faults              #    0.018 K/sec</div><div class="line">               728      page-faults               #    0.018 K/sec</div><div class="line">      39804.626860      task-clock (msec)         #    1.000 CPUs utilized</div><div class="line">       209,884,485      L1-dcache-load-misses     #    0.62% of all L1-dcache hits    (43.75%)</div><div class="line">    33,591,847,895      L1-dcache-loads           #  843.918 M/sec                    (43.75%)</div><div class="line">       209,796,158      L1-dcache-store-misses    #    5.271 M/sec                    (43.75%)</div><div class="line">    33,595,628,139      L1-dcache-stores          #  844.013 M/sec                    (43.75%)</div><div class="line">         5,575,802      L1-icache-load-misses     #    0.140 M/sec                    (43.75%)</div><div class="line">    68,272,798,305      L1-icache-loads           # 1715.198 M/sec                    (37.50%)</div><div class="line">     1,642,653,627      branch-load-misses        #   41.268 M/sec                    (37.50%)</div><div class="line">     6,846,418,902      branch-loads              #  172.001 M/sec                    (37.50%)</div><div class="line">         4,162,728      dTLB-load-misses          #    0.105 M/sec                    (37.50%)</div><div class="line">            57,375      iTLB-load-misses          #    0.001 M/sec                    (37.50%)</div></pre></td></tr></table></figure>
<h3 id="Intel-x86-8163"><a href="#Intel-x86-8163" class="headerlink" title="Intel x86 8163"></a>Intel x86 8163</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">#perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores ./aftersort</div><div class="line">9.77</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">     6,541,060,672      branch-instructions       #  669.204 M/sec                    (10.72%)</div><div class="line">           727,847      branch-misses             #    0.01% of all branches          (14.30%)</div><div class="line">       241,730,862      bus-cycles                #   24.731 M/sec                    (17.88%)</div><div class="line">           275,443      cache-misses              #   44.685 % of all cache refs      (21.45%)</div><div class="line">           616,413      cache-references          #    0.063 M/sec                    (25.03%)</div><div class="line">    24,186,369,646      cpu-cycles                #    2.474 GHz                      (28.60%)</div><div class="line">    29,491,804,977      instructions              #    1.22  insns per cycle          (32.18%)</div><div class="line">    24,198,780,299      ref-cycles                # 2475.731 M/sec                    (35.75%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                16      context-switches          #    0.002 K/sec</div><div class="line">       9774.393202      cpu-clock (msec)</div><div class="line">                 8      cpu-migrations            #    0.001 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               490      minor-faults              #    0.050 K/sec</div><div class="line">               490      page-faults               #    0.050 K/sec</div><div class="line">       9774.396556      task-clock (msec)         #    1.001 CPUs utilized</div><div class="line">        74,078,676      L1-dcache-load-misses     #    1.64% of all L1-dcache hits    (189256748561.94%)</div><div class="line">     4,515,522,850      L1-dcache-loads           #  461.975 M/sec                    (189237344482.16%)</div><div class="line">         3,798,032      L1-dcache-stores          #    0.389 M/sec                    (189217941721.85%)</div><div class="line">         1,077,146      L1-icache-load-misses     #    0.110 M/sec                    (189198537875.18%)</div><div class="line">            89,144      LLC-load-misses           #   74.54% of all LL-cache hits     (189179139811.86%)</div><div class="line">           119,586      LLC-loads                 #    0.012 M/sec                    (189159737036.24%)</div><div class="line">             3,450      LLC-store-misses          #    0.353 K/sec                    (189140342885.02%)</div><div class="line">           105,021      LLC-stores                #    0.011 M/sec                    (7.15%)</div><div class="line">           458,465      branch-load-misses        #    0.047 M/sec                    (10.73%)</div><div class="line">     6,557,558,579      branch-loads              #  670.891 M/sec                    (14.30%)</div><div class="line">               733      dTLB-load-misses          #    0.00% of all dTLB cache hits   (17.87%)</div><div class="line">    12,039,967,837      dTLB-loads                # 1231.786 M/sec                    (21.44%)</div><div class="line">               104      dTLB-store-misses         #    0.011 K/sec                    (25.01%)</div><div class="line">         7,040,783      dTLB-stores               #    0.720 M/sec                    (28.58%)</div><div class="line">               763      iTLB-load-misses          #   62.80% of all iTLB cache hits   (28.56%)</div><div class="line">             1,215      iTLB-loads                #    0.124 K/sec                    (28.55%)</div><div class="line">           168,588      node-load-misses          #    0.017 M/sec                    (28.55%)</div><div class="line">           131,578      node-loads                #    0.013 M/sec                    (28.55%)</div><div class="line">             4,484      node-store-misses         #    0.459 K/sec                    (7.14%)</div><div class="line">                42      node-stores               #    0.004 K/sec                    (7.14%)</div><div class="line">                </div><div class="line">#perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores ./beforesort</div><div class="line">29.52</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">     6,565,036,614      branch-instructions       #  222.370 M/sec                    (10.72%)</div><div class="line">     1,599,826,737      branch-misses             #   24.37% of all branches          (14.29%)</div><div class="line">       730,977,010      bus-cycles                #   24.760 M/sec                    (17.86%)</div><div class="line">           920,858      cache-misses              #   48.057 % of all cache refs      (21.43%)</div><div class="line">         1,916,178      cache-references          #    0.065 M/sec                    (25.00%)</div><div class="line">    73,123,904,158      cpu-cycles                #    2.477 GHz                      (28.57%)</div><div class="line">    29,618,485,912      instructions              #    0.41  insns per cycle          (32.14%)</div><div class="line">    73,152,861,566      ref-cycles                # 2477.828 M/sec                    (35.72%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                26      context-switches          #    0.001 K/sec</div><div class="line">      29522.972689      cpu-clock (msec)</div><div class="line">                13      cpu-migrations            #    0.000 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               593      minor-faults              #    0.020 K/sec</div><div class="line">               593      page-faults               #    0.020 K/sec</div><div class="line">      29522.976661      task-clock (msec)         #    1.001 CPUs utilized</div><div class="line">        76,164,025      L1-dcache-load-misses     #    1.68% of all L1-dcache hits    (62596004730.92%)</div><div class="line">     4,521,935,099      L1-dcache-loads           #  153.167 M/sec                    (62593882213.79%)</div><div class="line">         1,170,288      L1-dcache-stores          #    0.040 M/sec                    (62591759384.11%)</div><div class="line">         2,975,318      L1-icache-load-misses     #    0.101 M/sec                    (62591281765.29%)</div><div class="line">           178,510      LLC-load-misses           #   66.98% of all LL-cache hits     (62591281765.30%)</div><div class="line">           266,514      LLC-loads                 #    0.009 M/sec                    (62591281765.18%)</div><div class="line">             6,841      LLC-store-misses          #    0.232 K/sec                    (62591578887.87%)</div><div class="line">           335,369      LLC-stores                #    0.011 M/sec                    (7.15%)</div><div class="line">     1,600,893,693      branch-load-misses        #   54.225 M/sec                    (10.72%)</div><div class="line">     6,565,516,562      branch-loads              #  222.387 M/sec                    (14.29%)</div><div class="line">            33,070      dTLB-load-misses          #    0.00% of all dTLB cache hits   (17.87%)</div><div class="line">    12,043,088,689      dTLB-loads                #  407.923 M/sec                    (21.44%)</div><div class="line">               180      dTLB-store-misses         #    0.006 K/sec                    (25.01%)</div><div class="line">         2,359,365      dTLB-stores               #    0.080 M/sec                    (28.58%)</div><div class="line">             9,399      iTLB-load-misses          #  849.82% of all iTLB cache hits   (28.58%)</div><div class="line">             1,106      iTLB-loads                #    0.037 K/sec                    (28.58%)</div><div class="line">           439,052      node-load-misses          #    0.015 M/sec                    (28.58%)</div><div class="line">           367,546      node-loads                #    0.012 M/sec                    (28.58%)</div><div class="line">             7,539      node-store-misses         #    0.255 K/sec                    (7.15%)</div><div class="line">             1,736      node-stores               #    0.059 K/sec                    (7.14%)</div></pre></td></tr></table></figure>
<p>从 x86 和 aarch 对比来看，x86 编译后的指令数是 aarch 的35%，ARM 是精简指令，数量多比较好理解。主频2.5 GHz 较 M710低了11%。</p>
<p>IPC 差异比较大，有一部分是因为 ARM 精简指令本来有较高的 IPC。</p>
<p>从排序前的差异来看除了指令集外导致 IPC 较高的原因主要也是 branch-load-misses(1,232,325,180)/branch-loads(14,776,289,690)  比 intel的 1,602,020,038/6,568,921,480, 也就是 M710的 branch miss 率比 intel 低了一倍。</p>
<p>排序后去掉了 branch miss 差异，M710 比 intel 快了 10%，只要是因为主频的差异</p>
<p>on 8269 3.2GHz</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#perf stat -e branch-instructions,branch-misses,cpu-cycles,instructions,branch-load-misses,branch-loads,task-clock,cpu-clock ./beforesort</div><div class="line">22.96</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line"> Performance counter stats for &apos;./beforesort&apos;:</div><div class="line"></div><div class="line">     6,573,626,859      branch-instructions       #  286.177 M/sec                    (83.33%)</div><div class="line">     1,602,898,541      branch-misses             #   24.38% of all branches          (83.33%)</div><div class="line">    73,189,204,878      cpu-cycles                #    3.186 GHz                      (66.67%)</div><div class="line">    29,627,520,323      instructions              #    0.40  insns per cycle          (83.33%)</div><div class="line">     1,602,848,454      branch-load-misses        #   69.779 M/sec                    (83.33%)</div><div class="line">     6,572,915,651      branch-loads              #  286.146 M/sec                    (83.33%)</div><div class="line">      22970.482491      task-clock (msec)         #    1.001 CPUs utilized</div><div class="line">      22970.482557      cpu-clock (msec)</div></pre></td></tr></table></figure>
<h3 id="hygon-7260-1"><a href="#hygon-7260-1" class="headerlink" title="hygon 7260"></a>hygon 7260</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">#perf stat -e branch-instructions,branch-misses,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-prefetches,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./aftersort</div><div class="line">10.9479</div><div class="line">sum = 314931600000</div><div class="line">     9,848,123,830      branch-instructions       #  898.161 M/sec                    (26.26%)</div><div class="line">           496,734      branch-misses             #    0.01% of all branches          (26.30%)</div><div class="line">           713,235      cache-misses              #    0.336 % of all cache refs      (26.34%)</div><div class="line">       212,455,257      cache-references          #   19.376 M/sec                    (26.37%)</div><div class="line">    27,277,461,559      cpu-cycles                #    2.488 GHz                      (26.41%)</div><div class="line">    32,785,270,866      instructions              #    1.20  insn per cycle</div><div class="line">                                                  #    0.58  stalled cycles per insn  (26.43%)</div><div class="line">    19,069,766,918      stalled-cycles-backend    #   69.91% backend cycles idle      (26.43%)</div><div class="line">         6,560,109      stalled-cycles-frontend   #    0.02% frontend cycles idle     (26.42%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                 0      bpf-output                #    0.000 K/sec</div><div class="line">             1,086      context-switches          #    0.099 K/sec</div><div class="line">         10,964.61 msec cpu-clock                 #    0.999 CPUs utilized</div><div class="line">                 0      cpu-migrations            #    0.000 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               154      minor-faults              #    0.014 K/sec</div><div class="line">               154      page-faults               #    0.014 K/sec</div><div class="line">         10,964.91 msec task-clock                #    0.999 CPUs utilized</div><div class="line">       206,294,123      L1-dcache-load-misses     #    1.14% of all L1-dcache hits    (26.38%)</div><div class="line">    18,083,269,173      L1-dcache-loads           # 1649.217 M/sec                    (26.35%)</div><div class="line">       205,499,292      L1-dcache-prefetches      #   18.742 M/sec                    (26.31%)</div><div class="line">           749,548      L1-icache-load-misses     #    8.67% of all L1-icache hits    (26.27%)</div><div class="line">         8,643,478      L1-icache-loads           #    0.788 M/sec                    (26.25%)</div><div class="line">           305,577      branch-load-misses        #    0.028 M/sec                    (26.25%)</div><div class="line">     9,850,674,490      branch-loads              #  898.394 M/sec                    (26.25%)</div><div class="line">             6,736      dTLB-load-misses          #    6.85% of all dTLB cache hits   (26.25%)</div><div class="line">            98,327      dTLB-loads                #    0.009 M/sec                    (26.25%)</div><div class="line">               114      iTLB-load-misses          #   78.62% of all iTLB cache hits   (26.25%)</div><div class="line">               145      iTLB-loads                #    0.013 K/sec                    (26.25%)</div><div class="line">               </div><div class="line">#perf stat -e branch-instructions,branch-misses,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-prefetches,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./beforesort</div><div class="line">23.3648</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">     9,843,358,378      branch-instructions       #  421.186 M/sec                    (26.26%)</div><div class="line">     1,156,804,801      branch-misses             #   11.75% of all branches          (26.28%)</div><div class="line">           754,542      cache-misses              #    0.351 % of all cache refs      (26.29%)</div><div class="line">       215,234,724      cache-references          #    9.210 M/sec                    (26.31%)</div><div class="line">    58,274,116,562      cpu-cycles                #    2.493 GHz                      (26.33%)</div><div class="line">    32,850,416,330      instructions              #    0.56  insn per cycle</div><div class="line">                                                  #    0.06  stalled cycles per insn  (26.34%)</div><div class="line">     1,838,222,200      stalled-cycles-backend    #    3.15% backend cycles idle      (26.34%)</div><div class="line">     1,187,291,146      stalled-cycles-frontend   #    2.04% frontend cycles idle     (26.34%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                 0      bpf-output                #    0.000 K/sec</div><div class="line">             2,326      context-switches          #    0.100 K/sec</div><div class="line">         23,370.23 msec cpu-clock                 #    0.999 CPUs utilized</div><div class="line">                 0      cpu-migrations            #    0.000 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               150      minor-faults              #    0.006 K/sec</div><div class="line">               150      page-faults               #    0.006 K/sec</div><div class="line">         23,370.97 msec task-clock                #    0.999 CPUs utilized</div><div class="line">       207,451,839      L1-dcache-load-misses     #    0.82% of all L1-dcache hits    (26.34%)</div><div class="line">    25,180,673,249      L1-dcache-loads           # 1077.451 M/sec                    (26.34%)</div><div class="line">       205,669,557      L1-dcache-prefetches      #    8.800 M/sec                    (26.34%)</div><div class="line">         1,725,971      L1-icache-load-misses     #    8.12% of all L1-icache hits    (26.34%)</div><div class="line">        21,265,604      L1-icache-loads           #    0.910 M/sec                    (26.34%)</div><div class="line">     1,157,454,249      branch-load-misses        #   49.526 M/sec                    (26.34%)</div><div class="line">     9,843,015,406      branch-loads              #  421.171 M/sec                    (26.33%)</div><div class="line">            22,287      dTLB-load-misses          #    7.08% of all dTLB cache hits   (26.31%)</div><div class="line">           314,618      dTLB-loads                #    0.013 M/sec                    (26.29%)</div><div class="line">               445      iTLB-load-misses          #   44.95% of all iTLB cache hits   (26.28%)</div><div class="line">               990      iTLB-loads                #    0.042 K/sec                    (26.26%)</div></pre></td></tr></table></figure>
<p>hygon 在这两个场景中排序前比 intel 好了 20%，IPC 好30%，但是指令数多了10%，最关键的也是因为hygon的 branch-load-misses 率较低。</p>
<p>排序后 hygon 略慢10%，主要是指令数多了将近10%。</p>
<p>如果直接将 intel 下 编译好的二进制放到 hygon 下运行，完全可以跑通，指令数也显示和 intel 一样了，但是总时间较在hygon下编译的二进制没有变化</p>
<p><img src="/images/951413iMgBlog/image-20230308145915585.png" alt="image-20230308145915585"></p>
<h2 id="开启-gcc-O3-优化"><a href="#开启-gcc-O3-优化" class="headerlink" title="开启 gcc O3 优化"></a>开启 gcc O3 优化</h2><h3 id="intel-8163"><a href="#intel-8163" class="headerlink" title="intel 8163"></a>intel 8163</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">#perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores ./beforesort</div><div class="line">2.94</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">     3,268,501,946      branch-instructions       # 1109.263 M/sec                    (10.74%)</div><div class="line">           226,833      branch-misses             #    0.01% of all branches          (14.33%)</div><div class="line">        72,998,727      bus-cycles                #   24.774 M/sec                    (17.90%)</div><div class="line">            89,636      cache-misses              #   34.026 % of all cache refs      (21.47%)</div><div class="line">           263,434      cache-references          #    0.089 M/sec                    (25.03%)</div><div class="line">     7,301,839,495      cpu-cycles                #    2.478 GHz                      (28.59%)</div><div class="line">    26,180,809,574      instructions              #    3.59  insns per cycle          (32.16%)</div><div class="line">     7,304,150,283      ref-cycles                # 2478.880 M/sec                    (35.73%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                10      context-switches          #    0.003 K/sec</div><div class="line">       2946.550492      cpu-clock (msec)</div><div class="line">                 7      cpu-migrations            #    0.002 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               370      minor-faults              #    0.126 K/sec</div><div class="line">               370      page-faults               #    0.126 K/sec</div><div class="line">       2946.552985      task-clock (msec)         #    1.001 CPUs utilized</div><div class="line">        73,550,829      L1-dcache-load-misses     #    8.97% of all L1-dcache hits    (627063379426.55%)</div><div class="line">       820,264,255      L1-dcache-loads           #  278.381 M/sec                    (627063379426.55%)</div><div class="line">             6,301      L1-dcache-stores          #    0.002 M/sec                    (627063379426.52%)</div><div class="line">           344,639      L1-icache-load-misses     #    0.117 M/sec                    (627063379426.51%)</div><div class="line">            70,181      LLC-load-misses           #   84.80% of all LL-cache hits     (630745019998.59%)</div><div class="line">            82,757      LLC-loads                 #    0.028 M/sec                    (630529428492.86%)</div><div class="line">               592      LLC-store-misses          #    0.201 K/sec                    (630313967916.99%)</div><div class="line">            33,362      LLC-stores                #    0.011 M/sec                    (7.17%)</div><div class="line">           153,522      branch-load-misses        #    0.052 M/sec                    (10.75%)</div><div class="line">     3,263,884,498      branch-loads              # 1107.696 M/sec                    (14.33%)</div><div class="line">               274      dTLB-load-misses          #    0.00% of all dTLB cache hits   (17.90%)</div><div class="line">     2,179,821,780      dTLB-loads                #  739.787 M/sec                    (21.47%)</div><div class="line">                 8      dTLB-store-misses         #    0.003 K/sec                    (25.04%)</div><div class="line">            12,708      dTLB-stores               #    0.004 M/sec                    (28.61%)</div><div class="line">                59      iTLB-load-misses          #   52.68% of all iTLB cache hits   (28.60%)</div><div class="line">               112      iTLB-loads                #    0.038 K/sec                    (28.59%)</div><div class="line">             5,919      node-load-misses          #    0.002 M/sec                    (28.59%)</div><div class="line">             1,648      node-loads                #    0.559 K/sec                    (28.58%)</div><div class="line">               560      node-store-misses         #    0.190 K/sec                    (7.15%)</div><div class="line">                14      node-stores               #    0.005 K/sec                    (7.14%)</div><div class="line">                </div><div class="line">#perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores ./aftersort</div><div class="line">2.95</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">     3,255,184,180      branch-instructions       # 1102.320 M/sec                    (10.74%)</div><div class="line">           791,180      branch-misses             #    0.02% of all branches          (14.35%)</div><div class="line">        73,001,075      bus-cycles                #   24.721 M/sec                    (17.93%)</div><div class="line">           520,140      cache-misses              #   82.262 % of all cache refs      (21.52%)</div><div class="line">           632,298      cache-references          #    0.214 M/sec                    (25.11%)</div><div class="line">     7,309,286,959      cpu-cycles                #    2.475 GHz                      (28.69%)</div><div class="line">    26,120,077,275      instructions              #    3.57  insns per cycle          (32.28%)</div><div class="line">     7,316,568,954      ref-cycles                # 2477.649 M/sec                    (35.86%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                10      context-switches          #    0.003 K/sec</div><div class="line">       2953.027151      cpu-clock (msec)</div><div class="line">                 3      cpu-migrations            #    0.001 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               370      minor-faults              #    0.125 K/sec</div><div class="line">               370      page-faults               #    0.125 K/sec</div><div class="line">       2953.029425      task-clock (msec)         #    1.001 CPUs utilized</div><div class="line">        73,778,174      L1-dcache-load-misses     #    8.94% of all L1-dcache hits    (625801033059.49%)</div><div class="line">       825,038,324      L1-dcache-loads           #  279.387 M/sec                    (625693600466.98%)</div><div class="line">             6,137      L1-dcache-stores          #    0.002 M/sec                    (625693600466.94%)</div><div class="line">           339,275      L1-icache-load-misses     #    0.115 M/sec                    (625693600466.87%)</div><div class="line">             7,611      LLC-load-misses           #   52.34% of all LL-cache hits     (625693600466.22%)</div><div class="line">            14,542      LLC-loads                 #    0.005 M/sec                    (625693600466.18%)</div><div class="line">               975      LLC-store-misses          #    0.330 K/sec                    (625718826721.74%)</div><div class="line">            28,542      LLC-stores                #    0.010 M/sec                    (7.17%)</div><div class="line">           150,256      branch-load-misses        #    0.051 M/sec                    (10.75%)</div><div class="line">     3,260,765,171      branch-loads              # 1104.210 M/sec                    (14.33%)</div><div class="line">                84      dTLB-load-misses          #    0.00% of all dTLB cache hits   (17.91%)</div><div class="line">     2,177,927,665      dTLB-loads                #  737.523 M/sec                    (21.48%)</div><div class="line">                 0      dTLB-store-misses         #    0.000 K/sec                    (25.05%)</div><div class="line">            12,502      dTLB-stores               #    0.004 M/sec                    (28.62%)</div><div class="line">                10      iTLB-load-misses          #    5.62% of all iTLB cache hits   (28.61%)</div><div class="line">               178      iTLB-loads                #    0.060 K/sec                    (28.60%)</div><div class="line">            14,538      node-load-misses          #    0.005 M/sec                    (28.59%)</div><div class="line">             1,527      node-loads                #    0.517 K/sec                    (28.62%)</div><div class="line">             2,339      node-store-misses         #    0.792 K/sec                    (7.18%)</div><div class="line">                 0      node-stores               #    0.000 K/sec                    (7.14%)</div></pre></td></tr></table></figure>
<p>可以看到 O3 优化后是否排序执行时间差不多，并且都比没有 O3 前的快几倍，指令数较优化前基本不变。</p>
<p>最明显的是排序前的 branch-load-misses 几乎都被优化掉了，这也导致 IPC 从0.41 提升到了3.59</p>
<h3 id="aarch64-M710-1"><a href="#aarch64-M710-1" class="headerlink" title="aarch64 M710"></a>aarch64 M710</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-icache-load-misses,L1-icache-loads,LLC-load-misses,LLC-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads  ./beforesort</div><div class="line">1.19468</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">           178,045      branch-misses                                                 (29.84%)</div><div class="line">     3,290,281,574      bus-cycles                # 2748.321 M/sec                    (29.84%)</div><div class="line">       204,017,139      cache-misses              #   24.768 % of all cache refs      (29.84%)</div><div class="line">       823,700,482      cache-references          #  688.024 M/sec                    (29.84%)</div><div class="line">     3,290,247,311      cpu-cycles                #    2.748 GHz                      (34.85%)</div><div class="line">     5,730,855,778      instructions              #    1.74  insn per cycle</div><div class="line">                                                  #    0.26  stalled cycles per insn  (34.85%)</div><div class="line">     1,485,014,712      stalled-cycles-backend    #   45.13% backend cycles idle      (35.03%)</div><div class="line">           980,441      stalled-cycles-frontend   #    0.03% frontend cycles idle     (35.08%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                 0      bpf-output                #    0.000 K/sec</div><div class="line">                 2      context-switches          #    0.002 K/sec</div><div class="line">          1,197.20 msec cpu-clock                 #    1.000 CPUs utilized</div><div class="line">                 0      cpu-migrations            #    0.000 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               140      minor-faults              #    0.117 K/sec</div><div class="line">               140      page-faults               #    0.117 K/sec</div><div class="line">          1,197.20 msec task-clock                #    1.000 CPUs utilized</div><div class="line">       205,399,817      L1-dcache-load-misses     #   25.00% of all L1-dcache accesses  (35.08%)</div><div class="line">       821,607,081      L1-dcache-loads           #  686.276 M/sec                    (35.08%)</div><div class="line">            10,361      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (35.08%)</div><div class="line">     1,150,511,080      L1-icache-loads           #  961.004 M/sec                    (30.07%)</div><div class="line">             6,275      LLC-load-misses           #    0.00% of all LL-cache accesses  (30.07%)</div><div class="line">                 0      LLC-loads                 #    0.000 K/sec                    (30.07%)</div><div class="line">           103,368      branch-load-misses        #    0.086 M/sec                    (30.07%)</div><div class="line">       821,524,106      branch-loads              #  686.206 M/sec                    (30.07%)</div><div class="line">            15,315      dTLB-load-misses          #    0.00% of all dTLB cache accesses  (30.07%)</div><div class="line">       821,589,564      dTLB-loads                #  686.261 M/sec                    (30.07%)</div><div class="line">             1,084      iTLB-load-misses          #    0.07% of all iTLB cache accesses  (30.07%)</div><div class="line">         1,613,786      iTLB-loads                #    1.348 M/sec                    (29.89%)</div><div class="line"></div><div class="line"></div><div class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-icache-load-misses,L1-icache-loads,LLC-load-misses,LLC-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads  ./aftersort</div><div class="line">1.1949</div><div class="line">sum = 314931600000</div><div class="line"></div><div class="line">           656,175      branch-misses                                                 (29.91%)</div><div class="line">     3,293,615,450      bus-cycles                # 2748.397 M/sec                    (29.91%)</div><div class="line">       203,683,518      cache-misses              #   24.631 % of all cache refs      (29.91%)</div><div class="line">       826,934,774      cache-references          #  690.046 M/sec                    (29.91%)</div><div class="line">     3,293,560,111      cpu-cycles                #    2.748 GHz                      (34.92%)</div><div class="line">     5,732,241,288      instructions              #    1.74  insn per cycle</div><div class="line">                                                  #    0.29  stalled cycles per insn  (34.91%)</div><div class="line">     1,645,938,192      stalled-cycles-backend    #   49.97% backend cycles idle      (35.00%)</div><div class="line">         1,757,056      stalled-cycles-frontend   #    0.05% frontend cycles idle     (35.05%)</div><div class="line">                 0      alignment-faults          #    0.000 K/sec</div><div class="line">                 0      bpf-output                #    0.000 K/sec</div><div class="line">                 2      context-switches          #    0.002 K/sec</div><div class="line">          1,198.38 msec cpu-clock                 #    1.000 CPUs utilized</div><div class="line">                 0      cpu-migrations            #    0.000 K/sec</div><div class="line">                 0      dummy                     #    0.000 K/sec</div><div class="line">                 0      emulation-faults          #    0.000 K/sec</div><div class="line">                 0      major-faults              #    0.000 K/sec</div><div class="line">               137      minor-faults              #    0.114 K/sec</div><div class="line">               137      page-faults               #    0.114 K/sec</div><div class="line">          1,198.38 msec task-clock                #    1.000 CPUs utilized</div><div class="line">       205,557,180      L1-dcache-load-misses     #   25.00% of all L1-dcache accesses  (35.05%)</div><div class="line">       822,366,213      L1-dcache-loads           #  686.233 M/sec                    (35.04%)</div><div class="line">            12,708      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (35.05%)</div><div class="line">       987,422,733      L1-icache-loads           #  823.967 M/sec                    (30.04%)</div><div class="line">             6,234      LLC-load-misses           #    0.00% of all LL-cache accesses  (30.04%)</div><div class="line">                 0      LLC-loads                 #    0.000 K/sec                    (30.04%)</div><div class="line">           103,635      branch-load-misses        #    0.086 M/sec                    (30.04%)</div><div class="line">       822,357,251      branch-loads              #  686.226 M/sec                    (30.04%)</div><div class="line">            13,961      dTLB-load-misses          #    0.00% of all dTLB cache accesses  (30.04%)</div><div class="line">       822,374,897      dTLB-loads                #  686.241 M/sec                    (30.04%)</div><div class="line">               709      iTLB-load-misses          #    0.05% of all iTLB cache accesses  (30.04%)</div><div class="line">         1,562,083      iTLB-loads                #    1.303 M/sec                    (29.96%)</div></pre></td></tr></table></figure>
<p>可以看到在M710上开启 O3 优化后是否排序执行时间差不多，并且都比没有 O3 前</p>
<p>的快几倍，最明显的是指令数只有之前的7%。另外就是排序前的 branch-load-misses 几乎都被优化掉了，虽然这里 IPC 提升不大但主要在指令数的减少上。</p>
<p>O3意味着代码尽可能展开，更长的代码意味着对 L1i（以及 L2和更高级别）高速缓存的压力更高。这会导致性能降低。更短的代码可以运行得更快。幸运的是，gcc 有一个优化选项可以指定此项。如果使用-Os，则编译器将优化代码大小。使用后，能够增加代码大小的哪些优化将被禁用。使用此选项通常会产生令人惊讶的结果。特别是循环展开和内联没有实质优势时，那么此选项将是一个很好的选择。</p>
<h2 id="分支预测原理介绍"><a href="#分支预测原理介绍" class="headerlink" title="分支预测原理介绍"></a>分支预测原理介绍</h2><p><img src="/images/951413iMgBlog/v2-475f184ea376484878515491a120bf49_1440w.png" alt="img"></p>
<p>如上图的上面部分代表通常情况下的简单代码布局。如果区域 B（这里是内联函数 inlfct 生成的代码）经常由于条件 I 被跳过，而不会执行，处理器的预取将拉入很少使用的包含块 B 的高速缓存行。使用块重新排序可以改变这种局面，改变之后的效果可以在图的下半部分看到。经常执行的代码在内存中是线性的，而很少执行的代码被移动到不会损害预取和 L1i 效率的位置。</p>
<h2 id="Linux内核流水线优化案例"><a href="#Linux内核流水线优化案例" class="headerlink" title="Linux内核流水线优化案例"></a>Linux内核流水线优化案例</h2><p>在Linux Kernel中有大量的 likely/unlikely</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ip 层收到消息后，如果是tcp就调用tcp_v4_rcv作为tcp协议的入口</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_v4_rcv</span><span class="params">(struct sk_buff *skb)</span></span></div><div class="line">&#123;</div><div class="line">  ...</div><div class="line">	<span class="keyword">if</span> (unlikely(th-&gt;doff &lt; <span class="keyword">sizeof</span>(struct tcphdr) / <span class="number">4</span>))</div><div class="line">		<span class="keyword">goto</span> bad_packet; <span class="comment">//概率很小</span></div><div class="line">	<span class="keyword">if</span> (!pskb_may_pull(skb, th-&gt;doff * <span class="number">4</span>))</div><div class="line">		<span class="keyword">goto</span> discard_it;</div><div class="line">  </div><div class="line"><span class="comment">//file: net/ipv4/tcp_input.c</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_rcv_established</span><span class="params">(struct sock *sk, ...)</span></span></div><div class="line">&#123;</div><div class="line"> <span class="keyword">if</span> (unlikely(sk-&gt;sk_rx_dst == <span class="literal">NULL</span>))</div><div class="line">  ......</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//file: include/linux/compiler.h</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> likely(x)   __builtin_expect(!!(x),1)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> unlikely(x) __builtin_expect(!!(x),0)</span></div></pre></td></tr></table></figure>
<p>__builtin_expect 这个指令是 gcc 引入的。该函数作用是允许程序员将最有可能执行的分支告诉编译器，来辅助系统进行分支预测。(参见 <a href="https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html" target="_blank" rel="external">https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html</a>)</p>
<p>它的用法为：__builtin_expect(EXP, N)。意思是：EXP == N的概率很大。那么上面 likely 和 unlikely 这两句的具体含义就是：</p>
<ul>
<li><strong>builtin_expect(!!(x),1) x 为真的可能性更大  //0两次取反还是0，非0两次取反都是1，这样可以适配</strong>builtin_expect(EXP, N)的N，要不N的参数没法传</li>
<li>__builtin_expect(!!(x),0) x 为假的可能性更大</li>
</ul>
<p>当正确地使用了__builtin_expect后，编译器在编译过程中会根据程序员的指令，将可能性更大的代码紧跟着前面的代码，从而减少指令跳转带来的性能上的下降。让L1i中加载的代码尽量有效紧凑</p>
<p>这样可以让 CPU流水线分支预测的时候默认走可能性更大的分支。如果分支预测错误所有流水线都要取消重新计算。</p>
<p>如果程序员利用这些宏，然后使用 <code>-freorder-blocks</code> 优化选项，则 gcc 将对块进行重新排序，如原理解图所示。该选项在 -O 2中启用，但在-Os 中禁用。还有另一种对块进行重新排序的选项（<code>-freorder-blocks-and-partition</code> ），但是它的用处有限，因为它不适用于异常处理。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>不排序的代码(分支极难预测正确)运行数据对比：</p>
<table>
<thead>
<tr>
<th></th>
<th>branch-load-misses/branch-loads</th>
<th>instructions</th>
<th>IPC</th>
<th>耗时(秒)</th>
<th>排序后耗时(秒)</th>
</tr>
</thead>
<tbody>
<tr>
<td>鲲鹏920</td>
<td>21.7%</td>
<td>83,694,841,472</td>
<td>1.04</td>
<td>30.92</td>
<td>11.44</td>
</tr>
<tr>
<td>M710</td>
<td>8.3%</td>
<td>77,083,625,280</td>
<td>1.66</td>
<td>16.89</td>
<td>8.20</td>
</tr>
<tr>
<td>Intel 8163</td>
<td>24.4%</td>
<td>29,618,485,912</td>
<td>0.41</td>
<td>29.52</td>
<td>9.77</td>
</tr>
<tr>
<td>hygon 7260</td>
<td>11.8%</td>
<td>32,850,416,330</td>
<td>0.56</td>
<td>23.36</td>
<td>10.95</td>
</tr>
<tr>
<td>FT S2500</td>
<td>24%</td>
<td>83,872,213,462</td>
<td>1.01</td>
<td>39.8</td>
<td>16.63</td>
</tr>
</tbody>
</table>
<p>排序后的代码(分支预测容易)运行数据对比：</p>
<table>
<thead>
<tr>
<th></th>
<th>instructions</th>
<th>instructions(排序前)</th>
<th>IPC</th>
<th>耗时(秒)</th>
</tr>
</thead>
<tbody>
<tr>
<td>鲲鹏920</td>
<td>83,666,813,837</td>
<td>83,694,841,472</td>
<td>2.82</td>
<td>11.44</td>
</tr>
<tr>
<td>M710</td>
<td>77,068,271,833</td>
<td>77,083,625,280</td>
<td>3.42</td>
<td>8.20</td>
</tr>
<tr>
<td>Intel 8163</td>
<td>29,491,804,977</td>
<td>29,618,485,912</td>
<td>1.22</td>
<td>9.77</td>
</tr>
<tr>
<td>hygon 7260</td>
<td>32,785,270,866</td>
<td>32,850,416,330</td>
<td>1.20</td>
<td>10.95</td>
</tr>
<tr>
<td>FT S2500</td>
<td>83,918,069,835</td>
<td>83,872,213,462</td>
<td>2.41</td>
<td>16.63</td>
</tr>
</tbody>
</table>
<ul>
<li>所有 CPU 都期望对分支预测友好的代码</li>
<li>分支预测重点关注 perf branch-load-misses/branch-loads</li>
<li>aarch64 较 x86_64 指令数是2.6倍，同时对流水线更友好，也就是 IPC 更高(2.6倍)，测试代码单线程、无锁</li>
<li>M710的分支预测正确率是鲲鹏920、intel的3倍，hygon 是鲲鹏 、intel的分支预测率的2倍</li>
<li>10% 的分支load miss 会带来一倍的性能差异</li>
<li>gcc O3 优化效果很明显，代价就是代码展开后很大，容易造成icache不够，对小段测试代码效果最好，实践不一定</li>
<li>测试代码只是极简场景，实际生产环境更复杂，也就是预测效果不会这么明显</li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CPU/" rel="tag"># CPU</a>
          
            <a href="/tags/perf/" rel="tag"># perf</a>
          
            <a href="/tags/IPC/" rel="tag"># IPC</a>
          
            <a href="/tags/branch-miss/" rel="tag"># branch_miss</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2023/04/06/为什么你不去看文档/" rel="next" title="为什么你不去看文档">
                <i class="fa fa-chevron-left"></i> 为什么你不去看文档
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2023/05/06/我的网络传输速度为什么突然下降了/" rel="prev" title="我的网络传输速度为什么突然下降了">
                我的网络传输速度为什么突然下降了 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="twitter @plantegg" />
          <p class="site-author-name" itemprop="name">twitter @plantegg</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">157</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">249</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#比较不同CPU下的分支预测"><span class="nav-number">1.</span> <span class="nav-text">比较不同CPU下的分支预测</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#目的"><span class="nav-number">1.1.</span> <span class="nav-text">目的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU-情况"><span class="nav-number">1.2.</span> <span class="nav-text">CPU 情况</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#intel-x86"><span class="nav-number">1.2.1.</span> <span class="nav-text">intel x86</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hygon-7260"><span class="nav-number">1.2.2.</span> <span class="nav-text">hygon 7260</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ARM-鲲鹏920"><span class="nav-number">1.2.3.</span> <span class="nav-text">ARM 鲲鹏920</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ARM-M710"><span class="nav-number">1.2.4.</span> <span class="nav-text">ARM M710</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ARM-FT-S2500"><span class="nav-number">1.2.5.</span> <span class="nav-text">ARM FT S2500</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试代码"><span class="nav-number">1.3.</span> <span class="nav-text">测试代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试结果"><span class="nav-number">1.4.</span> <span class="nav-text">测试结果</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#aarch64-鲲鹏920"><span class="nav-number">1.4.1.</span> <span class="nav-text">aarch64 鲲鹏920</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#aarch64-M710"><span class="nav-number">1.4.2.</span> <span class="nav-text">aarch64 M710</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#aarch64-FT-S2500"><span class="nav-number">1.4.3.</span> <span class="nav-text">aarch64 FT S2500</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Intel-x86-8163"><span class="nav-number">1.4.4.</span> <span class="nav-text">Intel x86 8163</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hygon-7260-1"><span class="nav-number">1.4.5.</span> <span class="nav-text">hygon 7260</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开启-gcc-O3-优化"><span class="nav-number">1.5.</span> <span class="nav-text">开启 gcc O3 优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#intel-8163"><span class="nav-number">1.5.1.</span> <span class="nav-text">intel 8163</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#aarch64-M710-1"><span class="nav-number">1.5.2.</span> <span class="nav-text">aarch64 M710</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分支预测原理介绍"><span class="nav-number">1.6.</span> <span class="nav-text">分支预测原理介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux内核流水线优化案例"><span class="nav-number">1.7.</span> <span class="nav-text">Linux内核流水线优化案例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.8.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">twitter @plantegg</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv_footer"></span>次
</span>
<span id="busuanzi_container_site_uv">
  本站访客数<span id="busuanzi_value_site_uv_footer"></span>人次
</span>


        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
